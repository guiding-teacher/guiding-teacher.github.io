<!-- START OF FILE complete-profile.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>إكمال الملف الشخصي</title>
<link rel="stylesheet" href="css/style.css">
<style>
    /* Ensure body is hidden until auth check is complete */
    body { display: none; }
</style>
</head>
<body>
<div class="login-container">
    <h2>مرحباً بك!</h2>
    <p>يرجى إكمال بيانات ملفك الشخصي للمتابعة إلى لوحة التحكم.</p>
    <p>بريدك الإلكتروني: <strong id="user-email-display">...</strong></p>
    <form id="complete-profile-form">
        <input type="text" id="name" placeholder="الاسم الكامل *" required>
        <input type="tel" id="phone" placeholder="رقم الهاتف *" required>
        <input type="text" id="institution" placeholder="المؤسسة *" required>
        <input type="text" id="governorate" placeholder="المحافظة *" required>
        <input type="date" id="dob" placeholder="المواليد *" required style="color-scheme: dark;">
        <select id="gender" required style="color-scheme: dark; width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ddd; background-color: #fff; color: #888; direction: rtl;">
            <option value="" disabled selected>الجنس *</option>
            <option value="male">ذكر</option>
            <option value="female">أنثى</option>
        </select>
        <button type="submit">حفظ ومتابعة</button>
    </form>
    <p id="error-message"></p>
    <button id="logout-btn" style="background-color: #6c757d; margin-top: 15px;">تسجيل الخروج</button>
</div>

<script type="module">
    import { auth, db } from './js/firebase-config.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, setDoc, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const userEmailDisplay = document.getElementById('user-email-display');
    const completeProfileForm = document.getElementById('complete-profile-form');
    const errorMessage = document.getElementById('error-message');
    const logoutBtn = document.getElementById('logout-btn');

    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            // Check if profile is already complete
            const adminRef = doc(db, "admins", user.uid);
            const adminDoc = await getDoc(adminRef);

            if (adminDoc.exists() && adminDoc.data().name) {
                // Profile is already complete, redirect to admin panel
                window.location.replace('admin.html');
            } else {
                // Profile is not complete, show the page
                userEmailDisplay.textContent = user.email;
                document.body.style.display = 'flex'; // Use flex for centering
            }
        } else {
            // No user logged in, redirect to login
            window.location.replace('admin-login.html');
        }
    });

    completeProfileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) {
            errorMessage.textContent = 'خطأ: لم يتم التعرف على المستخدم.';
            return;
        }

        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const institution = document.getElementById('institution').value.trim();
        const governorate = document.getElementById('governorate').value.trim();
        const dob = document.getElementById('dob').value.trim();
        const gender = document.getElementById('gender').value;

        if (!name || !phone || !institution || !governorate || !dob || !gender) {
            errorMessage.textContent = 'جميع الحقول إجبارية.';
            return;
        }

        const adminData = {
            name,
            email: currentUser.email,
            phone,
            institution,
            governorate,
            dob,
            gender,
            createdAt: Timestamp.now(),
            lastLogin: Timestamp.now(),
            status: 'active'
        };

        try {
            // Use setDoc with merge:true to create or update the document safely
            await setDoc(doc(db, "admins", currentUser.uid), adminData, { merge: true });
            alert('تم حفظ بياناتك بنجاح! سيتم توجيهك الآن إلى لوحة التحكم.');
            window.location.href = 'admin.html';
        } catch (error) {
            console.error("Error saving profile:", error);
            errorMessage.textContent = 'حدث خطأ أثناء حفظ البيانات. حاول مرة أخرى.';
        }
    });

    logoutBtn.addEventListener('click', async () => {
        await signOut(auth);
        window.location.href = 'admin-login.html';
    });
</script>
</body>
</html>