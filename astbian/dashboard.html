<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ù†ØµØ© Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“Š</text></svg>">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --primary-bg: #f4f7fc;
            --secondary-bg: #ffffff;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
            --sidebar-active-bg: #34495e;
            --primary-blue: #3498db;
            --primary-blue-hover: #2980b9;
            --text-primary: #34495e;
            --text-secondary: #7f8c8d;
            --border-color: #e1e4e8;
            --error-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .dashboard-container { display: flex; min-height: 100vh; }

        .sidebar {
            width: 260px; background-color: var(--sidebar-bg); color: var(--sidebar-text);
            padding: 1.5rem 0; position: fixed; top: 0; right: 0; bottom: 0;
            transition: right 0.3s ease; z-index: 100;
        }
        .sidebar-header { text-align: center; padding: 0 1rem 1.5rem 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--sidebar-active-bg); }
        .sidebar-header h2 { font-size: 1.5rem; }
        .sidebar-nav { list-style: none; }
        .sidebar-nav a {
            display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem;
            color: var(--sidebar-text); text-decoration: none; font-size: 1.1rem;
            transition: background-color 0.2s, color 0.2s; border-right: 3px solid transparent;
        }
        .sidebar-nav a:hover { background-color: var(--sidebar-active-bg); }
        .sidebar-nav a.active { background-color: var(--sidebar-active-bg); border-right-color: var(--primary-blue); font-weight: 700; }
        .sidebar-nav a svg { width: 20px; height: 20px; opacity: 0.8; }

        .main-content { margin-right: 260px; width: calc(100% - 260px); padding: 2rem; }
        .page-header { margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; }
        .page-header h1 { font-size: 2.2rem; }
        .page-header .button-primary {
            background-color: var(--primary-blue); color: white; padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius); text-decoration: none; font-weight: 500;
            transition: background-color 0.2s;
        }
        .page-header .button-primary:hover { background-color: var(--primary-blue-hover); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background-color: var(--secondary-bg); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
        .stat-card h3 { font-size: 1rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
        .stat-card .stat-value { font-size: 2.5rem; font-weight: 700; }

        .card { background-color: var(--secondary-bg); padding: 2rem; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .table-container { overflow-x: auto; }
        .survey-table { width: 100%; border-collapse: collapse; text-align: right; }
        .survey-table th, .survey-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .survey-table th { font-weight: 500; color: var(--text-secondary); }
        .survey-table a, .survey-table .link-like { color: var(--primary-blue); text-decoration: none; font-weight: 500; cursor: pointer; }
        .survey-table a:hover, .survey-table .link-like:hover { text-decoration: underline; }

        .status-badge { padding: 0.25rem 0.6rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; color: white; }
        .status-active { background-color: var(--success-color); } .status-ended { background-color: var(--error-color); }
        .status-scheduled { background-color: var(--warning-color); color: var(--text-primary); }

        .action-buttons { display: flex; gap: 0.5rem; }
        .action-btn { background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .action-btn:hover { background-color: #f0f0f0; }
        .action-btn svg { width: 18px; height: 18px; }
        .action-btn.delete-btn svg { color: var(--error-color); }
        .bulk-actions { margin-bottom: 1rem; }
        .bulk-actions button { background-color: var(--error-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: var(--border-radius); cursor: pointer; display: none; }
        .loader { border: 4px solid #e9ecef; border-top: 4px solid var(--primary-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 4rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #alert-container { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 1001; width: 90%; max-width: 500px; }
        .alert { padding: 1rem; margin-bottom: 1rem; border-radius: var(--border-radius); box-shadow: var(--shadow-md); opacity: 0; transform: translateY(-20px); animation: fadeIn 0.3s forwards; }
        .alert.success { background-color: var(--success-color); color: white; }
        .alert.error { background-color: var(--error-color); color: white; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--secondary-bg); border-radius: var(--border-radius); padding: 2rem;
            width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto;
            box-shadow: var(--shadow-md); position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .modal-header h3 { margin: 0; color: var(--primary-blue); }
        .close-btn { font-size: 2rem; font-weight: bold; color: var(--text-secondary); cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: var(--error-color); }
        .response-details .question { font-weight: bold; color: var(--text-primary); margin-top: 1.5rem; }
        .response-details .answer { padding: 0.75rem; background: var(--primary-bg); border-radius: 0.5rem; margin-top: 0.5rem; white-space: pre-wrap; word-wrap: break-word; }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar { right: -260px; }
            .sidebar.open { right: 0; }
            .main-content { margin-right: 0; width: 100%; }
            .menu-toggle {
                display: block; position: fixed; top: 1rem; right: 1rem; z-index: 101;
                background: var(--sidebar-bg); color: white; border: none; padding: 0.75rem;
                border-radius: var(--border-radius); cursor: pointer;
            }
        }
        .menu-toggle { display: none; }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            </div>
            <ul class="sidebar-nav">
                <li><a href="#" class="sidebar-link active" data-section="dashboard-home">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L8.707 1.5z"/><path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293z"/></svg>
                    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                </a></li>
                <li><a href="#" class="sidebar-link" data-section="all-surveys">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5z"/><path d="M1 9.5A1.5 1.5 0 0 1 2.5 8h3A1.5 1.5 0 0 1 7 9.5v3A1.5 1.5 0 0 1 5.5 14h-3A1.5 1.5 0 0 1 1 12.5zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5zM8 2.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5m0 4a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5m0 4a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5"/></svg>
                    <span>ÙƒÙ„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª</span>
                </a></li>
                <!-- NEW SECTION LINK -->
                <li><a href="#" class="sidebar-link" data-section="individual-responses">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/></svg>
                    <span>Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¬ÙŠØ¨ÙŠÙ†</span>
                </a></li>
                <li><a href="admin.html">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3z"/></svg>
                    <span>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø¬Ø¯ÙŠØ¯</span>
                </a></li>
            </ul>
        </aside>

        <button class="menu-toggle" id="menu-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5"/></svg>
        </button>

        <!-- Main Content Area -->
        <main class="main-content">
            <div id="alert-container"></div>
            
            <section id="dashboard-home">
                <div class="page-header"><h1>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h1><a href="admin.html" class="button-primary">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø¬Ø¯ÙŠØ¯</a></div>
                <div class="stats-grid">
                    <div class="stat-card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª</h3><p class="stat-value" id="total-surveys-stat">0</p></div>
                    <div class="stat-card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</h3><p class="stat-value" id="total-responses-stat">0</p></div>
                    <div class="stat-card"><h3>Ø£ÙƒØ«Ø± Ø§Ø³ØªØ¨ÙŠØ§Ù† Ù†Ø´Ø§Ø·Ø§Ù‹</h3><p class="stat-value" id="most-active-survey-stat" style="font-size: 1.5rem; line-height: 1.2; padding-top: 1rem;">...</p></div>
                </div>
                <div class="card">
                    <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª</h3>
                    <div id="survey-chart-container" style="height: 350px;"><canvas id="survey-chart"></canvas></div>
                </div>
            </section>

            <section id="all-surveys" style="display: none;">
                <div class="page-header"><h1>ÙƒÙ„ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª</h1></div>
                <div class="card">
                    <div class="bulk-actions"><button id="delete-selected-btn">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button></div>
                    <div class="table-container">
                        <table class="survey-table">
                            <thead><tr><th><input type="checkbox" id="select-all-checkbox"></th><th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†</th><th>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                            <tbody id="surveys-list-tbody"></tbody>
                        </table>
                    </div>
                    <div id="loader-all-surveys" class="loader"></div>
                </div>
            </section>

            <!-- NEW SECTION: Individual Responses -->
            <section id="individual-responses" style="display: none;">
                <div class="page-header"><h1>Ø¹Ø±Ø¶ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¬ÙŠØ¨ÙŠÙ†</h1></div>
                <div class="card">
                    <div class="form-group">
                        <label for="survey-selector">Ø§Ø®ØªØ± Ø§Ø³ØªØ¨ÙŠØ§Ù†Ù‹Ø§ Ù„Ø¹Ø±Ø¶ Ø¥Ø¬Ø§Ø¨Ø§ØªÙ‡:</label>
                        <select id="survey-selector" class="form-control"></select>
                    </div>
                </div>
                <div id="responses-table-container" class="card" style="display: none;">
                    <h3 id="responses-table-title">Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ø³ØªØ¨ÙŠØ§Ù†: ...</h3>
                    <div class="table-container">
                         <table class="survey-table">
                            <thead><tr><th>#</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</th><th>Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ù†Ø¸Ø§Ù…</th><th>Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</th></tr></thead>
                            <tbody id="responses-list-tbody"></tbody>
                        </table>
                    </div>
                    <div id="loader-responses" class="loader" style="display: none;"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal for showing individual response details -->
    <div id="response-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</h3>
                <span class="close-btn" id="modal-close-btn">&times;</span>
            </div>
            <div id="modal-body" class="response-details">
                <!-- Response details will be injected here -->
            </div>
        </div>
    </div>


<script>
    // --- START OF JAVASCRIPT ---

    // ====== Firebase Configuration ======
    const firebaseConfig = {
      apiKey: "AIzaSyA4idIicapTuRwacbuzFeoAEJE6iUpQG9Y",
      authDomain: "mcqs-28ac8.firebaseapp.com",
      databaseURL: "https://mcqs-28ac8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "mcqs-28ac8",
      storageBucket: "mcqs-28ac8.appspot.com",
      messagingSenderId: "305239385864",
      appId: "1:305239385864:web:d2d44dd61f73a502b96ebd",
      measurementId: "G-2E3137CYTR"
    };

    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    } catch (e) {
        console.error("Firebase initialization error:", e);
        document.body.innerHTML = '<h1>Ø®Ø·Ø£ ÙØ§Ø¯Ø­: ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase</h1>';
    }

    const db = firebase.firestore();
    let surveyChartInstance = null;
    let allSurveysCache = []; // Cache for surveys

    // ====== Helper Functions ======
    function showAlert(message, type, duration = 4000) {
        const alertContainer = document.getElementById('alert-container');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${type}`;
        alertDiv.textContent = message;
        alertContainer.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), duration);
    }

    function showLoader(loaderId, show = true) {
        const loader = document.getElementById(loaderId);
        if (loader) loader.style.display = show ? 'block' : 'none';
    }
    
    // ====== Dashboard Logic ======
    document.addEventListener('DOMContentLoaded', () => {
        initDashboard();
        setupEventListeners();
    });

    async function initDashboard() {
        showLoader('loader-all-surveys');
        try {
            const [surveys, responsesCountMap] = await Promise.all([ fetchAllSurveys(), fetchSurveyResponsesCount() ]);
            allSurveysCache = surveys; // Store surveys in cache
            
            populateDashboardHome(surveys, responsesCountMap);
            populateAllSurveysTable(surveys, responsesCountMap);
            populateSurveySelector(surveys); // Populate the new selector

        } catch (error) {
            console.error("Error initializing dashboard:", error);
            showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….", "error");
        } finally {
            showLoader('loader-all-surveys', false);
        }
    }

    function setupEventListeners() {
        // Sidebar navigation
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', (e) => {
                if(link.getAttribute('href') === '#') {
                    e.preventDefault();
                    const sectionId = link.getAttribute('data-section');
                    showSection(sectionId);
                    document.querySelector('.sidebar-link.active').classList.remove('active');
                    link.classList.add('active');
                }
            });
        });

        // Responsive menu toggle
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        if(menuToggle) {
            menuToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
        }
        
        // Bulk delete functionality
        document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
            document.querySelectorAll('.survey-row-checkbox').forEach(cb => { cb.checked = e.target.checked; });
            toggleBulkDeleteButton();
        });
        document.getElementById('delete-selected-btn').addEventListener('click', handleBulkDelete);

        // Individual Responses Section Event Listener
        document.getElementById('survey-selector').addEventListener('change', handleSurveySelectionChange);

        // Modal close button
        document.getElementById('modal-close-btn').addEventListener('click', () => document.getElementById('response-modal').style.display = 'none');
        window.addEventListener('click', (e) => {
             if (e.target == document.getElementById('response-modal')) e.target.style.display = 'none';
        });
    }
    
    function showSection(sectionId) {
        document.querySelectorAll('main > section').forEach(section => { section.style.display = 'none'; });
        const activeSection = document.getElementById(sectionId);
        if (activeSection) activeSection.style.display = 'block';
    }

    async function fetchAllSurveys() {
        const snapshot = await db.collection('surveys').orderBy('createdAt', 'desc').get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function fetchSurveyResponsesCount() {
        const snapshot = await db.collection('responses').get();
        const counts = new Map();
        snapshot.docs.forEach(doc => {
            const surveyId = doc.data().surveyId;
            if (surveyId) counts.set(surveyId, (counts.get(surveyId) || 0) + 1);
        });
        return counts;
    }

    // --- POPULATE DASHBOARD SECTIONS ---
    function populateDashboardHome(surveys, responsesCountMap) {
        document.getElementById('total-surveys-stat').textContent = surveys.length;
        document.getElementById('total-responses-stat').textContent = Array.from(responsesCountMap.values()).reduce((sum, count) => sum + count, 0);
        let mostActiveSurvey = { name: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯', count: -1 };
        responsesCountMap.forEach((count, surveyId) => {
            if (count > mostActiveSurvey.count) {
                const survey = surveys.find(s => s.id === surveyId);
                if (survey) mostActiveSurvey = { name: survey.title, count: count };
            }
        });
        document.getElementById('most-active-survey-stat').textContent = mostActiveSurvey.name;
        renderSurveysChart(surveys, responsesCountMap);
    }
    
    function renderSurveysChart(surveys, responsesCountMap) {
        const ctx = document.getElementById('survey-chart').getContext('2d');
        const chartData = {
            labels: [],
            datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª', data: [], backgroundColor: 'rgba(52, 152, 219, 0.5)', borderColor: 'rgb(52, 152, 219)', borderWidth: 1, borderRadius: 4 }]
        };
        surveys.slice(0, 10).forEach(survey => {
            chartData.labels.push(survey.title.substring(0, 20) + '...');
            chartData.datasets[0].data.push(responsesCountMap.get(survey.id) || 0);
        });
        if (surveyChartInstance) surveyChartInstance.destroy();
        surveyChartInstance = new Chart(ctx, {
            type: 'bar', data: chartData,
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false }, tooltip: { rtl: true, textDirection: 'rtl' } } }
        });
    }

    function populateAllSurveysTable(surveys, responsesCountMap) {
        const tbody = document.getElementById('surveys-list-tbody');
        tbody.innerHTML = '';
        if (surveys.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem;">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙŠ Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</td></tr>`;
            return;
        }
        surveys.forEach(survey => {
            const { statusClass, statusText } = getSurveyStatus(survey);
            const row = document.createElement('tr');
            row.dataset.id = survey.id;
            row.innerHTML = `
                <td><input type="checkbox" class="survey-row-checkbox" data-id="${survey.id}"></td>
                <td><a href="results.html?id=${survey.id}" title="Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬">${survey.title}</a></td>
                <td>${responsesCountMap.get(survey.id) || 0}</td>
                <td>${survey.createdAt?.toDate ? survey.createdAt.toDate().toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td class="action-buttons">
                    <a href="admin.html?id=${survey.id}" class="action-btn" title="ØªØ¹Ø¯ÙŠÙ„"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M12.854.146a.5.5 0 0 0-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 0 0 0-.708zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.207zm-7.468 7.468A.5.5 0 0 1 6 13.5V13h-.5a.5.5 0 0 1-.5-.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.5-.5V10h-.5a.499.499 0 0 1-.175-.032l-.179.178a.5.5 0 0 0-.11.168l-2 5a.5.5 0 0 0 .65.65l5-2a.5.5 0 0 0 .168-.11z"/></svg></a>
                    <a href="survey.html?id=${survey.id}" target="_blank" class="action-btn" title="Ù…Ø¹Ø§ÙŠÙ†Ø©"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"/></svg></a>
                    <button class="action-btn delete-btn" title="Ø­Ø°Ù" data-id="${survey.id}"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button>
                </td>`;
            tbody.appendChild(row);
        });
        tbody.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleSingleDelete));
        tbody.querySelectorAll('.survey-row-checkbox').forEach(cb => cb.addEventListener('change', toggleBulkDeleteButton));
    }
    
    // --- NEW: INDIVIDUAL RESPONSES SECTION LOGIC ---
    function populateSurveySelector(surveys) {
        const selector = document.getElementById('survey-selector');
        selector.innerHTML = '<option value="">-- ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± --</option>';
        surveys.forEach(survey => {
            const option = document.createElement('option');
            option.value = survey.id;
            option.textContent = survey.title;
            selector.appendChild(option);
        });
    }

    async function handleSurveySelectionChange(event) {
        const surveyId = event.target.value;
        const responsesContainer = document.getElementById('responses-table-container');
        const tbody = document.getElementById('responses-list-tbody');
        tbody.innerHTML = '';

        if (!surveyId) {
            responsesContainer.style.display = 'none';
            return;
        }

        const selectedSurvey = allSurveysCache.find(s => s.id === surveyId);
        document.getElementById('responses-table-title').textContent = `Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ø³ØªØ¨ÙŠØ§Ù†: ${selectedSurvey.title}`;
        responsesContainer.style.display = 'block';
        showLoader('loader-responses', true);

        try {
            const responsesSnapshot = await db.collection('responses').where('surveyId', '==', surveyId).orderBy('timestamp', 'desc').get();
            const responses = responsesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            if (responses.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø¨Ø¹Ø¯.</td></tr>`;
                return;
            }

            responses.forEach((response, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${response.timestamp?.toDate ? response.timestamp.toDate().toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>${response.userAgent ? response.userAgent.substring(0, 40) + '...' : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                    <td><span class="link-like" data-response-id="${response.id}">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</span></td>
                `;
                tbody.appendChild(row);
            });

            // Add event listeners to the "view details" links
            tbody.querySelectorAll('.link-like').forEach(link => {
                link.addEventListener('click', () => {
                    const response = responses.find(r => r.id === link.dataset.responseId);
                    showResponseDetails(response, selectedSurvey.questions);
                });
            });

        } catch (error) {
            console.error("Error fetching responses:", error);
            showAlert("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª.", "error");
            tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--error-color);">Ø­Ø¯Ø« Ø®Ø·Ø£.</td></tr>`;
        } finally {
            showLoader('loader-responses', false);
        }
    }

    function showResponseDetails(response, surveyQuestions) {
        const modal = document.getElementById('response-modal');
        const modalBody = document.getElementById('modal-body');
        modalBody.innerHTML = ''; // Clear previous details

        if (!response || !response.answers) {
            modalBody.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.</p>';
            modal.style.display = 'flex';
            return;
        }

        surveyQuestions.forEach((question, index) => {
            const answerObj = response.answers.find(a => a.questionId === question.id);
            let answerText = '<em style="color: var(--text-secondary)">(Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø©)</em>';

            if (answerObj && answerObj.answer != null) {
                if (Array.isArray(answerObj.answer)) {
                    answerText = answerObj.answer.join('ØŒ ') || answerText;
                } else {
                    answerText = String(answerObj.answer);
                }
            }
            
            const detailDiv = document.createElement('div');
            detailDiv.innerHTML = `<p class="question">${index + 1}. ${question.text}</p><div class="answer">${answerText}</div>`;
            modalBody.appendChild(detailDiv);
        });
        
        modal.style.display = 'flex';
    }


    // --- UTILITY AND EVENT HANDLERS ---
    function getSurveyStatus(survey) {
        if (!survey.settings) return { statusClass: 'status-active', statusText: 'Ù†Ø´Ø·' };
        const now = new Date();
        const startDate = survey.settings.startDate ? new Date(survey.settings.startDate + 'T' + (survey.settings.startTime || '00:00')) : null;
        const endDate = survey.settings.endDate ? new Date(survey.settings.endDate + 'T' + (survey.settings.endTime || '23:59')) : null;
        if (endDate && now > endDate) return { statusClass: 'status-ended', statusText: 'Ù…Ù†ØªÙ‡ÙŠ' };
        if (startDate && now < startDate) return { statusClass: 'status-scheduled', statusText: 'Ù…Ø¬Ø¯ÙˆÙ„' };
        return { statusClass: 'status-active', statusText: 'Ù†Ø´Ø·' };
    }

    function toggleBulkDeleteButton() {
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const checkedCount = document.querySelectorAll('.survey-row-checkbox:checked').length;
        deleteSelectedBtn.style.display = checkedCount > 0 ? 'inline-block' : 'none';
        deleteSelectedBtn.textContent = `Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ (${checkedCount})`;
    }

    async function handleSingleDelete(event) {
        const surveyId = event.currentTarget.dataset.id;
        const surveyTitle = event.currentTarget.closest('tr').querySelector('a').textContent;
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù† "${surveyTitle}"ØŸ`)) {
            try {
                await db.collection('surveys').doc(surveyId).delete();
                showAlert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø¨Ù†Ø¬Ø§Ø­.", "success");
                initDashboard(); // Refresh
            } catch (error) { showAlert("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†.", "error"); }
        }
    }

    async function handleBulkDelete() {
        const selectedIds = Array.from(document.querySelectorAll('.survey-row-checkbox:checked')).map(cb => cb.dataset.id);
        if (selectedIds.length === 0) return;
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${selectedIds.length} Ø§Ø³ØªØ¨ÙŠØ§Ù† (Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª)ØŸ`)) {
            showLoader('loader-all-surveys', true);
            const deletePromises = selectedIds.map(id => db.collection('surveys').doc(id).delete());
            try {
                await Promise.all(deletePromises);
                showAlert(`ØªÙ… Ø­Ø°Ù ${selectedIds.length} Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø¨Ù†Ø¬Ø§Ø­.`, "success");
                initDashboard();
            } catch (error) { showAlert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù.", "error"); } 
            finally { showLoader('loader-all-surveys', false); }
        }
    }

    // --- END OF JAVASCRIPT ---
</script>

</body>
</html>