<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>محرر الصور والنصوص التفاعلي</title>

    <!-- تضمين مكتبة jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- تضمين خطوط Google Fonts العربية -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&family=Amiri:ital,wght@0,400;0,700;1,400;1,700&family=Aref+Ruqaa+Ink:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@200..1000&family=Changa:wght@200..800&family=El+Messiri:wght@400..700&family=Harmattan:wght@400;700&family=IBM+Plex+Sans+Arabic:wght@100..700&family=Jomhuria&family=Katibeh&family=Lalezar&family=Lateef:wght@200..800&family=Lemonada:wght@300..700&family=Mada:wght@200..900&family=Markazi+Text:wght@400..700&family=Mirza:wght@400..700&family=Noto+Kufi+Arabic:wght@100..900&family=Noto+Naskh+Arabic:wght@400..700&family=Noto+Sans+Arabic:wght@100..900&family=Readex+Pro:wght@160..700&family=Reem+Kufi+Fun:wght@400..700&family=Reem+Kufi+Ink:wght@400&family=Reem+Kufi:wght@400..700&family=Ruwudu:wght@400..700&family=Scheherazade+New:wght@400;700&family=Tajawal:wght@200..900&family=Vibes&family=Gulzar&family=Alkalami&family=Noto+Nastaliq+Urdu&family=Alkalami&family=Mirza&display=swap" rel="stylesheet">

    <!-- تضمين Font Awesome للأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --primary-color: #4a6fa5; --secondary-color: #6c757d; --light-color: #f8f9fa;
            --dark-color: #343a40; --background-color: #f5f7fa; --danger-color: #e74c3c;
            --success-color: #2ecc71; --info-color: #3498db; --shadow-color: rgba(0, 0, 0, 0.1);
            --a4-width-px: 794px; --a4-height-px: 1123px; --toolbar-bg: #2c3e50;
            --toolbar-text: #ecf0f1; --toolbar-hover: #34495e; --toolbar-active: #1abc9c;
            --mobile-breakpoint: 768px;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body {
            font-family: 'Cairo', sans-serif; background-color: var(--background-color); color: var(--dark-color);
            direction: rtl; text-align: right; min-height: 100vh; display: flex; flex-direction: column;
            align-items: center; padding: 1rem; line-height: 1.6; user-select: none; -webkit-user-select: none;
            -moz-user-select: none; -ms-user-select: none; overflow-x: hidden;
        }
        h1 {
            color: var(--primary-color); margin-bottom: 1rem; text-align: center; font-family: 'Changa', sans-serif;
            font-weight: 700; font-size: 2.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #image-selection-area {
            background-color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 6px 18px var(--shadow-color);
            margin-bottom: 1.5rem; width: 100%; max-width: 900px; display: flex; flex-direction: column; transition: all 0.3s ease;
        }
        #image-selection-area h2 {
            text-align: center; margin-bottom: 1.5rem; color: var(--primary-color); font-size: 1.4rem;
            font-family: 'Tajawal', sans-serif; font-weight: 600;
        }
        #image-gallery {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1.2rem; max-height: 350px;
            overflow-y: auto; padding: 0.8rem; border: 1px solid #eee; margin-bottom: 1.2rem; background-color: #fdfdfd; border-radius: 8px;
        }
        .gallery-item {
            display: flex; flex-direction: column; align-items: center; gap: 0.8rem; border: 1px solid #e0e0e0; padding: 0.8rem;
            border-radius: 8px; background-color: white; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.05); cursor: pointer;
        }
        .gallery-item:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); border-color: var(--primary-color); }
        .gallery-item img { max-width: 100%; height: 100px; object-fit: cover; border-radius: 6px; }
        .gallery-item button {
            font-size: 0.9rem; padding: 0.5rem 0.8rem; cursor: pointer; background-color: var(--primary-color); color: white;
            border: none; border-radius: 6px; transition: all 0.3s ease; width: 100%; font-family: 'Tajawal', sans-serif;
        }
        #upload-section { margin-top: 1.2rem; border-top: 1px dashed #ddd; padding-top: 1.2rem; text-align: center; }
        #large-upload-button {
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.8rem;
            background-color: var(--primary-color); color: white; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;
            width: 100%; min-height: 120px; font-size: 1.3rem; border: 2px dashed rgba(255,255,255,0.3); font-family: 'Tajawal', sans-serif;
        }
        #imageLoader { display: none; }
        #editor-screen { display: none; flex-direction: column; align-items: center; width: 100%; }
        #editor-main-area {
            display: flex; flex-direction: row-reverse; gap: 1.5rem; width: 100%; max-width: 1400px; align-items: flex-start;
        }
        #canvas-container {
            flex: 1; min-width: 60%; border: 1px solid #d1d8e0; box-shadow: 0 8px 24px var(--shadow-color);
            background-color: white; position: relative; overflow: hidden; aspect-ratio: var(--a4-width-px) / var(--a4-height-px);
            height: auto; touch-action: none; border-radius: 8px;
        }
        #imageCanvas { display: block; width: 100%; height: 100%; cursor: crosshair; background-color: #f1f5f9; }
        #imageCanvas.grabbing { cursor: grabbing; }
        #text-input-overlay {
            position: absolute; display: none; background: rgba(44, 62, 80, 0.95); border: 2px solid var(--info-color);
            border-radius: 8px; padding: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 100; transform-origin: top right;
            min-width: 200px; max-width: 90%;
        }
        #text-input-field {
            width: auto; min-width: 150px; max-width: 100%; border: none; outline: none; font-size: 24px;
            font-family: inherit; background: transparent; color: white; text-align: right; resize: none;
            min-height: 40px; max-height: 250px; overflow-y: auto; padding: 8px;
        }
        #text-input-buttons { display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px; }
        #text-input-buttons button {
            padding: 5px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-family: 'Tajawal', sans-serif;
        }
        #confirm-text-btn { background-color: var(--success-color); color: white; }
        #cancel-text-btn { background-color: var(--secondary-color); color: white; }
        #loading-indicator {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.85);
            color: white; padding: 20px 30px; border-radius: 12px; font-size: 1.2rem; display: none; z-index: 100;
        }
        #toolbar {
            flex-basis: 340px; min-width: 320px; background-color: var(--toolbar-bg); padding: 1rem; border-radius: 12px;
            box-shadow: 0 6px 18px var(--shadow-color); display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem;
            color: var(--toolbar-text); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto;
        }
        .tool-group { display: flex; flex-direction: column; gap: 0.5rem; position: relative; }
        .tool-group.full-width { grid-column: 1 / -1; }
        .tool-group label { font-size: 0.85rem; color: var(--toolbar-text); margin-bottom: 0.2rem; white-space: nowrap; font-family: 'Tajawal', sans-serif; }
        .input-spinner { display: flex; align-items: center; width: 100%; border: 1px solid #3d5166; border-radius: 8px; overflow: hidden; }
        .input-spinner input[type="number"] {
            flex-grow: 1; padding: 0.5rem; border: none; font-size: 0.95rem; text-align: center;
            background-color: #2c3e50; color: var(--toolbar-text); -moz-appearance: textfield; appearance: textfield;
        }
        .input-spinner input::-webkit-outer-spin-button, .input-spinner input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-spinner button {
            background-color: #3d5166; border: none; color: var(--toolbar-text); padding: 0 0.6rem; cursor: pointer; font-size: 1.1rem; align-self: stretch;
        }
        .input-spinner button:hover:not(:disabled) { background-color: var(--toolbar-hover); }
        .input-spinner button:disabled { opacity: 0.5; cursor: not-allowed; }
        #toolbar select, #toolbar input[type="color"], #toolbar input[type="range"] {
            width: 100%; padding: 0.5rem; border: 1px solid #3d5166; border-radius: 8px; font-size: 0.95rem;
            background-color: #2c3e50; color: var(--toolbar-text);
        }
        #toolbar input[type="color"] { padding: 0.2rem; height: 36px; cursor: pointer; }
        .style-buttons, #image-controls { display: flex; gap: 0.6rem; grid-column: 1 / -1; flex-wrap: wrap; justify-content: flex-start; }
        .style-button {
            padding: 0.6rem 0.8rem; border: 1px solid #3d5166; background-color: #34495e; border-radius: 8px; cursor: pointer;
            font-size: 0.95rem; font-weight: bold; min-width: 40px; color: var(--toolbar-text); display: flex; align-items: center; justify-content: center;
        }
        .style-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .style-button:hover:not(:disabled) { background-color: var(--toolbar-hover); }
        .style-button.active { background-color: var(--toolbar-active); color: white; }
        #deleteTextBtn { background-color: var(--danger-color); color: white; border: none; margin-right: auto; }
        .image-control-button {
            padding: 0.5rem 0.8rem; border: 1px solid #3d5166; background-color: #34495e; border-radius: 8px;
            cursor: pointer; font-size: 0.9rem; color: var(--toolbar-text); display: flex; align-items: center; gap: 0.3rem;
        }
        .image-control-button:hover { background-color: var(--toolbar-hover); }
        .image-control-button.delete { background-color: var(--danger-color); color: white; }
        #zoom-controls { position: fixed; bottom: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .zoom-button {
            width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color); color: white;
            display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #action-buttons { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 1400px; margin: 1.5rem auto 0 auto; }
        .action-button {
            padding: 0.8rem 1.5rem; border: none; border-radius: 8px; background-color: var(--primary-color); color: white;
            font-size: 1rem; font-weight: 600; cursor: pointer; flex-grow: 1; min-width: 150px;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .action-button:disabled { opacity: 0.6; cursor: not-allowed; background-color: var(--secondary-color); }
        .toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 9999; }
        .toast {
            background: white; border-left: 5px solid; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px 20px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;
            opacity: 0; transform: translateX(-100%); transition: all 0.4s ease-in-out;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        
        /* تحسينات للهاتف */
        @media (max-width: 1024px) {
            #editor-main-area { flex-direction: column; }
            #toolbar { width: 100%; max-width: var(--a4-width-px); position: static; max-height: none; overflow-y: visible; }
            #canvas-container { width: 100%; max-width: var(--a4-width-px); margin: 0 auto; }
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            #image-gallery { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
            .gallery-item img { height: 80px; }
            #large-upload-button { padding: 1.2rem; font-size: 1.1rem; min-height: 100px; }
            #toolbar { min-width: unset; grid-template-columns: 1fr; }
            .tool-group.full-width { grid-column: 1; }
            .style-buttons, #image-controls { justify-content: center; }
            #action-buttons { flex-direction: column; }
            .action-button { width: 100%; }
            #zoom-controls { bottom: 10px; left: 10px; }
            .zoom-button { width: 36px; height: 36px; font-size: 16px; }
            #text-input-overlay { max-width: 95%; }
        }
        
        @media (max-width: 480px) {
            body { padding: 0.5rem; }
            #image-selection-area { padding: 1rem; }
            #image-gallery { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.8rem; }
            .gallery-item img { height: 70px; }
            .gallery-item button { font-size: 0.8rem; padding: 0.4rem 0.6rem; }
            #large-upload-button { font-size: 1rem; padding: 1rem; }
            #toolbar { padding: 0.8rem; gap: 0.8rem; }
            .input-spinner input[type="number"] { padding: 0.4rem; }
            .style-button, .image-control-button { padding: 0.5rem 0.6rem; font-size: 0.85rem; }
        }
        
        /* تحسينات لوضعية الهاتف الأفقي */
        @media (max-height: 500px) and (orientation: landscape) {
            #editor-main-area { flex-direction: row; }
            #toolbar { max-height: 80vh; overflow-y: auto; }
        }
        
        /* تحسينات خاصة للعناصر المحددة */
        .text-element.selected { outline: 2px dashed rgba(0, 123, 255, 0.7); }
        .image-element.selected { outline: 2px dashed rgba(0, 123, 255, 0.7); }
        
        /* تحسينات لواجهة اللمس */
        .touch-optimized {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
    </style>
</head>
<body>
    <button onclick="window.location.href='index.html'" style="all: unset; position: fixed; top: 10px; left: 20px; font-size: 30px; color: #b7b63c; text-shadow: 1px 1px 1px #52484a; cursor: pointer; z-index: 9999;">
        <i class="fas fa-home"></i> 
    </button>
    <h1>محرر الصور والنصوص التفاعلي</h1>

    <div id="image-selection-area">
        <h2>اختر صورة للبدء</h2>
        <div id="image-gallery">
            <div class="gallery-item"><img src="images/bbr123.png" data-src="images/bbr123.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbraa.png" data-src="images/bbraa.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrdd.png" data-src="images/bbrdd.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrff.png" data-src="images/bbrff.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrgg.png" data-src="images/bbrgg.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrhh.png" data-src="images/bbrhh.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrjj.png" data-src="images/bbrjj.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrss.png" data-src="images/bbrss.png"><button>استخدام</button></div>
        </div>
        <div id="upload-section">
            <input type="file" id="imageLoader" accept="image/*"/>
            <label for="imageLoader" id="large-upload-button">
                <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg" style="width: 48px; height: 48px; margin-bottom: 0.8rem;"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
                <span>اختر صورة من جهازك</span>
            </label>
        </div>
    </div>

    <div id="editor-screen">
        <div id="editor-main-area">
            <div id="canvas-container">
                <canvas id="imageCanvas"></canvas>
                <div id="text-input-overlay">
                    <textarea id="text-input-field" placeholder="اكتب النص هنا"></textarea>
                    <div id="text-input-buttons">
                        <button id="cancel-text-btn">إلغاء</button>
                        <button id="confirm-text-btn">تأكيد</button>
                    </div>
                </div>
                <div id="loading-indicator"></div>
            </div>
            <div id="toolbar">
                <div class="tool-group"><label for="fontSize">الحجم:</label><div class="input-spinner"><button class="spinner-btn decrease" data-target="fontSize">-</button><input type="number" id="fontSize" value="48" min="8" max="500"><button class="spinner-btn increase" data-target="fontSize">+</button></div></div>
                <div class="tool-group"><label for="fontColor">لون الخط:</label><input type="color" id="fontColor" value="#000000"></div>
                <div class="tool-group"><label for="strokeColor">لون الحد:</label><input type="color" id="strokeColor" value="#ffffff"></div>
                <div class="tool-group"><label for="strokeWidth">عرض الحد:</label><div class="input-spinner"><button class="spinner-btn decrease" data-target="strokeWidth">-</button><input type="number" id="strokeWidth" value="0" min="0" max="50"><button class="spinner-btn increase" data-target="strokeWidth">+</button></div></div>
                <div class="tool-group"><label for="bgColor">لون الخلفية:</label><input type="color" id="bgColor" value="#ffffff"></div>
                <div class="tool-group"><label for="bgOpacity">شفافية الخلفية:</label><input type="range" id="bgOpacity" min="0" max="1" step="0.1" value="0"></div>
                <div class="tool-group full-width"><label for="fontFamily">نوع الخط:</label><select id="fontFamily"><option value="'Cairo', sans-serif">Cairo</option><option value="'Noto Kufi Arabic', sans-serif">Noto Kufi Arabic</option><option value="'Reem Kufi', sans-serif">Reem Kufi</option><option value="'Aref Ruqaa', serif">Aref Ruqaa</option><option value="'Amiri', serif">Amiri</option><option value="'Tajawal', sans-serif">Tajawal</option><option value="'Changa', sans-serif">Changa</option></select></div>
                <div class="tool-group"><label for="textOpacity">شفافية النص:</label><input type="range" id="textOpacity" min="0" max="1" step="0.05" value="1"></div>
                <div class="tool-group"><label for="letterSpacing">تباعد الأحرف:</label><div class="input-spinner"><button class="spinner-btn decrease" data-target="letterSpacing">-</button><input type="number" id="letterSpacing" value="0" min="-10" max="50" step="1"><button class="spinner-btn increase" data-target="letterSpacing">+</button></div></div>
                <div class="tool-group"><label for="textRotation">الدوران:</label><div class="input-spinner"><button class="spinner-btn decrease" data-target="textRotation">-</button><input type="number" id="textRotation" value="0" min="-180" max="180" step="5"><button class="spinner-btn increase" data-target="textRotation">+</button></div></div>
                <div class="tool-group"><label for="lineHeight">تباعد الأسطر:</label><div class="input-spinner"><button class="spinner-btn decrease" data-target="lineHeight">-</button><input type="number" id="lineHeight" value="1.2" min="0.8" max="3" step="0.1"><button class="spinner-btn increase" data-target="lineHeight">+</button></div></div>
                <div class="style-buttons"><button class="style-button" id="boldBtn"><b>B</b></button><button class="style-button" id="italicBtn"><i>I</i></button><button class="style-button" id="underlineBtn"><u>U</u></button><button class="style-button" id="shadowBtn">ظل</button><button class="style-button" id="copyTextBtn">نسخ</button><button class="style-button" id="pasteTextBtn">لصق</button><button class="style-button" id="deleteTextBtn"><i class="fas fa-trash"></i></button></div>
                <div id="image-controls"><button class="image-control-button" id="addImageBtn"><i class="fas fa-plus"></i> إضافة صورة</button><button class="image-control-button" id="scaleUpBtn"><i class="fas fa-search-plus"></i></button><button class="image-control-button" id="scaleDownBtn"><i class="fas fa-search-minus"></i></button><button class="image-control-button delete" id="deleteImageBtn"><i class="fas fa-trash"></i></button></div>
            </div>
        </div>
        <div id="action-buttons">
            <button id="saveBtn" class="action-button"><i class="fas fa-save"></i> حفظ (PNG)</button>
            <button id="pdfBtn" class="action-button"><i class="fas fa-file-pdf"></i> تصدير PDF</button>
            <button id="printBtn" class="action-button"><i class="fas fa-print"></i> طباعة</button>
            <button id="resetBtn" class="action-button"><i class="fas fa-sync-alt"></i> اختيار صورة أخرى</button>
        </div>
    </div>
    <div id="zoom-controls">
        <div class="zoom-button" id="zoomInBtn"><i class="fas fa-plus"></i></div>
        <div class="zoom-button" id="zoomOutBtn"><i class="fas fa-minus"></i></div>
        <div class="zoom-button" id="resetZoomBtn"><i class="fas fa-sync-alt"></i></div>
    </div>
    <div class="toast-container"></div>

    <script>
    (function() {
        'use strict';
        const imageSelectionArea = document.getElementById('image-selection-area');
        const editorScreen = document.getElementById('editor-screen');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const toolbar = document.getElementById('toolbar');
        const textInputOverlay = document.getElementById('text-input-overlay');
        const textInputField = document.getElementById('text-input-field');

        let currentImage = null, originalImageWidth = 0, originalImageHeight = 0;
        let textObjects = [], overlayImages = [];
        let selectedTextIndex = -1, selectedImageIndex = -1;
        let isDragging = false, dragStartX = 0, dragStartY = 0, didMove = false;
        let copiedTextObject = null;
        let canvasScale = 1, canvasOffsetX = 0, canvasOffsetY = 0;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        function setupEventListeners() {
            document.getElementById('image-gallery').addEventListener('click', (e) => {
                const item = e.target.closest('.gallery-item');
                if (item) loadImage(item.querySelector('img').dataset.src);
            });
            document.getElementById('imageLoader').addEventListener('change', handleImageUpload);
            setupCanvasListeners();
            toolbar.addEventListener('input', handleToolbarInteraction);
            toolbar.addEventListener('click', (e) => {
                if (e.target.closest('.style-button, .spinner-btn, .image-control-button')) {
                    handleToolbarInteraction(e);
                }
            });
            document.getElementById('confirm-text-btn').addEventListener('click', confirmTextInput);
            document.getElementById('cancel-text-btn').addEventListener('click', cancelTextInput);
            textInputField.addEventListener('input', autoResizeTextarea);
            document.getElementById('saveBtn').addEventListener('click', () => withLoading(document.getElementById('saveBtn'), saveImage));
            document.getElementById('pdfBtn').addEventListener('click', () => withLoading(document.getElementById('pdfBtn'), exportToPDF));
            document.getElementById('printBtn').addEventListener('click', () => withLoading(document.getElementById('printBtn'), printCanvas));
            document.getElementById('resetBtn').addEventListener('click', resetEditor);
            document.getElementById('zoomInBtn').addEventListener('click', () => adjustCanvasZoom(0.1));
            document.getElementById('zoomOutBtn').addEventListener('click', () => adjustCanvasZoom(-0.1));
            document.getElementById('resetZoomBtn').addEventListener('click', resetCanvasZoom);
            
            // تحسينات للهاتف: إضافة event listeners لللمس
            if (isMobile) {
                document.querySelectorAll('button, .gallery-item, .style-button, .image-control-button, .action-button, .zoom-button').forEach(el => {
                    el.classList.add('touch-optimized');
                });
            }
        }

        function autoResizeTextarea() {
            textInputField.style.height = 'auto';
            textInputField.style.height = (textInputField.scrollHeight) + 'px';
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => loadImage(event.target.result);
                reader.readAsDataURL(file);
                showLoading(true, "جارٍ تحميل الملف...");
            }
            e.target.value = null;
        }

        function setupCanvasListeners() {
            const getEventCoords = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                return { 
                    x: (clientX - rect.left) * (canvas.width / rect.width), 
                    y: (clientY - rect.top) * (canvas.height / rect.height) 
                };
            };

            const handleStart = (e) => {
                if (!currentImage) return;
                e.preventDefault();
                const coords = getEventCoords(e);
                dragStartX = coords.x; 
                dragStartY = coords.y;
                didMove = false;
                
                const textIndex = findTextIndexAt(coords.x, coords.y);
                const imageIndex = findImageIndexAt(coords.x, coords.y);

                if (textIndex !== -1) {
                    selectText(textIndex);
                    isDragging = true;
                    // على الهاتف، لا نفتح محرر النص مباشرة بل ننتظر النقر مرة أخرى
                    if (!isMobile) {
                        editSelectedText();
                    }
                } else if (imageIndex !== -1) {
                    selectImage(imageIndex);
                    isDragging = true;
                } else {
                    deselectAll();
                }
                drawCanvas();
            };

            const handleMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                didMove = true;
                const coords = getEventCoords(e);
                const dx = coords.x - dragStartX; 
                const dy = coords.y - dragStartY;
                if (selectedTextIndex !== -1) {
                    textObjects[selectedTextIndex].x += dx;
                    textObjects[selectedTextIndex].y += dy;
                } else if (selectedImageIndex !== -1) {
                    overlayImages[selectedImageIndex].x += dx;
                    overlayImages[selectedImageIndex].y += dy;
                }
                dragStartX = coords.x; 
                dragStartY = coords.y;
                requestAnimationFrame(drawCanvas);
            };

            const handleEnd = (e) => { 
                isDragging = false; 
                
                // على الهاتف، نفتح محرر النص عند النقر (وليس السحب)
                if (isMobile && selectedTextIndex !== -1 && !didMove) {
                    const coords = getEventCoords(e);
                    const textIndex = findTextIndexAt(coords.x, coords.y);
                    if (textIndex === selectedTextIndex) {
                        editSelectedText();
                    }
                }
            };

            const handleDoubleClick = (e) => {
                if(didMove) return;
                const coords = getEventCoords(e);
                const textIndex = findTextIndexAt(coords.x, coords.y);
                if (textIndex !== -1) {
                    editSelectedText();
                } else if (findImageIndexAt(coords.x, coords.y) === -1) {
                    addNewText(coords.x, coords.y);
                }
            };

            // إضافة event listeners لللمس والفأرة
            canvas.addEventListener('mousedown', handleStart);
            canvas.addEventListener('mousemove', handleMove);
            canvas.addEventListener('mouseup', handleEnd);
            canvas.addEventListener('mouseleave', handleEnd);
            canvas.addEventListener('dblclick', handleDoubleClick);
            
            // تحسينات لأحداث اللمس
            canvas.addEventListener('touchstart', handleStart, { passive: false });
            canvas.addEventListener('touchmove', handleMove, { passive: false });
            canvas.addEventListener('touchend', handleEnd);
            canvas.addEventListener('touchcancel', handleEnd);
        }
        
        function loadImage(src) {
            showLoading(true, "جارٍ تحميل الصورة...");
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => {
                currentImage = img;
                originalImageWidth = img.width; 
                originalImageHeight = img.height;
                canvas.width = originalImageWidth; 
                canvas.height = originalImageHeight;
                resetEditorState();
                drawCanvas();
                imageSelectionArea.style.display = 'none';
                editorScreen.style.display = 'flex';
                showLoading(false);
                enableActionButtons();
            };
            img.onerror = () => { 
                showLoading(false); 
                showToast("خطأ في تحميل الصورة.", 'error'); 
            };
            img.src = src;
        }

        function drawCanvas() {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvasOffsetX, canvasOffsetY);
            ctx.scale(canvasScale, canvasScale);
            if (currentImage) ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            overlayImages.forEach((imgObj, index) => drawSingleImage(imgObj, index === selectedImageIndex));
            textObjects.forEach((textObj, index) => drawSingleText(textObj, index === selectedTextIndex));
            ctx.restore();
        }

        function drawSingleText(textObj, isSelected) {
            ctx.save();
            ctx.globalAlpha = textObj.opacity;
            const font = `${textObj.italic ? 'italic' : 'normal'} ${textObj.bold ? 'bold' : 'normal'} ${textObj.fontSize}px ${textObj.fontFamily}`;
            ctx.font = font;
            ctx.textAlign = 'right'; 
            ctx.textBaseline = 'top';
            if ('letterSpacing' in ctx) ctx.letterSpacing = `${textObj.letterSpacing || 0}px`;

            const lines = textObj.text.split('\n');
            const lineHeight = textObj.fontSize * (textObj.lineHeight || 1.2);
            let maxWidth = 0;
            lines.forEach(line => {
                const metrics = ctx.measureText(line);
                if (metrics.width > maxWidth) maxWidth = metrics.width;
            });
            const totalHeight = (lines.length * lineHeight) - (lineHeight - textObj.fontSize) * (lines.length > 0 ? 1 : 0);
            
            textObj.bounds = { 
                x1: textObj.x - maxWidth - 5, 
                y1: textObj.y - 5, 
                width: maxWidth + 10, 
                height: totalHeight + 10 
            };

            if (textObj.rotation) {
                const centerX = textObj.x - maxWidth / 2; 
                const centerY = textObj.y + totalHeight / 2;
                ctx.translate(centerX, centerY);
                ctx.rotate(textObj.rotation * Math.PI / 180);
                ctx.translate(-centerX, -centerY);
            }
            
            if (textObj.bgOpacity > 0) {
                ctx.fillStyle = textObj.bgColor;
                ctx.globalAlpha = textObj.bgOpacity * textObj.opacity;
                ctx.fillRect(textObj.bounds.x1 + 5, textObj.bounds.y1 + 5, textObj.bounds.width - 10, textObj.bounds.height - 10);
                ctx.globalAlpha = textObj.opacity;
            }
            
            if (textObj.shadow) { 
                ctx.shadowColor = 'rgba(0,0,0,0.6)'; 
                ctx.shadowBlur = 7; 
                ctx.shadowOffsetX = 3; 
                ctx.shadowOffsetY = 3; 
            }
            
            lines.forEach((line, i) => {
                const yPos = textObj.y + (i * lineHeight);
                if (textObj.strokeWidth > 0) {
                    ctx.strokeStyle = textObj.strokeColor;
                    ctx.lineWidth = textObj.strokeWidth;
                    ctx.strokeText(line, textObj.x, yPos);
                }
                ctx.fillStyle = textObj.color;
                ctx.fillText(line, textObj.x, yPos);
            });
            
            if (isSelected) {
                ctx.strokeStyle = 'rgba(0, 123, 255, 0.9)'; 
                ctx.lineWidth = 2; 
                ctx.setLineDash([6, 4]);
                ctx.strokeRect(textObj.bounds.x1, textObj.bounds.y1, textObj.bounds.width, textObj.bounds.height);
            }
            ctx.restore();
        }
        
        function drawSingleImage(imgObj, isSelected) {
            ctx.save();
            ctx.drawImage(imgObj.image, imgObj.x - imgObj.width/2, imgObj.y - imgObj.height/2, imgObj.width, imgObj.height);
            if (isSelected) {
                ctx.strokeStyle = 'rgba(0, 123, 255, 0.9)'; 
                ctx.lineWidth = 2;
                ctx.strokeRect(imgObj.x - imgObj.width/2, imgObj.y - imgObj.height/2, imgObj.width, imgObj.height);
            }
            ctx.restore();
            imgObj.bounds = { 
                x1: imgObj.x - imgObj.width/2, 
                y1: imgObj.y - imgObj.height/2, 
                width: imgObj.width, 
                height: imgObj.height 
            };
        }

        function findTextIndexAt(x, y) {
            for (let i = textObjects.length - 1; i >= 0; i--) {
                const b = textObjects[i].bounds;
                if (b && x >= b.x1 && x <= b.x1 + b.width && y >= b.y1 && y <= b.y1 + b.height) return i;
            }
            return -1;
        }
        
        function findImageIndexAt(x, y) {
            for (let i = overlayImages.length - 1; i >= 0; i--) {
                const b = overlayImages[i].bounds;
                if (b && x >= b.x1 && x <= b.x1 + b.width && y >= b.y1 && y <= b.y1 + b.height) return i;
            }
            return -1;
        }

        function addNewText(x, y) {
            const newTextObj = {
                text: "نص جديد", 
                x, 
                y, 
                fontSize: 48, 
                fontFamily: "'Cairo', sans-serif", 
                color: "#000000",
                bold: false, 
                italic: false, 
                underline: false, 
                shadow: false, 
                strokeWidth: 0, 
                bgOpacity: 0, 
                opacity: 1,
                letterSpacing: 0, 
                rotation: 0, 
                lineHeight: 1.2, 
                strokeColor: '#ffffff', 
                bgColor: '#ffffff'
            };
            textObjects.push(newTextObj);
            selectText(textObjects.length - 1);
            drawCanvas(); // رسم أولي لحساب الأبعاد
            editSelectedText();
        }
        
        function editSelectedText() {
            if (selectedTextIndex === -1) return;
            const textObj = textObjects[selectedTextIndex];
            
            // حساب موضع مربع النص بالنسبة للشاشة
            const rect = canvas.getBoundingClientRect();
            const scaleX = rect.width / canvas.width;
            const scaleY = rect.height / canvas.height;
            
            // حساب أبعاد النص
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.font = `${textObj.fontSize}px ${textObj.fontFamily}`;
            const lines = textObj.text.split('\n');
            const lineHeight = textObj.fontSize * (textObj.lineHeight || 1.2);
            let maxWidth = 0;
            lines.forEach(line => {
                const metrics = tempCtx.measureText(line);
                if (metrics.width > maxWidth) maxWidth = metrics.width;
            });
            const totalHeight = (lines.length * lineHeight) - (lineHeight - textObj.fontSize);
            
            // وضع مربع النص فوق النص مباشرة
            const displayX = (textObj.x / canvas.width) * rect.width;
            const displayY = (textObj.y / canvas.height) * rect.height;
            
            textInputOverlay.style.display = 'block';
            textInputOverlay.style.right = `${rect.width - displayX}px`;
            textInputOverlay.style.top = `${displayY}px`;
            textInputOverlay.style.minWidth = `${Math.min(maxWidth * scaleX + 30, rect.width * 0.8)}px`;
            
            textInputField.value = textObj.text;
            textInputField.style.font = `${textObj.fontSize * scaleX}px ${textObj.fontFamily}`;
            textInputField.style.color = textObj.color;
            textInputField.style.minHeight = `${totalHeight * scaleY}px`;
            autoResizeTextarea();
            textInputField.focus();
            
            // إضافة event listener لإخفاء الأدوات عند الضغط خارج النص
            setTimeout(() => {
                document.addEventListener('click', handleClickOutsideText);
            }, 0);
        }
        
        function handleClickOutsideText(e) {
            if (!textInputOverlay.contains(e.target) && e.target !== textInputField) {
                confirmTextInput();
                document.removeEventListener('click', handleClickOutsideText);
            }
        }

        function confirmTextInput() {
            if (selectedTextIndex !== -1) {
                const text = textInputField.value;
                if (text.trim() === "") {
                    textObjects.splice(selectedTextIndex, 1);
                    deselectAll();
                } else {
                    textObjects[selectedTextIndex].text = text;
                }
                drawCanvas();
            }
            textInputOverlay.style.display = 'none';
            document.removeEventListener('click', handleClickOutsideText);
        }

        function cancelTextInput() {
            if (selectedTextIndex !== -1 && textObjects[selectedTextIndex].text === "نص جديد") {
                textObjects.splice(selectedTextIndex, 1);
                deselectAll();
                drawCanvas();
            }
            textInputOverlay.style.display = 'none';
            document.removeEventListener('click', handleClickOutsideText);
        }

        function handleToolbarInteraction(e) {
            const target = e.target.closest('input, select, button');
            if (!target || target.disabled) return;
            const id = target.id;
            
            if (target.closest('.spinner-btn')) {
                const input = document.getElementById(target.dataset.target);
                const step = parseFloat(input.step) || 1;
                input.value = parseFloat(input.value) + (target.classList.contains('increase') ? step : -step);
                input.dispatchEvent(new Event('input', { bubbles: true })); 
                return;
            }

            if (selectedTextIndex !== -1) {
                const obj = textObjects[selectedTextIndex];
                if (id === 'deleteTextBtn') { 
                    textObjects.splice(selectedTextIndex, 1); 
                    deselectAll(); 
                }
                else if (id === 'copyTextBtn') { 
                    copiedTextObject = JSON.parse(JSON.stringify(obj)); 
                    document.getElementById('pasteTextBtn').disabled = false; 
                    showToast("تم نسخ النص!", 'info'); 
                }
                else if (id === 'pasteTextBtn' && copiedTextObject) { 
                    const newObj = { ...copiedTextObject, x: copiedTextObject.x + 20, y: copiedTextObject.y + 20 }; 
                    textObjects.push(newObj); 
                    selectText(textObjects.length - 1); 
                }
                else if (target.classList.contains('style-button')) { 
                    target.classList.toggle('active'); 
                    obj[id.replace('Btn', '')] = target.classList.contains('active'); 
                }
                else { 
                    const prop = target.id; 
                    obj[prop] = (target.type.match(/number|range/)) ? parseFloat(target.value) : target.value; 
                }
            } else if (selectedImageIndex !== -1) {
                const img = overlayImages[selectedImageIndex];
                if (id === 'scaleUpBtn') { 
                    img.width *= 1.1; 
                    img.height *= 1.1; 
                }
                else if (id === 'scaleDownBtn') { 
                    img.width *= 0.9; 
                    img.height *= 0.9; 
                }
                else if (id === 'deleteImageBtn') { 
                    overlayImages.splice(selectedImageIndex, 1); 
                    deselectAll(); 
                }
            }
            
            if (id === 'addImageBtn') {
                const input = document.createElement('input');
                input.type = 'file'; 
                input.accept = 'image/*';
                input.onchange = e => {
                    const reader = new FileReader();
                    reader.onload = event => {
                        const img = new Image();
                        img.onload = () => { 
                            overlayImages.push({ 
                                image: img, 
                                x: canvas.width / 2, 
                                y: canvas.height / 2, 
                                width: img.width * 0.3, 
                                height: img.height * 0.3 
                            }); 
                            selectImage(overlayImages.length - 1); 
                            drawCanvas(); 
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                };
                input.click();
            }
            drawCanvas();
        }
        
        async function withLoading(button, asyncFunc) {
            const originalContent = button.innerHTML;
            button.disabled = true; 
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جارٍ العمل...`;
            try { 
                await asyncFunc(); 
            }
            catch (error) { 
                console.error(error); 
                showToast(`حدث خطأ: ${error.message}`, 'error'); 
            }
            finally { 
                button.disabled = false; 
                button.innerHTML = originalContent; 
            }
        }

        async function saveImage() {
            const dataURL = prepareOutputCanvas().toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'edited-image.png'; 
            link.href = dataURL; 
            link.click();
            showToast('تم بدء تحميل الصورة!', 'success');
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: 'a4' });
            const imgData = prepareOutputCanvas().toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
            pdf.save('edited-image.pdf');
            showToast('تم تصدير PDF بنجاح!', 'success');
        }

        async function printCanvas() {
            const dataURL = prepareOutputCanvas().toDataURL('image/png');
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<html><head><title>طباعة</title><style>@page{size:A4 portrait;margin:0}body{margin:0}img{width:100%;height:100%}</style></head><body><img src="${dataURL}" onload="window.print();setTimeout(window.close, 100);"></body></html>`);
            printWindow.document.close();
        }

        function prepareOutputCanvas() {
            deselectAll(); 
            drawCanvas();
            const outputCanvas = document.createElement('canvas');
            outputCanvas.width = originalImageWidth; 
            outputCanvas.height = originalImageHeight;
            const outCtx = outputCanvas.getContext('2d');
            const scale = outputCanvas.width / canvas.width;
            outCtx.drawImage(currentImage, 0, 0, outputCanvas.width, outputCanvas.height);
            overlayImages.forEach(imgObj => {
                outCtx.drawImage(
                    imgObj.image, 
                    (imgObj.x - imgObj.width / 2) * scale, 
                    (imgObj.y - imgObj.height / 2) * scale, 
                    imgObj.width * scale, 
                    imgObj.height * scale
                );
            });
            textObjects.forEach(obj => {
                const scaledObj = JSON.parse(JSON.stringify(obj));
                scaledObj.x *= scale; 
                scaledObj.y *= scale;
                scaledObj.fontSize *= scale; 
                scaledObj.strokeWidth *= scale;
                drawSingleTextOnContext(outCtx, scaledObj);
            });
            return outputCanvas;
        }

        function drawSingleTextOnContext(targetContext, obj) {
            targetContext.save();
            targetContext.globalAlpha = obj.opacity;
            const font = `${obj.italic ? 'italic' : 'normal'} ${obj.bold ? 'bold' : 'normal'} ${obj.fontSize}px ${obj.fontFamily}`;
            targetContext.font = font;
            targetContext.textAlign = 'right'; 
            targetContext.textBaseline = 'top';
            if ('letterSpacing' in targetContext) targetContext.letterSpacing = `${obj.letterSpacing || 0}px`;

            const lines = obj.text.split('\n');
            const lineHeight = obj.fontSize * (obj.lineHeight || 1.2);
            let maxWidth = 0;
            lines.forEach(line => {
                const metrics = targetContext.measureText(line);
                if (metrics.width > maxWidth) maxWidth = metrics.width;
            });
            const totalHeight = (lines.length * lineHeight) - (lineHeight - obj.fontSize) * (lines.length > 0 ? 1 : 0);

            if (obj.rotation) {
                const centerX = obj.x - maxWidth / 2; 
                const centerY = obj.y + totalHeight / 2;
                targetContext.translate(centerX, centerY);
                targetContext.rotate(obj.rotation * Math.PI / 180);
                targetContext.translate(-centerX, -centerY);
            }
            
            if (obj.bgOpacity > 0) {
                targetContext.fillStyle = obj.bgColor;
                targetContext.globalAlpha = obj.bgOpacity * obj.opacity;
                targetContext.fillRect(obj.x - maxWidth, obj.y, maxWidth, totalHeight);
                targetContext.globalAlpha = obj.opacity;
            }
            
            if (obj.shadow) { 
                targetContext.shadowColor = 'rgba(0,0,0,0.6)'; 
                targetContext.shadowBlur = 7; 
                targetContext.shadowOffsetX = 3; 
                targetContext.shadowOffsetY = 3; 
            }

            lines.forEach((line, i) => {
                const yPos = obj.y + (i * lineHeight);
                if (obj.strokeWidth > 0) {
                    targetContext.strokeStyle = obj.strokeColor;
                    targetContext.lineWidth = obj.strokeWidth;
                    targetContext.strokeText(line, obj.x, yPos);
                }
                targetContext.fillStyle = obj.color;
                targetContext.fillText(line, obj.x, yPos);
            });
            targetContext.restore();
        }

        // --- Helper Functions ---
        function selectText(index) { 
            selectedTextIndex = index; 
            selectedImageIndex = -1; 
            updateToolbarForSelection(); 
            updateImageControls(); 
        }
        
        function selectImage(index) { 
            selectedImageIndex = index; 
            selectedTextIndex = -1; 
            updateImageControls(); 
            disableTextToolbar(); 
        }
        
        function deselectAll() { 
            selectedTextIndex = -1; 
            selectedImageIndex = -1; 
            disableTextToolbar(); 
            updateImageControls(); 
        }
        
        function resetEditorState() { 
            textObjects = []; 
            overlayImages = []; 
            deselectAll(); 
            resetCanvasZoom(); 
        }
        
        function resetEditor() { 
            currentImage = null; 
            resetEditorState(); 
            drawCanvas(); 
            imageSelectionArea.style.display = 'flex'; 
            editorScreen.style.display = 'none'; 
            disableActionButtons(); 
        }
        
        function disableTextToolbar() { 
            toolbar.querySelectorAll('input, select, button:not(#addImageBtn):not([class*="image-control-button"])').forEach(el => { 
                el.disabled = true; 
                if (el.classList.contains('active')) el.classList.remove('active'); 
            }); 
        }
        
        function updateToolbarForSelection() {
            disableTextToolbar();
            if (selectedTextIndex === -1) return;
            toolbar.querySelectorAll('input, select, button:not([class*="image-control-button"])').forEach(el => el.disabled = false);
            const obj = textObjects[selectedTextIndex];
            for (const key in obj) {
                const el = document.getElementById(key) || document.getElementById(key + 'Btn');
                if (el) {
                    if (el.classList.contains('style-button')) {
                        el.classList.toggle('active', !!obj[key]);
                    } else {
                        el.value = obj[key];
                    }
                }
            }
        }
        
        function updateImageControls() { 
            ['scaleUpBtn', 'scaleDownBtn', 'deleteImageBtn'].forEach(id => {
                document.getElementById(id).disabled = selectedImageIndex === -1;
            }); 
        }
        
        function disableActionButtons() { 
            ['saveBtn', 'pdfBtn', 'printBtn'].forEach(id => {
                document.getElementById(id).disabled = true;
            }); 
        }
        
        function enableActionButtons() { 
            ['saveBtn', 'pdfBtn', 'printBtn'].forEach(id => {
                document.getElementById(id).disabled = false;
            }); 
        }
        
        function showLoading(show, msg = "...") { 
            const el = document.getElementById('loading-indicator'); 
            el.textContent = msg; 
            el.style.display = show ? 'block' : 'none'; 
        }
        
        function adjustCanvasZoom(delta) { 
            canvasScale = Math.max(0.1, Math.min(5, canvasScale + delta)); 
            drawCanvas(); 
        }
        
        function resetCanvasZoom() { 
            canvasScale = 1; 
            canvasOffsetX = 0; 
            canvasOffsetY = 0; 
            drawCanvas(); 
        }
        
        function showToast(message, type = 'info') {
            const container = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast`;
            toast.style.borderLeftColor = `var(--${type}-color)`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        // Initialize
        setupEventListeners();
        disableActionButtons();
        disableTextToolbar();
        updateImageControls();
    })();
    </script>
</body>
</html>