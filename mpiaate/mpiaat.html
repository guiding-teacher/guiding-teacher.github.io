
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الأقساط المتقدم</title>
    <meta name="description" content=" برنامج ادارة المبيعات للمشتركين يستخدم للمحال التجارية والمحال الصغيرة لادارة عمليات البيع والحساب مجاني بالكامل .">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="icon" href="assets/favicon.ico" type="image/x-icon">
    
    <!-- Dexie.js Library for IndexedDB -->
    <script src="https://unpkg.com/dexie@3.2.5/dist/dexie.js"></script>
    
    <style>
        
/* --- خطوط وألوان أساسية --- */
/* @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap'); */ /* Removed for offline capability */

:root {
    --primary-color: #2980b9; /* أزرق */
    --secondary-color: #2c3e50; /* كحلي */
    --accent-color: #e67e22; /* برتقالي */
    --success-color: #27ae60; /* أخضر */
    --danger-color: #c0392b; /* أحمر */
    --warning-color: #f39c12; /* أصفر */
    --info-color: #3498db; /* أزرق سماوي - يمكن استخدامه للمعلومات */
    --light-color: #ecf0f1; /* رمادي فاتح جدا */
    --dark-color: #34495e; /* رمادي غامق */

    --text-color-light: #2c3e50;
    --text-color-dark: #ecf0f1;
    --bg-color-light: white;
    --bg-color-dark: #2c3e50; 
    --nav-bg-light: #f8f9fa;
    --nav-bg-dark: #34495e;
    --border-color: #bdc3c7;
    --table-header-bg: #3498db;
    --table-header-text: #ffffff;
    --table-row-hover: #e0e0e0;
    --modal-bg-light: #ffffff;
    --modal-bg-dark: #3a506b; 

    --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; /* Fallback fonts */
    --border-radius: 8px;
    --border-radius-sm: 4px; 
    --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    --transition-speed: 0.3s ease;
}

/* --- سمة المحيط Ocean Theme --- */
[data-theme="ocean"] {
    --primary-color: #1abc9c; /* تركواز */
    --secondary-color: #3498db; /* أزرق سماوي */
    --accent-color: #f1c40f; /* أصفر ذهبي */
    --bg-color-light: #e0f7fa; /* أزرق فاتح جداً */
    --bg-color-dark: #004d40; /* أخضر غامق */
    --text-color-light: #00796b;
    --text-color-dark: #b2dfdb;
    --nav-bg-light: #b2ebf2;
    --nav-bg-dark: #00796b;
    --table-header-bg: #26a69a;
    --modal-bg-light: #e0f7fa;
    --modal-bg-dark: #00695c;
}

/* --- السمة الفاتحة --- */
[data-theme="light"] {
    --bg-color-light: #fdfdfd;
    --nav-bg-light: #f0f2f5;
}

/* --- الوضع الداكن --- */
body.dark-mode, [data-theme="dark"] {
    --bg-color-light: var(--bg-color-dark);
    --text-color-light: var(--text-color-dark);
    --nav-bg-light: var(--nav-bg-dark);
    --secondary-color: #4a6fa5;
    --border-color: #4a4a4a;
    --table-row-hover: #3f51b530;
    --table-header-bg: #4a6fa5;
    --modal-bg-light: var(--modal-bg-dark);
}


/* --- أساسيات --- */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    font-family: var(--font-family); line-height: 1.6; background-color: var(--bg-color-light); color: var(--text-color-light);
    transition: background-color var(--transition-speed), color var(--transition-speed);
    display: flex; justify-content: center; padding-top: 15px; padding-bottom: 15px;
}
.app-container {
    width: 96%; max-width: 1400px; background-color: var(--bg-color-light); 
    border-radius: var(--border-radius); box-shadow: var(--box-shadow);
    overflow: hidden; display: flex; flex-direction: column; min-height: 95vh;
    border: 1px solid var(--border-color);
}

/* --- الهيدر --- */
.app-header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: var(--text-color-dark); padding: 12px 20px;
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 3px solid var(--accent-color);
}
.app-header h1 { font-size: 1.6em; margin: 0; display: flex; align-items: center; }
.app-header h1 i { margin-left: 10px; font-size: 1.1em; }
.header-right { display: flex; align-items: center; gap: 15px; }
.header-icon-btn {
    background: none; border: none; color: var(--text-color-dark);
    font-size: 1.5em; cursor: pointer; transition: transform var(--transition-speed), color var(--transition-speed);
}
.header-icon-btn:hover { transform: scale(1.15); color: var(--accent-color); }

/* --- شريط التنقل --- */
.app-nav {
    display: flex; background-color: var(--nav-bg-light); border-bottom: 1px solid var(--border-color);
    padding: 5px 0; justify-content: space-around; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.nav-btn {
    background-color: transparent; border: none; color: var(--text-color-light); padding: 10px 12px;
    cursor: pointer; font-size: 0.85em; font-weight: 500; transition: all var(--transition-speed);
    display: flex; flex-direction: column; align-items: center; gap: 4px; border-radius: var(--border-radius-sm);
    min-width: 80px; text-align: center;
}
.nav-btn i { font-size: 1.4em; }
.nav-btn:hover { background-color: color-mix(in srgb, var(--primary-color) 15%, transparent); color: var(--primary-color); }
.nav-btn.active { background-color: var(--primary-color); color: var(--text-color-dark); box-shadow: inset 0 -4px 0 var(--accent-color); }

/* --- المحتوى الرئيسي والأقسام --- */
.app-main { flex-grow: 1; padding: 20px 25px; }
.page-section { display: none; animation: fadeIn 0.4s ease-in-out; }
.page-section.active-section { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

.page-section h2, .page-section h3, .setting-item h4, .modal-content h3, .modal-content h4, .stat-card h3 {
    color: var(--primary-color); margin-bottom: 18px; border-bottom: 2px solid var(--accent-color);
    padding-bottom: 8px; display: flex; align-items: center; font-size: 1.4em;
}
.page-section h3 { font-size: 1.25em; margin-top: 30px; } 
.setting-item h4 { font-size: 1.15em; border-bottom-width: 1px; }
.modal-content h3 { font-size: 1.3em; }
.modal-content h4 { font-size: 1.1em; border-bottom-width: 1px; margin-top: 20px;}
.page-section h2 i, .page-section h3 i, .setting-item h4 i, .modal-content h3 i, .modal-content h4 i, .stat-card h3 i { margin-left: 10px; font-size: 0.9em; }

/* --- الأزرار --- */
.btn {
    padding: 9px 16px; border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.9em;
    font-weight: 500; transition: all var(--transition-speed); text-decoration: none; display: inline-flex;
    align-items: center; gap: 7px; box-shadow: 0 2px 4px rgba(0,0,0,0.07);
}
.btn i { font-size: 1.05em; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.btn:active { transform: translateY(0px); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.btn:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-primary { background-color: var(--primary-color); color: white; }
.btn-primary:hover:not(:disabled) { background-color: color-mix(in srgb, var(--primary-color) 85%, black); }
.btn-secondary { background-color: var(--secondary-color); color: white; }
.btn-secondary:hover:not(:disabled) { background-color: color-mix(in srgb, var(--secondary-color) 85%, black); }
.btn-success { background-color: var(--success-color); color: white; }
.btn-success:hover:not(:disabled) { background-color: color-mix(in srgb, var(--success-color) 85%, black); }
.btn-danger { background-color: var(--danger-color); color: white; }
.btn-danger:hover:not(:disabled) { background-color: color-mix(in srgb, var(--danger-color) 85%, black); }
.btn-info { background-color: var(--info-color); color: white; }
.btn-info:hover:not(:disabled) { background-color: color-mix(in srgb, var(--info-color) 85%, black); }
.btn-warning { background-color: var(--warning-color); color: white; }
.btn-warning:hover:not(:disabled) { background-color: color-mix(in srgb, var(--warning-color) 85%, black); }
.btn-sm { padding: 5px 10px; font-size: 0.8em; }
.btn-sm i { font-size: 0.95em; }
.btn-back { background-color: var(--dark-color); color: white; }
.actions-bar { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
.search-input {
    padding: 9px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm);
    font-family: var(--font-family); flex-grow: 1; min-width: 200px;
    background-color: var(--bg-color-light); color: var(--text-color-light);
}

/* --- [NEW] Contract switcher style --- */
#contractSwitcherContainer {
    padding: 10px; background-color: color-mix(in srgb, var(--secondary-color) 5%, transparent);
    border-radius: var(--border-radius); gap: 15px;
}
#contractSwitcherContainer h4 {
    color: var(--secondary-color); font-size: 1em; border: none; padding: 0; margin: 0;
}
body.dark-mode #contractSwitcherContainer h4 { color: var(--light-color); }
#contractSwitcherContainer .btn.btn-primary {
    transform: scale(1.05); /* Highlight active contract */
}

/* --- الجداول --- */
.table-responsive { overflow-x: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: var(--box-shadow); }
/* [MODIFIED] Add vertical scroll to main dashboard tables */
#dashboard-section .table-responsive {
    max-height: 400px; /* Adjust height as needed */
    overflow-y: auto;
}
table { width: 100%; border-collapse: collapse; font-size: 0.88em; }
th, td { padding: 10px 12px; text-align: right; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
thead tr { background-color: var(--table-header-bg); color: var(--table-header-text); font-weight: bold; }
thead th { border-bottom-width: 2px; position: sticky; top: 0; z-index: 10; background-color: var(--table-header-bg); }
tbody tr:nth-child(even) { background-color: color-mix(in srgb, var(--bg-color-light) 95%, #00000005); }
tbody tr:hover { background-color: var(--table-row-hover); }
td .btn { padding: 5px 8px; font-size: 0.8em; margin-left: 5px; box-shadow: none; }
td .btn:hover { box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.status-paid { color: var(--success-color); font-weight: bold; }
.status-unpaid { color: var(--danger-color); font-weight: bold; }
.status-pending { color: var(--warning-color); font-weight: bold; }

/* --- المودال (النافذة المنبثقة) --- */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.65); animation: fadeInModal 0.3s; }
@keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
.modal-content {
    background-color: var(--modal-bg-light); color: var(--text-color-light); margin: 5% auto;
    padding: 20px 30px; border: 1px solid var(--border-color); width: 90%; max-width: 650px;
    border-radius: var(--border-radius); box-shadow: 0 8px 25px rgba(0,0,0,0.15); position: relative;
    animation: slideInModal 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
}
@keyframes slideInModal { from { transform: translateY(-30px) scale(0.98); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
.close-btn { color: var(--text-color-light); position: absolute; left: 15px; top: 10px; font-size: 30px; font-weight: bold; cursor: pointer; line-height: 1; }
.close-btn:hover, .close-btn:focus { color: var(--danger-color); text-decoration: none; }

/* --- الحقول والنماذج --- */
.form-group { margin-bottom: 16px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--primary-color); font-size: 0.9em; }
.form-group input[type="text"], .form-group input[type="tel"], .form-group input[type="email"], .form-group input[type="number"], .form-group input[type="date"], .form-group textarea, .form-inline input[type="text"] {
    width: 100%; padding: 9px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); font-family: var(--font-family);
    font-size: 0.9em; background-color: color-mix(in srgb, var(--bg-color-light) 98%, #00000003); color: var(--text-color-light);
    transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
}
.form-group input:focus, .form-group textarea:focus, .form-inline input[type="text"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent); }
.form-group textarea { resize: vertical; min-height: 70px; }
hr { border: 0; height: 1px; background-image: linear-gradient(to right, rgba(0, 0, 0, 0), var(--border-color), rgba(0, 0, 0, 0)); margin: 25px 0; }
#calculatedNumberOfInstallments { font-weight: bold; color: var(--accent-color); font-size: 1.1em; margin-right: 5px; }

/* --- بطاقة المعلومات --- */
.info-card {
    background-color: color-mix(in srgb, var(--bg-color-light) 96%, #00000004); padding: 15px 20px;
    border-radius: var(--border-radius); margin-bottom: 20px; border-left: 5px solid var(--primary-color);
    box-shadow: 0 2px 5px rgba(0,0,0,0.03);
}
.info-card h4 { color: var(--primary-color); margin-bottom: 12px; font-size: 1.1em; padding-bottom: 6px; border-bottom: 1px solid color-mix(in srgb, var(--accent-color) 50%, transparent); }
.info-card p { margin-bottom: 8px; font-size: 0.95em; line-height: 1.7; }
.info-card p strong { color: var(--secondary-color); min-width: 150px; display: inline-block; font-weight: 500; }
body.dark-mode .info-card p strong, [data-theme="dark"] .info-card p strong, [data-theme="ocean"] .info-card p strong { color: var(--accent-color); }
#totalInstallmentsCountDisplay { font-weight: bold; color: var(--accent-color); }
#installmentsSummary { background-color: color-mix(in srgb, var(--accent-color) 15%, transparent); color: color-mix(in srgb, var(--accent-color) 80%, black); padding: 10px 15px; border-radius: var(--border-radius-sm); margin: -10px 0 20px 0; text-align: center; font-weight: 500; }

/* --- وصل القبض A4 --- */
.receipt-a4-wrapper {
    margin-top: 25px; padding: 15px; background-color: #e0e0e0;
    border: 1px solid #ccc; border-radius: var(--border-radius);
}
.receipt-a4-container {
    width: 210mm; min-height: 297mm; padding: 20mm; margin: 0 auto;
    background: white; color: #000; box-shadow: 0 0 15px rgba(0,0,0,0.2);
    display: flex; flex-direction: column; font-family: var(--font-family);
}
.receipt-a4-header {
    display: flex; justify-content: space-between; align-items: flex-start;
    border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px;
}
.receipt-a4-header .store-info h2 { font-size: 24pt; color: #111; margin: 0; }
.receipt-a4-header .receipt-logo { max-width: 150px; max-height: 80px; }
.receipt-a4-title { text-align: center; margin-bottom: 25px; }
.receipt-a4-title h1 {
    font-size: 20pt; font-weight: bold; text-decoration: underline;
    text-underline-offset: 8px; margin: 0;
}
.receipt-a4-details { display: flex; justify-content: space-between; margin-bottom: 25px; font-size: 11pt; }
.receipt-a4-details p { margin: 5px 0; }
.receipt-a4-details strong { font-weight: bold; }

.receipt-a4-body { margin-bottom: 30px; flex-grow: 1; }
.receipt-a4-body table { width: 100%; border-collapse: collapse; font-size: 11pt; }
.receipt-a4-body th, .receipt-a4-body td { border: 1px solid #999; padding: 10px; text-align: right; }
.receipt-a4-body th { background-color: #f2f2f2; font-weight: bold; }
.receipt-a4-body .summary-table td { font-weight: bold; }
.receipt-a4-body .summary-table .final-total { background-color: #e0e0e0; }

.receipt-a4-footer {
    display: flex; flex-direction: column; align-items: stretch;
    padding-top: 20px; border-top: 2px solid #333; font-size: 10pt;
    color: #333; margin-top: auto;
}
.receipt-signatures {
    display: flex; justify-content: space-around;
    width: 100%; margin-bottom: 30px;
}
.receipt-signatures .seller-signature, .receipt-signatures .buyer-signature {
    text-align: center;
}
.receipt-signatures p { margin-top: 40px; }
.receipt-contact-info {
    text-align: center; width: 100%; border-top: 1px dashed #aaa;
    padding-top: 10px; font-size: 9pt; display: flex;
    justify-content: center; align-items: center; flex-wrap: wrap; gap: 5px 15px;
}
.receipt-contact-info span { display: inline-flex; align-items: center; gap: 5px; }
.receipt-contact-info span:not(:last-child)::after {
    content: "|"; margin-right: 8px; color: #999;
}

.receipt-a4-actions {
    margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc;
    display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;
}

@media print {
    body, .app-container { margin: 0; padding: 0; box-shadow: none; border: none; background: #fff; }
    .app-header, .app-nav, .app-main > *:not(#subscriber-detail-section), .app-footer, .actions-bar,
    #subscriber-detail-section > *:not(.receipt-a4-wrapper), .receipt-a4-actions {
        display: none !important;
    }
    #subscriber-detail-section, .receipt-a4-wrapper { display: block !important; padding: 0; margin: 0; }
    .receipt-a4-container { box-shadow: none; border: none; margin: 0; width: 100%; height: 100%; min-height: auto; padding: 0; }
    @page { size: A4; margin: 20mm; }
}
/* --- نهاية ستايل وصل A4 --- */


/* --- قسم الإعدادات --- */
.setting-item { margin-bottom: 25px; padding: 18px; background-color: color-mix(in srgb, var(--secondary-color) 3%, transparent); border-radius: var(--border-radius); border-left: 4px solid var(--secondary-color); box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
.setting-item label:not(.switch) { font-weight: 500; margin-left: 10px; font-size: 0.95em; }
.setting-item input[type="number"], .setting-item input[type="text"] { padding: 8px 10px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); width: auto; min-width: 80px; text-align: center; }
.setting-item input[type="text"] { text-align: right; }
.setting-item .btn { margin-top: 10px; margin-left: 5px;}
#customFieldsList .custom-field-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); margin-bottom: 8px; background-color: color-mix(in srgb, var(--bg-color-light) 98%, transparent); }
#customFieldsList .custom-field-item span { font-weight: 500; color: var(--text-color-light); }
#customFieldsList .custom-field-item .btn-danger { padding: 4px 8px; font-size: 0.75em; }
.form-inline { display: flex; gap: 10px; align-items: center; margin-top: 15px; }
.form-inline input[type="text"] { flex-grow: 1; }
/* Logo uploader styles */
.logo-uploader { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
.logo-preview-img { max-width: 100px; max-height: 50px; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); object-fit: contain; }
/* Switch toggle */
.switch { position: relative; display: inline-block; width: 50px; height: 24px; vertical-align: middle; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; }
input:checked + .slider { background-color: var(--success-color); }
input:focus + .slider { box-shadow: 0 0 1px var(--success-color); }
input:checked + .slider:before { transform: translateX(26px); }
.slider.round { border-radius: 24px; }
.slider.round:before { border-radius: 50%; }
.theme-btn { padding: 8px 15px; margin: 5px; border: 2px solid var(--primary-color); background-color: transparent; color: var(--primary-color); border-radius: var(--border-radius-sm); cursor: pointer; transition: all 0.2s ease; font-weight: 500; }
.theme-btn:hover, .theme-btn.active-theme { background-color: var(--primary-color); color: white; transform: scale(1.05); }

/* --- قسم الاحصائيات --- */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background-color: var(--bg-color-light); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); border-left: 5px solid var(--primary-color); }
.stat-card h3 { font-size: 1.2em; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
.stat-card .stat-value { font-size: 2em; font-weight: 700; color: var(--secondary-color); }
.stat-card .stat-description { font-size: 0.9em; color: #777; }
body.dark-mode .stat-card .stat-description { color: var(--light-color); }
.progress-bar-container { width: 100%; background-color: #e0e0e0; border-radius: var(--border-radius-sm); overflow: hidden; height: 25px; margin: 15px 0; display: flex; }
.progress-bar-collected { background-color: var(--success-color); color: white; text-align: center; line-height: 25px; font-size: 0.8em; transition: width 0.5s ease-in-out; }
.progress-bar-remaining { background-color: var(--danger-color); flex-grow: 1; }
.stats-list {
    list-style-type: none;
    padding: 0;
    max-height: 300px; /* [MODIFIED] Set a max height for scrolling */
    overflow-y: auto;  /* [MODIFIED] Enable vertical scrolling when content overflows */
}
.stats-list li { background-color: color-mix(in srgb, var(--bg-color-light) 95%, #00000005); padding: 10px 15px; border-radius: var(--border-radius-sm); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
.stats-list li i { color: var(--secondary-color); }
.stats-list li .date { font-size: 0.8em; color: #666; white-space: nowrap; }
body.dark-mode .stats-list li .date { color: var(--light-color); }

/* --- الفوتر --- */
.app-footer { background-color: var(--dark-color); color: var(--light-color); text-align: center; padding: 12px; font-size: 0.85em; border-top: 3px solid var(--accent-color); }

/* --- إشعارات Toast --- */
.toast-notifications-container { position: fixed; bottom: 20px; left: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
.toast-notification {
    padding: 15px 20px; border-radius: var(--border-radius-sm); box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    color: white; display: flex; align-items: center; gap: 10px; min-width: 250px;
    animation: slideInToast 0.4s ease-out, fadeOutToast 0.4s ease-in 4.5s forwards;
}
.toast-notification.success { background-color: var(--success-color); }
.toast-notification.error { background-color: var(--danger-color); }
.toast-notification.info { background-color: var(--info-color); }
.toast-notification i { font-size: 1.4em; }
@keyframes slideInToast { from { transform: translateX(-120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
@keyframes fadeOutToast { from { opacity: 1; } to { opacity: 0; transform: translateX(-120%); } }

/* --- مودال التعليمات --- */
#helpModal .modal-content { max-height: 85vh; overflow-y: auto; font-size: 0.95em; }
#helpModal ul, #helpModal ol { margin-right: 25px; margin-bottom: 18px; }
#helpModal li { margin-bottom: 10px; line-height: 1.7; }
#helpModal h4 { font-size: 1.1em; margin-top: 15px; margin-bottom: 8px; color: var(--secondary-color); border-bottom: 1px dashed var(--border-color); }
body.dark-mode #helpModal h4, [data-theme="dark"] #helpModal h4, [data-theme="ocean"] #helpModal h4 { color: var(--accent-color); }

/* --- استجابة للهواتف --- */
@media (max-width: 768px) {
    body { padding: 10px; } .app-container { width: 98%; min-height: 98vh; }
    .app-header h1 { font-size: 1.3em; } .app-header h1 i { font-size: 1em; } .header-icon-btn { font-size: 1.3em; }
    .app-nav { padding: 3px 0; }
    .nav-btn { padding: 7px 5px; font-size: 0.7em; min-width: 65px; }
    .nav-btn i { font-size: 1.2em; } .nav-btn span { display: none; }
    .actions-bar .search-input { width: 100%; margin-top: 10px; order: 3; }
    .app-main { padding: 15px; }
    .page-section h2, .page-section h3, .modal-content h3 { font-size: 1.2em; margin-bottom: 15px; }
    .modal-content { width: 95%; margin: 10% auto; padding: 15px 20px; }
    .actions-bar { flex-direction: column; align-items: stretch; }
    .actions-bar .btn { width: 100%; margin-bottom: 8px; font-size: 0.85em; }
    th, td { padding: 8px 10px; font-size: 0.8em; }
    .info-card p strong { min-width: 100px; }
    .stats-grid { grid-template-columns: 1fr; }
    #contractSwitcherContainer { flex-direction: column; }
    #contractSwitcherContainer h4 { text-align: center; margin-bottom: 10px; }
}
@media (max-width: 480px) {
    .app-header h1 { font-size: 1.1em; } .nav-btn i { font-size: 1.1em; } .page-section h2, .page-section h3 { font-size: 1.1em; }
    .modal-content { padding: 15px; } .form-group label { font-size: 0.85em; }
    .form-group input, .form-group textarea { font-size: 0.85em; padding: 8px; }
    th, td { font-size: 0.75em; padding: 6px 8px; }
    .btn { font-size: 0.85em; padding: 8px 12px; } .btn-sm { font-size: 0.75em; padding: 4px 8px; }
.app-nav{
    height: 40px;
    font-size: 25px;
}

    .setting-item { padding: 12px; }
    .toast-notifications-container { left: 10px; right: 10px; bottom: 10px; width: auto; }
}
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <h1><i class="fas fa-cash-register"></i> نظام إدارة الأقساط</h1>
            </div>
            <div class="header-right">
                <button id="helpBtn" class="header-icon-btn" title="تعليمات"><i class="fas fa-question-circle"></i></button>
                <button id="themeToggleBtn" class="header-icon-btn" title="تبديل السمة"><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <nav class="app-nav">
      <button class="nav-btn active" data-section="dashboard-section">
                <i class="fas fa-tachometer-alt"></i>
                <span>الرئيسية</span>
            </button>
            <button class="nav-btn" data-section="defaulters-section">
                <i class="fas fa-user-times"></i>
                <span>المتأخرون</span>
            </button>
            <button class="nav-btn" data-section="stats-section">
                <i class="fas fa-chart-pie"></i>
                <span>الإحصائيات</span>
            </button>
            <button class="nav-btn" data-section="settings-section">
                <i class="fas fa-cog"></i>
                <span>الإعدادات</span>
            </button>
        </nav>

        <main class="app-main">
            <!-- القسم الأول: لوحة التحكم والمشتركين -->
            <section id="dashboard-section" class="page-section active-section">
                <h2><i class="fas fa-users"></i> المشتركون</h2>
                <div class="actions-bar">
                    <button id="addSubscriberBtn" class="btn btn-primary"><i class="fas fa-user-plus"></i> إضافة مشترك جديد</button>
                    <input type="search" id="mainSearchInput" class="search-input" placeholder="ابحث بالاسم، السلعة، أو الهاتف...">
                    <button id="printSubscribersTableBtn" class="btn btn-secondary"><i class="fas fa-print"></i> طباعة جدول المشتركين</button>
                    <button id="downloadSubscribersExcelBtn" class="btn btn-success"><i class="fas fa-file-excel"></i> تنزيل Excel</button>
                </div>
                <div class="table-responsive">
                    <table id="subscribersTable">
                        <thead>
                            <tr>
                                <th>ت</th>
                                <th>الاسم</th>
                                <th>السلع/العقود</th>
                                <th>تاريخ أول اشتراك</th>
                                <th>عدد العقود</th>
                                <th>عرض التفاصيل</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Sales Log Table -->
                <h3><i class="fas fa-history"></i> سجل المبيعات (جميع العقود)</h3>
                <div class="table-responsive">
                    <table id="salesLogTable">
                        <thead>
                            <tr>
                                <th>السلعة</th>
                                <th>المشتري</th>
                                <th>تاريخ العقد</th>
                                <th>القسط</th>
                                <th>المبلغ الإجمالي</th>
                                <th>المتبقي</th>
                                <th>آخر تسديد</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- القسم الثاني: صفحة المشترك -->
            <section id="subscriber-detail-section" class="page-section">
                <div class="actions-bar">
                    <button class="btn btn-back" id="backToDashboardBtn"><i class="fas fa-arrow-right"></i> العودة للرئيسية</button>
                    <button class="btn btn-secondary" id="editSubscriberFromDetailBtn"><i class="fas fa-edit"></i> تعديل بيانات العقد الحالي</button>
                    <button class="btn btn-danger" id="deleteSubscriberFromDetailBtn"><i class="fas fa-trash-alt"></i> حذف العقد الحالي</button>
                    <button class="btn btn-primary" id="addNewItemForSubscriberBtn"><i class="fas fa-plus-circle"></i> إضافة عقد جديد لهذا المشترك</button>
                </div>
                <!-- Contract Switcher -->
                <div id="contractSwitcherContainer" class="actions-bar" style="justify-content: flex-start; display: none;"></div>

                <div id="subscriberInfoContainer" class="info-card"></div>
                <div id="subscriberCustomFieldsContainer" class="info-card" style="margin-top:15px;"></div>

                <h3><i class="fas fa-calendar-alt"></i> جدول أقساط العقد الحالي (<span id="totalInstallmentsCountDisplay"></span> أقساط)</h3>
                <div id="installmentsSummary" style="display: none;"></div>
                <div class="table-responsive">
                    <table id="installmentsTable">
                        <thead>
                            <tr>
                                <th>القسط رقم</th>
                                <th>تاريخ الاستحقاق</th>
                                <th>المبلغ</th>
                                <th>تاريخ السداد</th>
                                <th>الحالة</th>
                                <th>إجراء</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="actions-bar">
                    <button id="generateReceiptBtn" class="btn btn-success"><i class="fas fa-receipt"></i> إنشاء وصل للقسط القادم</button>
                </div>

                <!-- A4 Receipt Structure -->
                <div id="receiptPreviewWrapper" class="receipt-a4-wrapper" style="display: none;">
                    <div id="receiptPreview" class="receipt-a4-container">
                        <header class="receipt-a4-header">
                            <div class="store-info">
                                <h2 id="receiptStoreName">اسم المتجر</h2>
                            </div>
                            <img id="receiptLogo" src="" alt="شعار المتجر" class="receipt-logo" style="display:none;">
                        </header>
                        <section class="receipt-a4-title">
                            <h1>سند قبض / Receipt Voucher</h1>
                        </section>
                        <section class="receipt-a4-details">
                            <div class="receipt-customer-info">
                                <p><strong>استلمنا من السيد/ة:</strong> <span id="receiptSubscriberName"></span></p>
                                <p><strong>بخصوص:</strong> <span id="receiptItemName"></span></p>
                            </div>
                            <div class="receipt-meta-info">
                                <p><strong>رقم السند:</strong> <span id="receiptId"></span></p>
                                <p><strong>التاريخ:</strong> <span id="receiptPaymentDate"></span></p>
                            </div>
                        </section>
                        <main class="receipt-a4-body">
                            <table class="payment-details-table">
                                <thead>
                                    <tr>
                                        <th>البيان</th>
                                        <th>المبلغ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><p>دفعة من حساب الأقساط (قسط رقم <span id="receiptInstallmentNumber"></span>)</p></td>
                                        <td id="receiptAmountPaid"></td>
                                    </tr>
                                </tbody>
                            </table>
                            <br>
                            <table class="summary-table">
                                <tbody>
                                    <tr>
                                        <td>المبلغ الإجمالي للعقد</td>
                                        <td id="receiptTotalAmount"></td>
                                    </tr>
                                    <tr>
                                        <td>المبلغ المدفوع سابقاً</td>
                                        <td id="receiptPaidPreviously"></td>
                                    </tr>
                                    <tr class="final-total">
                                        <td>المبلغ المتبقي بعد هذه الدفعة</td>
                                        <td id="receiptRemainingAmount"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </main>
                        <footer class="receipt-a4-footer">
                            <div class="receipt-signatures">
                                <div class="buyer-signature">
                                    <h4>توقيع المستلم</h4>
                                    <p>.........................</p>
                                </div>
                                <div class="seller-signature">
                                    <h4>توقيع البائع / <span id="receiptSellerName"></span></h4>
                                    <p>.........................</p>
                                </div>
                            </div>
                            <div class="receipt-contact-info">
                                <!-- Populated by JS -->
                            </div>
                        </footer>
                    </div>
                    <!-- Receipt Actions -->
                    <div class="receipt-a4-actions">
                        <button id="printReceiptBtn" class="btn btn-secondary"><i class="fas fa-print"></i> طباعة</button>
                        <!-- [إضافة] زر تحميل الصورة -->
                        <button id="downloadReceiptImageBtn" class="btn btn-info"><i class="fas fa-camera"></i> تحميل كصورة</button>
                        <button id="closeReceiptPreviewBtn" class="btn btn-warning"><i class="fas fa-times-circle"></i> إغلاق</button>
                    </div>
                </div>
            </section>

            <!-- القسم الثالث: المتأخرون عن السداد -->
            <section id="defaulters-section" class="page-section">
                <h2><i class="fas fa-user-clock"></i> قائمة المتأخرين عن السداد</h2>
                 <div class="actions-bar">
                     <button id="printDefaultersTableBtn" class="btn btn-secondary"><i class="fas fa-print"></i> طباعة القائمة</button>
                     <button id="downloadDefaultersExcelBtn" class="btn btn-success"><i class="fas fa-file-excel"></i> تنزيل Excel</button>
                </div>
                <div class="table-responsive">
                    <table id="defaultersTable">
                         <thead>
                            <tr>
                                <th>ت</th>
                                <th>الاسم</th>
                                <th>السلعة</th>
                                <th>آخر قسط مستحق</th>
                                <th>أيام التأخير</th>
                                <th>صفحة المشترك</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
            
            <!-- القسم الرابع: الاحصائيات -->
            <section id="stats-section" class="page-section">
                <h2><i class="fas fa-chart-line"></i> إحصائيات وتقارير</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3><i class="fas fa-wallet"></i> إجمالي الإيرادات</h3>
                        <p id="statsTotalRevenue" class="stat-value">0</p>
                        <p class="stat-description">مجموع أسعار جميع السلع المباعة.</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-hand-holding-usd"></i> المبالغ المحصلة</h3>
                        <p id="statsTotalCollected" class="stat-value">0</p>
                        <p class="stat-description">مجموع الأقساط التي تم سدادها.</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-file-invoice-dollar"></i> المبالغ المتبقية</h3>
                        <p id="statsTotalRemaining" class="stat-value">0</p>
                        <p class="stat-description">إجمالي الديون المتبقية على المشتركين.</p>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-users"></i> المشتركون والعقود</h3>
                        <p id="statsUserCount" class="stat-value">0 / 0</p>
                        <p class="stat-description">عدد المشتركين الفعليين / إجمالي العقود.</p>
                    </div>
                </div>
                <div class="stat-card">
                    <h3><i class="fas fa-tasks"></i> نسبة التحصيل</h3>
                    <div class="progress-bar-container">
                        <div id="statsCollectedBar" class="progress-bar-collected" style="width: 0%;">0%</div>
                        <div class="progress-bar-remaining"></div>
                    </div>
                    <p class="stat-description">النسبة المئوية للمبالغ المحصلة من إجمالي الإيرادات.</p>
                </div>
                <div class="stats-grid" style="margin-top: 30px;">
                     <div class="stat-card">
                        <h3><i class="fas fa-history"></i> أحدث النشاطات</h3>
                        <ul id="statsRecentActivity" class="stats-list"></ul>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-star"></i> السلع الأكثر مبيعاً</h3>
                        <ul id="statsTopItems" class="stats-list"></ul>
                    </div>
                </div>
            </section>


            <!-- القسم الخامس: الإعدادات -->
            <section id="settings-section" class="page-section">
                <h2><i class="fas fa-cogs"></i> إعدادات البرنامج</h2>
                <div class="setting-item">
                    <h4><i class="fas fa-store"></i> معلومات المتجر (للوصل)</h4>
                    <div class="form-group">
                        <label for="storeNameInput">اسم المتجر:</label>
                        <input type="text" id="storeNameInput" placeholder="مثال: متجر الحمد">
                    </div>
                    <div class="form-group">
                        <label for="storeLogoInput">شعار المتجر (اختياري):</label>
                        <div class="logo-uploader">
                            <img id="logoPreview" src="" alt="معاينة الشعار" class="logo-preview-img" style="display: none;">
                            <label for="storeLogoInput" class="btn btn-sm btn-info"><i class="fas fa-upload"></i> اختيار صورة</label>
                            <input type="file" id="storeLogoInput" accept="image/*" style="display: none;">
                            <button id="removeLogoBtn" class="btn btn-sm btn-danger" style="display: none;"><i class="fas fa-trash"></i> إزالة</button>
                        </div>
                    </div>
                </div>
                <div class="setting-item">
                    <h4><i class="fas fa-user-tie"></i> معلومات البائع (للوصل)</h4>
                     <div class="form-group">
                        <label for="sellerNameInput">اسم البائع أو الشركة:</label>
                        <input type="text" id="sellerNameInput" placeholder="اسمك أو اسم شركتك">
                    </div>
                    <div class="form-group">
                        <label for="sellerAddressInput">عنوان البائع:</label>
                        <input type="text" id="sellerAddressInput" placeholder="المدينة - الشارع">
                    </div>
                    <div class="form-group">
                        <label for="sellerPhoneInput">رقم هاتف البائع:</label>
                        <input type="text" id="sellerPhoneInput" placeholder="رقم للتواصل">
                    </div>
                </div>
                <div class="setting-item">
                    <h4><i class="fas fa-bell"></i> الإشعارات والأصوات</h4>
                    <label for="notificationSoundToggle">تفعيل صوت الإشعارات:</label>
                    <label class="switch">
                        <input type="checkbox" id="notificationSoundToggle">
                        <span class="slider round"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <h4><i class="fas fa-calendar-times"></i> إعدادات التأخير</h4>
                    <label for="daysGracePeriod">فترة السماح للتأخير (أيام):</label>
                    <input type="number" id="daysGracePeriod" value="30" min="0">
                </div>
                <div class="setting-item">
                    <h4><i class="fas fa-list-alt"></i> الحقول المخصصة لبيانات المشتركين</h4>
                    <p>أضف حقولاً إضافية لجمع معلومات محددة.</p>
                    <div id="customFieldsList"></div>
                    <div class="form-inline">
                        <input type="text" id="newCustomFieldName" placeholder="اسم الحقل الجديد (مثال: رقم الهوية)">
                        <button id="addCustomFieldBtn" class="btn btn-sm btn-primary"><i class="fas fa-plus"></i> إضافة حقل</button>
                    </div>
                </div>
                <div class="setting-item">
                    <h4><i class="fas fa-database"></i> إدارة البيانات</h4>
                    <p><strong>ملاحظة:</strong> البيانات تخزن بأمان في متصفحك باستخدام IndexedDB. يمكنك تصديرها كنسخة احتياطية.</p>
                    <button id="exportDataBtn" class="btn btn-info"><i class="fas fa-file-export"></i> تصدير البيانات (JSON)</button>
                    <label for="importDataFile" class="btn btn-info"><i class="fas fa-file-import"></i> استيراد البيانات (JSON)</label>
                    <input type="file" id="importDataFile" accept=".json" style="display: none;">
                    <button id="clearAllDataBtn" class="btn btn-danger"><i class="fas fa-trash-alt"></i> مسح جميع البيانات (تحذير!)</button>
                </div>
                 <div class="setting-item">
                    <h4><i class="fas fa-palette"></i> مظهر البرنامج</h4>
                     <p>اختر السمة:</p>
                     <button class="theme-btn" data-theme="default">أساسي</button>
                     <button class="theme-btn" data-theme="dark">داكن</button>
                     <button class="theme-btn" data-theme="light">فاتح</button>
                     <button class="theme-btn" data-theme="ocean">محيط</button>
                </div>
            </section>
        </main>

        <footer class="app-footer">
            <p>© <span id="currentYear"></span> نظام إدارة الأقساط المتقدم. </p>
            <p style="font-size: 10px; color: #e4e48e; font-weight: 500">برنامج ادارة المبيعات للمشتركين يستخدم للمحال التجارية والمحال الصغيرة لادارة عمليات البيع والحساب مجاني بالكامل</p>
            <p style="margin-top: 5px; font-size: 12px; font-weight: 500">للتواصل والاستفسار 
            <a href="intent://resolve?domain=T_abrahim#Intent;package=org.telegram.messenger;scheme=tg;end;" target="_blank">
            <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" width="20" height="20"  alt="تيليغرام">
        </a>
                     
        <a href="intent://send?phone=+9647708077310#Intent;package=com.whatsapp;scheme=whatsapp;end;" target="_blank">
            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" width="25" height="25" alt="واتساب">
        </a></p>
        </footer>
    </div>

    <!-- مودال إضافة/تعديل مشترك -->
    <div id="subscriberModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">×</span>
            <h3 id="modalTitle">إضافة مشترك جديد</h3>
            <form id="subscriberForm">
                <input type="hidden" id="subscriberId">
                <input type="hidden" id="isNewItemForExistingSubscriber" value="false">
                
                <h4><i class="fas fa-user-circle"></i> البيانات الأساسية</h4>
                <div class="form-group">
                    <label for="subscriberName">اسم المشترك:</label>
                    <input type="text" id="subscriberName" required>
                </div>
                <div class="form-group">
                    <label for="subscriberPhone">رقم الهاتف:</label>
                    <input type="tel" id="subscriberPhone">
                </div>
                <div class="form-group">
                    <label for="subscriberAddress">العنوان:</label>
                    <input type="text" id="subscriberAddress">
                </div>
                <hr>
                <h4><i class="fas fa-shopping-cart"></i> تفاصيل السلعة والأقساط</h4>
                <div class="form-group">
                    <label for="itemName">اسم السلعة:</label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                    <label for="itemPrice">السعر الإجمالي للسلعة:</label>
                    <input type="number" id="itemPrice" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="monthlyInstallmentAmount">مبلغ القسط الشهري المقرر:</label>
                    <input type="number" id="monthlyInstallmentAmount" required min="1" step="0.01">
                </div>
                <div class="form-group">
                    <label>عدد الأقساط المحتسب:</label>
                    <span id="calculatedNumberOfInstallments">---</span> (سيتم حسابه تلقائياً)
                </div>
                 <div class="form-group">
                    <label for="subscriptionDate">تاريخ بدء الأقساط (أول قسط بعد شهر من هذا التاريخ):</label>
                    <input type="date" id="subscriptionDate" required>
                </div>
                <hr>
                <h4><i class="fas fa-plus-square"></i> بيانات إضافية (مخصصة)</h4>
                <div id="customFieldsInputsContainer"></div>
                <div class="form-group">
                    <label for="customNotes">ملاحظات عامة:</label>
                    <textarea id="customNotes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" id="saveSubscriberBtn"><i class="fas fa-save"></i> حفظ</button>
            </form>
        </div>
    </div>

    <!-- مودال التعليمات -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeHelpModalBtn">×</span>
            <h3><i class="fas fa-question-circle"></i> تعليمات استخدام البرنامج</h3>
            <p>مرحباً بك في نظام إدارة الأقساط المتقدم!</p>
            <h4>الأقسام الرئيسية:</h4>
            <ul>
                <li><strong>الرئيسية:</strong> عرض قائمة فريدة بالمشتركين، بالإضافة إلى سجل شامل لكل المبيعات (العقود).</li>
                <li><strong>المتأخرون:</strong> قائمة بالعقود التي تجاوزت فترة السماح للسداد.</li>
                <li><strong>الإحصائيات:</strong> عرض تقارير ورسوم بيانية حول أداء المبيعات والتحصيلات.</li>
                <li><strong>الإعدادات:</strong> تخصيص البرنامج، وتصدير/استيراد البيانات.</li>
            </ul>
             <h4>إضافة عقود متعددة:</h4>
            <p>عندما يكون لمشترك واحد أكثر من عقد (سلعة)، سيظهر اسمه مرة واحدة في الجدول الرئيسي. عند الضغط على "عرض"، ستجد في صفحة التفاصيل الخاصة به شريط تبديل يتيح لك التنقل بين عقوده المختلفة بسهولة. لإضافة عقد جديد لنفس المشترك، استخدم زر "إضافة عقد جديد لهذا المشترك" من داخل صفحته.</p>
             <h4>الوصل الاحترافي (A4):</h4>
            <p>من صفحة تفاصيل المشترك، عند الضغط على زر "وصل" بجانب قسط مسدد، سيظهر سند قبض بحجم A4 جاهز للطباعة. يمكنك تخصيص معلومات المتجر ورفع شعارك الخاص من قسم الإعدادات. يمكنك أيضاً تحميل الوصل كملف صورة.</p>
            <h4>إدارة البيانات:</h4>
            <p><strong>هام جداً:</strong> البرنامج يخزن البيانات بأمان في متصفحك (IndexedDB). للحماية من فقدانها عند تلف الجهاز أو المتصفح، قم بتصديرها بانتظام من قسم الإعدادات.</p>
        </div>
    </div>
    
    <div id="toastNotificationsContainer" class="toast-notifications-container"></div>

    <!-- مكتبات JS الخارجية -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- [إضافة] مكتبة تحويل HTML إلى صورة -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
document.addEventListener('DOMContentLoaded', () => {
    
    // IndexedDB setup with Dexie.js
    const db = new Dexie('AqsatManagerDB_v2');
    db.version(1).stores({
        subscribers: 'id, name, item', // Primary key 'id', and indexes for searching
        appSettings: 'key' // A key-value store for global settings
    });

    // --- عناصر DOM ---
    const navButtons = document.querySelectorAll('.nav-btn');
    const pageSections = document.querySelectorAll('.page-section');
    const addSubscriberBtn = document.getElementById('addSubscriberBtn');
    const subscriberModal = document.getElementById('subscriberModal');
    const closeModalBtn = document.querySelector('#subscriberModal .close-btn');
    const subscriberForm = document.getElementById('subscriberForm');
    const subscribersTableBody = document.querySelector('#subscribersTable tbody');
    const salesLogTableBody = document.querySelector('#salesLogTable tbody');
    const modalTitle = document.getElementById('modalTitle');
    const saveSubscriberBtn = document.getElementById('saveSubscriberBtn');
    const backToDashboardBtn = document.getElementById('backToDashboardBtn');
    const editSubscriberFromDetailBtn = document.getElementById('editSubscriberFromDetailBtn');
    const deleteSubscriberFromDetailBtn = document.getElementById('deleteSubscriberFromDetailBtn');
    const helpBtn = document.getElementById('helpBtn');
    const helpModal = document.getElementById('helpModal');
    const closeHelpModalBtn = document.getElementById('closeHelpModalBtn');
    const itemPriceInput = document.getElementById('itemPrice');
    const monthlyInstallmentAmountInput = document.getElementById('monthlyInstallmentAmount');
    const calculatedNumberOfInstallmentsSpan = document.getElementById('calculatedNumberOfInstallments');
    const totalInstallmentsCountDisplay = document.getElementById('totalInstallmentsCountDisplay');
    const contractSwitcherContainer = document.getElementById('contractSwitcherContainer');
    
    // Settings DOM
    const storeNameInput = document.getElementById('storeNameInput');
    const storeLogoInput = document.getElementById('storeLogoInput');
    const logoPreview = document.getElementById('logoPreview');
    const removeLogoBtn = document.getElementById('removeLogoBtn');
    const sellerNameInput = document.getElementById('sellerNameInput');
    const sellerAddressInput = document.getElementById('sellerAddressInput');
    const sellerPhoneInput = document.getElementById('sellerPhoneInput');
    const customFieldsListDiv = document.getElementById('customFieldsList');
    const newCustomFieldNameInput = document.getElementById('newCustomFieldName');
    const addCustomFieldBtn = document.getElementById('addCustomFieldBtn');
    const customFieldsInputsContainer = document.getElementById('customFieldsInputsContainer');
    const subscriberCustomFieldsContainer = document.getElementById('subscriberCustomFieldsContainer');
    const downloadSubscribersExcelBtn = document.getElementById('downloadSubscribersExcelBtn');
    const downloadDefaultersExcelBtn = document.getElementById('downloadDefaultersExcelBtn');
    const printDefaultersTableBtn = document.getElementById('printDefaultersTableBtn');
    const printSubscribersTableBtn = document.getElementById('printSubscribersTableBtn');
    const subscriberInfoContainer = document.getElementById('subscriberInfoContainer');
    const installmentsTableBody = document.querySelector('#installmentsTable tbody');
    const installmentsSummary = document.getElementById('installmentsSummary');
    
    // Receipt DOM
    const generateReceiptBtn = document.getElementById('generateReceiptBtn');
    const receiptPreviewWrapper = document.getElementById('receiptPreviewWrapper');
    const printReceiptBtn = document.getElementById('printReceiptBtn');
    const downloadReceiptImageBtn = document.getElementById('downloadReceiptImageBtn'); 
    const closeReceiptPreviewBtn = document.getElementById('closeReceiptPreviewBtn');
    const receiptStoreName = document.getElementById('receiptStoreName');
    const receiptLogo = document.getElementById('receiptLogo');
    const receiptSubscriberName = document.getElementById('receiptSubscriberName');
    const receiptItemName = document.getElementById('receiptItemName');
    const receiptInstallmentNumber = document.getElementById('receiptInstallmentNumber');
    const receiptAmountPaid = document.getElementById('receiptAmountPaid');
    const receiptPaymentDate = document.getElementById('receiptPaymentDate');
    const receiptTotalAmount = document.getElementById('receiptTotalAmount');
    const receiptPaidPreviously = document.getElementById('receiptPaidPreviously');
    const receiptRemainingAmount = document.getElementById('receiptRemainingAmount');
    const receiptIdSpan = document.getElementById('receiptId');
    const receiptSellerName = document.getElementById('receiptSellerName');
    const receiptContactInfo = document.querySelector('.receipt-contact-info');

    // General Settings DOM
    const notificationSoundToggle = document.getElementById('notificationSoundToggle');
    const daysGracePeriodInput = document.getElementById('daysGracePeriod');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importDataFile = document.getElementById('importDataFile');
    const clearAllDataBtn = document.getElementById('clearAllDataBtn');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const themeButtons = document.querySelectorAll('.theme-btn');
    const mainSearchInput = document.getElementById('mainSearchInput');
    const addNewItemForSubscriberBtn = document.getElementById('addNewItemForSubscriberBtn');

    // --- الحالة والتخزين ---
    let subscribers = []; // This array holds all contracts
    let currentEditingSubscriberId = null;
    let currentSubscriberForDetails = null; // This holds the currently viewed contract
    let settings = {
        notificationSound: false,
        daysGracePeriod: 30,
        theme: 'default',
        storeName: 'متجرك الافتراضي',
        logoDataUrl: null,
        sellerName: '',
        sellerAddress: '',
        sellerPhone: '',
        customFields: [],
        activityLog: [], // [MODIFIED] Persistent activity log
        lastReceiptNumber: 0
    };
    const MAX_LOG_ENTRIES = 50; // A reasonable limit for the activity log

    // --- وظائف مساعدة ---
    const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const formatDate = (dateString) => {
        if (!dateString) return '---';
        try {
            return new Date(dateString).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
        } catch (e) { return 'تاريخ غير صالح'; }
    };
    const formatCurrency = (amount) => {
        const num = parseFloat(amount);
        if (isNaN(num)) return 'N/A';
        return `${num.toLocaleString('ar-IQ')} د.ع`;
    };

    function showToast(message, type = 'info') {
        const container = document.getElementById('toastNotificationsContainer');
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
        toast.innerHTML = `<i class="fas ${icons[type]}"></i> <p>${message}</p>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }
    
    // --- دوال التخزين في IndexedDB ---
    async function loadDataFromDB() {
        try {
            const [storedSubscribers, storedSettingsObject] = await Promise.all([
                db.subscribers.toArray(),
                db.appSettings.get('mainSettings')
            ]);
            
            subscribers = storedSubscribers || [];
            
            if (storedSettingsObject) {
                settings = { ...settings, ...storedSettingsObject.data };
            }
            
            if (!Array.isArray(settings.customFields)) settings.customFields = [];
            if (!Array.isArray(settings.activityLog)) settings.activityLog = []; // [MODIFIED] Ensure activityLog is an array
            if (typeof settings.lastReceiptNumber !== 'number') settings.lastReceiptNumber = 0;
            
            applySettings();
            renderCustomFieldsInSettings();
        } catch (error) {
            console.error("Error loading data from IndexedDB:", error);
            showToast("حدث خطأ أثناء تحميل البيانات.", "error");
        }
    }

    async function saveSettings() {
        try {
            await db.appSettings.put({ key: 'mainSettings', data: settings });
        } catch (error) {
            console.error("Failed to save settings:", error);
            showToast("فشل حفظ الإعدادات.", "error");
        }
    }
    
    // [NEW] Function to log activities
    async function logActivity(htmlMessage) {
        if (!Array.isArray(settings.activityLog)) {
            settings.activityLog = [];
        }

        const newEntry = {
            timestamp: new Date().toISOString(),
            html: htmlMessage
        };
        
        // Add new activity to the start of the log
        settings.activityLog.unshift(newEntry);

        // Trim the log to the maximum size
        if (settings.activityLog.length > MAX_LOG_ENTRIES) {
            settings.activityLog.length = MAX_LOG_ENTRIES;
        }
        
        // Save the updated settings object (which includes the log)
        await saveSettings();
    }


    function applySettings() {
        notificationSoundToggle.checked = settings.notificationSound;
        daysGracePeriodInput.value = settings.daysGracePeriod;
        storeNameInput.value = settings.storeName || '';
        sellerNameInput.value = settings.sellerName || '';
        sellerAddressInput.value = settings.sellerAddress || '';
        sellerPhoneInput.value = settings.sellerPhone || '';

        if (settings.logoDataUrl) {
            logoPreview.src = settings.logoDataUrl;
            logoPreview.style.display = 'block';
            removeLogoBtn.style.display = 'inline-flex';
        } else {
            logoPreview.style.display = 'none';
            removeLogoBtn.style.display = 'none';
        }

        document.body.classList.toggle('dark-mode', settings.theme === 'dark');
        themeToggleBtn.innerHTML = (settings.theme === 'dark' || settings.theme === 'ocean') ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        document.documentElement.setAttribute('data-theme', settings.theme);
        themeButtons.forEach(btn => {
            btn.classList.toggle('active-theme', btn.dataset.theme === settings.theme);
        });
    }

    // --- وظائف التنقل ---
    function setActiveSection(sectionId) {
        pageSections.forEach(section => section.classList.toggle('active-section', section.id === sectionId));
        navButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.section === sectionId));
        
        if (receiptPreviewWrapper) receiptPreviewWrapper.style.display = 'none';

        // Always render relevant tables when switching sections
        switch(sectionId) {
            case 'dashboard-section':
                renderSubscribersTable();
                renderSalesLogTable();
                break;
            case 'defaulters-section':
                renderDefaultersTable();
                break;
            case 'stats-section':
                renderStatistics();
                break;
        }
    }

    navButtons.forEach(button => button.addEventListener('click', () => setActiveSection(button.dataset.section)));

    // --- وظائف المشتركين (القسم الأول) ---
    function updateCalculatedInstallments() {
        const price = parseFloat(itemPriceInput.value);
        const monthlyAmount = parseFloat(monthlyInstallmentAmountInput.value);
        calculatedNumberOfInstallmentsSpan.textContent = (price > 0 && monthlyAmount > 0) ? Math.ceil(price / monthlyAmount) : '---';
    }

    itemPriceInput.addEventListener('input', updateCalculatedInstallments);
    monthlyInstallmentAmountInput.addEventListener('input', updateCalculatedInstallments);

    function openModal(subscriberId = null, isNewItem = false) {
        subscriberForm.reset();
        calculatedNumberOfInstallmentsSpan.textContent = '---';
        renderCustomFieldInputsInModal();
        currentEditingSubscriberId = subscriberId;

        document.getElementById('isNewItemForExistingSubscriber').value = isNewItem.toString();

        if (isNewItem && currentSubscriberForDetails) {
            // Adding a new contract for an existing subscriber, based on the one we are viewing
            const subscriber = currentSubscriberForDetails;
            modalTitle.textContent = `إضافة عقد جديد لـ ${subscriber.name}`;
            saveSubscriberBtn.innerHTML = '<i class="fas fa-plus"></i> إضافة العقد';
            document.getElementById('subscriberName').value = subscriber.name || '';
            document.getElementById('subscriberPhone').value = subscriber.phone || '';
            document.getElementById('subscriberAddress').value = subscriber.address || '';
            if (subscriber.customData) {
                settings.customFields.forEach(field => {
                    const inputElement = document.getElementById(`customField_${field.id}`);
                    if (inputElement && subscriber.customData[field.id]) inputElement.value = subscriber.customData[field.id];
                });
            }
            document.getElementById('subscriberName').readOnly = true;
            document.getElementById('subscriberPhone').readOnly = true;
            document.getElementById('subscriberAddress').readOnly = true;
            document.getElementById('subscriptionDate').valueAsDate = new Date();
            currentEditingSubscriberId = null; // We are adding a new one, not editing
        
        } else if (subscriberId) { // Regular edit mode for an existing contract
            modalTitle.textContent = 'تعديل بيانات العقد';
            saveSubscriberBtn.innerHTML = '<i class="fas fa-save"></i> تعديل وحفظ';
            document.getElementById('subscriberName').readOnly = false;
            document.getElementById('subscriberPhone').readOnly = false;
            document.getElementById('subscriberAddress').readOnly = false;
            const subscriber = subscribers.find(s => s.id === subscriberId);
            if (subscriber) {
                document.getElementById('subscriberId').value = subscriber.id;
                document.getElementById('subscriberName').value = subscriber.name || '';
                document.getElementById('subscriberPhone').value = subscriber.phone || '';
                document.getElementById('subscriberAddress').value = subscriber.address || '';
                document.getElementById('itemName').value = subscriber.item || '';
                itemPriceInput.value = subscriber.price || '';
                monthlyInstallmentAmountInput.value = subscriber.monthlyInstallment || '';
                document.getElementById('subscriptionDate').value = subscriber.subscriptionDate || '';
                document.getElementById('customNotes').value = subscriber.notes || '';

                if (subscriber.customData) {
                    settings.customFields.forEach(field => {
                        const inputElement = document.getElementById(`customField_${field.id}`);
                        if (inputElement && subscriber.customData[field.id]) inputElement.value = subscriber.customData[field.id];
                    });
                }
                updateCalculatedInstallments();
            }
        } else { // New subscriber mode
            modalTitle.textContent = 'إضافة مشترك جديد';
            saveSubscriberBtn.innerHTML = '<i class="fas fa-user-plus"></i> إضافة المشترك';
            document.getElementById('subscriberName').readOnly = false;
            document.getElementById('subscriberPhone').readOnly = false;
            document.getElementById('subscriberAddress').readOnly = false;
            document.getElementById('subscriptionDate').valueAsDate = new Date();
        }
        subscriberModal.style.display = 'block';
    }

    function closeModal() {
        subscriberModal.style.display = 'none';
        currentEditingSubscriberId = null;
    }

    subscriberForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const isEditing = !!currentEditingSubscriberId;
        const id = isEditing ? currentEditingSubscriberId : generateId();
        const name = document.getElementById('subscriberName').value;
        const phone = document.getElementById('subscriberPhone').value;
        const address = document.getElementById('subscriberAddress').value;
        const item = document.getElementById('itemName').value;
        const price = parseFloat(itemPriceInput.value);
        const monthlyInstallment = parseFloat(monthlyInstallmentAmountInput.value);
        const subscriptionDate = document.getElementById('subscriptionDate').value;
        const notes = document.getElementById('customNotes').value;

        const customData = {};
        settings.customFields.forEach(field => {
            const inputElement = document.getElementById(`customField_${field.id}`);
            if (inputElement) customData[field.id] = inputElement.value;
        });

        if (!name || !item || !price || !monthlyInstallment || !subscriptionDate) {
            showToast('يرجى ملء جميع الحقول الإلزامية.', 'error');
            return;
        }

        const numberOfInstallments = Math.ceil(price / monthlyInstallment);
        let installments = [];
        const existingContract = isEditing ? subscribers.find(s => s.id === currentEditingSubscriberId) : null;
        const oldInstallments = existingContract?.installments || [];

        for (let i = 0; i < numberOfInstallments; i++) {
            const dueDate = new Date(subscriptionDate);
            dueDate.setMonth(dueDate.getMonth() + i + 1);
            const currentInstallmentAmount = (i === numberOfInstallments - 1) ? (price - (monthlyInstallment * (numberOfInstallments - 1))) : monthlyInstallment;
            installments.push({
                month: i + 1, dueDate: dueDate.toISOString().split('T')[0],
                amount: parseFloat(currentInstallmentAmount.toFixed(2)),
                paid: oldInstallments[i]?.paid || false,
                paymentDate: oldInstallments[i]?.paymentDate || null,
                receiptId: oldInstallments[i]?.receiptId || null
            });
        }

        const contractData = { id, name, phone, address, item, price, monthlyInstallment, subscriptionDate, installments, notes, customData };
        
        try {
            await db.subscribers.put(contractData);
            
            if (isEditing) {
                const index = subscribers.findIndex(s => s.id === currentEditingSubscriberId);
                if (index > -1) subscribers[index] = contractData;
                if(currentSubscriberForDetails?.id === currentEditingSubscriberId) {
                    currentSubscriberForDetails = contractData;
                    showSubscriberDetailPage(contractData.id); // Refresh detail page
                }
                logActivity(`<span><i class="fas fa-edit" style="color:var(--warning-color);"></i> تعديل عقد <b>${item}</b> لـ <b>${name}</b></span>`);
            } else {
                subscribers.push(contractData);
                logActivity(`<span><i class="fas fa-tag" style="color:var(--info-color);"></i> بيع <b>${item}</b> إلى <b>${name}</b></span>`);

                const isNewItemForExisting = document.getElementById('isNewItemForExistingSubscriber').value === 'true';
                if(isNewItemForExisting) {
                    showSubscriberDetailPage(contractData.id);
                }
            }
            renderSubscribersTable();
            renderSalesLogTable();
            closeModal();
            playSound('success');
            showToast(isEditing ? 'تم تعديل العقد بنجاح' : 'تمت إضافة العقد بنجاح', 'success');
        } catch (error) {
            console.error("Error saving contract:", error);
            showToast("فشل حفظ بيانات العقد.", "error");
        }
    });

    function renderSubscribersTable(filteredData = subscribers) {
        const subscribersByName = new Map();

        filteredData.forEach(sub => {
            const name = sub.name.trim();
            if (!subscribersByName.has(name)) {
                subscribersByName.set(name, []);
            }
            subscribersByName.get(name).push(sub);
        });
        
        let tableHtml = '';
        if (subscribersByName.size === 0) {
            tableHtml = '<tr><td colspan="6" style="text-align:center;">لا يوجد مشتركين.</td></tr>';
        } else {
            let index = 0;
            const sortedSubscribers = new Map([...subscribersByName.entries()].sort((a, b) => a[0].localeCompare(b[0])));

            for (const [name, contracts] of sortedSubscribers.entries()) {
                const contractCount = contracts.length;
                
                const firstContract = contracts.reduce((earliest, current) => 
                    new Date(current.subscriptionDate) < new Date(earliest.subscriptionDate) ? current : earliest
                );
                
                const latestContract = contracts.reduce((latest, current) => 
                    new Date(current.subscriptionDate) > new Date(latest.subscriptionDate) ? latest : current
                );

                const itemDisplay = contractCount > 1 
                    ? `عقود متعددة (${contractCount})` 
                    : contracts[0].item;
                
                tableHtml += `
                    <tr>
                        <td>${++index}</td>
                        <td>${name}</td>
                        <td>${itemDisplay}</td>
                        <td>${formatDate(firstContract.subscriptionDate)}</td>
                        <td>${contractCount}</td>
                        <td><button class="btn btn-info btn-sm" onclick="window.showSubscriberDetailPage('${latestContract.id}')"><i class="fas fa-eye"></i> عرض</button></td>
                    </tr>`;
            }
        }
        subscribersTableBody.innerHTML = tableHtml;
    }
    
    function renderSalesLogTable() {
        let tableHtml = '';
        if (subscribers.length === 0) {
            tableHtml = '<tr><td colspan="7" style="text-align:center;">لا توجد مبيعات مسجلة.</td></tr>';
        } else {
            const sorted = [...subscribers].sort((a,b) => new Date(b.subscriptionDate) - new Date(a.subscriptionDate));
            sorted.forEach(sub => {
                const paidAmount = sub.installments.filter(i => i.paid).reduce((sum, i) => sum + i.amount, 0);
                const remainingAmount = sub.price - paidAmount;
                const lastPayment = sub.installments.filter(i => i.paid).map(i => new Date(i.paymentDate)).sort((a,b) => b-a)[0];

                tableHtml += `
                    <tr>
                        <td>${sub.item}</td>
                        <td>${sub.name}</td>
                        <td>${formatDate(sub.subscriptionDate)}</td>
                        <td>${formatCurrency(sub.monthlyInstallment)}</td>
                        <td>${formatCurrency(sub.price)}</td>
                        <td>${formatCurrency(remainingAmount)}</td>
                        <td>${lastPayment ? formatDate(lastPayment) : '---'}</td>
                    </tr>`;
            });
        }
        salesLogTableBody.innerHTML = tableHtml;
    }

    window.showSubscriberDetailPage = (id) => {
        currentSubscriberForDetails = subscribers.find(s => s.id === id);
        if (currentSubscriberForDetails) {
            const subscriberName = currentSubscriberForDetails.name;
            const allContractsForSubscriber = subscribers.filter(s => s.name === subscriberName).sort((a,b) => new Date(b.subscriptionDate) - new Date(a.subscriptionDate));
            
            contractSwitcherContainer.innerHTML = '';
            if (allContractsForSubscriber.length > 1) {
                contractSwitcherContainer.style.display = 'flex';
                let switcherHTML = '<h4>عقود هذا المشترك:</h4>';
                allContractsForSubscriber.forEach(contract => {
                    const isActive = contract.id === currentSubscriberForDetails.id ? 'btn-primary' : 'btn-secondary';
                    switcherHTML += `<button class="btn btn-sm ${isActive}" onclick="window.showSubscriberDetailPage('${contract.id}')">${contract.item}</button>`;
                });
                contractSwitcherContainer.innerHTML = switcherHTML;
            } else {
                contractSwitcherContainer.style.display = 'none';
            }

            subscriberInfoContainer.innerHTML = `
                <h4><i class="fas fa-id-card"></i> بيانات المشترك الأساسية</h4>
                <p><strong>الاسم:</strong> ${currentSubscriberForDetails.name || 'N/A'}</p>
                <p><strong>الهاتف:</strong> ${currentSubscriberForDetails.phone || 'غير مسجل'}</p>
                <p><strong>العنوان:</strong> ${currentSubscriberForDetails.address || 'غير مسجل'}</p>
                <h4><i class="fas fa-file-contract"></i> تفاصيل العقد الحالي</h4>
                <p><strong>السلعة:</strong> ${currentSubscriberForDetails.item || 'N/A'}</p>
                <p><strong>السعر الإجمالي للعقد:</strong> ${formatCurrency(currentSubscriberForDetails.price)}</p>`;
            
            let customContent = '<h4><i class="fas fa-info-circle"></i> بيانات إضافية</h4>';
            let hasCustomData = false;
            if (currentSubscriberForDetails.customData) {
                 settings.customFields.forEach(fieldDef => {
                    const value = currentSubscriberForDetails.customData[fieldDef.id];
                    if (value) {
                        customContent += `<p><strong>${fieldDef.label}:</strong> ${value}</p>`;
                        hasCustomData = true;
                    }
                });
            }
            if (currentSubscriberForDetails.notes) {
                 customContent += `<p><strong>ملاحظات العقد:</strong> ${currentSubscriberForDetails.notes}</p>`;
                 hasCustomData = true;
            }
            if (!hasCustomData) customContent += "<p>لا توجد بيانات إضافية مسجلة.</p>";
            subscriberCustomFieldsContainer.innerHTML = customContent;
            
            totalInstallmentsCountDisplay.textContent = currentSubscriberForDetails.installments?.length || 0;
            renderInstallmentsTable(currentSubscriberForDetails);
            renderInstallmentsSummary(currentSubscriberForDetails);
            setActiveSection('subscriber-detail-section');
        } else { setActiveSection('dashboard-section'); }
    };

    window.openModal = openModal;
    
    deleteSubscriberFromDetailBtn.addEventListener('click', async () => {
        if (!currentSubscriberForDetails) return;
        const subscriberId = currentSubscriberForDetails.id;
        if (confirm('هل أنت متأكد من حذف هذا العقد وجميع بياناته؟ لا يمكن التراجع عن هذا الإجراء.')) {
            try {
                const deletedSubscriberName = currentSubscriberForDetails.name;
                const deletedSubscriberItem = currentSubscriberForDetails.item;

                await db.subscribers.delete(subscriberId);
                logActivity(`<span><i class="fas fa-trash-alt" style="color:var(--danger-color);"></i> حذف عقد <b>${deletedSubscriberItem}</b> الخاص بـ <b>${deletedSubscriberName}</b></span>`);

                subscribers = subscribers.filter(s => s.id !== subscriberId);
                
                const remainingContracts = subscribers.filter(s => s.name === currentSubscriberForDetails.name);
                if (remainingContracts.length > 0) {
                    const latestRemaining = remainingContracts.sort((a,b) => new Date(b.subscriptionDate) - new Date(a.subscriptionDate))[0];
                    showSubscriberDetailPage(latestRemaining.id);
                } else {
                    setActiveSection('dashboard-section');
                    currentSubscriberForDetails = null;
                }
                
                renderSubscribersTable();
                renderSalesLogTable();
                
                playSound('delete');
                showToast('تم حذف العقد بنجاح.', 'success');
            } catch (error) {
                console.error("Error deleting contract:", error);
                showToast("فشل حذف العقد.", "error");
            }
        }
    });

    function renderInstallmentsTable(subscriber) {
        let tableHtml = '';
        if (subscriber && subscriber.installments) {
            const today = new Date().toISOString().split('T')[0];
            subscriber.installments.forEach((inst, index) => {
                let statusHtml;
                if (inst.paid) {
                    statusHtml = `<span class="status-paid">مسدد</span>` + (inst.receiptId ? `<br><small style="color: #777;">وصل: ${inst.receiptId}</small>` : '');
                } else if (inst.dueDate < today) {
                    statusHtml = `<span class="status-unpaid">متأخر</span>`;
                } else {
                    statusHtml = `<span class="status-pending">قادم</span>`;
                }

                let actionHtml;
                if (!inst.paid) {
                    actionHtml = `<button class="btn btn-success btn-sm" onclick="window.markInstallmentPaid('${subscriber.id}', ${index})"><i class="fas fa-check-circle"></i> سداد</button>`;
                } else {
                    actionHtml = `
                        <button class="btn btn-warning btn-sm" onclick="window.unmarkInstallmentPaid('${subscriber.id}', ${index})"><i class="fas fa-times-circle"></i> إلغاء</button>
                        <button class="btn btn-info btn-sm" onclick="window.generateAndShowReceiptForPaid('${subscriber.id}', ${index})"><i class="fas fa-receipt"></i> وصل</button>`;
                }

                tableHtml += `
                    <tr id="inst_row_${subscriber.id}_${index}">
                        <td>${inst.month}</td>
                        <td>${formatDate(inst.dueDate)}</td>
                        <td>${formatCurrency(inst.amount)}</td>
                        <td>${inst.paymentDate ? formatDate(inst.paymentDate) : '---'}</td>
                        <td>${statusHtml}</td>
                        <td>${actionHtml}</td>
                    </tr>`;
            });
        }
        installmentsTableBody.innerHTML = tableHtml;
    }
    
    window.markInstallmentPaid = async (subscriberId, installmentIndex) => {
        const subscriber = subscribers.find(s => s.id === subscriberId);
        if (subscriber && subscriber.installments[installmentIndex]) {
            const installment = subscriber.installments[installmentIndex];
            installment.paid = true;
            installment.paymentDate = new Date().toISOString().split('T')[0];
            if (!installment.receiptId) {
                 installment.receiptId = await generateNewReceiptId();
            }
            try {
                await db.subscribers.put(subscriber);
                await saveSettings(); // Save updated receipt number
                
                logActivity(`<span><i class="fas fa-money-check-alt" style="color:var(--success-color);"></i> تسديد قسط من <b>${subscriber.name}</b> (${subscriber.item}) بقيمة ${formatCurrency(installment.amount)}</span>`);

                renderInstallmentsTable(subscriber);
                renderInstallmentsSummary(subscriber);
                playSound('payment');
            } catch (error) {
                console.error("Error marking installment as paid:", error);
                showToast("فشل تحديث حالة القسط.", "error");
            }
        }
    };
    window.unmarkInstallmentPaid = async (subscriberId, installmentIndex) => {
        const subscriber = subscribers.find(s => s.id === subscriberId);
        if (subscriber && subscriber.installments[installmentIndex]) {
            if(confirm("هل أنت متأكد من إلغاء حالة السداد؟")) {
                subscriber.installments[installmentIndex].paid = false;
                subscriber.installments[installmentIndex].paymentDate = null;
                try {
                    await db.subscribers.put(subscriber);
                    renderInstallmentsTable(subscriber);
                    renderInstallmentsSummary(subscriber);
                    playSound('undo');
                } catch(error) {
                    console.error("Error unmarking installment:", error);
                    showToast("فشل إلغاء حالة القسط.", "error");
                }
            }
        }
    };
    window.generateAndShowReceiptForPaid = (subscriberId, installmentIndex) => {
        const subscriber = subscribers.find(s => s.id === subscriberId);
        const inst = subscriber?.installments[installmentIndex];
        if (!subscriber || !inst || !inst.paid) return;
        
        const totalPaidBeforeThis = subscriber.installments
            .slice(0, installmentIndex)
            .filter(i => i.paid)
            .reduce((sum, i) => sum + i.amount, 0);

        const remainingAmount = subscriber.price - (totalPaidBeforeThis + inst.amount);
        
        const receiptData = {
            subscriber, installment: inst, totalPaidPreviously: totalPaidBeforeThis, remainingAmount,
        };
        populateAndShowReceipt(receiptData);
    };

    function renderInstallmentsSummary(subscriber) {
        if (!subscriber || !subscriber.installments) {
            installmentsSummary.style.display = 'none';
            return;
        }
        const paidCount = subscriber.installments.filter(i => i.paid).length;
        const totalCount = subscriber.installments.length;
        const totalPaid = subscriber.installments.filter(i => i.paid).reduce((sum, i) => sum + i.amount, 0);
        const remainingAmount = subscriber.price - totalPaid;
        
        installmentsSummary.innerHTML = `
            تم سداد <strong>${paidCount}</strong> من <strong>${totalCount}</strong> قسط. 
            المبلغ المحصّل: <strong>${formatCurrency(totalPaid)}</strong>. 
            المتبقي: <strong>${formatCurrency(remainingAmount)}</strong>.
        `;
        installmentsSummary.style.display = 'block';
    }

    // --- وظائف وصل القبض المحسنة ---
    async function generateNewReceiptId() {
        settings.lastReceiptNumber++;
        const year = new Date().getFullYear();
        // The calling function will save settings
        return `RCPT-${year}-${String(settings.lastReceiptNumber).padStart(4, '0')}`;
    }

    generateReceiptBtn.addEventListener('click', async () => {
        if (!currentSubscriberForDetails?.installments) return;
        const firstUnpaid = currentSubscriberForDetails.installments.find(inst => !inst.paid);
        if (!firstUnpaid) { showToast("جميع أقساط هذا العقد مسددة.", "info"); return; }

        const totalPaidPreviously = currentSubscriberForDetails.installments
            .filter(i => i.paid)
            .reduce((sum, i) => sum + i.amount, 0);
        
        const remainingAmountAfterPayment = currentSubscriberForDetails.price - totalPaidPreviously - firstUnpaid.amount;
        
        const tempReceiptId = `PREVIEW-${Date.now()}`;
        
        const receiptData = {
            subscriber: currentSubscriberForDetails,
            installment: { ...firstUnpaid, receiptId: tempReceiptId, paymentDate: new Date().toISOString().split('T')[0] },
            totalPaidPreviously,
            remainingAmount: remainingAmountAfterPayment,
        };
        populateAndShowReceipt(receiptData);
    });

    function populateAndShowReceipt(data) {
        if (!data) return;
        const { subscriber, installment, totalPaidPreviously, remainingAmount } = data;
        
        receiptStoreName.textContent = settings.storeName || 'اسم المتجر';
        if (settings.logoDataUrl) {
            receiptLogo.src = settings.logoDataUrl;
            receiptLogo.style.display = 'block';
        } else {
            receiptLogo.style.display = 'none';
        }

        receiptSubscriberName.textContent = subscriber.name;
        receiptItemName.textContent = subscriber.item;
        receiptIdSpan.textContent = installment.receiptId;
        receiptPaymentDate.textContent = formatDate(installment.paymentDate);
        
        receiptInstallmentNumber.textContent = installment.month;
        receiptAmountPaid.textContent = formatCurrency(installment.amount);
        receiptTotalAmount.textContent = formatCurrency(subscriber.price);
        receiptPaidPreviously.textContent = formatCurrency(totalPaidPreviously);
        receiptRemainingAmount.textContent = formatCurrency(remainingAmount);
        
        receiptSellerName.textContent = settings.sellerName || settings.storeName;
        receiptContactInfo.innerHTML = '';
        if(settings.sellerAddress) receiptContactInfo.innerHTML += `<span><i class="fas fa-map-marker-alt"></i> ${settings.sellerAddress}</span>`;
        if(settings.sellerPhone) receiptContactInfo.innerHTML += `<span><i class="fas fa-phone-alt"></i> ${settings.sellerPhone}</span>`;
        if(settings.storeName) receiptContactInfo.innerHTML += `<span><i class="fas fa-store"></i> ${settings.storeName}</span>`;

        receiptPreviewWrapper.style.display = 'block';
        receiptPreviewWrapper.scrollIntoView({ behavior: 'smooth' });
    }

    printReceiptBtn.addEventListener('click', () => {
        if (receiptPreviewWrapper.style.display === 'none') {
            showToast("لا يوجد سند لطباعته.", "error"); return;
        }
        window.print();
    });
    
    closeReceiptPreviewBtn.addEventListener('click', () => {
        receiptPreviewWrapper.style.display = 'none';
    });

    async function handleDownloadReceiptAsImage() {
        const receiptElement = document.getElementById('receiptPreview');
        if (!receiptElement || receiptPreviewWrapper.style.display === 'none') {
            showToast("لا يوجد وصل ظاهر لتحميله.", "error");
            return;
        }

        const originalBtnHtml = downloadReceiptImageBtn.innerHTML;
        downloadReceiptImageBtn.disabled = true;
        downloadReceiptImageBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جارٍ التحضير...`;

        try {
            const canvas = await html2canvas(receiptElement, {
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#ffffff'
            });
            const imageUrl = canvas.toDataURL('image/png');
            const receiptId = document.getElementById('receiptId').textContent || 'receipt';
            
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `وصل_قبض_${receiptId}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast("تم تحميل الوصل كصورة بنجاح.", "success");
        } catch (error) {
            console.error("Error generating receipt image:", error);
            showToast("حدث خطأ أثناء إنشاء الصورة.", "error");
        } finally {
            downloadReceiptImageBtn.disabled = false;
            downloadReceiptImageBtn.innerHTML = originalBtnHtml;
        }
    }


    // --- قسم المتأخرين ---
    const defaultersTableBody = document.querySelector('#defaultersTable tbody');
    function renderDefaultersTable() {
        let tableHtml = '';
        const today = new Date();
        const defaulters = [];
        
        subscribers.forEach(sub => {
            const firstUnpaidInstallment = sub.installments?.find(inst => !inst.paid);
            if(firstUnpaidInstallment) {
                const dueDate = new Date(firstUnpaidInstallment.dueDate);
                const timeDiff = today.getTime() - dueDate.getTime();
                const daysLate = Math.floor(timeDiff / (1000 * 3600 * 24));

                if (daysLate > (settings.daysGracePeriod || 30)) {
                    defaulters.push({ sub, firstUnpaidInstallment, daysLate });
                }
            }
        });

        if (defaulters.length === 0) {
            tableHtml = '<tr><td colspan="6" style="text-align:center;">لا يوجد متأخرون حالياً.</td></tr>';
        } else {
            defaulters.sort((a,b) => b.daysLate - a.daysLate).forEach((item, index) => {
                 tableHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.sub.name}</td>
                        <td>${item.sub.item}</td>
                        <td>القسط ${item.firstUnpaidInstallment.month} (${formatDate(item.firstUnpaidInstallment.dueDate)})</td>
                        <td><span class="status-unpaid">${item.daysLate} يوم</span></td>
                        <td><button class="btn btn-info btn-sm" onclick="window.showSubscriberDetailPage('${item.sub.id}')"><i class="fas fa-eye"></i> عرض</button></td>
                    </tr>`;
            });
        }
        defaultersTableBody.innerHTML = tableHtml;
    }

    // --- قسم الإحصائيات [مُحسّن] ---
    function renderStatistics() {
        let totalRevenue = 0, totalCollected = 0;
        const uniqueSubscribers = new Set();
        const itemCounts = {};

        subscribers.forEach(sub => {
            totalRevenue += sub.price || 0;
            uniqueSubscribers.add(sub.name.trim());
            itemCounts[sub.item] = (itemCounts[sub.item] || 0) + 1;
            
            if (sub.installments) {
                sub.installments.forEach(inst => {
                    if (inst.paid) {
                        totalCollected += inst.amount || 0;
                    }
                });
            }
        });
        
        document.getElementById('statsTotalRevenue').textContent = formatCurrency(totalRevenue);
        document.getElementById('statsTotalCollected').textContent = formatCurrency(totalCollected);
        document.getElementById('statsTotalRemaining').textContent = formatCurrency(totalRevenue - totalCollected);
        document.getElementById('statsUserCount').textContent = `${uniqueSubscribers.size} / ${subscribers.length}`;
        
        const collectionPercentage = totalRevenue > 0 ? (totalCollected / totalRevenue) * 100 : 0;
        const collectedBar = document.getElementById('statsCollectedBar');
        collectedBar.style.width = `${collectionPercentage.toFixed(1)}%`;
        collectedBar.textContent = `${collectionPercentage.toFixed(1)}%`;
        
        const topItems = Object.entries(itemCounts).sort(([,a],[,b]) => b-a).slice(0, 15);
        document.getElementById('statsTopItems').innerHTML = topItems.map(item => `<li><i class="fas fa-star"></i> <span>${item[0]} <strong>(${item[1]} مرة)</strong></span></li>`).join('') || '<li>لا توجد بيانات.</li>';
        
        // [MODIFIED] Render activities directly from the persistent log
        const recentActivitiesHTML = (settings.activityLog || [])
            .slice(0, 20) // Get the latest 20
            .map(act => `<li>${act.html} <span class="date">${formatDate(act.timestamp)}</span></li>`)
            .join('') || '<li>لا توجد نشاطات مسجلة.</li>';

        document.getElementById('statsRecentActivity').innerHTML = recentActivitiesHTML;
    }


    // --- بقية الدوال (إعدادات، استيراد/تصدير، طباعة، إلخ.) ---
    storeNameInput.addEventListener('change', (e) => { settings.storeName = e.target.value; saveSettings(); });
    sellerNameInput.addEventListener('change', (e) => { settings.sellerName = e.target.value; saveSettings(); });
    sellerAddressInput.addEventListener('change', (e) => { settings.sellerAddress = e.target.value; saveSettings(); });
    sellerPhoneInput.addEventListener('change', (e) => { settings.sellerPhone = e.target.value; saveSettings(); });
    notificationSoundToggle.addEventListener('change', (e) => { settings.notificationSound = e.target.checked; saveSettings(); });
    daysGracePeriodInput.addEventListener('change', (e) => { settings.daysGracePeriod = parseInt(e.target.value) || 30; if(settings.daysGracePeriod < 0) settings.daysGracePeriod = 0; e.target.value = settings.daysGracePeriod; saveSettings(); renderDefaultersTable(); });
    themeToggleBtn.addEventListener('click', () => { settings.theme = (settings.theme === 'dark' || settings.theme === 'ocean') ? 'default' : 'dark'; applySettings(); saveSettings(); });
    themeButtons.forEach(button => button.addEventListener('click', () => { settings.theme = button.dataset.theme; applySettings(); saveSettings(); }));
    
    storeLogoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (event) => {
                settings.logoDataUrl = event.target.result;
                logoPreview.src = event.target.result;
                logoPreview.style.display = 'block';
                removeLogoBtn.style.display = 'inline-flex';
                saveSettings();
                showToast("تم حفظ الشعار بنجاح.", "success");
            };
            reader.readAsDataURL(file);
        } else if (file) {
            showToast("الرجاء اختيار ملف صورة صالح.", "error");
        }
    });

    removeLogoBtn.addEventListener('click', () => {
        settings.logoDataUrl = null;
        logoPreview.src = '';
        logoPreview.style.display = 'none';
        removeLogoBtn.style.display = 'none';
        storeLogoInput.value = '';
        saveSettings();
        showToast("تم إزالة الشعار.", "info");
    });
    
    mainSearchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        if (!searchTerm) {
            renderSubscribersTable(subscribers);
            return;
        }
        const filtered = subscribers.filter(sub => 
            (sub.name && sub.name.toLowerCase().includes(searchTerm)) ||
            (sub.item && sub.item.toLowerCase().includes(searchTerm)) ||
            (sub.phone && sub.phone.includes(searchTerm))
        );
        renderSubscribersTable(filtered);
    });
    
    addCustomFieldBtn.addEventListener('click', () => {
        const fieldName = newCustomFieldNameInput.value.trim();
        if(fieldName && !settings.customFields.find(f => f.label === fieldName)) {
            settings.customFields.push({ id: `cf_${Date.now()}`, label: fieldName });
            saveSettings();
            renderCustomFieldsInSettings();
            newCustomFieldNameInput.value = '';
        }
    });

    function renderCustomFieldsInSettings() {
        customFieldsListDiv.innerHTML = settings.customFields.map(field => `
            <div class="custom-field-item">
                <span>${field.label}</span>
                <button class="btn btn-danger btn-sm" onclick="window.removeCustomField('${field.id}')"><i class="fas fa-trash"></i></button>
            </div>`).join('');
    }

    window.removeCustomField = (fieldId) => {
        settings.customFields = settings.customFields.filter(f => f.id !== fieldId);
        saveSettings();
        renderCustomFieldsInSettings();
    }

    function renderCustomFieldInputsInModal() {
        customFieldsInputsContainer.innerHTML = settings.customFields.map(field => `
            <div class="form-group">
                <label for="customField_${field.id}">${field.label}:</label>
                <input type="text" id="customField_${field.id}">
            </div>`).join('');
    }
    
    exportDataBtn.addEventListener('click', async () => {
        try {
            const allData = {
                subscribers: await db.subscribers.toArray(),
                settings: (await db.appSettings.get('mainSettings'))?.data
            };
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aqsat_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast("تم تصدير البيانات بنجاح.", "success");
        } catch (error) {
            console.error("Export failed:", error);
            showToast("فشل تصدير البيانات.", "error");
        }
    });

    importDataFile.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (!data.subscribers || !data.settings) throw new Error("Invalid file format");
                if (confirm("هل أنت متأكد؟ سيتم استبدال جميع البيانات الحالية بالبيانات الموجودة في الملف.")) {
                    await db.transaction('rw', db.subscribers, db.appSettings, async () => {
                        await db.subscribers.clear();
                        await db.appSettings.clear();
                        await db.subscribers.bulkAdd(data.subscribers);
                        await db.appSettings.put({key: 'mainSettings', data: data.settings});
                    });
                    showToast("تم استيراد البيانات بنجاح. سيتم إعادة تحميل الصفحة.", "success");
                    setTimeout(() => window.location.reload(), 2000);
                }
            } catch (error) {
                console.error("Import failed:", error);
                showToast("فشل استيراد البيانات. تأكد من أن الملف صحيح.", "error");
            } finally {
                importDataFile.value = ''; // Reset input
            }
        };
        reader.readAsText(file);
    });

    clearAllDataBtn.addEventListener('click', async () => {
        if(prompt("للتأكيد، اكتب 'مسح الكل' في المربع أدناه:") === "مسح الكل") {
            try {
                await db.delete();
                showToast("تم مسح جميع البيانات بنجاح! سيتم إعادة تحميل الصفحة.", "success");
                setTimeout(() => window.location.reload(), 2000);
            } catch (error) {
                console.error("Clear data failed:", error);
                showToast("فشل مسح البيانات.", "error");
            }
        } else {
            showToast("لم يتم تأكيد العملية. لم يتم حذف أي شيء.", "info");
        }
    });

    printSubscribersTableBtn.addEventListener('click', () => printTable('subscribersTable', 'قائمة المشتركين'));
    printDefaultersTableBtn.addEventListener('click', () => printTable('defaultersTable', 'قائمة المتأخرين عن السداد'));
    
    function printTable(tableId, title) {
        const table = document.getElementById(tableId);
        if(!table) return;

        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>' + title + '</title>');
        printWindow.document.write('<style>body{font-family:sans-serif;direction:rtl;} table{width:100%;border-collapse:collapse;} th,td{border:1px solid #ddd;padding:8px;text-align:right;} th{background-color:#f2f2f2;} h1{text-align:center;}</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write('<h1>' + title + '</h1>');
        printWindow.document.write(table.outerHTML);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    downloadSubscribersExcelBtn.addEventListener('click', () => { exportToExcel('subscribers', "قائمة_المشتركين"); });
    downloadDefaultersExcelBtn.addEventListener('click', () => { exportToExcel('defaulters', "قائمة_المتأخرين"); });

    function exportToExcel(type, fileName) {
        let data, headers;
        if (type === 'subscribers') {
             headers = ["ت", "الاسم", "عدد العقود", "إجمالي الديون", "إجمالي المسدد"];
             const subscribersByName = new Map();
             subscribers.forEach(sub => {
                const name = sub.name.trim();
                if (!subscribersByName.has(name)) subscribersByName.set(name, []);
                subscribersByName.get(name).push(sub);
             });

             data = Array.from(subscribersByName.values()).map((contracts, index) => {
                 const totalDebt = contracts.reduce((sum, c) => sum + c.price, 0);
                 const totalPaid = contracts.reduce((sum, c) => sum + c.installments.filter(i => i.paid).reduce((s, i) => s + i.amount, 0), 0);
                 return [
                     index + 1,
                     contracts[0].name,
                     contracts.length,
                     totalDebt,
                     totalPaid
                 ];
             });
        } else { // defaulters
            headers = ["ت", "الاسم", "السلعة", "آخر قسط مستحق", "تاريخ الاستحقاق", "أيام التأخير"];
            const today = new Date();
            const defaultersList = subscribers
                .map(sub => {
                    const firstUnpaid = sub.installments.find(i => !i.paid);
                    if (!firstUnpaid) return null;
                    const daysLate = Math.floor((today - new Date(firstUnpaid.dueDate)) / (1000 * 3600 * 24));
                    if (daysLate > settings.daysGracePeriod) {
                        return [sub.name, sub.item, `القسط ${firstUnpaid.month}`, formatDate(firstUnpaid.dueDate), daysLate];
                    }
                    return null;
                })
                .filter(Boolean);
            data = defaultersList.map((row, index) => [index + 1, ...row]);
        }

        const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, `${fileName}_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

function playSound(type) {
    if (!settings.notificationSound) return;
    let audio;
    if (type === 'success') audio = new Audio('data:audio/mp3;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU' + Array(1e3).join('123')); // Placeholder sound
    if (type === 'payment') audio = new Audio('data:audio/mp3;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU' + Array(1e3).join('456')); // Placeholder sound
    if (type === 'delete') audio = new Audio('data:audio/mp3;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU' + Array(1e3).join('789')); // Placeholder sound
    if (audio) audio.play().catch(e => console.log("Audio play failed"));
}

// --- Event Listeners and Initial Load ---
helpBtn.addEventListener('click', () => helpModal.style.display = 'block');
closeHelpModalBtn.addEventListener('click', () => helpModal.style.display = 'none');
window.addEventListener('click', (e) => { if (e.target == helpModal) helpModal.style.display = 'none'; });
document.getElementById('currentYear').textContent = new Date().getFullYear();
addSubscriberBtn.addEventListener('click', () => openModal());
closeModalBtn.addEventListener('click', closeModal);
window.addEventListener('click', (event) => { if (event.target == subscriberModal) closeModal(); });
backToDashboardBtn.addEventListener('click', () => { currentSubscriberForDetails = null;
    setActiveSection('dashboard-section'); });
editSubscriberFromDetailBtn.addEventListener('click', () => { if (currentSubscriberForDetails) openModal(currentSubscriberForDetails.id); });
addNewItemForSubscriberBtn.addEventListener('click', () => { if (currentSubscriberForDetails) openModal(currentSubscriberForDetails.id, true); });
downloadReceiptImageBtn.addEventListener('click', handleDownloadReceiptAsImage); 

async function initializeApp() {
    await loadDataFromDB();
    setActiveSection('dashboard-section');
}

initializeApp();
});
</script> 
</body> 
</html>
