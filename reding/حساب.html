
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÑÿπÿ®ÿ© ÿπÿØ ÿßŸÑÿßÿ®ÿ™ÿ≥ÿßŸÖÿßÿ™ - ŸÖÿ∫ÿßŸÖÿ±ÿ© ÿßŸÑÿπÿØ ŸÑŸÑÿ£ÿ∑ŸÅÿßŸÑ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßÆ</text></svg>">
    
    <style>
        :root {
            --primary: #6C63FF;
            --primary-dark: #564FC1;
            --secondary: #FFD166;
            --success: #06D6A0;
            --danger: #EF476F;
            --light: #F8F9FA;
            --dark: #212529;
            --background: #F0F4F8;
            --card-bg: #FFFFFF;
            --text: #2B2D42;
            --text-light: #8D99AE;
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            direction: rtl;
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1; /* Allow container to grow and push nav to bottom */
            display: flex; /* Make container a flex container too */
            flex-direction: column; /* Content inside container stacks vertically */
        }

        /* Screen transitions */
        .screen {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            flex-grow: 1; /* Allow screens to fill available space */
        }

        .screen.active {
            display: flex; /* Or block, depending on content */
            opacity: 1;
            transform: translateY(0);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.5rem;
            margin-top: 20px;
            text-align: center;
        }

        /* Start Screen */
        .start-screen {
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            text-align: center;
            padding-bottom: 80px; /* Space for nav bar */
        }

        .game-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            color: var(--primary);
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--primary-dark);
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .game-subtitle {
            font-size: 1.2rem;
            color: var(--text-light);
            margin-bottom: 30px;
            max-width: 600px;
        }

        .start-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Buttons */
        .btn {
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(108, 99, 255, 0.3);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: #FFC233;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(255, 209, 102, 0.3);
        }

        .btn-lg {
            padding: 15px 40px;
            font-size: 1.3rem;
        }

        /* Level Select Screen */
        .level-select-screen {
            padding-bottom: 80px; /* Space for nav bar */
        }

        .section-title {
            font-size: 2rem;
            font-weight: 900;
            color: var(--primary-dark);
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            padding-bottom: 10px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 50%;
            transform: translateX(50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 2px;
        }

        .level-categories {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
        }

        .category-btn {
            padding: 10px 20px;
            border-radius: 50px;
            background-color: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(108, 99, 255, 0.2);
        }

        .levels-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .level-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .level-card.locked {
            opacity: 0.7;
            filter: grayscale(0.5);
            cursor: not-allowed;
        }

        .level-card.locked::after {
            content: '\f023'; /* Font Awesome lock icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem; /* Larger lock icon */
            color: var(--text-light);
            background-color: rgba(255, 255, 255, 0.7); /* Slightly translucent background for visibility */
            border-radius: 50%;
            padding: 15px;
            z-index: 1;
        }

        .level-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-name {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--text);
            margin-bottom: 15px;
        }

        .level-difficulty {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .difficulty-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--text-light);
        }

        .difficulty-dot.active {
            background-color: var(--secondary);
        }

        .level-description {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .level-rewards {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .reward {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .reward i {
            color: var(--secondary);
        }

        .stars-earned {
            display: flex;
            gap: 5px;
            margin-top: 15px;
        }

        .star {
            color: var(--text-light);
        }

        .star.earned {
            color: var(--secondary);
        }

        /* Game Screen */
        .game-screen {
            padding-bottom: 80px; /* Space for nav bar */
            flex-direction: column;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 15px; /* Gap between elements on wrap */
        }
        .game-header .btn {
            flex-shrink: 0; /* Prevent back button from shrinking too much */
        }
        .game-info {
            display: flex;
            gap: 10px; /* Reduced gap */
            flex-wrap: wrap; /* Allow wrapping info boxes */
            justify-content: flex-end; /* Align to end if wrapped */
            flex-grow: 1; /* Allow info boxes to take available space */
        }
        .info-box {
            background-color: white;
            border-radius: 10px;
            padding: 8px 12px; /* Smaller padding */
            display: flex;
            align-items: center;
            gap: 6px; /* Smaller gap */
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            font-weight: 700;
            color: var(--text);
            font-size: 0.9rem; /* Smaller font size */
        }

        .game-info .info-box i {
            font-size: 1rem; /* Smaller icon size */
        }

        @media (max-width: 480px) {
            .game-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .game-info {
                justify-content: flex-start;
                width: 100%;
            }
            .info-box {
                flex-grow: 1; /* Allow info boxes to grow to fill space */
                justify-content: center;
            }
        }


        .game-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
            flex-grow: 1; /* Pushes nav bar down */
        }

        .question-text {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 30px;
            text-align: center;
        }

        .items-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            max-width: 600px;
            min-height: 200px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .items-container.addition-layout,
        .items-container.subtraction-layout,
        .items-container.comparison-layout,
        .items-container.odd-even-layout { /* Added odd-even layout */
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .items-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            min-width: 120px; /* Ensure groups have some width */
            padding: 10px;
            border: 2px dashed var(--primary);
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            min-height: 100px;
            flex-grow: 1; /* Allow groups to grow */
        }

        .math-operator {
            font-size: 4rem;
            font-weight: 900;
            color: var(--primary);
            margin: 0 10px;
        }
        
        .emoji-item {
            font-size: 3.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }

        .emoji-item.removed {
            opacity: 0.3;
            text-decoration: line-through;
            transform: scale(0.8);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .emoji-item:hover {
            transform: scale(1.1) rotate(10deg);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 500px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .options-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .option-btn {
            aspect-ratio: 1/1;
            border-radius: 15px;
            background-color: white;
            border: 3px solid var(--primary);
            color: var(--primary);
            font-size: 2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .option-btn:hover:not(.disabled) {
            background-color: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(108, 99, 255, 0.3);
        }

        .option-btn.correct {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
            transform: scale(1.05);
        }

        .option-btn.wrong {
            background-color: var(--danger);
            border-color: var(--danger);
            color: white;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }

        .feedback-container {
            min-height: 60px;
            margin-bottom: 20px;
            text-align: center;
        }

        .feedback-message {
            font-size: 1.3rem;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 50px;
            display: inline-block;
        }

        .feedback-message.correct {
            background-color: rgba(6, 214, 160, 0.1);
            color: var(--success);
        }

        .feedback-message.wrong {
            background-color: rgba(239, 71, 111, 0.1);
            color: var(--danger);
        }

        .next-btn {
            margin-top: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .next-btn.show {
            opacity: 1;
            transform: translateY(0);
        }

        .progress-container {
            width: 100%;
            max-width: 500px;
            background-color: #e0e0e0;
            border-radius: 10px;
            height: 10px;
            margin-top: 30px;
            margin-bottom: 20px; /* Added margin */
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Next Stage Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .next-stage-modal {
            background: linear-gradient(135deg, var(--card-bg), #f9f9f9);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: scale(0.8);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.show .next-stage-modal {
            transform: scale(1);
            opacity: 1;
        }

        .modal-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .modal-title {
            font-size: 2rem;
            font-weight: 900;
            color: var(--primary-dark);
            margin-bottom: 15px;
        }

        .modal-subtitle {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 25px;
        }

        .modal-progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e0e0e0;
            border-radius: 6px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .modal-progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--success), var(--secondary));
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .modal-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .modal-stat-item {
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-stat-item i {
            color: var(--secondary);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .modal-buttons .btn {
            flex-grow: 1;
            min-width: 150px;
        }


        /* Level Complete Screen */
        .level-complete-screen {
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            text-align: center;
            padding-bottom: 80px; /* Space for nav bar */
        }

        .celebration-emoji {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-20px); }
        }

        .complete-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--success);
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .complete-subtitle {
            font-size: 1.2rem;
            color: var(--text-light);
            margin-bottom: 30px;
            max-width: 600px;
        }

        .stars-earned-large {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .star-large {
            font-size: 2.5rem;
            color: #e0e0e0;
        }

        .star-large.earned {
            color: var(--secondary);
            animation: starPop 0.5s ease-out;
        }

        @keyframes starPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .reward-container {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }

        .reward-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .reward-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .reward-item:last-child {
            border-bottom: none;
        }

        .reward-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reward-value {
            font-weight: 700;
            color: var(--success);
        }

        /* Shop Screen */
        .shop-screen {
            padding-bottom: 80px; /* Space for nav bar */
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .shop-item {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            text-align: center;
            border: 2px solid transparent;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .shop-item-image {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .shop-item-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text);
        }

        .shop-item-price {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 1.1rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }

        .shop-item-description {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .shop-item-btn {
            width: 100%;
            padding: 10px;
            border-radius: 50px;
            background-color: var(--primary);
            color: white;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shop-item-btn:hover {
            background-color: var(--primary-dark);
        }

        .shop-item-btn.owned {
            background-color: var(--success);
        }

        .shop-item-btn.not-enough {
            background-color: var(--danger);
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .shop-item-btn.applied {
            background-color: var(--primary-dark);
            cursor: default;
            pointer-events: none;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Daily Challenge Screen */
        .daily-challenge-screen {
            padding-bottom: 80px; /* Space for nav bar */
        }

        .challenge-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
            text-align: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .challenge-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .challenge-description {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .challenge-progress {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .challenge-progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .challenge-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            color: var(--text-light);
        }

        .challenge-reward {
            background-color: rgba(255, 209, 102, 0.1);
            border: 2px dashed var(--secondary);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .challenge-reward-title {
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        /* Settings Screen */
        .settings-screen {
            padding-bottom: 80px; /* Space for nav bar */
        }

        .settings-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
        }

        .settings-group {
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 700;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Profile Screen */
        .profile-screen {
            padding-bottom: 80px; /* Space for nav bar */
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            border: 3px solid var(--secondary);
            flex-shrink: 0; /* Prevent shrinking */
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--text);
            margin-bottom: 5px;
        }

        .profile-level {
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .profile-progress {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .profile-progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Nav Bar */
        .nav-bar {
            position: sticky; /* Changed to sticky for better layout control */
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
            margin-top: auto; /* Push to bottom */
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-light);
            font-size: 0.8rem;
            transition: all 0.3s ease;
            flex: 1; /* Distribute space evenly */
        }

        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .nav-item.active {
            color: var(--primary);
            transform: translateY(-5px);
        }

        /* Special Effects */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--primary);
            opacity: 0;
            z-index: 999;
            animation: confetti-fall 3s ease-in-out forwards;
            border-radius: 50%; /* Make confetti round */
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .game-subtitle {
                font-size: 1rem;
            }
            
            .question-text {
                font-size: 1.5rem;
            }
            
            .emoji-item {
                font-size: 2.5rem;
            }
            
            .option-btn {
                font-size: 1.5rem;
            }
            
            .complete-title {
                font-size: 2rem;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar {
                margin-bottom: 15px;
            }
        }

        @media (max-width: 480px) {
            .options-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px; /* Smaller gap for mobile options */
            }
            
            .btn-lg {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            
            .level-name {
                font-size: 1.2rem;
            }
            
            .complete-title {
                font-size: 1.8rem;
            }

            .nav-item {
                font-size: 0.7rem;
            }
            .nav-item i {
                font-size: 1.2rem;
            }

            .modal-title {
                font-size: 1.5rem;
            }
            .modal-subtitle {
                font-size: 0.9rem;
            }
            .modal-icon {
                font-size: 3rem;
            }
            /* Specific mobile size adjustment for option buttons */
            .option-btn {
                font-size: 1.1rem; /* Reduced from 1.2rem */
                padding: 6px; /* Further adjusted padding */
                border-radius: 10px; /* Slightly smaller border radius */
            }
            .emoji-item {
                font-size: 1.8rem; /* Reduced from 2.2rem */
            }
            .items-container {
                min-height: unset; /* Allow it to be more flexible */
                gap: 10px; /* Slightly smaller gap */
            }
            .items-group {
                min-height: unset; /* Allow it to be more flexible */
                gap: 8px; /* Slightly smaller gap */
            }
            .math-operator {
                font-size: 3rem; /* Smaller operator */
            }
        }
    </style>
</head>
<body>
    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ -->
    <div class="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÑÿπÿ®ÿ©...</div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© -->
    <div class="start-screen container screen">
        <div class="game-logo">üßÆ</div>
        <h1 class="game-title">ŸÖÿ∫ÿßŸÖÿ±ÿ© ÿßŸÑÿπÿØ ÿßŸÑŸÖŸÖÿ™ÿπÿ©</h1>
        <p class="game-subtitle">ÿ™ÿπŸÑŸÖ ÿßŸÑÿπÿØ ÿ®ÿ∑ÿ±ŸäŸÇÿ© ŸÖŸÖÿ™ÿπÿ© ŸÖÿπ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ŸàÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™! ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ≥ÿ™ÿπÿØ ŸÑŸÑŸÖÿ∫ÿßŸÖÿ±ÿ©ÿü</p>
        
        <div class="start-buttons">
            <button id="start-game-btn" class="btn btn-primary btn-lg">
                <i class="fas fa-play"></i> ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®
            </button>
            <button id="daily-challenge-btn" class="btn btn-secondary btn-lg">
                <i class="fas fa-calendar-star"></i> ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä
            </button>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ -->
    <div class="level-select-screen container screen">
        <h2 class="section-title">ÿßÿÆÿ™ÿ± ŸÖÿ≥ÿ™ŸàŸâ</h2>
        
        <div class="level-categories">
            <button class="category-btn active" data-category="all">ÿßŸÑŸÉŸÑ</button>
            <button class="category-btn" data-category="count">ÿπÿØ</button>
            <button class="category-btn" data-category="addition">ÿ¨ŸÖÿπ</button>
            <button class="category-btn" data-category="subtraction">ÿ∑ÿ±ÿ≠</button>
            <button class="category-btn" data-category="comparison">ŸÖŸÇÿßÿ±ŸÜÿ©</button>
            <button class="category-btn" data-category="odd_even">ŸÅÿ±ÿØŸä/ÿ≤Ÿàÿ¨Ÿä</button>
        </div>
        
        <div class="levels-container">
            <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÑÿπÿ® -->
    <div class="game-screen container screen">
        <div class="game-header">
            <button id="back-to-levels-btn" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> ÿßŸÑÿπŸàÿØÿ©
            </button>
            
            <div class="game-info">
                <div class="info-box">
                    <i class="fas fa-star"></i>
                    <span id="current-score">0</span>
                </div>
                <div class="info-box">
                    <i class="fas fa-trophy"></i>
                    <span id="current-level-name">ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 1</span>
                    <span id="current-stage-display"> (ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© 1/10)</span>
                </div>
                <div class="info-box">
                    <i class="fas fa-gem"></i>
                    <span id="current-gems">0</span>
                </div>
            </div>
        </div>
        
        <div class="game-content">
            <div class="progress-container">
                <div class="progress-bar" id="level-progress"></div>
            </div>
            
            <h3 class="question-text" id="question-text"></h3>
            
            <div class="items-container" id="items-container">
                <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
            </div>
            
            <div class="options-grid" id="options-grid">
                <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
            </div>
            
            <div class="feedback-container">
                <div class="feedback-message" id="feedback-message"></div>
            </div>
            
            <button id="next-btn" class="btn btn-primary next-btn">
                <i class="fas fa-arrow-left"></i> ÿßŸÑÿ™ÿßŸÑŸä
            </button>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© (Modal) -->
    <div class="modal-overlay" id="next-stage-modal-overlay">
        <div class="next-stage-modal">
            <div class="modal-icon" id="modal-icon">‚ú®</div>
            <h3 class="modal-title" id="modal-title">ÿ£ÿ≠ÿ≥ŸÜÿ™!</h3>
            <p class="modal-subtitle" id="modal-subtitle">ÿßŸÜÿ™ŸÇŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ≠ÿßŸÑŸä!</p>
            
            <div class="modal-progress-bar">
                <div class="modal-progress-fill" id="modal-progress-fill"></div>
            </div>
            
            <div class="modal-stats">
                <div class="modal-stat-item">
                    <i class="fas fa-check-circle"></i>
                    <span id="modal-correct-answers">0/0</span>
                </div>
                <div class="modal-stat-item">
                    <i class="fas fa-trophy"></i>
                    <span id="modal-current-stage">ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© 1/10</span>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button id="modal-continue-btn" class="btn btn-primary btn-lg">
                    <i class="fas fa-arrow-left"></i> ÿ£ŸÉŸÖŸÑ ÿßŸÑŸÑÿπÿ®
                </button>
                <button id="modal-back-to-levels-btn" class="btn btn-secondary">
                    <i class="fas fa-list"></i> ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™
                </button>
            </div>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ -->
    <div class="level-complete-screen container screen">
        <div class="celebration-emoji">üéâ</div>
        <h2 class="complete-title">ÿ£ÿ≠ÿ≥ŸÜÿ™! ŸÑŸÇÿØ ÿ£ŸÉŸÖŸÑÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ!</h2>
        <p class="complete-subtitle">ŸÑŸÇÿØ ÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ <span id="earned-points">0</span> ŸÜŸÇÿ∑ÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ</p>
        
        <div class="stars-earned-large">
            <div class="star-large" id="star-1"><i class="fas fa-star"></i></div>
            <div class="star-large" id="star-2"><i class="fas fa-star"></i></div>
            <div class="star-large" id="star-3"><i class="fas fa-star"></i></div>
        </div>
        
        <div class="reward-container">
            <h3 class="reward-title">ÿßŸÑŸÖŸÉÿßŸÅÿ¢ÿ™</h3>
            <div class="reward-item">
                <div class="reward-name">
                    <i class="fas fa-star"></i>
                    <span>ÿßŸÑŸÜŸÇÿßÿ∑</span>
                </div>
                <div class="reward-value" id="complete-screen-points">+50</div>
            </div>
            <div class="reward-item">
                <div class="reward-name">
                    <i class="fas fa-gem"></i>
                    <span>ÿßŸÑÿ¨ŸàÿßŸáÿ±</span>
                </div>
                <div class="reward-value" id="complete-screen-gems">+5</div>
            </div>
            <div class="reward-item" id="next-level-reward-item">
                <div class="reward-name">
                    <i class="fas fa-trophy"></i>
                    <span>ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿßŸÑŸä</span>
                </div>
                <div class="reward-value">ŸÖŸÅÿ™Ÿàÿ≠!</div>
            </div>
        </div>
        
        <div class="start-buttons">
            <button id="next-level-complete-btn" class="btn btn-primary btn-lg">
                <i class="fas fa-arrow-circle-right"></i> ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿßŸÑŸä
            </button>
            <button id="back-to-levels-complete-btn" class="btn btn-secondary btn-lg">
                <i class="fas fa-list"></i> ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™
            </button>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÖÿ™ÿ¨ÿ± -->
    <div class="shop-screen container screen">
        <h2 class="section-title">ŸÖÿ™ÿ¨ÿ± ÿßŸÑŸÑÿπÿ®ÿ©</h2>
        <p class="game-subtitle">ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ¨ŸàÿßŸáÿ± ÿßŸÑÿ™Ÿä ÿ¨ŸÖÿπÿ™Ÿáÿß ŸÑÿ¥ÿ±ÿßÿ° ÿ¥ÿÆÿµŸäÿßÿ™ ŸàŸÖŸàÿßÿ∂Ÿäÿπ ÿ¨ÿØŸäÿØÿ©</p>
        <div class="info-box" style="justify-content: center; margin-bottom: 20px;">
            <i class="fas fa-gem"></i>
            <span id="shop-current-gems" style="font-size: 1.2rem; font-weight: bold;">0</span>
        </div>
        
        <div class="shop-items">
            <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ÿßŸÑŸäŸàŸÖŸäÿ© -->
    <div class="daily-challenge-screen container screen">
        <h2 class="section-title">ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä</h2>
        
        <div class="challenge-card">
            <h3 class="challenge-title" id="daily-challenge-title">ÿ™ÿ≠ÿØŸä ÿßŸÑÿπÿØ ÿßŸÑÿ≥ÿ±Ÿäÿπ</h3>
            <p class="challenge-description" id="daily-challenge-desc">
                ÿ£ÿ¨ÿ® ÿπŸÑŸâ 10 ÿ£ÿ≥ÿ¶ŸÑÿ© ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠ ÿÆŸÑÿßŸÑ 3 ÿØŸÇÿßÿ¶ŸÇ ŸÑÿ™ÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÖŸÉÿßŸÅÿ£ÿ© ÿÆÿßÿµÿ©!
            </p>
            
            <div class="challenge-progress">
                <div class="challenge-progress-bar" id="challenge-progress"></div>
            </div>
            
            <div class="challenge-stats">
                <span id="challenge-completed">0/10 ŸÖŸÉÿ™ŸÖŸÑ</span>
                <span id="challenge-time">03:00 ŸÖÿ™ÿ®ŸÇŸä</span>
            </div>
            
            <div class="challenge-reward">
                <div class="challenge-reward-title">ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑŸäŸàŸÖŸäÿ©</div>
                <div class="reward-item">
                    <div class="reward-name">
                        <i class="fas fa-gem"></i>
                        <span>10 ÿ¨ŸàÿßŸáÿ±</span>
                    </div>
                </div>
            </div>
            
            <button id="start-challenge-btn" class="btn btn-primary btn-lg">
                <i class="fas fa-play"></i> ÿßÿ®ÿØÿ£ ÿßŸÑÿ™ÿ≠ÿØŸä
            </button>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ -->
    <div class="settings-screen container screen">
        <h2 class="section-title">ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h2>
        
        <div class="settings-card">
            <div class="settings-group">
                <h3 class="settings-title"><i class="fas fa-volume-up"></i> ÿßŸÑÿµŸàÿ™</h3>
                <div class="settings-option">
                    <span class="settings-label">ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖÿ§ÿ´ÿ±ÿßÿ™ ÿßŸÑÿµŸàÿ™Ÿäÿ©</span>
                    <label class="switch">
                        <input type="checkbox" id="sound-effects-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-option">
                    <span class="settings-label">ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ</span>
                    <label class="switch">
                        <input type="checkbox" id="background-music-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-group">
                <h3 class="settings-title"><i class="fas fa-gamepad"></i> ÿßŸÑŸÑÿπÿ®ÿ©</h3>
                <div class="settings-option">
                    <span class="settings-label">Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ÿØŸä</span>
                    <label class="switch">
                        <input type="checkbox" id="challenge-mode-toggle" disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-option">
                    <span class="settings-label">ÿßŸÑÿßŸáÿ™ÿ≤ÿßÿ≤</span>
                    <label class="switch">
                        <input type="checkbox" id="vibration-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-group">
                <h3 class="settings-title"><i class="fas fa-user"></i> ÿßŸÑÿ≠ÿ≥ÿßÿ®</h3>
                <div class="settings-option">
                    <span class="settings-label">ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</span>
                    <button id="reset-data-btn" class="btn btn-danger">ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ</button>
                </div>
                <div class="settings-option">
                    <span class="settings-label">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</span>
                    <button id="logout-btn" class="btn btn-secondary">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä -->
    <div class="profile-screen container screen">
        <h2 class="section-title">ŸÖŸÑŸÅŸä ÿßŸÑÿ¥ÿÆÿµŸä</h2>
        
        <div class="profile-header">
            <div class="profile-avatar" id="profile-avatar">A</div>
            <div class="profile-info">
                <h3 class="profile-name" id="profile-name">ÿ£ÿ≠ŸÖÿØ</h3>
                <p class="profile-level">ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ <span id="profile-level">5</span></p>
                <div class="profile-progress">
                    <div class="profile-progress-bar" id="profile-progress-bar" style="width: 60%"></div>
                </div>
                <p><span id="profile-current-xp">600</span>/<span id="profile-next-xp">1000</span> ŸÜŸÇÿ∑ÿ© ÿÆÿ®ÿ±ÿ©</p>
            </div>
        </div>
        
        <div class="profile-stats">
            <div class="stat-card">
                <div class="stat-value" id="total-points">1,250</div>
                <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÜŸÇÿßÿ∑</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-levels">12</div>
                <div class="stat-label">ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ÿßŸÑŸÖŸÉÿ™ŸÖŸÑÿ©</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-stars">28</div>
                <div class="stat-label">ÿßŸÑŸÜÿ¨ŸàŸÖ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-gems">45</div>
                <div class="stat-label">ÿßŸÑÿ¨ŸàÿßŸáÿ±</div>
            </div>
        </div>
        
        <button id="edit-profile-btn" class="btn btn-primary btn-lg">
            <i class="fas fa-user-edit"></i> ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä
        </button>
    </div>

    <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ -->
    <div class="nav-bar">
        <a href="#" class="nav-item active" id="nav-home">
            <i class="fas fa-home"></i>
            <span>ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
        </a>
        <a href="#" class="nav-item" id="nav-levels">
            <i class="fas fa-gamepad"></i>
            <span>ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™</span>
        </a>
        <a href="#" class="nav-item" id="nav-shop">
            <i class="fas fa-shopping-bag"></i>
            <span>ÿßŸÑŸÖÿ™ÿ¨ÿ±</span>
        </a>
        <a href="#" class="nav-item" id="nav-profile">
            <i class="fas fa-user"></i>
            <span>ŸÖŸÑŸÅŸä</span>
        </a>
        <a href="#" class="nav-item" id="nav-settings">
            <i class="fas fa-cog"></i>
            <span>ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</span>
        </a>
    </div>

    <!-- ŸÖŸÉÿ™ÿ®ÿßÿ™ JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <!-- Moment.js is included but not actively used for new features -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ar.min.js"></script>

    <script>
        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÑÿπÿ®ÿ©
        document.addEventListener('DOMContentLoaded', () => {
            // ÿπŸÜÿßÿµÿ± DOM
            const loadingScreen = document.querySelector('.loading-screen');
            const startScreen = document.querySelector('.start-screen');
            const levelSelectScreen = document.querySelector('.level-select-screen');
            const gameScreen = document.querySelector('.game-screen');
            const nextStageModalOverlay = document.getElementById('next-stage-modal-overlay');
            const nextStageModal = nextStageModalOverlay.querySelector('.next-stage-modal');
            const levelCompleteScreen = document.querySelector('.level-complete-screen');
            const shopScreen = document.querySelector('.shop-screen');
            const dailyChallengeScreen = document.querySelector('.daily-challenge-screen');
            const settingsScreen = document.querySelector('.settings-screen');
            const profileScreen = document.querySelector('.profile-screen');
            
            // ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ŸÜŸÇŸÑ
            const navHome = document.getElementById('nav-home');
            const navLevels = document.getElementById('nav-levels');
            const navShop = document.getElementById('nav-shop');
            const navProfile = document.getElementById('nav-profile');
            const navSettings = document.getElementById('nav-settings'); // New
            
            // ÿ£ÿ≤ÿ±ÿßÿ±/ÿπŸÜÿßÿµÿ± ÿ£ÿÆÿ±Ÿâ
            const startGameBtn = document.getElementById('start-game-btn');
            const dailyChallengeBtn = document.getElementById('daily-challenge-btn');
            const backToLevelsBtn = document.getElementById('back-to-levels-btn');
            const nextBtn = document.getElementById('next-btn');
            const modalContinueBtn = document.getElementById('modal-continue-btn'); // New
            const modalBackToLevelsBtn = document.getElementById('modal-back-to-levels-btn'); // New
            const nextLevelCompleteBtn = document.getElementById('next-level-complete-btn');
            const backToLevelsCompleteBtn = document.getElementById('back-to-levels-complete-btn');
            const startChallengeBtn = document.getElementById('start-challenge-btn');
            const resetDataBtn = document.getElementById('reset-data-btn'); // New
            const logoutBtn = document.getElementById('logout-btn'); // Existing, but add functionality
            const editProfileBtn = document.getElementById('edit-profile-btn'); // New
            
            // ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿµŸàÿ™
            const soundEffectsToggle = document.getElementById('sound-effects-toggle');
            const backgroundMusicToggle = document.getElementById('background-music-toggle');
            const vibrationToggle = document.getElementById('vibration-toggle');
            
            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ©
            const gameData = {
                player: {
                    name: "ÿ£ÿ≠ŸÖÿØ",
                    avatar: "A",
                    level: 1, // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿπÿßŸÖ ŸÑŸÑÿßÿπÿ®
                    xp: 0,
                    nextLevelXp: 1000,
                    points: 0, // ÿßŸÑÿπŸÖŸÑÿ© ÿßŸÑÿπÿßŸÖÿ©
                    gems: 10, // ÿßŸÑÿπŸÖŸÑÿ© ÿßŸÑŸÖŸÖŸäÿ≤ÿ©
                    unlockedLevels: [1], // ŸÖÿπÿ±ŸÅÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©
                    stars: {}, // { levelId: starsCount }
                    inventory: [], // ŸÖÿπÿ±ŸÅÿßÿ™ ÿπŸÜÿßÿµÿ± ÿßŸÑŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ™Ÿä ÿ™ŸÖ ÿ¥ÿ±ÿßÿ§Ÿáÿß
                    activeAvatar: null, // ŸÖÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ±ŸÖÿ≤Ÿäÿ© ÿßŸÑŸÜÿ¥ÿ∑ÿ© ÿ≠ÿßŸÑŸäÿß
                    activeBackground: null, // ŸÖÿπÿ±ŸÅ ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑŸÜÿ¥ÿ∑ÿ© ÿ≠ÿßŸÑŸäÿß
                    settings: {
                        soundEffects: true,
                        backgroundMusic: true,
                        vibration: true
                    }
                },
                levels: [
                    // Count Levels
                    {
                        id: 1, name: "ÿßŸÑÿπÿØ ÿßŸÑÿ®ÿ≥Ÿäÿ∑", category: "easy", type: "count", description: "ÿπÿØ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© ŸÅŸÇÿ∑ (ŸÖÿπ ÿ£ÿ¥ŸÉÿßŸÑ ÿ£ÿÆÿ±Ÿâ).",
                        emojis: ['üçé', '‚≠ê', 'üéà'], allEmojis: ['üçé', '‚≠ê', 'üéà', 'üíô', 'üü¢', 'üü•', 'üü°', 'üî∂'], minCount: 2, maxCount: 5, numDistractors: 2, questions: 10, rewardPoints: 50, rewardGems: 1, unlocked: true
                    },
                    {
                        id: 2, name: "ÿπÿØ ÿßŸÑŸÅŸàÿßŸÉŸá", category: "easy", type: "count", description: "ÿπÿØ ÿßŸÑŸÅŸàÿßŸÉŸá ŸàÿßŸÑÿÆÿ∂ÿ±Ÿàÿßÿ™ ÿßŸÑŸÖÿ™ÿ¥ÿßÿ®Ÿáÿ© (ŸÖÿπ ŸÖÿ¥ÿ™ÿ™ÿßÿ™).",
                        emojis: ['üçá', 'üçã', 'ü•ï', 'üçì'], allEmojis: ['üçá', 'üçã', 'ü•ï', 'üçì', 'ü•ë', 'ü•¶', 'üçå', 'ü•ù', 'üçí'], minCount: 3, maxCount: 6, numDistractors: 3, questions: 10, rewardPoints: 60, rewardGems: 1, unlocked: false
                    },
                    // Addition Levels
                    {
                        id: 3, name: "ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ", category: "medium", type: "addition", description: "ÿßÿ¨ŸÖÿπ ÿ£ÿπÿØÿßÿØ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ ŸÑÿ™ÿ¨ÿØ ÿßŸÑŸÖÿ¨ŸÖŸàÿπ.",
                        emojis: ['üê∂', 'üê±', 'üê∞'], minCount: 4, maxCount: 8, questions: 10, rewardPoints: 70, rewardGems: 2, unlocked: false // min/max refer to total sum
                    },
                    {
                        id: 4, name: "ÿ¨ŸÖÿπ ÿßŸÑÿ£ÿ∑ÿπŸÖÿ©", category: "medium", type: "addition", description: "ÿßÿ¨ŸÖÿπ ÿ£ÿπÿØÿßÿØ ÿßŸÑÿ£ÿ∑ÿπŸÖÿ© ÿßŸÑŸÑÿ∞Ÿäÿ∞ÿ©.",
                        emojis: ['üçï', 'üçî', 'üç©'], minCount: 5, maxCount: 10, questions: 10, rewardPoints: 80, rewardGems: 2, unlocked: false // min/max refer to total sum
                    },
                    // Subtraction Levels
                    {
                        id: 5, name: "ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ", category: "medium", type: "subtraction", description: "ÿ£ÿ≤ŸÑ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ ŸàÿπÿØ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä.",
                        emojis: ['‚öΩ', 'üèÄ', 'üèà'], minCount: 5, maxCount: 8, questions: 10, rewardPoints: 90, rewardGems: 3, unlocked: false
                    },
                    {
                        id: 6, name: "ÿ∑ÿ±ÿ≠ ÿßŸÑŸÖÿ±ŸÉÿ®ÿßÿ™", category: "medium", type: "subtraction", description: "ÿßŸÉÿ™ÿ¥ŸÅ ÿπÿØÿØ ÿßŸÑŸÖÿ±ŸÉÿ®ÿßÿ™ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©.",
                        emojis: ['üöó', 'üöï', 'üöå'], minCount: 6, maxCount: 9, questions: 10, rewardPoints: 100, rewardGems: 3, unlocked: false
                    },
                    // Comparison Levels
                    {
                        id: 7, name: "ŸÖŸÇÿßÿ±ŸÜÿ© ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ", category: "hard", type: "comparison", description: "ŸÇÿßÿ±ŸÜ ÿ®ŸäŸÜ ŸÖÿ¨ŸÖŸàÿπÿ™ŸäŸÜ ŸÖŸÜ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ (ÿ£ŸÉÿ´ÿ±ÿå ÿ£ŸÇŸÑÿå Ÿäÿ≥ÿßŸàŸä).",
                        emojis: ['üå≥', 'üå∫', '‚òÄÔ∏è'], minCount: 4, maxCount: 8, questions: 10, rewardPoints: 110, rewardGems: 4, unlocked: false
                    },
                    {
                        id: 8, name: "ÿßŸÑŸÅÿ∂ÿßÿ° ŸàÿßŸÑŸÖŸÇÿßÿ±ŸÜÿ©", category: "hard", type: "comparison", description: "ŸÇÿßÿ±ŸÜ ÿ®ŸäŸÜ ÿπÿØÿØ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ ŸÅŸä ÿßŸÑŸÅÿ∂ÿßÿ°.",
                        emojis: ['üöÄ', 'üåå', 'üå†'], minCount: 5, maxCount: 9, questions: 10, rewardPoints: 120, rewardGems: 4, unlocked: false
                    },
                    // Odd/Even Levels
                    {
                        id: 9, name: "ŸÅÿ±ÿØŸä ÿ£ŸÖ ÿ≤Ÿàÿ¨Ÿäÿü", category: "hard", type: "odd_even", description: "ÿ≠ÿØÿØ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿπÿØÿØ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ ŸÅÿ±ÿØŸäÿßŸã ÿ£ŸÖ ÿ≤Ÿàÿ¨ŸäÿßŸã.",
                        emojis: ['üåü', 'üåà', 'üí°'], minCount: 3, maxCount: 10, questions: 10, rewardPoints: 130, rewardGems: 5, unlocked: false
                    },
                    // Mixed Challenge Levels
                    {
                        id: 10, name: "ÿ™ÿ≠ÿØŸä ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ", category: "hard", type: "mixed", description: "ŸÖÿ≤Ÿäÿ¨ ŸÖŸÜ ÿ™ÿ≠ÿØŸäÿßÿ™ ÿßŸÑÿπÿØÿå ÿßŸÑÿ¨ŸÖÿπÿå ŸàÿßŸÑÿ∑ÿ±ÿ≠.",
                        emojis: ['üî¢', 'üßÆ', 'üìà', 'üìâ'], minCount: 7, maxCount: 12, questions: 10, rewardPoints: 140, rewardGems: 5, unlocked: false
                    },
                    {
                        id: 11, name: "ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä", category: "hard", type: "mixed", description: "ÿßÿÆÿ™ÿ®ÿ± ŸÉŸÑ ŸÖŸáÿßÿ±ÿßÿ™ŸÉ ŸÅŸä ÿ™ÿ≠ÿØŸä ÿ¥ÿßŸÖŸÑ (ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÜŸàÿßÿπ).",
                        emojis: ['üèÜ', 'üèÖ', 'ü•á', 'üëë', 'üíé', '‚ú®', 'üéâ'], minCount: 8, maxCount: 15, questions: 10, rewardPoints: 150, rewardGems: 5, unlocked: false
                    }
                ],
                shopItems: [
                    { id: 1, name: "ÿ¥ÿÆÿµŸäÿ© ÿ±ÿßÿ¶ÿØ ŸÅÿ∂ÿßÿ°", description: "ÿ¥ÿÆÿµŸäÿ© ÿ±ÿßÿ¶ÿØ ŸÅÿ∂ÿßÿ° ŸÖŸÖŸäÿ≤ÿ©", price: 20, type: "avatar", emoji: "üë®‚ÄçüöÄ", applied: false },
                    { id: 2, name: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ®", description: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ® ÿßŸÑŸÖÿ≠ÿ™ÿ±ŸÅ", price: 25, type: "avatar", emoji: "üë®‚Äç‚öïÔ∏è", applied: false },
                    { id: 3, name: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ¥ÿ±ÿ∑Ÿä", description: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ¥ÿ±ÿ∑Ÿä ÿßŸÑÿ¥ÿ¨ÿßÿπ", price: 25, type: "avatar", emoji: "üëÆ", applied: false },
                    { id: 4, name: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ≥ÿßÿ≠ÿ±", description: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ≥ÿßÿ≠ÿ± ÿßŸÑÿ∫ÿßŸÖÿ∂", price: 30, type: "avatar", emoji: "üßô", applied: false },
                    { id: 5, name: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ£ŸÖŸäÿ±ÿ©", description: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ£ŸÖŸäÿ±ÿ© ÿßŸÑÿ¨ŸÖŸäŸÑÿ©", price: 30, type: "avatar", emoji: "üë∏", applied: false },
                    { id: 6, name: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑŸÖŸÇÿßÿ™ŸÑ", description: "ÿ¥ÿÆÿµŸäÿ© ŸÖŸÇÿßÿ™ŸÑ ŸÇŸàŸä", price: 35, type: "avatar", emoji: "ü•∑", applied: false },
                    { id: 7, name: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿπÿßŸÑŸÖ", description: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿπÿßŸÑŸÖ ÿßŸÑÿ∞ŸÉŸä", price: 35, type: "avatar", emoji: "üßë‚Äçüî¨", applied: false },
                    { id: 8, name: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ∑ÿ®ÿßÿÆ", description: "ÿ¥ÿÆÿµŸäÿ© ÿ∑ÿ®ÿßÿÆ ŸÖÿßŸáÿ±", price: 32, type: "avatar", emoji: "üë®‚Äçüç≥", applied: false },
                    { id: 9, name: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑÿ±Ÿàÿ®Ÿàÿ™", description: "ÿ¥ÿÆÿµŸäÿ© ÿ±Ÿàÿ®Ÿàÿ™ ÿ∞ŸÉŸäÿ©", price: 40, type: "avatar", emoji: "ü§ñ", applied: false },
                    { id: 10, name: "ÿ¥ÿÆÿµŸäÿ© ÿßŸÑŸÅŸÜÿßŸÜ", description: "ÿ¥ÿÆÿµŸäÿ© ŸÅŸÜÿßŸÜ ŸÖÿ®ÿØÿπ", price: 40, type: "avatar", emoji: "üßë‚Äçüé®", applied: false },

                    { id: 11, name: "ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ∫ÿßÿ®ÿ©", description: "ÿÆŸÑŸÅŸäÿ© ÿ∫ÿßÿ®ÿ© ÿ¨ŸÖŸäŸÑÿ© ŸÑŸÑÿπÿ®ÿ©", price: 30, type: "background", emoji: "üå≤", applied: false },
                    { id: 12, name: "ÿÆŸÑŸÅŸäÿ© ÿßŸÑŸÅÿ∂ÿßÿ°", description: "ÿÆŸÑŸÅŸäÿ© ŸÅÿ∂ÿßÿ¶Ÿäÿ© ÿ±ÿßÿ¶ÿπÿ©", price: 35, type: "background", emoji: "üöÄ", applied: false },
                    { id: 13, name: "ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ®ÿ≠ÿ±", description: "ÿÆŸÑŸÅŸäÿ© ÿ™ÿ≠ÿ™ ÿßŸÑŸÖÿßÿ° ŸÖÿπ ÿßŸÑÿ£ÿ≥ŸÖÿßŸÉ", price: 35, type: "background", emoji: "üåä", applied: false },
                    { id: 14, name: "ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿµÿ≠ÿ±ÿßÿ°", description: "ÿÆŸÑŸÅŸäÿ© ÿµÿ≠ÿ±ÿßŸàŸäÿ© ŸáÿßÿØÿ¶ÿ©", price: 40, type: "background", emoji: "üèúÔ∏è", applied: false },
                    { id: 15, name: "ÿÆŸÑŸÅŸäÿ© ÿßŸÑŸÖÿØŸäŸÜÿ©", description: "ÿÆŸÑŸÅŸäÿ© ŸÖÿØŸäŸÜÿ© ÿµÿßÿÆÿ®ÿ©", price: 40, type: "background", emoji: "üèôÔ∏è", applied: false },
                    { id: 16, name: "ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ±ÿ®Ÿäÿπ", description: "ÿÆŸÑŸÅŸäÿ© ÿ≤ŸáŸàÿ± Ÿàÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿ±ÿ®Ÿäÿπ", price: 30, type: "background", emoji: "üå∏", applied: false },
                    { id: 17, name: "ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ¥ÿ™ÿßÿ°", description: "ÿÆŸÑŸÅŸäÿ© ÿ´ŸÑŸàÿ¨ Ÿàÿ£ÿ¨Ÿàÿßÿ° ÿßŸÑÿ¥ÿ™ÿßÿ°", price: 30, type: "background", emoji: "‚ùÑÔ∏è", applied: false },
                    { id: 18, name: "ÿÆŸÑŸÅŸäÿ© ŸÇŸàÿ≥ ŸÇÿ≤ÿ≠", description: "ÿÆŸÑŸÅŸäÿ© ŸÖŸÑŸàŸÜÿ© ÿ®ÿ£ŸÑŸàÿßŸÜ ŸÇŸàÿ≥ ŸÇÿ≤ÿ≠", price: 25, type: "background", emoji: "üåà", applied: false },
                    { id: 19, name: "ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ∫ÿ±Ÿàÿ®", description: "ÿÆŸÑŸÅŸäÿ© ÿ∫ÿ±Ÿàÿ® ÿßŸÑÿ¥ŸÖÿ≥ ÿßŸÑÿÆŸÑÿßÿ®", price: 38, type: "background", emoji: "üåá", applied: false },
                    { id: 20, name: "ÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ¥ÿßÿ∑ÿ¶", description: "ÿÆŸÑŸÅŸäÿ© ÿ¥ÿßÿ∑ÿ¶ ÿßÿ≥ÿ™Ÿàÿßÿ¶Ÿä", price: 33, type: "background", emoji: "üèñÔ∏è", applied: false },

                    { id: 21, name: "ÿ≠ÿ≤ŸÖÿ© ÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™", description: "ÿ£ÿ¥ŸÉÿßŸÑ ÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿπÿØ", price: 40, type: "emoji_pack", emoji: "üêæ", content: ['ü¶Å', 'ü¶ä', 'ü¶â', 'üê¢', 'ü¶Ä'] },
                    { id: 22, name: "ÿ≠ÿ≤ŸÖÿ© ÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑÿ∑ÿπÿßŸÖ", description: "ÿ£ÿ¥ŸÉÿßŸÑ ÿ∑ÿπÿßŸÖ ÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿπÿØ", price: 45, type: "emoji_pack", emoji: "üçî", content: ['üåÆ', 'üçï', 'üçú', 'üç©', 'üç™'] },
                    { id: 23, name: "ÿ≠ÿ≤ŸÖÿ© ÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑÿ£ÿØŸàÿßÿ™", description: "ÿ£ÿ¥ŸÉÿßŸÑ ÿ£ÿØŸàÿßÿ™ ŸÖÿ™ŸÜŸàÿπÿ© ŸÑŸÑÿπÿØ", price: 50, type: "emoji_pack", emoji: "üõ†Ô∏è", content: ['üîß', 'üî®', 'üî©', '‚öôÔ∏è', 'üîó'] },
                    { id: 24, name: "ÿ≠ÿ≤ŸÖÿ© ÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑÿ£ŸäÿØŸä", description: "ÿ£ÿ¥ŸÉÿßŸÑ ÿ£ŸäÿØŸä ŸÖÿ™ŸÜŸàÿπÿ© ŸÑŸÑÿπÿØ", price: 55, type: "emoji_pack", emoji: "‚úã", content: ['üñêÔ∏è', 'ü§û', 'ü§ô', '‚úä', 'üëç'] },
                    { id: 25, name: "ÿ≠ÿ≤ŸÖÿ© ÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑÿ£ÿπŸÑÿßŸÖ", description: "ÿ£ÿπŸÑÿßŸÖ ÿØŸàŸÑ ŸÖÿÆÿ™ŸÑŸÅÿ© ŸÑŸÑÿπÿØ", price: 60, type: "emoji_pack", emoji: "üéå", content: ['üá™üá¨', 'üá∏üá¶', 'üá¶üá™', 'üá∂üá¶', 'üá∞üáº'] },
                    { id: 26, name: "ÿ≠ÿ≤ŸÖÿ© ÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑÿ∑ÿ®Ÿäÿπÿ©", description: "ÿ£ÿ¥ŸÉÿßŸÑ ŸÖŸÜ ÿßŸÑÿ∑ÿ®Ÿäÿπÿ© ÿßŸÑÿÆŸÑÿßÿ®ÿ©", price: 45, type: "emoji_pack", emoji: "üåø", content: ['üå≤', 'üå≥', 'üçÇ', 'üçÅ', 'üçÑ'] },
                    { id: 27, name: "ÿ≠ÿ≤ŸÖÿ© ÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑŸáŸÜÿØÿ≥Ÿäÿ©", description: "ÿ£ÿ¥ŸÉÿßŸÑ ŸáŸÜÿØÿ≥Ÿäÿ© ŸÑŸÑÿπÿØ", price: 35, type: "emoji_pack", emoji: "üìê", content: ['üî∫', '‚¨õ', '‚ö™', '‚≠ê', '‚ù§Ô∏è'] },
                    { id: 28, name: "ÿ≠ÿ≤ŸÖÿ© ÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑŸÖŸàÿ≥ŸäŸÇŸâ", description: "ÿ£ÿ¥ŸÉÿßŸÑ ÿ£ÿØŸàÿßÿ™ ŸÖŸàÿ≥ŸäŸÇŸäÿ©", price: 40, type: "emoji_pack", emoji: "üé∂", content: ['üéµ', 'üéº', 'üéπ', 'ü•Å', 'üé∫'] },
                    { id: 29, name: "ÿ≠ÿ≤ŸÖÿ© ÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑŸÖÿ¥ÿßÿπÿ±", description: "ÿ£ÿ¥ŸÉÿßŸÑ ÿ™ÿπÿ®Ÿäÿ±Ÿäÿ© ŸÑŸÑÿπÿØ", price: 50, type: "emoji_pack", emoji: "üòÄ", content: ['üòä', 'üòÇ', 'üòç', 'ü§©', 'üòé'] },
                    { id: 30, name: "ÿ≠ÿ≤ŸÖÿ© ÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑŸÅÿµŸàŸÑ", description: "ÿ£ÿ¥ŸÉÿßŸÑ ŸÑŸÉŸÑ ŸÅÿµŸàŸÑ ÿßŸÑÿ≥ŸÜÿ©", price: 55, type: "emoji_pack", emoji: "üåª", content: ['‚òÄÔ∏è', 'üçÇ', '‚ùÑÔ∏è', 'üå∏', '‚òî'] },

                    { id: 31, name: "ÿ™ŸÑŸÖŸäÿ≠ÿßÿ™ (x5)", description: "5 ÿ™ŸÑŸÖŸäÿ≠ÿßÿ™ ŸÑŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ÿßŸÑÿµÿπÿ®ÿ©", price: 15, type: "power_up", emoji: "üí°", quantity: 5 },
                    { id: 32, name: "ÿ™ÿÆÿ∑Ÿä ÿ≥ÿ§ÿßŸÑ (x3)", description: "3 ŸÅÿ±ÿµ ŸÑÿ™ÿÆÿ∑Ÿä ÿ£Ÿä ÿ≥ÿ§ÿßŸÑ ÿµÿπÿ®", price: 20, type: "power_up", emoji: "‚è≠Ô∏è", quantity: 3 },
                ],
                dailyChallenge: {
                    title: "ÿ™ÿ≠ÿØŸä ÿßŸÑÿπÿØ ÿßŸÑÿ≥ÿ±Ÿäÿπ",
                    description: "ÿ£ÿ¨ÿ® ÿπŸÑŸâ 10 ÿ£ÿ≥ÿ¶ŸÑÿ© ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠ ÿÆŸÑÿßŸÑ 3 ÿØŸÇÿßÿ¶ŸÇ ŸÑÿ™ÿ≠ÿµŸÑ ÿπŸÑŸâ ŸÖŸÉÿßŸÅÿ£ÿ© ÿÆÿßÿµÿ©!",
                    goal: 10,
                    timeLimit: 180, // 3 ÿØŸÇÿßÿ¶ŸÇ ÿ®ÿßŸÑÿ´ŸàÿßŸÜŸä
                    rewardGems: 10,
                    rewardXp: 200 // ŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑÿÆÿ®ÿ±ÿ© ŸÑŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä
                }
            };
            
            // ÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©
            let currentState = {
                currentScreen: null, // ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÜÿ¥ÿ∑ÿ© ŸÖŸÜ ÿ£ÿ¨ŸÑ ÿßŸÜÿ™ŸÇÿßŸÑÿßÿ™ GSAP
                currentLevel: null,
                currentStage: 0, // ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ≠ÿßŸÑŸä ÿØÿßÿÆŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ (Ÿäÿ®ÿØÿ£ ŸÖŸÜ 1)
                correctAnswersInLevel: 0,
                selectedAnswer: null,
                isAnswered: false,
                isCorrectLastQuestion: false, // NEW: Flag to store correctness of last question
                timer: null,
                timeLeft: 0,
                isDailyChallengeActive: false, // ÿπŸÑÿßŸÖÿ© ŸÑŸàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä
                dailyChallenge: {
                    completedQuestions: 0,
                    correctQuestions: 0,
                    timeLimit: 0,
                    timerInterval: null
                },
                currentCorrectAnswer: null
            };
            
            // ÿßŸÑÿ£ÿµŸàÿßÿ™
            const sounds = {
                background: new Howl({
                    src: ['https://assets.codepen.io/21542/howler-demo-bg.mp3'],
                    loop: true,
                    volume: 0.2 // ÿ≠ÿ¨ŸÖ ÿµŸàÿ™ ÿ£ŸÇŸÑ ŸÑŸÑŸÖŸàÿ≥ŸäŸÇŸâ ÿßŸÑÿÆŸÑŸÅŸäÿ©
                }),
                correct: new Howl({
                    src: ['https://assets.codepen.io/21542/howler-demo-sound1.mp3'],
                    volume: 0.5
                }),
                wrong: new Howl({
                    src: ['https://assets.codepen.io/21542/howler-demo-sound2.mp3'],
                    volume: 0.5
                }),
                levelComplete: new Howl({
                    src: ['https://assets.codepen.io/21542/howler-demo-sound3.mp3'],
                    volume: 0.6
                }),
                buttonClick: new Howl({
                    src: ['https://assets.codepen.io/21542/howler-demo-sound4.mp3'], // Placeholder
                    volume: 0.3
                })
            };
            
            // --- ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÑÿπÿ®ÿ© Ÿàÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ---
            function initGame() {
                loadGameData();
                applyPlayerSettings(); // ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ≠ŸÖŸÑÿ© ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
                playBackgroundMusic();
                updateProfileUI(); // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
                renderLevels();
                renderShopItems();
                updateDailyChallengeUI();
                
                // ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ÿπÿØ 1.5 ÿ´ÿßŸÜŸäÿ©
                gsap.to(loadingScreen, { opacity: 0, duration: 0.5, delay: 1.5, onComplete: () => {
                    loadingScreen.style.display = 'none';
                    showScreen(startScreen);
                }});
            }
            
            function loadGameData() {
                const savedData = localStorage.getItem('countingGameData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    Object.assign(gameData.player, parsedData);
                    
                    if (!gameData.player.unlockedLevels || gameData.player.unlockedLevels.length === 0) {
                        gameData.player.unlockedLevels = [1];
                    }
                    gameData.levels.forEach(level => {
                        level.unlocked = gameData.player.unlockedLevels.includes(level.id);
                    });

                    if (!gameData.player.settings) {
                        gameData.player.settings = { soundEffects: true, backgroundMusic: true, vibration: true };
                    }
                    // ÿ™ŸáŸäÿ¶ÿ© ÿ≠ÿßŸÑÿ© "ŸÖÿ∑ÿ®ŸÇ" ŸÑÿπŸÜÿßÿµÿ± ÿßŸÑŸÖÿ™ÿ¨ÿ±
                    gameData.shopItems.forEach(item => {
                        item.applied = false; // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ£ŸàŸÑÿßŸã
                        if (item.type === 'avatar' && item.id === gameData.player.activeAvatar) {
                            item.applied = true;
                        } else if (item.type === 'background' && item.id === gameData.player.activeBackground) {
                            item.applied = true;
                        }
                    });

                } else {
                    gameData.levels[0].unlocked = true;
                }
            }
            
            function saveGameData() {
                localStorage.setItem('countingGameData', JSON.stringify(gameData.player));
            }

            function resetGameData() {
                if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜŸÉ ÿ™ÿ±ŸäÿØ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ©ÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.')) {
                    localStorage.removeItem('countingGameData');
                    alert('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ©. ÿ≥ÿ™ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÑÿπÿ®ÿ©.');
                    location.reload(); // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ©
                }
            }
            
            // --- ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™ ---
            function showScreen(screenElement) {
                // Hide all screens initially without transition
                document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');

                if (currentState.currentScreen) {
                    gsap.to(currentState.currentScreen, { opacity: 0, y: 20, duration: 0.3, onComplete: () => {
                        currentState.currentScreen.style.display = 'none'; // Ensure display is none after animation
                        screenElement.style.display = 'flex'; // Use flex for all main screens
                        gsap.fromTo(screenElement, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.3 });
                        currentState.currentScreen = screenElement;
                        updateNavButtons(screenElement);
                    }});
                } else {
                    screenElement.style.display = 'flex';
                    gsap.fromTo(screenElement, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.3 });
                    currentState.currentScreen = screenElement;
                    updateNavButtons(screenElement);
                }
            }
            
            function updateNavButtons(screen) {
                const navItems = [navHome, navLevels, navShop, navProfile, navSettings];
                navItems.forEach(item => item.classList.remove('active'));
                
                if (screen === startScreen) {
                    navHome.classList.add('active');
                } else if (screen === levelSelectScreen || screen === gameScreen || screen === levelCompleteScreen) {
                    navLevels.classList.add('active');
                } else if (screen === shopScreen) {
                    navShop.classList.add('active');
                } else if (screen === profileScreen) {
                    navProfile.classList.add('active');
                } else if (screen === settingsScreen) {
                    navSettings.classList.add('active');
                }
            }

            function playSound(sound) {
                if (gameData.player.settings.soundEffects) {
                    sound.play();
                }
            }

            function playBackgroundMusic() {
                if (gameData.player.settings.backgroundMusic) {
                    sounds.background.play();
                } else {
                    sounds.background.stop();
                }
            }

            function applyPlayerSettings() {
                soundEffectsToggle.checked = gameData.player.settings.soundEffects;
                backgroundMusicToggle.checked = gameData.player.settings.backgroundMusic;
                vibrationToggle.checked = gameData.player.settings.vibration;

                if (gameData.player.activeAvatar) {
                    const avatarItem = gameData.shopItems.find(item => item.id === gameData.player.activeAvatar && item.type === 'avatar');
                    if (avatarItem) {
                        document.getElementById('profile-avatar').textContent = avatarItem.emoji;
                    }
                } else {
                    document.getElementById('profile-avatar').textContent = gameData.player.avatar;
                }

                if (gameData.player.activeBackground) {
                    const backgroundItem = gameData.shopItems.find(item => item.id === gameData.player.activeBackground && item.type === 'background');
                    if (backgroundItem) {
                        // For demonstration, changing background color or simple gradients.
                        // For actual images, you'd need image assets and adjust CSS for `body.background-id-X`.
                        document.body.style.backgroundImage = 'none'; // Reset any previous gradient/image
                        document.body.style.backgroundColor = 'var(--background)'; // Reset default
                        if (backgroundItem.id === 11) document.body.style.backgroundImage = 'linear-gradient(to top, #A8E6CF, #DCEC6B)'; // Forest feel
                        else if (backgroundItem.id === 12) document.body.style.backgroundImage = 'linear-gradient(to bottom, #1A2980, #26D0CE)'; // Space feel
                        else if (backgroundItem.id === 13) document.body.style.backgroundImage = 'linear-gradient(to top, #36D1DC, #5B86E5)'; // Sea feel
                        else if (backgroundItem.id === 14) document.body.style.backgroundImage = 'linear-gradient(to right, #F9D423, #FF4E50)'; // Desert feel
                        else if (backgroundItem.id === 15) document.body.style.backgroundImage = 'linear-gradient(to bottom, #2C3E50, #BDC3C7)'; // City feel
                        else if (backgroundItem.id === 16) document.body.style.backgroundImage = 'linear-gradient(to top right, #FFB6C1, #FFFACD)'; // Spring feel
                        else if (backgroundItem.id === 17) document.body.style.backgroundImage = 'linear-gradient(to top, #B2D4F3, #E8F5FF)'; // Winter feel
                        else if (backgroundItem.id === 18) document.body.style.backgroundImage = 'linear-gradient(to right, #FFD166, #EF476F, #06D6A0, #118AB2)'; // Rainbow feel
                        else if (backgroundItem.id === 19) document.body.style.backgroundImage = 'linear-gradient(to top, #FF8008, #FFC837)'; // Sunset feel
                        else if (backgroundItem.id === 20) document.body.style.backgroundImage = 'linear-gradient(to bottom, #7DDFFF, #F7FCF0)'; // Beach feel
                    }
                } else {
                    document.body.style.backgroundImage = 'none';
                    document.body.style.backgroundColor = 'var(--background)';
                }
            }
            
            // --- ÿßÿÆÿ™Ÿäÿßÿ± Ÿàÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ---
            function renderLevels(category = 'all') {
                const levelsContainer = document.querySelector('.levels-container');
                levelsContainer.innerHTML = '';
                
                gameData.levels.forEach(level => {
                    // Filter by category or type
                    if (category !== 'all' && level.category !== category && level.type !== category) return;
                    
                    const starsEarned = gameData.player.stars[level.id] || 0;
                    const isUnlocked = gameData.player.unlockedLevels.includes(level.id);

                    let iconClass;
                    switch(level.type) {
                        case 'count': iconClass = 'calculator'; break;
                        case 'addition': iconClass = 'plus'; break;
                        case 'subtraction': iconClass = 'minus'; break;
                        case 'comparison': iconClass = 'balance-scale'; break;
                        case 'odd_even': iconClass = 'dice-five'; break; // Representing numbers visually
                        default: iconClass = 'brain';
                    }
                    
                    const levelCard = document.createElement('div');
                    levelCard.className = `level-card ${isUnlocked ? '' : 'locked'}`;
                    levelCard.innerHTML = `
                        <div class="level-number">
                            <i class="fas fa-${iconClass}"></i>
                            ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ${level.id}
                        </div>
                        <h3 class="level-name">${level.name}</h3>
                        <div class="level-difficulty">
                            <div class="difficulty-dot ${level.category === 'easy' ? 'active' : ''}"></div>
                            <div class="difficulty-dot ${level.category === 'medium' ? 'active' : ''}"></div>
                            <div class="difficulty-dot ${level.category === 'hard' ? 'active' : ''}"></div>
                        </div>
                        <p class="level-description">${level.description}</p>
                        <div class="level-rewards">
                            <div class="reward">
                                <i class="fas fa-coins"></i>
                                <span>${level.rewardPoints} ŸÜŸÇÿ∑ÿ©</span>
                            </div>
                            <div class="reward">
                                <i class="fas fa-gem"></i>
                                <span>${level.rewardGems} ÿ¨ŸàŸáÿ±ÿ©</span>
                            </div>
                        </div>
                        ${starsEarned > 0 ? `
                        <div class="stars-earned">
                            <div class="star ${starsEarned >= 1 ? 'earned' : ''}"><i class="fas fa-star"></i></div>
                            <div class="star ${starsEarned >= 2 ? 'earned' : ''}"><i class="fas fa-star"></i></div>
                            <div class="star ${starsEarned >= 3 ? 'earned' : ''}"><i class="fas fa-star"></i></div>
                        </div>
                        ` : ''}
                    `;
                    
                    if (isUnlocked) {
                        levelCard.addEventListener('click', () => startLevel(level));
                    }
                    
                    levelsContainer.appendChild(levelCard);
                });
            }
            
            // --- ŸÖŸÜÿ∑ŸÇ ÿßŸÑŸÑÿπÿ® (ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ÿßŸÑŸÖÿÆÿ™ŸÑŸÅÿ©) ---
            function startLevel(level) {
                currentState.currentLevel = level;
                currentState.currentStage = 0; // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿπÿØÿßÿØ ÿßŸÑŸÖÿ±ÿßÿ≠ŸÑ ŸÑŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ¨ÿØŸäÿØ
                currentState.correctAnswersInLevel = 0;
                currentState.isDailyChallengeActive = false; // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿπÿØŸÖ Ÿàÿ¨ŸàÿØ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ≠ÿØŸä
                
                document.getElementById('current-level-name').textContent = level.name;
                document.getElementById('current-score').textContent = gameData.player.points;
                document.getElementById('current-gems').textContent = gameData.player.gems;
                
                showScreen(gameScreen);
                loadQuestion();
            }
            
            function loadQuestion() {
                currentState.currentStage++; // ÿ≤ŸäÿßÿØÿ© ÿπÿØÿßÿØ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©
                currentState.isAnswered = false;
                currentState.selectedAnswer = null;
                currentState.isCorrectLastQuestion = false; // Reset correctness flag for new question
                
                document.getElementById('current-stage-display').textContent = ` (ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ${currentState.currentStage}/${currentState.currentLevel.questions})`;
                
                const progress = (currentState.currentStage - 1) / currentState.currentLevel.questions * 100;
                document.getElementById('level-progress').style.width = `${progress}%`;
                
                nextBtn.classList.remove('show');
                const feedbackMessage = document.getElementById('feedback-message');
                feedbackMessage.textContent = '';
                feedbackMessage.className = 'feedback-message';
                
                // ÿ™ÿ≠ÿØŸäÿØ ŸÜŸàÿπ ÿßŸÑÿ≥ÿ§ÿßŸÑ
                let questionType = currentState.currentLevel.type;
                if (questionType === 'mixed') { // For mixed levels, randomize question types
                    const availableTypes = ['count', 'addition', 'subtraction', 'comparison', 'odd_even'];
                    questionType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
                }

                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container'; // Reset container layout initially

                switch (questionType) {
                    case 'count':
                        _loadCountingQuestion();
                        break;
                    case 'addition':
                        _loadAdditionQuestion();
                        break;
                    case 'subtraction':
                        _loadSubtractionQuestion();
                        break;
                    case 'comparison':
                        _loadComparisonQuestion();
                        break;
                    case 'odd_even':
                        _loadOddEvenQuestion();
                        break;
                    default:
                        _loadCountingQuestion(); // Fallback
                }
            }

            // Helper to get available emojis (including unlocked packs)
            function _getAvailableEmojis(levelEmojis) {
                let availableEmojis = [...levelEmojis];
                gameData.player.inventory.forEach(itemId => {
                    const item = gameData.shopItems.find(si => si.id === itemId && si.type === 'emoji_pack');
                    if (item && item.content) {
                        availableEmojis = availableEmojis.concat(item.content);
                    }
                });
                return availableEmojis;
            }

            // Shuffle array helper
            function _shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // --- Question Type Specific Loaders ---

            function _loadCountingQuestion() {
                const level = currentState.currentLevel;
                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container'; // Ensure default layout

                const targetEmojisPool = level.emojis; // Emojis specific to be counted for this level
                const allEmojisPool = level.allEmojis || _getAvailableEmojis(level.emojis); // All possible emojis including distractors
                
                const targetEmoji = targetEmojisPool[Math.floor(Math.random() * targetEmojisPool.length)];
                
                const count = Math.floor(Math.random() * (level.maxCount - level.minCount + 1)) + level.minCount;
                const numDistractors = level.numDistractors || Math.floor(Math.random() * (level.maxCount / 2)) + 1; // Random distractors up to half of max count

                let allEmojis = Array(count).fill(targetEmoji);
                let currentDistractors = 0;
                while (currentDistractors < numDistractors) {
                    const randomEmoji = allEmojisPool[Math.floor(Math.random() * allEmojisPool.length)];
                    if (randomEmoji !== targetEmoji) {
                        allEmojis.push(randomEmoji);
                        currentDistractors++;
                    }
                }
                allEmojis = _shuffleArray(allEmojis);

                itemsContainer.innerHTML = '';
                allEmojis.forEach(emoji => {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji;
                    itemsContainer.appendChild(item);
                });

                document.getElementById('question-text').innerHTML = `ŸÉŸÖ ŸäŸàÿ¨ÿØ ŸÖŸÜ <span id="current-emoji">${targetEmoji}</span> ŸÅŸÇÿ∑ÿü`;
                currentState.currentCorrectAnswer = count;
                _renderOptions(count, 'number');
            }

            function _loadAdditionQuestion() {
                const level = currentState.currentLevel;
                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container addition-layout'; // Set layout class

                const emoji = _getAvailableEmojis(level.emojis)[Math.floor(Math.random() * level.emojis.length)];
                
                // Ensure totalSum is between level.minCount and level.maxCount
                const totalSum = Math.floor(Math.random() * (level.maxCount - level.minCount + 1)) + level.minCount;
                
                // Ensure count1 is at least 1, and count2 (totalSum - count1) is at least 1
                // And ensure count1 is not too large compared to totalSum
                const maxCount1 = Math.min(totalSum - 1, Math.floor(level.maxCount / 2)); // Limit each part to half of maxLevelCount
                const minCount1 = Math.max(1, totalSum - Math.floor(level.maxCount / 2));
                const count1 = Math.floor(Math.random() * (maxCount1 - minCount1 + 1)) + minCount1;
                const count2 = totalSum - count1;

                itemsContainer.innerHTML = `
                    <div class="items-group group1"></div>
                    <div class="math-operator">+</div>
                    <div class="items-group group2"></div>
                `;
                const group1 = itemsContainer.querySelector('.group1');
                const group2 = itemsContainer.querySelector('.group2');

                for (let i = 0; i < count1; i++) {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji;
                    group1.appendChild(item);
                }
                for (let i = 0; i < count2; i++) {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji;
                    group2.appendChild(item);
                }

                document.getElementById('question-text').innerHTML = `ŸÉŸÖ ŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑÿü`;
                currentState.currentCorrectAnswer = totalSum; // The correct answer is the total sum
                _renderOptions(totalSum, 'number');
            }

            function _loadSubtractionQuestion() {
                const level = currentState.currentLevel;
                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container subtraction-layout'; // Set layout class

                const emoji = _getAvailableEmojis(level.emojis)[Math.floor(Math.random() * level.emojis.length)];
                
                const totalCount = Math.floor(Math.random() * (level.maxCount - level.minCount + 1)) + level.minCount;
                const removeCount = Math.floor(Math.random() * (totalCount - 1)) + 1; // Must remove at least 1, max total-1

                itemsContainer.innerHTML = `<div class="items-group group1"></div>`;
                const group1 = itemsContainer.querySelector('.group1');

                const emojisToDisplay = [];
                for (let i = 0; i < totalCount; i++) {
                    emojisToDisplay.push({ emoji: emoji, removed: i < removeCount });
                }
                _shuffleArray(emojisToDisplay); // Shuffle so removed items aren't always first

                emojisToDisplay.forEach(itemData => {
                    const item = document.createElement('div');
                    item.className = `emoji-item ${itemData.removed ? 'removed' : ''}`;
                    item.textContent = itemData.emoji;
                    group1.appendChild(item);
                });

                document.getElementById('question-text').innerHTML = `ÿ•ÿ∞ÿß ÿ£ÿ≤ŸÑÿ™ ÿßŸÑÿ£ÿ¥ŸÉÿßŸÑ ÿßŸÑŸÖÿÆÿ∑ÿ∑ÿ©ÿå ŸÅŸÉŸÖ Ÿäÿ™ÿ®ŸÇŸâÿü`;
                currentState.currentCorrectAnswer = totalCount - removeCount;
                _renderOptions(totalCount - removeCount, 'number');
            }

            function _loadComparisonQuestion() {
                const level = currentState.currentLevel;
                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container comparison-layout'; // Set layout class

                const availableEmojis = _getAvailableEmojis(level.emojis);
                const emoji1 = availableEmojis[0];
                const emoji2 = availableEmojis.length > 1 ? availableEmojis[1] : availableEmojis[0]; // Ensure a different emoji if possible
                
                let count1, count2;
                const comparisonType = Math.floor(Math.random() * 3); // 0: equal, 1: more, 2: less

                const minVal = level.minCount;
                const maxVal = level.maxCount;

                if (comparisonType === 0) { // Equal
                    count1 = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
                    count2 = count1;
                } else if (comparisonType === 1) { // More (count1 > count2)
                    count1 = Math.floor(Math.random() * (maxVal - minVal - 1)) + minVal + 1; // count1 is at least minVal+1
                    count2 = Math.floor(Math.random() * (count1 - minVal)) + minVal; // count2 is less than count1
                } else { // Less (count1 < count2)
                    count2 = Math.floor(Math.random() * (maxVal - minVal - 1)) + minVal + 1;
                    count1 = Math.floor(Math.random() * (count2 - minVal)) + minVal;
                }
                count1 = Math.max(minVal, Math.min(count1, maxVal));
                count2 = Math.max(minVal, Math.min(count2, maxVal));


                itemsContainer.innerHTML = `
                    <div class="items-group group1"></div>
                    <span class="math-operator"> vs </span>
                    <div class="items-group group2"></div>
                `;
                const group1 = itemsContainer.querySelector('.group1');
                const group2 = itemsContainer.querySelector('.group2');

                for (let i = 0; i < count1; i++) {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji1;
                    group1.appendChild(item);
                }
                for (let i = 0; i < count2; i++) {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji2;
                    group2.appendChild(item);
                }
                
                document.getElementById('question-text').innerHTML = `ŸáŸÑ ÿπÿØÿØ ${emoji1} "ÿ£ŸÉÿ´ÿ± ŸÖŸÜ" ÿ£ŸÖ "ÿ£ŸÇŸÑ ŸÖŸÜ" ÿ£ŸÖ "Ÿäÿ≥ÿßŸàŸä" ÿπÿØÿØ ${emoji2}ÿü`;
                
                let correctAnswerText;
                if (count1 > count2) correctAnswerText = 'ÿ£ŸÉÿ´ÿ± ŸÖŸÜ';
                else if (count1 < count2) correctAnswerText = 'ÿ£ŸÇŸÑ ŸÖŸÜ';
                else correctAnswerText = 'Ÿäÿ≥ÿßŸàŸä';

                currentState.currentCorrectAnswer = correctAnswerText;
                _renderOptions(correctAnswerText, 'comparison_text');
            }

            function _loadOddEvenQuestion() {
                const level = currentState.currentLevel;
                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container odd-even-layout'; // Set layout class for odd/even

                const availableEmojis = _getAvailableEmojis(level.emojis);
                const targetEmoji = availableEmojis[Math.floor(Math.random() * availableEmojis.length)];
                
                const count = Math.floor(Math.random() * (level.maxCount - level.minCount + 1)) + level.minCount;
                
                itemsContainer.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = targetEmoji;
                    itemsContainer.appendChild(item);
                }

                document.getElementById('question-text').innerHTML = `ŸáŸÑ ÿπÿØÿØ ${targetEmoji} ŸÅÿ±ÿØŸä ÿ£ŸÖ ÿ≤Ÿàÿ¨Ÿäÿü`;
                
                currentState.currentCorrectAnswer = (count % 2 === 0) ? 'ÿ≤Ÿàÿ¨Ÿä' : 'ŸÅÿ±ÿØŸä';
                _renderOptions(currentState.currentCorrectAnswer, 'odd_even_text');
            }


            // Helper to render options based on type
            function _renderOptions(correctAnswer, type) {
                const optionsGrid = document.getElementById('options-grid');
                optionsGrid.innerHTML = '';
                
                let optionsArray = [];
                if (type === 'number') {
                    optionsArray = _generateNumericOptions(correctAnswer, currentState.currentLevel.maxCount);
                } else if (type === 'comparison_text') {
                    optionsArray = _generateComparisonTextOptions(correctAnswer);
                } else if (type === 'odd_even_text') {
                    optionsArray = _generateOddEvenTextOptions(correctAnswer);
                }

                optionsArray.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    button.textContent = option;
                    button.dataset.value = option;
                    button.addEventListener('click', () => selectAnswer(option, button));
                    optionsGrid.appendChild(button);
                });

                gsap.fromTo(optionsGrid.children, {
                    opacity: 0,
                    y: 50
                }, {
                    opacity: 1,
                    y: 0,
                    duration: 0.4,
                    delay: (i) => 0.2 + i * 0.08,
                    ease: 'power3.out'
                });
            }
            
            function _generateNumericOptions(correctAnswer, maxPossible) {
                let options = new Set();
                options.add(correctAnswer);
                
                while (options.size < 4) {
                    let randomOption;
                    const offset = Math.floor(Math.random() * 5) - 2; // -2, -1, 0, 1, 2
                    randomOption = correctAnswer + offset;
                    randomOption = Math.max(1, Math.min(randomOption, maxPossible + 5));
                    if (randomOption !== correctAnswer) {
                        options.add(randomOption);
                    }
                }
                return Array.from(options).sort(() => Math.random() - 0.5);
            }

            function _generateComparisonTextOptions(correctAnswer) {
                const allOptions = ['ÿ£ŸÉÿ´ÿ± ŸÖŸÜ', 'ÿ£ŸÇŸÑ ŸÖŸÜ', 'Ÿäÿ≥ÿßŸàŸä'];
                let options = new Set();
                options.add(correctAnswer);
                
                while (options.size < 3) { // Comparison has 3 options
                    const randomOption = allOptions[Math.floor(Math.random() * allOptions.length)];
                    options.add(randomOption);
                }
                return Array.from(options).sort(() => Math.random() - 0.5);
            }

            function _generateOddEvenTextOptions(correctAnswer) {
                const allOptions = ['ŸÅÿ±ÿØŸä', 'ÿ≤Ÿàÿ¨Ÿä'];
                let options = new Set();
                options.add(correctAnswer);
                while (options.size < 2) { // Only two options
                    const randomOption = allOptions[Math.floor(Math.random() * allOptions.length)];
                    options.add(randomOption);
                }
                return Array.from(options).sort(() => Math.random() - 0.5);
            }
            
            function selectAnswer(selectedAnswer, button) {
                if (currentState.isAnswered) return;
                
                currentState.isAnswered = true;
                currentState.selectedAnswer = selectedAnswer;
                
                // Compare based on type (numbers or strings)
                const isCorrect = (selectedAnswer == currentState.currentCorrectAnswer);
                
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.classList.add('disabled');
                    btn.disabled = true;
                });
                
                if (isCorrect) {
                    button.classList.add('correct');
                    currentState.correctAnswersInLevel++;
                    gameData.player.points += 10;
                    currentState.isCorrectLastQuestion = true; // Set flag
                    
                    document.getElementById('current-score').textContent = gameData.player.points;
                    
                    const feedbackMessage = document.getElementById('feedback-message');
                    feedbackMessage.textContent = 'ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©! ÿ£ÿ≠ÿ≥ŸÜÿ™! üéâ';
                    feedbackMessage.classList.add('correct');
                    playSound(sounds.correct);
                    
                    if (gameData.player.settings.vibration && 'vibrate' in navigator) {
                        navigator.vibrate(100);
                    }
                } else {
                    button.classList.add('wrong');
                    currentState.isCorrectLastQuestion = false; // Set flag
                    
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.dataset.value == currentState.currentCorrectAnswer) {
                            btn.classList.add('correct');
                        }
                    });
                    
                    const feedbackMessage = document.getElementById('feedback-message');
                    feedbackMessage.textContent = `ÿ•ÿ¨ÿßÿ®ÿ© ÿÆÿßÿ∑ÿ¶ÿ©! ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸáŸä ${currentState.currentCorrectAnswer}.`;
                    feedbackMessage.classList.add('wrong');
                    playSound(sounds.wrong);
                    
                    if (gameData.player.settings.vibration && 'vibrate' in navigator) {
                        navigator.vibrate([100, 50, 100]);
                    }
                }
                
                gsap.to(nextBtn, { opacity: 1, y: 0, duration: 0.3, delay: 1, onComplete: () => nextBtn.classList.add('show') });
            }
            
            // New helper function to proceed
            function _proceedToNextQuestionOrComplete() {
                if (currentState.currentStage < currentState.currentLevel.questions) {
                    loadQuestion();
                } else {
                    completeLevel();
                }
            }

            // --- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ© (Modal) ---
            function showNextStageModal() {
                const isPreviousCorrect = currentState.isCorrectLastQuestion; // Use the stored flag
                document.getElementById('modal-icon').textContent = isPreviousCorrect ? '‚úÖ' : '‚ùå';
                document.getElementById('modal-title').textContent = isPreviousCorrect ? 'ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©!' : 'ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ!'; // Show this even for wrong if desired
                document.getElementById('modal-subtitle').textContent = `ŸÑŸÇÿØ ÿ£ŸÉŸÖŸÑÿ™ ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ${currentState.currentStage} ŸÖŸÜ ÿ£ÿµŸÑ ${currentState.currentLevel.questions}.`;
                
                const progressPercentage = (currentState.currentStage / currentState.currentLevel.questions) * 100;
                document.getElementById('modal-progress-fill').style.width = `${progressPercentage}%`;
                
                document.getElementById('modal-correct-answers').textContent = `${currentState.correctAnswersInLevel}/${currentState.currentStage}`;
                document.getElementById('modal-current-stage').textContent = `ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ© ${currentState.currentStage}/${currentState.currentLevel.questions}`;
                
                nextStageModalOverlay.classList.add('show');
                playSound(sounds.buttonClick);
            }

            function hideNextStageModal() {
                nextStageModalOverlay.classList.remove('show');
                _proceedToNextQuestionOrComplete(); // Proceed after modal is hidden
            }
            
            // --- ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ---
            function completeLevel() {
                const level = currentState.currentLevel;
                
                const starsEarned = Math.min(3, Math.floor(currentState.correctAnswersInLevel / level.questions * 3));
                
                if (!gameData.player.stars[level.id] || starsEarned > gameData.player.stars[level.id]) {
                    gameData.player.stars[level.id] = starsEarned;
                }
                
                const pointsAwarded = level.rewardPoints + (starsEarned * 10);
                const gemsAwarded = level.rewardGems + (starsEarned >= 3 ? 2 : starsEarned >= 2 ? 1 : 0);
                
                gameData.player.points += pointsAwarded;
                gameData.player.gems += gemsAwarded;
                
                const nextLevelId = level.id + 1;
                const nextLevelExists = gameData.levels.find(l => l.id === nextLevelId);
                if (nextLevelExists && !gameData.player.unlockedLevels.includes(nextLevelId)) {
                    gameData.player.unlockedLevels.push(nextLevelId);
                    nextLevelExists.unlocked = true;
                    document.getElementById('next-level-reward-item').style.display = 'flex';
                } else {
                    document.getElementById('next-level-reward-item').style.display = 'none';
                }
                
                gameData.player.xp += pointsAwarded;
                if (gameData.player.xp >= gameData.player.nextLevelXp) {
                    gameData.player.level++;
                    gameData.player.xp -= gameData.player.nextLevelXp;
                    gameData.player.nextLevelXp = Math.floor(gameData.player.nextLevelXp * 1.5);
                    alert(`ÿ™ŸáÿßŸÜŸäŸÜÿß! ŸÑŸÇÿØ ŸàÿµŸÑÿ™ ŸÑŸÑŸÖÿ≥ÿ™ŸàŸâ ${gameData.player.level}!`);
                }
                
                saveGameData();
                
                document.getElementById('earned-points').textContent = pointsAwarded;
                document.getElementById('complete-screen-points').textContent = `+${pointsAwarded}`;
                document.getElementById('complete-screen-gems').textContent = `+${gemsAwarded}`;
                
                const stars = [
                    document.getElementById('star-1'),
                    document.getElementById('star-2'),
                    document.getElementById('star-3')
                ];
                
                stars.forEach((star, index) => {
                    star.classList.remove('earned');
                    if (index < starsEarned) {
                        setTimeout(() => {
                            star.classList.add('earned');
                        }, index * 200);
                    }
                });
                
                playSound(sounds.levelComplete);
                createConfetti();
                
                showScreen(levelCompleteScreen);
            }
            
            function createConfetti() {
                const colors = ['#6C63FF', '#FFD166', '#06D6A0', '#EF476F', '#118AB2', '#FF9F1C', '#CBF3F0'];
                
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.top = `${Math.random() * -20}vh`;
                    confetti.style.width = `${Math.random() * 10 + 5}px`;
                    confetti.style.height = `${Math.random() * 10 + 5}px`;
                    confetti.style.animationDuration = `${Math.random() * 2 + 3}s`;
                    confetti.style.animationDelay = `${Math.random() * 1.5}s`;
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    
                    document.body.appendChild(confetti);
                    
                    gsap.to(confetti, {
                        y: window.innerHeight * 1.2,
                        x: (Math.random() - 0.5) * window.innerWidth * 0.5,
                        rotation: '+=720',
                        opacity: 0,
                        duration: 3 + Math.random() * 2,
                        ease: 'power1.in',
                        delay: Math.random() * 0.5,
                        onComplete: () => confetti.remove()
                    });
                }
            }
            
            // --- ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ™ÿ¨ÿ± ---
            function renderShopItems() {
                const shopItemsContainer = document.querySelector('.shop-items');
                shopItemsContainer.innerHTML = '';

                document.getElementById('shop-current-gems').textContent = gameData.player.gems;
                
                gameData.shopItems.forEach(item => {
                    const isOwned = gameData.player.inventory.includes(item.id);
                    const canAfford = gameData.player.gems >= item.price;
                    const isApplied = (item.type === 'avatar' && gameData.player.activeAvatar === item.id) ||
                                      (item.type === 'background' && gameData.player.activeBackground === item.id);
                    
                    const shopItem = document.createElement('div');
                    shopItem.className = 'shop-item';
                    shopItem.innerHTML = `
                        <div class="shop-item-image">${item.emoji}</div>
                        <h3 class="shop-item-name">${item.name}</h3>
                        <div class="shop-item-price">
                            <i class="fas fa-gem"></i>
                            <span>${item.price}</span>
                        </div>
                        <p class="shop-item-description">${item.description}</p>
                        <button class="shop-item-btn" 
                                data-id="${item.id}"
                                data-type="${item.type}"
                                ${isOwned ? '' : (canAfford ? '' : 'disabled')}>
                            ${isOwned ? (isApplied ? 'ŸÖŸèÿ∑ÿ®ŸÇ' : 'ÿ™ÿ∑ÿ®ŸäŸÇ') : (canAfford ? 'ÿ¥ÿ±ÿßÿ°' : 'ÿ¨ŸàÿßŸáÿ± ÿ∫Ÿäÿ± ŸÉÿßŸÅŸäÿ©')}
                        </button>
                    `;
                    
                    const btn = shopItem.querySelector('.shop-item-btn');
                    if (isOwned) {
                        btn.classList.add('owned');
                        if (isApplied) btn.classList.add('applied');
                        btn.textContent = isApplied ? 'ŸÖŸèÿ∑ÿ®ŸÇ' : 'ÿ™ÿ∑ÿ®ŸäŸÇ';
                        btn.disabled = false;
                    } else if (!canAfford) {
                        btn.classList.add('not-enough');
                        btn.disabled = true;
                    }

                    btn.addEventListener('click', () => {
                        if (isOwned) {
                            applyItem(item);
                        } else {
                            purchaseItem(item);
                        }
                    });
                    
                    shopItemsContainer.appendChild(shopItem);
                });
            }
            
            function purchaseItem(item) {
                playSound(sounds.buttonClick);
                if (gameData.player.gems >= item.price) {
                    gameData.player.gems -= item.price;
                    gameData.player.inventory.push(item.id);
                    
                    if (item.type === 'power_up') {
                        alert(`ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ${item.name} ÿ®ŸÜÿ¨ÿßÿ≠! ŸÑÿØŸäŸÉ ÿßŸÑÿ¢ŸÜ ${item.quantity} ŸÖŸÜ ${item.name}.`);
                    } else {
                        alert(`ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ${item.name} ÿ®ŸÜÿ¨ÿßÿ≠!`);
                    }
                    
                    saveGameData();
                    updateProfileUI();
                    renderShopItems();
                } else {
                    alert('ŸÑÿß ÿ™ŸÖŸÑŸÉ ÿ¨ŸàÿßŸáÿ± ŸÉÿßŸÅŸäÿ© ŸÑÿ¥ÿ±ÿßÿ° Ÿáÿ∞ÿß ÿßŸÑÿπŸÜÿµÿ±!');
                }
            }

            function applyItem(item) {
                playSound(sounds.buttonClick);
                if (item.type === 'avatar') {
                    if (gameData.player.activeAvatar !== item.id) {
                        gameData.player.activeAvatar = item.id;
                        document.getElementById('profile-avatar').textContent = item.emoji;
                        alert(`ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿ¥ÿÆÿµŸäÿ© ${item.name}!`);
                    } else {
                        gameData.player.activeAvatar = null;
                        document.getElementById('profile-avatar').textContent = gameData.player.avatar;
                        alert(`ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ™ÿ∑ÿ®ŸäŸÇ ÿ¥ÿÆÿµŸäÿ© ${item.name}!`);
                    }
                } else if (item.type === 'background') {
                    if (gameData.player.activeBackground !== item.id) {
                        gameData.player.activeBackground = item.id;
                        applyPlayerSettings(); // Reapply settings to update background
                        alert(`ÿ™ŸÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿÆŸÑŸÅŸäÿ© ${item.name}!`);
                    } else {
                        gameData.player.activeBackground = null;
                        applyPlayerSettings(); // Reapply settings to remove background
                        alert(`ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿ™ÿ∑ÿ®ŸäŸÇ ÿÆŸÑŸÅŸäÿ© ${item.name}!`);
                    }
                } else if (item.type === 'emoji_pack') {
                    alert(`ÿ≠ÿ≤ŸÖÿ© ${item.name} ŸÖÿ™ÿßÿ≠ÿ© ÿßŸÑÿ¢ŸÜ ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÅŸä ÿßŸÑŸÑÿπÿ®ÿ©!`);
                }
                saveGameData();
                renderShopItems();
            }
            
            // --- ŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä ---
            function updateDailyChallengeUI() {
                const challenge = gameData.dailyChallenge;
                document.getElementById('daily-challenge-title').textContent = challenge.title;
                document.getElementById('daily-challenge-desc').textContent = challenge.description;
                
                const progressPercentage = (currentState.dailyChallenge.correctQuestions / challenge.goal) * 100;
                document.getElementById('challenge-progress').style.width = `${progressPercentage}%`;
                
                document.getElementById('challenge-completed').textContent = 
                    `${currentState.dailyChallenge.correctQuestions}/${challenge.goal} ŸÖŸÉÿ™ŸÖŸÑ`;
                
                const minutes = Math.floor(currentState.dailyChallenge.timeLimit / 60);
                const seconds = currentState.dailyChallenge.timeLimit % 60;
                document.getElementById('challenge-time').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} ŸÖÿ™ÿ®ŸÇŸä`;
            }

            // --- ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä ---
            function updateProfileUI() {
                document.getElementById('profile-name').textContent = gameData.player.name;
                document.getElementById('profile-level').textContent = gameData.player.level;
                
                const progressPercentage = (gameData.player.xp / gameData.player.nextLevelXp) * 100;
                document.getElementById('profile-progress-bar').style.width = `${progressPercentage}%`;
                document.getElementById('profile-current-xp').textContent = gameData.player.xp;
                document.getElementById('profile-next-xp').textContent = gameData.player.nextLevelXp;
                
                document.getElementById('total-points').textContent = gameData.player.points.toLocaleString();
                document.getElementById('total-levels').textContent = gameData.player.unlockedLevels.length;
                document.getElementById('total-stars').textContent = Object.values(gameData.player.stars).reduce((a, b) => a + b, 0);
                document.getElementById('total-gems').textContent = gameData.player.gems;

                if (document.getElementById('current-gems')) {
                    document.getElementById('current-gems').textContent = gameData.player.gems;
                }
            }

            function editProfile() {
                playSound(sounds.buttonClick);
                const newName = prompt('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ÿßŸÑÿ¨ÿØŸäÿØ:', gameData.player.name);
                if (newName && newName.trim() !== '') {
                    gameData.player.name = newName.trim();
                }
                
                if (!gameData.player.activeAvatar) {
                    const newAvatarChar = prompt('ÿ£ÿØÿÆŸÑ ÿ≠ÿ±ŸÅŸãÿß ÿ£Ÿà ÿ±ŸÖÿ≤Ÿãÿß ÿ¨ÿØŸäÿØŸãÿß ŸÑÿ±ŸÖÿ≤ŸÉ (ŸÖÿ´ÿßŸÑ: ÿ£, üòÑ):', gameData.player.avatar);
                    if (newAvatarChar && newAvatarChar.trim() !== '') {
                        gameData.player.avatar = newAvatarChar.trim().substring(0, 1);
                    }
                }
                saveGameData();
                updateProfileUI();
                alert('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸÑŸÅŸÉ ÿßŸÑÿ¥ÿÆÿµŸä!');
            }
            
            // --- ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´ ---
            startGameBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                showScreen(levelSelectScreen);
            });
            
            dailyChallengeBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                showScreen(dailyChallengeScreen);
                currentState.isDailyChallengeActive = true;
                currentState.dailyChallenge.correctQuestions = 0;
                currentState.dailyChallenge.timeLimit = gameData.dailyChallenge.timeLimit;
                updateDailyChallengeUI();
                clearInterval(currentState.dailyChallenge.timerInterval);
                currentState.dailyChallenge.timerInterval = setInterval(() => {
                    currentState.dailyChallenge.timeLimit--;
                    if (currentState.dailyChallenge.timeLimit <= 0) {
                        clearInterval(currentState.dailyChallenge.timerInterval);
                        alert('ÿßŸÜÿ™ŸáŸâ ŸàŸÇÿ™ ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä!');
                        currentState.isDailyChallengeActive = false;
                    } else if (currentState.dailyChallenge.correctQuestions < gameData.dailyChallenge.goal) {
                        // Simulate answering questions
                        currentState.dailyChallenge.correctQuestions++;
                    } else {
                         clearInterval(currentState.dailyChallenge.timerInterval);
                         alert('ÿ™ŸáÿßŸÜŸäŸÜÿß! ŸÑŸÇÿØ ÿ£ŸÉŸÖŸÑÿ™ ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä Ÿàÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ ÿ¨Ÿàÿßÿ¶ÿ≤!');
                         gameData.player.gems += gameData.dailyChallenge.rewardGems;
                         gameData.player.xp += gameData.dailyChallenge.rewardXp;
                         saveGameData();
                         updateProfileUI();
                         currentState.isDailyChallengeActive = false;
                    }
                    updateDailyChallengeUI();
                }, 1000);
            });
            
            backToLevelsBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                showScreen(levelSelectScreen);
            });
            
            nextBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                // NEW: Logic for next button press
                if (currentState.currentLevel && currentState.currentStage < currentState.currentLevel.questions && currentState.isCorrectLastQuestion) {
                    showNextStageModal(); // Show modal only if correct and not last stage
                } else {
                    _proceedToNextQuestionOrComplete(); // Proceed directly if wrong or last stage
                }
            });

            modalContinueBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                hideNextStageModal(); // This will call _proceedToNextQuestionOrComplete()
            });

            modalBackToLevelsBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                nextStageModalOverlay.classList.remove('show'); // Hide modal
                showScreen(levelSelectScreen);
            });
            
            nextLevelCompleteBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                const nextLevelId = currentState.currentLevel.id + 1;
                const nextLevel = gameData.levels.find(level => level.id === nextLevelId);
                
                if (nextLevel && gameData.player.unlockedLevels.includes(nextLevel.id)) {
                    startLevel(nextLevel);
                } else {
                    showScreen(levelSelectScreen);
                }
            });
            
            backToLevelsCompleteBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                showScreen(levelSelectScreen);
            });
            
            startChallengeBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                alert('ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä ŸÇŸäÿØ ÿßŸÑÿ™ÿ∑ŸàŸäÿ±! üöß');
                currentState.isDailyChallengeActive = true;
                currentState.dailyChallenge.correctQuestions = 0;
                currentState.dailyChallenge.timeLimit = gameData.dailyChallenge.timeLimit;
                updateDailyChallengeUI();
                clearInterval(currentState.dailyChallenge.timerInterval);
                currentState.dailyChallenge.timerInterval = setInterval(() => {
                    currentState.dailyChallenge.timeLimit--;
                    if (currentState.dailyChallenge.timeLimit <= 0) {
                        clearInterval(currentState.dailyChallenge.timerInterval);
                        alert('ÿßŸÜÿ™ŸáŸâ ŸàŸÇÿ™ ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä!');
                        currentState.isDailyChallengeActive = false;
                    } else if (currentState.dailyChallenge.correctQuestions < gameData.dailyChallenge.goal) {
                        currentState.dailyChallenge.correctQuestions++;
                    } else {
                         clearInterval(currentState.dailyChallenge.timerInterval);
                         alert('ÿ™ŸáÿßŸÜŸäŸÜÿß! ŸÑŸÇÿØ ÿ£ŸÉŸÖŸÑÿ™ ÿßŸÑÿ™ÿ≠ÿØŸä ÿßŸÑŸäŸàŸÖŸä Ÿàÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ ÿ¨Ÿàÿßÿ¶ÿ≤!');
                         gameData.player.gems += gameData.dailyChallenge.rewardGems;
                         gameData.player.xp += gameData.dailyChallenge.rewardXp;
                         saveGameData();
                         updateProfileUI();
                         currentState.isDailyChallengeActive = false;
                    }
                    updateDailyChallengeUI();
                }, 1000);
            });
            
            // ÿßŸÑÿ™ŸÜŸÇŸÑ
            navHome.addEventListener('click', (e) => { e.preventDefault(); playSound(sounds.buttonClick); showScreen(startScreen); });
            navLevels.addEventListener('click', (e) => { e.preventDefault(); playSound(sounds.buttonClick); renderLevels(); showScreen(levelSelectScreen); });
            navShop.addEventListener('click', (e) => { e.preventDefault(); playSound(sounds.buttonClick); renderShopItems(); showScreen(shopScreen); });
            navProfile.addEventListener('click', (e) => { e.preventDefault(); playSound(sounds.buttonClick); updateProfileUI(); showScreen(profileScreen); });
            navSettings.addEventListener('click', (e) => { e.preventDefault(); playSound(sounds.buttonClick); applyPlayerSettings(); showScreen(settingsScreen); });
            
            // ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ¶ÿ©
            document.querySelectorAll('.category-btn').forEach(button => {
                button.addEventListener('click', () => {
                    playSound(sounds.buttonClick);
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderLevels(button.dataset.category);
                });
            });

            // ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
            soundEffectsToggle.addEventListener('change', (e) => {
                gameData.player.settings.soundEffects = e.target.checked;
                saveGameData();
            });
            backgroundMusicToggle.addEventListener('change', (e) => {
                gameData.player.settings.backgroundMusic = e.target.checked;
                playBackgroundMusic();
                saveGameData();
            });
            vibrationToggle.addEventListener('change', (e) => {
                gameData.player.settings.vibration = e.target.checked;
                saveGameData();
            });

            // ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            resetDataBtn.addEventListener('click', resetGameData);
            logoutBtn.addEventListener('click', () => { alert('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨. (Ÿáÿ∞Ÿá ŸÖŸäÿ≤ÿ© ŸàŸáŸÖŸäÿ©)'); });

            // ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä
            editProfileBtn.addEventListener('click', editProfile);

            // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÑÿπÿ®ÿ©
            initGame();
        });
    </script>
</body>
</html>
