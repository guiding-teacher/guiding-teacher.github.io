
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>مغامرة تعلم اللهجة العراقية</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #7E57C2;
            --secondary-color: #5E35B1;
            --accent-color: #66BB6A;
            --text-color: #212121;
            --text-light: #FFFFFF;
            --bg-color: #ECEFF1;
            --app-bg-color-start: #e0f7fa;
            --app-bg-color-end: #b2ebf2;
            --card-bg: #ffffff;
            --button-hover: #4A148C;
            --correct-color: #4CAF50;
            --incorrect-color: #F44336;
            --known-color: #FFB300;
            --unknown-color: #E53935;
            --skip-color: #78909C;
            --skip-hover-color: #546E7A;
            --border-radius: 18px;
            --box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            --font-family: 'Cairo', sans-serif;
            --hover-glow: 0 0 15px rgba(var(--accent-rgb, 102, 187, 106), 0.5); /* RGB for accent color */
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-top: 75px;
            transition: background-color 0.5s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            width: 100%;
            max-width: 600px;
            background: linear-gradient(145deg, var(--app-bg-color-start) 0%, var(--app-bg-color-end) 100%);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 25px;
        }

        header {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        header h1 {
            font-size: 1.3em;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
        }
        
        .close-btn-header {
            cursor:pointer; 
            margin-left:18px;
            font-size: 1.6em;
            line-height: 1;
            transition: transform 0.2s ease;
        }
        .close-btn-header:hover {
            transform: scale(1.1);
        }

        .version-info {
            font-size: 0.9em;
            opacity: 0.9;
        }

        nav {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            background-color: #ffffff;
            padding: 8px 5px;
            border-bottom: 1px solid #CFD8DC;
        }

        nav button {
            background-color: #f5f5f5;
            color: var(--secondary-color);
            border: none;
            padding: 12px 10px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            border-radius: 10px;
            transition: background-color 0.2s, color 0.2s, transform 0.1s, box-shadow 0.2s;
            margin: 0 3px;
            text-align: center;
        }
        nav button:hover {
             box-shadow: var(--hover-glow);
        }

        nav button.active {
            background-color: var(--accent-color);
            color: var(--text-light);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        nav button:hover:not(.active) {
            background-color: #e0e0e0;
            transform: translateY(-1px);
        }
        nav button:active:not(.active) {
            transform: translateY(0px);
        }

        .section {
            display: none;
            padding: 25px;
            min-height: 420px;
            animation: fadeIn 0.4s ease-out;
            position: relative;
        }

        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            text-align: center;
            color: var(--secondary-color);
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 25px;
        }
        
        /* MODIFIED: Learn Section Progress Bar */
        #learn-section .progress-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            padding: 10px 15px; 
            background-color: rgba(255,255,255,0.5); 
            border-radius: 12px; 
        }
        #learn-section #learn-difficulty-subtitle {
            margin: 0;
            font-size: 1em;
            font-weight: 600;
            color: var(--secondary-color);
        }
        #learn-section .score-display { display: flex; align-items: center; font-size: 1.1em; }
        #learn-section .flame-container { display: flex; align-items: center; background-color: #FFA000; padding: 6px 12px; border-radius: 20px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #learn-section .flame-icon { font-size: 1.5em; margin-right: 6px; }
        #learn-section .flame-streak { font-weight: 700; }
        #learn-section .learn-progress-text { font-weight: 600; color: var(--secondary-color); }


        .start-game-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%; 
            position: absolute; 
            top: 0;
            left: 0;
            background-color: rgba(224, 247, 250, 0.85); 
            z-index: 5;
            padding: 20px;
            box-sizing: border-box;
        }
        #start-game-btn {
            padding: 20px 40px;
            font-size: 1.5em;
            font-weight: 700;
            border-radius: var(--border-radius);
            cursor: pointer;
            border: none;
            color: var(--text-light);
            background-color: var(--accent-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }
        #start-game-btn:hover {
            background-color: var(--secondary-color);
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }


        .flashcard-container {
            perspective: 1200px;
            width: 100%;
            height: 300px;
            margin-bottom: 25px;
            cursor: pointer;
            position: relative; 
        }

        .flashcard {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.25, 0.8, 0.25, 1);
            background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--border-radius);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            color: var(--text-light);
        }
        .flashcard.flipped { transform: rotateY(180deg); }

        .flashcard-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            padding: 25px; box-sizing: border-box; border-radius: var(--border-radius);
        }
        .flashcard-back { transform: rotateY(180deg); }
        .flashcard .flag { width: 55px; margin-bottom: 12px; }
        .flashcard .main-text { font-size: 2.4em; font-weight: 700; margin-bottom: 18px; line-height: 1.3; transition: opacity 0.3s; }
        .flashcard .pronunciation, .flashcard .example { font-size: 1.15em; margin-bottom: 10px; opacity: 0.9; transition: opacity 0.3s; }
        .flashcard .explanation { font-size: 1.05em; margin-top: 12px; font-style: italic; color: #E0E0E0; line-height: 1.5; transition: opacity 0.3s;}

        .audio-button-container { text-align: center; margin-bottom: 20px; }
        .audio-btn {
            background-color: var(--accent-color); color: var(--text-light); border: none;
            padding: 10px 18px; font-size: 0.95em; font-weight: 600; border-radius: 10px;
            cursor: pointer; margin: 0 6px; transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .audio-btn:hover { background-color: #558B2F; transform: translateY(-1px); box-shadow: var(--hover-glow);}
        .audio-btn:active { transform: translateY(0px); }
        .audio-btn:disabled { background-color: #BDBDBD; cursor: not-allowed; opacity: 0.7; }

        /* MODIFIED: Learn Actions Buttons Layout */
        .learn-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .learn-actions button {
            padding: 14px 10px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            border: none;
            color: var(--text-light);
            margin: 0;
            min-width: auto;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        .learn-actions button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 10px rgba(0,0,0,0.15), var(--hover-glow); 
        }
        .learn-actions button:active { 
            transform: translateY(0px); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }

        #hint-btn { background-color: var(--known-color); }
        #hint-btn:hover { background-color: #FF8F00; }
        #dont-know-btn { background-color: var(--unknown-color); }
        #dont-know-btn:hover { background-color: #C62828; }
        #next-card-btn { background-color: var(--skip-color); }
        #next-card-btn:hover { background-color: var(--skip-hover-color); }
        
        .completion-message { text-align: center; font-size: 1.2em; color: var(--accent-color); margin-top: 20px; font-weight: 600; animation: pulseCorrect 1s infinite alternate; }


        /* MODIFIED: Quiz Section */
        #quiz-section .section-title { margin-bottom: 15px;}
        .quiz-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(255,255,255,0.7);
            padding: 10px 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 1em;
            font-weight: 600;
            color: #455A64;
        }
        .quiz-status-bar > div { margin: 0; }
        #quiz-difficulty-subtitle { color: var(--secondary-color); }

        #quiz-question { font-size: 1.35em; text-align: center; margin-bottom: 25px; padding: 18px; background-color: rgba(255,255,255,0.75); border-radius: var(--border-radius); box-shadow: 0 2px 5px rgba(0,0,0,0.05); line-height: 1.4; }
        .options-container button {
            display: block; width: 100%; background-color: var(--card-bg); color: var(--text-color);
            border: 1px solid #B0BEC5; padding: 16px; margin-bottom: 12px;
            font-size: 1.1em; font-weight: 600; border-radius: 12px; cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, border-color 0.2s, box-shadow 0.2s;
        }
        .options-container button:hover { background-color: #f1f8e9; border-color: var(--accent-color); transform: translateY(-1px); box-shadow: var(--hover-glow); }
        .options-container button.correct { background-color: var(--correct-color) !important; color: var(--text-light); border-color: var(--correct-color); animation: pulseCorrect 0.5s; }
        .options-container button.incorrect { background-color: var(--incorrect-color) !important; color: var(--text-light); border-color: var(--incorrect-color); animation: shakeIncorrect 0.5s; }
        @keyframes pulseCorrect { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shakeIncorrect { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        #quiz-feedback { text-align: center; font-size: 1.25em; font-weight: 700; margin-top: 18px; min-height: 32px; }
        .quiz-actions { display: flex; justify-content: space-around; margin-top: 25px; }
        .quiz-actions button { padding: 14px 22px; font-size: 1.05em; border-radius: 12px; cursor: pointer; border: none; color: var(--text-light); font-weight: 600; transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s; }
        .quiz-actions button:hover { transform: translateY(-2px); box-shadow: var(--hover-glow); }
        #next-question-btn { background-color: var(--secondary-color); }
        #new-quiz-btn { background-color: var(--accent-color); }


        /* Combined Progress & Achievements Section */
        #stats-achievements-section .stat-item { background-color: var(--card-bg); padding: 18px; margin-bottom: 15px; border-radius: 12px; box-shadow: 0 3px 7px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        #stats-achievements-section .stat-item h3 { margin: 0; font-size: 1.15em; color: var(--secondary-color); font-weight: 600; }
        #stats-achievements-section .stat-item .value { font-size: 1.2em; font-weight: 700; color: var(--accent-color); }
        
        #stats-achievements-section .progress-chart-container { margin-top: 30px; background-color: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 3px 7px rgba(0,0,0,0.08); }
        #stats-achievements-section .progress-chart-container h3 { text-align: center; margin-bottom: 15px; color: var(--secondary-color); }
        #stats-achievements-section .chart-bar-outer { background-color: #E0E0E0; border-radius: 10px; height: 25px; overflow: hidden; }
        #stats-achievements-section .chart-bar-inner { background: linear-gradient(90deg, var(--accent-color), #81C784); height: 100%; width: 0%; border-radius: 10px; transition: width 1s ease-out; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;}

        #stats-achievements-section .achievement-item { background-color: var(--card-bg); padding: 18px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 3px 7px rgba(0,0,0,0.08); border-left: 6px solid var(--secondary-color); transition: border-left-color 0.3s, transform 0.2s; }
        #stats-achievements-section .achievement-item:hover { transform: translateY(-2px); }
        #stats-achievements-section .achievement-item.unlocked { border-left-color: var(--known-color); }
        #stats-achievements-section .achievement-item h3 { margin-top: 0; margin-bottom: 6px; color: var(--secondary-color); font-weight: 600; display: flex; align-items: center; }
        #stats-achievements-section .achievement-item.unlocked h3 { color: var(--known-color); }
        #stats-achievements-section .achievement-item h3 .trophy-icon { margin-right: 8px; font-size: 1.2em; }
        #stats-achievements-section .achievement-item p { margin-bottom: 12px; font-size: 0.95em; color: #455A64; }
        #stats-achievements-section .progress-bar-container { background-color: #E0E0E0; border-radius: 8px; height: 12px; overflow: hidden; margin-top: 8px; }
        #stats-achievements-section .progress-bar-fill { background-color: var(--accent-color); height: 100%; width: 0%; border-radius: 8px; transition: width 0.6s ease-in-out; }
        #stats-achievements-section .achievement-item.unlocked .progress-bar-fill { background-color: var(--known-color); }
        
        #stats-achievements-section .difficulty-stats-group { background-color: rgba(255,255,255,0.6); padding: 15px; margin-bottom: 20px; border-radius: var(--border-radius); border: 1px solid #CFD8DC; }
        #stats-achievements-section .difficulty-stats-group h4 { color: var(--secondary-color); font-size: 1.4em; font-weight: 700; margin-top: 0; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid var(--primary-color); }
        #stats-achievements-section .difficulty-stats-group .stat-line { display: flex; justify-content: space-between; align-items: center; font-size: 1.05em; margin-bottom: 10px; padding: 8px; background-color: rgba(255,255,255,0.7); border-radius: 8px; }
        #stats-achievements-section .difficulty-stats-group .stat-line .label { font-weight: 600; color: #37474F; }
        #stats-achievements-section .difficulty-stats-group .stat-line .value { font-weight: 700; color: var(--accent-color); }


        /* Settings Section */
        #settings-section .setting-group { margin-bottom: 28px; background-color: rgba(255,255,255,0.75); padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
        #settings-section .setting-group h3 { margin-top: 0; margin-bottom: 15px; color: var(--secondary-color); border-bottom: 1px solid #CFD8DC; padding-bottom: 8px; font-weight: 600; }
        #settings-section .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; }
        .difficulty-options button, .color-options span, .bg-color-options span {
            padding: 10px 14px; margin: 0; border-radius: 8px; cursor: pointer;
            border: 2px solid transparent; background-color: #E0E0E0; font-weight: 600; text-align: center;
            transition: background-color 0.2s, border-color 0.2s, transform 0.1s, box-shadow 0.2s;
        }
        .difficulty-options button:hover, .color-options span:hover, .bg-color-options span:hover { transform: translateY(-1px); box-shadow: var(--hover-glow);}
        .difficulty-options button.active { background-color: var(--accent-color); color: var(--text-light); border-color: var(--accent-color); }
        .color-options span, .bg-color-options span { display: inline-block; width: 35px; height: 35px; border-radius: 50%; }
        .color-options span.active, .bg-color-options span.active { border-color: var(--text-color); box-shadow: 0 0 0 2px var(--text-color) inset; }
        .checkbox-option { display: flex; align-items: center; margin-bottom: 12px; }
        .checkbox-option label { font-weight: 600; color: #37474F; margin-right: auto; }
        .checkbox-option input[type="checkbox"] { margin-left: 10px; width: 18px; height: 18px; accent-color: var(--accent-color); }
        #reset-progress-btn {
            background-color: var(--unknown-color); color: var(--text-light); padding: 14px 22px;
            font-size: 1.05em; border-radius: 12px; cursor: pointer; border: none; display: block;
            width: 100%; margin-top: 20px; font-weight: 600; transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        }
        #reset-progress-btn:hover { background-color: #C62828; transform: translateY(-2px); box-shadow: var(--hover-glow);}
        
        .smiley-mascot {
            position: fixed; bottom: 25px; right: 25px; font-size: 3.2em; background-color: gold;
            width: 65px; height: 65px; border-radius: 50%; display: flex; justify-content: center;
            align-items: center; box-shadow: 0 0 15px rgba(0,0,0,0.35); z-index: 1001;
            transition: transform 0.2s ease-out, box-shadow 0.2s;
        }
        .smiley-mascot:hover { transform: scale(1.1) rotate(10deg); box-shadow: 0 0 25px gold;}
        .hidden { display: none !important; }

        #learn-section .flashcard-container.hidden-initial,
        #learn-section .audio-button-container.hidden-initial,
        #learn-section .learn-actions.hidden-initial {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-out;
        }
         #learn-section .flashcard-container.visible-content,
        #learn-section .audio-button-container.visible-content,
        #learn-section .learn-actions.visible-content {
            opacity: 1;
            pointer-events: auto;
        }


        @media (max-width: 480px) {
            body { padding-top: 65px; }
            nav { grid-template-columns: repeat(2, 1fr); gap: 5px; }
            nav button { font-size: 0.75em; padding: 10px 6px; }
            .section-title { font-size: 1.8em; }
            .section { padding: 20px; min-height: auto; }
            .flashcard .main-text { font-size: 2.0em; }
            .flashcard .pronunciation, .flashcard .example { font-size: 1.0em; }
            .flashcard-container { height: 270px; }
            #quiz-question { font-size: 1.2em; }
            .options-container button { font-size: 0.95em; padding: 12px; }
            .learn-actions button { font-size: 0.9em; padding: 12px 8px; }
            .smiley-mascot { font-size: 2.8em; width: 55px; height: 55px; bottom: 20px; right: 20px; }
            #settings-section .options-grid { grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); }
            #start-game-btn { font-size: 1.3em; padding: 15px 30px; }
            .quiz-status-bar { font-size: 0.9em; padding: 8px 10px; }
            #learn-section .progress-info { flex-wrap: wrap; justify-content: center; gap: 10px; }
        }
    </style>
</head>
<body>
    <header>
        <h1><span class="close-btn-header" title="العودة للتعلم">✕</span>مغامرة اللهجة</h1>
        <div class="version-info">الإصدار 3.9.0</div>
    </header>

    <div class="app-container">
        <nav>
            <button id="nav-learn" class="active">🧠 تعلم</button>
            <button id="nav-quiz">❓ اختبار</button>
            <button id="nav-stats-achievements">🏆 تقدمي</button>
            <button id="nav-settings">⚙️ إعدادات</button>
        </nav>

        <section id="learn-section" class="section active">
            <h2 class="section-title">مغامرة تعلم</h2>
            
            <!-- MODIFIED: Progress Bar Layout -->
            <div class="progress-info">
                <div id="learn-difficulty-subtitle">المستوى: سهل</div>
                <div class="score-display">
                    <div class="flame-container">
                        <span class="flame-icon">🔥</span>
                        <span id="learn-streak" class="flame-streak">1</span>
                    </div>
                </div>
                <div class="learn-progress-text" id="learn-progress">0/0 :التقدم</div>
            </div>

            <div class="start-game-container" id="start-game-container">
                <button id="start-game-btn">🚀 ابدأ التعلم 🚀</button>
            </div>
            
            <div class="audio-button-container hidden-initial" id="learn-audio-buttons">
                <button class="audio-btn" id="audio-en-learn">🔊 انكليزي</button>
                <button class="audio-btn" id="audio-iq-learn">🔊 عراقي</button>
                <button class="audio-btn" id="audio-sa-learn">🔊 الشرح</button>
            </div>

            <div class="flashcard-container hidden-initial" id="flashcard-clickable-area">
                <div class="flashcard" id="flashcard">
                    <div class="flashcard-face flashcard-front">
                        <p class="main-text" id="flashcard-front-text"></p>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f6/Flag_of_Iraq.svg/125px-Flag_of_Iraq.svg.png" alt="Iraq Flag" class="flag">
                        <p class="main-text" id="flashcard-back-iraqi"></p>
                        <p class="pronunciation" id="flashcard-pronunciation"></p>
                        <p class="example" id="flashcard-example"></p>
                        <p class="explanation" id="flashcard-explanation"></p>
                    </div>
                </div>
            </div>
            <div id="learn-completion-message" class="completion-message hidden">🎉 رائع! لقد تعلمت كل الكلمات في هذا المستوى! 🎉</div>
            
            <!-- MODIFIED: Action Buttons Layout -->
            <div class="learn-actions hidden-initial" id="learn-main-actions">
                <button id="hint-btn">أعرفها 👍</button>
                <button id="dont-know-btn">لا أعرفها ❌</button>
                <button id="next-card-btn">تخطي ⏭️</button>
            </div>
        </section>

        <section id="quiz-section" class="section">
            <h2 class="section-title">اختبار اللهجة العراقية</h2>
            
            <!-- MODIFIED: Quiz Status Bar Layout -->
            <div class="quiz-status-bar">
                <div id="quiz-difficulty-subtitle">المستوى: سهل</div>
                <div id="quiz-progress">السؤال: 1/0</div>
                <div id="quiz-score-display">النتيجة: 0</div>
            </div>

            <div class="audio-button-container">
                <button class="audio-btn" id="audio-en-quiz">🔊 السؤال (انكليزي)</button>
            </div>

            <div id="quiz-question">ما هي ترجمة كلمة "Word" باللهجة العراقية؟</div>
            <div class="options-container" id="quiz-options"></div>
            <div id="quiz-feedback"></div>
            <div class="quiz-actions">
                <button id="new-quiz-btn" class="hidden">اختبار جديد 🔄</button>
                <button id="next-question-btn" class="hidden">السؤال التالي ❯</button>
            </div>
        </section>

        <section id="stats-achievements-section" class="section">
            <h2 class="section-title">📈 إنجازاتي وتقدمي</h2>
            
            <h3 style="text-align:center; margin-bottom:15px; color:var(--secondary-color);">ملخص التقدم العام</h3>
            <div class="stat-item">
                <h3>إجمالي الكلمات/الجمل المتعلمة (كل المستويات)</h3>
                <span class="value" id="stats-total-learned">0</span>
            </div>
            <div class="stat-item">
                <h3>أطول سلسلة تعلم (أفضل مستوى)</h3>
                <span class="value" id="stats-max-streak">0 🔥</span>
            </div>
            <div class="stat-item">
                <h3>متوسط الدقة في الاختبارات (إجمالي)</h3>
                <span class="value" id="stats-quiz-accuracy">0%</span>
            </div>
            <div class="stat-item">
                <h3>عدد الاختبارات المكتملة (إجمالي)</h3>
                <span class="value" id="stats-quizzes-completed">0</span>
            </div>
            <div class="progress-chart-container">
                <h3>التقدم العام في تعلم كل المحتوى</h3>
                <div class="chart-bar-outer">
                    <div class="chart-bar-inner" id="stats-overall-progress-bar">0%</div>
                </div>
            </div>

            <h3 style="text-align:center; margin-top:30px; margin-bottom:15px; color:var(--secondary-color);">النتائج التفصيلية لكل مستوى</h3>
            <div id="difficulty-stats-display"></div>

            <h3 style="text-align:center; margin-top:30px; margin-bottom:15px; color:var(--secondary-color);">الإنجازات العامة</h3>
            <div id="achievements-list"></div>
        </section>

        <section id="settings-section" class="section">
            <h2 class="section-title">الإعدادات</h2>
            <div class="setting-group">
                <h3>مستوى الصعوبة</h3>
                <div class="difficulty-options options-grid">
                    <button data-difficulty="easy" class="active">سهل</button>
                    <button data-difficulty="medium">متوسط</button>
                    <button data-difficulty="hard">صعب</button>
                </div>
            </div>
            <div class="setting-group">
                <h3>ألوان التطبيق</h3>
                <div class="color-options options-grid">
                    <span data-color-theme="default" class="active" style="background-color: #7E57C2;" title="بنفسجي (افتراضي)"></span>
                    <span data-color-theme="green" style="background-color: #66BB6A;" title="أخضر"></span>
                    <span data-color-theme="blue" style="background-color: #42A5F5;" title="أزرق"></span>
                    <span data-color-theme="orange" style="background-color: #FFA726;" title="برتقالي"></span>
                </div>
            </div>
             <div class="setting-group">
                <h3>لون خلفية الصفحة</h3>
                <div class="bg-color-options options-grid">
                    <span data-bg-color="#ECEFF1" class="active" style="background-color: #ECEFF1;" title="رمادي أزرق فاتح (افتراضي)"></span>
                    <span data-bg-color="#E8F5E9" style="background-color: #E8F5E9;" title="أخضر فاتح"></span>
                    <span data-bg-color="#E3F2FD" style="background-color: #E3F2FD;" title="أزرق سماوي فاتح"></span>
                    <span data-bg-color="#FFF3E0" style="background-color: #FFF3E0;" title="برتقالي فاتح"></span>
                </div>
            </div>
            <div class="setting-group">
                <h3>خيارات أخرى</h3>
                <div class="checkbox-option">
                    <label for="auto-flip-card">قلب البطاقة تلقائيا (3 ثوانٍ)</label>
                    <input type="checkbox" id="auto-flip-card">
                </div>
                <div class="checkbox-option">
                    <label for="show-examples">إظهار أمثلة للكلمات</label>
                    <input type="checkbox" id="show-examples" checked>
                </div>
                 <div class="checkbox-option">
                    <label for="enable-vibration">تفعيل الاهتزاز للتفاعلات</label>
                    <input type="checkbox" id="enable-vibration" checked>
                </div>
                <div class="checkbox-option">
                    <label for="enable-sound">تفعيل المؤثرات الصوتية</label>
                    <input type="checkbox" id="enable-sound" checked>
                </div>
            </div>
            <button id="reset-progress-btn">إعادة ضبط كل التقدم Reset</button>
        </section>
    </div>


    <script>
        // --- DATA (EXPANDED) ---
        const wordsData = [
            // --- EASY --- (Original + New)
            { id: 1, difficulty: 'easy', purpose: 'learn', english: "Hello", iraqi: "سلام", pronunciation: "سَلام", example: "سلام عليكم شلونكم؟", explanation: "كلمة ترحيب شائعة تعني السلام عليكم." },
            { id: 2, difficulty: 'easy', purpose: 'learn', english: "How are you?", iraqi: "شلونك؟", pronunciation: "شلونَك (m) / شلونِچ (f)", example: "شلونك اليوم؟", explanation: "سؤال عن الحال. 'شلونك' للذكر و 'شلونچ' للأنثى." },
            { id: 3, difficulty: 'easy', purpose: 'learn', english: "Good morning", iraqi: "صباح الخير", pronunciation: "صَباح الخير", example: "صباح الخير يا جماعة.", explanation: "تحية صباحية تعني 'صباح الخير'." },
            { id: 4, difficulty: 'easy', purpose: 'learn', english: "Please", iraqi: "رجاءً", pronunciation: "رَجاءً", example: "رجاءً، انطيني الماي.", explanation: "'رجاءً' للطلب." },
            { id: 5, difficulty: 'easy', purpose: 'learn', english: "Thank you", iraqi: "شكراً", pronunciation: "شُكراً", example: "مشكور ما قصرت.", explanation: "كلمة للتعبير عن الشكر." },
            { id: 6, difficulty: 'easy', purpose: 'learn', english: "Yes", iraqi: "إي", pronunciation: "إي", example: "إي، آني موافق.", explanation: "كلمة للموافقة أو التأكيد." },
            { id: 7, difficulty: 'easy', purpose: 'learn', english: "No", iraqi: "لا", pronunciation: "لا", example: "لا، ما أريد.", explanation: "كلمة للرفض أو النفي." },
            { id: 8, difficulty: 'easy', purpose: 'learn', english: "Water", iraqi: "ماي", pronunciation: "ماي", example: "أريد أشرب ماي.", explanation: "الماء الصالح للشرب." },
            { id: 9, difficulty: 'easy', purpose: 'learn', english: "Food", iraqi: "أكل", pronunciation: "أكِل", example: "الأكل كلش طيب.", explanation: "الطعام بشكل عام." },
            { id: 10, difficulty: 'easy', purpose: 'learn', english: "House", iraqi: "بيت", pronunciation: "بَيْت", example: "هذا بيتي الجديد.", explanation: "المسكن أو المنزل." },
            { id: 11, difficulty: 'easy', purpose: 'learn', english: "Car", iraqi: "سيارة", pronunciation: "سَيّارة", example: "سيارتي لونها أحمر.", explanation: "مركبة للتنقل." },
            { id: 12, difficulty: 'easy', purpose: 'learn', english: "Money", iraqi: "فلوس", pronunciation: "فْلوس", example: "ما عندي فلوس كافية.", explanation: "النقود." },
            { id: 13, difficulty: 'easy', purpose: 'learn', english: "Today", iraqi: "اليوم", pronunciation: "اليوم", example: "اليوم الجو حار.", explanation: "هذا النهار." },
            { id: 14, difficulty: 'easy', purpose: 'learn', english: "Tomorrow", iraqi: "باچر", pronunciation: "باچِر", example: "باچر عندي امتحان.", explanation: "اليوم الذي يلي هذا اليوم." },
            { id: 15, difficulty: 'easy', purpose: 'learn', english: "Friend", iraqi: "صديق / صديقة", pronunciation: "صَديق / صَديقة", example: "هو خوش صديق.", explanation: "شخص مقرب وموثوق به." },
            { id: 91, difficulty: 'easy', purpose: 'learn', english: "Family", iraqi: "عائلة", pronunciation: "عائِلَة", example: "عائلتي چبيرة.", explanation: "مجموعة الأقارب الذين يعيشون معًا." },
            { id: 92, difficulty: 'easy', purpose: 'learn', english: "Now", iraqi: "هسة", pronunciation: "هَسَّة", example: "لازم أروح هسة.", explanation: "ظرف زمان يعني في الوقت الحالي." },
            { id: 93, difficulty: 'easy', purpose: 'learn', english: "Yesterday", iraqi: "البارحة", pronunciation: "البارْحَة", example: "البارحة چان الجو حلو.", explanation: "اليوم الذي سبق هذا اليوم." },
            { id: 16, difficulty: 'easy', purpose: 'quiz', english: "Big", iraqi: "چبير", pronunciation: "چْبير", example: "هذا البيت چبير.", explanation: "صفة تعني كبير الحجم." },
            { id: 17, difficulty: 'easy', purpose: 'quiz', english: "Small", iraqi: "صغير", pronunciation: "صْغَيِّر", example: "القلم صغيرون.", explanation: "صفة تعني صغير الحجم." },
            { id: 18, difficulty: 'easy', purpose: 'quiz', english: "Good", iraqi: "زين", pronunciation: "زَيْن", example: "هذا الشي زين.", explanation: "صفة تعني جيد أو حسن." },
            { id: 19, difficulty: 'easy', purpose: 'quiz', english: "Bad", iraqi: "مو زين", pronunciation: "مو زَيْن", example: "التصرف هذا مو زين.", explanation: "صفة تعني سيء أو غير جيد." },
            { id: 20, difficulty: 'easy', purpose: 'quiz', english: "Man", iraqi: "رجال", pronunciation: "رَجّال", example: "هذا رجال طيب.", explanation: "كلمة تعني رجل." },
            { id: 21, difficulty: 'easy', purpose: 'quiz', english: "Woman", iraqi: "مرة", pronunciation: "مَرَة", example: "المرة دتشتغل.", explanation: "كلمة تعني امرأة." },
            { id: 22, difficulty: 'easy', purpose: 'quiz', english: "Boy", iraqi: "ولد", pronunciation: "وَلَد", example: "الولد يلعب طوبة.", explanation: "كلمة تعني صبي." },
            { id: 23, difficulty: 'easy', purpose: 'quiz', english: "Girl", iraqi: "بنية", pronunciation: "بْنَيَّة", example: "البنية تقرا كتاب.", explanation: "كلمة تعني فتاة." },
            { id: 24, difficulty: 'easy', purpose: 'quiz', english: "Sun", iraqi: "شمس", pronunciation: "شَمِس", example: "الشمس حارة اليوم.", explanation: "النجم المركزي في مجموعتنا الشمسية." },
            { id: 25, difficulty: 'easy', purpose: 'quiz', english: "Moon", iraqi: "گمر", pronunciation: "گُمَر", example: "الگمر منور الليلة.", explanation: "القمر الطبيعي للأرض." },
            { id: 26, difficulty: 'easy', purpose: 'quiz', english: "Book", iraqi: "كتاب", pronunciation: "كْتاب", example: "أحب أقرا كتب.", explanation: "مجموعة من الأوراق المكتوبة أو المطبوعة." },
            { id: 27, difficulty: 'easy', purpose: 'quiz', english: "Pen", iraqi: "قلم", pronunciation: "قَلَم", example: "عندك قلم أزرك؟", explanation: "أداة للكتابة." },
            { id: 28, difficulty: 'easy', purpose: 'quiz', english: "School", iraqi: "مدرسة", pronunciation: "مَدْرَسَة", example: "باچر أروح للمدرسة.", explanation: "مكان للتعليم." },
            { id: 29, difficulty: 'easy', purpose: 'quiz', english: "Market", iraqi: "سوگ", pronunciation: "سوگ", example: "نروح للسوگ نشتري خضرة.", explanation: "مكان لبيع وشراء البضائع." },
            { id: 30, difficulty: 'easy', purpose: 'quiz', english: "Sleep", iraqi: "نوم", pronunciation: "نوم", example: "أحتاج نوم هواية.", explanation: "فعل النوم أو حالة النوم." },
            { id: 94, difficulty: 'easy', purpose: 'quiz', english: "Work", iraqi: "شغل", pronunciation: "شُغُل", example: "عندي شغل هواية.", explanation: "العمل أو المهام المطلوب إنجازها." },
            { id: 95, difficulty: 'easy', purpose: 'quiz', english: "Father", iraqi: "أبو", pronunciation: "أبو", example: "أبوية بالبيت.", explanation: "الوالد." },
            { id: 96, difficulty: 'easy', purpose: 'quiz', english: "Mother", iraqi: "أم", pronunciation: "أُم", example: "أمي تطبخ أكل طيب.", explanation: "الوالدة." },

            // --- MEDIUM --- (Original + New)
            { id: 31, difficulty: 'medium', purpose: 'learn', english: "What is your name?", iraqi: "شسمك؟", pronunciation: "شِسْمَك (m) / شِسْمِچ (f)", example: "شسمك الحلو؟", explanation: "سؤال عن الاسم." },
            { id: 32, difficulty: 'medium', purpose: 'learn', english: "I am from Baghdad", iraqi: "آنَي مِن بغداد", pronunciation: "آنَي مِن بَغْداد", example: "آنَي مِن بغداد وأحبها كلش.", explanation: "التعبير عن المكان الأصلي." },
            { id: 33, difficulty: 'medium', purpose: 'learn', english: "How much is this?", iraqi: "بيش هذا؟", pronunciation: "بِيشْ هَذا؟", example: "بيش هذا الكتاب؟", explanation: "سؤال عن السعر." },
            { id: 34, difficulty: 'medium', purpose: 'learn', english: "I don't understand", iraqi: "ما دأفتهم", pronunciation: "ما دَأفـتـِهـِم", example: "عفواً، ما دأفتهم قصدك.", explanation: "التعبير عن عدم الفهم." },
            { id: 35, difficulty: 'medium', purpose: 'learn', english: "Where is the bathroom?", iraqi: "وين التواليت؟", pronunciation: "وَيْن التواليت؟", example: "بلا زحمة، وين التواليت؟", explanation: "سؤال عن مكان الحمام." },
            { id: 36, difficulty: 'medium', purpose: 'learn', english: "I want to eat", iraqi: "أريد آكل", pronunciation: "أريد آكِل", example: "جوعان، أريد آكل.", explanation: "التعبير عن الرغبة في الأكل." },
            { id: 37, difficulty: 'medium', purpose: 'learn', english: "This is delicious", iraqi: "هذا كلش طيب", pronunciation: "هَذا كُلِّش طَيِّب", example: "عاشت إيدك، هذا الأكل كلش طيب.", explanation: "التعبير عن استحسان الطعام." },
            { id: 38, difficulty: 'medium', purpose: 'learn', english: "I love you", iraqi: "أحبك / أحبچ", pronunciation: "أحِبَّك (m) / أحِبِّچ (f)", example: "أحبك هواية.", explanation: "التعبير عن الحب." },
            { id: 39, difficulty: 'medium', purpose: 'learn', english: "What time is it?", iraqi: "بيش الساعة؟", pronunciation: "بِيشْ السّاعَة؟", example: "بيش الساعة هسة؟", explanation: "سؤال عن الوقت." },
            { id: 40, difficulty: 'medium', purpose: 'learn', english: "I'm tired", iraqi: "تعبان / تعبانة", pronunciation: "تَعْبان (m) / تَعْبانة (f)", example: "كلش تعبان اليوم.", explanation: "التعبير عن التعب." },
            { id: 41, difficulty: 'medium', purpose: 'learn', english: "Let's go", iraqi: "خل نروح", pronunciation: "خَلْ نْروح", example: "يالله خل نروح نتمشى شوية.", explanation: "دعوة للذهاب." },
            { id: 42, difficulty: 'medium', purpose: 'learn', english: "Wait a moment", iraqi: "لحظة بالله", pronunciation: "لَحْظَة بالله", example: "لحظة بالله، دأخابر.", explanation: "طلب الانتظار قليلاً." },
            { id: 43, difficulty: 'medium', purpose: 'learn', english: "I'm sorry", iraqi: "آسف / آسفة", pronunciation: "آسِف (m) / آسْفة (f)", example: "آسف جداً على اللي صار.", explanation: "الاعتذار." },
            { id: 44, difficulty: 'medium', purpose: 'learn', english: "Help me", iraqi: "ساعدني / ساعديني", pronunciation: "ساعِدْني (m) / ساعْديني (f)", example: "فدوة ساعدني بهاي الشغلة.", explanation: "طلب المساعدة." },
            { id: 45, difficulty: 'medium', purpose: 'learn', english: "I don't know", iraqi: "ما أدري", pronunciation: "ما أدْرَي", example: "سألته بس گال ما أدري.", explanation: "التعبير عن عدم المعرفة." },
            { id: 97, difficulty: 'medium', purpose: 'learn', english: "What happened?", iraqi: "شصار؟", pronunciation: "شْصار؟", example: "ليش ضايج، شصار؟", explanation: "سؤال للاستفسار عن حدث ما." },
            { id: 98, difficulty: 'medium', purpose: 'learn', english: "Don't worry", iraqi: "لا تشيل هم", pronunciation: "لا تْشيل هَم", example: "الموضوع يمي، لا تشيل هم.", explanation: "عبارة للطمأنة." },
            { id: 99, difficulty: 'medium', purpose: 'learn', english: "A lot / Very", iraqi: "هواية", pronunciation: "هْوايَة", example: "أحبك هواية.", explanation: "كلمة تعني الكثير أو جداً." },
            { id: 100, difficulty: 'medium', purpose: 'learn', english: "A little", iraqi: "شوية", pronunciation: "شْوَيَّة", example: "انطيني شوية وقت.", explanation: "كلمة تعني القليل." },
            { id: 101, difficulty: 'medium', purpose: 'learn', english: "Give me", iraqi: "انطيني", pronunciation: "إنْطيني", example: "انطيني القلم.", explanation: "فعل أمر بمعنى أعطني." },
            { id: 46, difficulty: 'medium', purpose: 'quiz', english: "What's new?", iraqi: "شكو ماكو؟", pronunciation: "شَكو ماكو؟", example: "ها، شكو ماكو اليوم؟", explanation: "سؤال عن الأخبار والمستجدات." },
            { id: 47, difficulty: 'medium', purpose: 'quiz', english: "Everything is fine", iraqi: "كلشي تمام", pronunciation: "كِلْشي تَمام", example: "الحمد لله، كلشي تمام.", explanation: "رد إيجابي يعني أن كل شيء على ما يرام." },
            { id: 48, difficulty: 'medium', purpose: 'quiz', english: "See you later", iraqi: "أشوفك بعدين", pronunciation: "أشوفَك بَعْدين (m) / أشوفِچ بَعْدين (f)", example: "يالله مع السلامة، أشوفك بعدين.", explanation: "لتوديع شخص مع نية رؤيته لاحقًا." },
            { id: 49, difficulty: 'medium', purpose: 'quiz', english: "How is work?", iraqi: "شلون الشغل؟", pronunciation: "شْلون الشُغُل؟", example: "طمني عنك، شلون الشغل وياك؟", explanation: "سؤال عن أحوال العمل." },
            { id: 50, difficulty: 'medium', purpose: 'quiz', english: "I am hungry", iraqi: "آني جوعان / جوعانة", pronunciation: "آني جوعان (m) / جوعانة (f)", example: "ما تغديت، آني كلش جوعان.", explanation: "التعبير عن الشعور بالجوع." },
            { id: 51, difficulty: 'medium', purpose: 'quiz', english: "I am thirsty", iraqi: "آني عطشان / عطشانة", pronunciation: "آني عَطْشان (m) / عَطْشانة (f)", example: "الدنيا حارة، آني عطشان.", explanation: "التعبير عن الشعور بالعطش." },
            { id: 52, difficulty: 'medium', purpose: 'quiz', english: "It's very hot", iraqi: "الدنيا كلش حارة", pronunciation: "الدِنْيا kُلِّش حارَة", example: "ما أگدر أطلع، الدنيا كلش حارة.", explanation: "وصف الطقس الحار جدًا." },
            { id: 53, difficulty: 'medium', purpose: 'quiz', english: "It's very cold", iraqi: "الدنيا كلش باردة", pronunciation: "الدِنْيا كُلِّش بارْدَة", example: "البس زين، الدنيا كلش باردة.", explanation: "وصف الطقس البارد جدًا." },
            { id: 54, difficulty: 'medium', purpose: 'quiz', english: "I need a doctor", iraqi: "أحتاج طبيب", pronunciation: "أحْتاج طَبيب", example: "أتأذيت، أحتاج طبيب بسرعة.", explanation: "التعبير عن الحاجة إلى طبيب." },
            { id: 55, difficulty: 'medium', purpose: 'quiz', english: "Are you married?", iraqi: "متزوج / متزوجة؟", pronunciation: "مِتْزَوِّج (m) / مِتْزَوِّجَة (f)؟", example: "سؤال شخصي: حضرتك متزوج؟", explanation: "سؤال عن الحالة الاجتماعية." },
            { id: 56, difficulty: 'medium', purpose: 'quiz', english: "How old are you?", iraqi: "شگد عمرك؟", pronunciation: "شْگَد عُمْرَك (m) / عُمْرِچ (f)؟", example: "إذا ماكو إحراج، شگد عمرك؟", explanation: "سؤال عن العمر." },
            { id: 57, difficulty: 'medium', purpose: 'quiz', english: "Welcome", iraqi: "أهلاً وسهلاً", pronunciation: "أهْلاً وسَهْلاً", example: "أهلاً وسهلاً بيكم ببيتنا.", explanation: "عبارة ترحيب بالضيوف." },
            { id: 58, difficulty: 'medium', purpose: 'quiz', english: "It's okay / Never mind", iraqi: "ميخالف", pronunciation: "ميخالِف", example: "كسرت القلم بالغلط. الرد: ميخالف، عادي.", explanation: "تُقال للتعبير عن أن الأمر لا بأس به." },
            { id: 59, difficulty: 'medium', purpose: 'quiz', english: "Really? / Seriously?", iraqi: "صدُگ؟", pronunciation: "صَدُگ؟", example: "نجحت بالامتحان! الرد: صدُگ؟ ألف مبروك!", explanation: "للتعبير عن التفاجؤ أو لطلب التأكيد." },
            { id: 60, difficulty: 'medium', purpose: 'quiz', english: "What are you doing?", iraqi: "شـ تسوي؟", pronunciation: "شـ تْسَوّي؟", example: "شـ تسوي هسة؟ مشغول؟", explanation: "سؤال عن النشاط الحالي للشخص." },
            { id: 102, difficulty: 'medium', purpose: 'quiz', english: "No problem", iraqi: "مو مشكلة", pronunciation: "مو مُشْكِلَة", example: "تأخرت عليك. الرد: عادي مو مشكلة.", explanation: "تعبير يعني أن الأمر لا يسبب إزعاجًا." },
            { id: 103, difficulty: 'medium', purpose: 'quiz', english: "Hospital", iraqi: "مستشفى", pronunciation: "مُسْتَشْفى", example: "لازم أروح للمستشفى.", explanation: "مكان لتلقي العلاج." },
            { id: 104, difficulty: 'medium', purpose: 'quiz', english: "Airport", iraqi: "مطار", pronunciation: "مَطار", example: "رحلتي بعد ساعة من المطار.", explanation: "مكان إقلاع وهبوط الطائرات." },
            { id: 105, difficulty: 'medium', purpose: 'quiz', english: "Restaurant", iraqi: "مطعم", pronunciation: "مَطْعَم", example: "خل نتعشى بالمطعم اليوم.", explanation: "مكان لبيع وتقديم الطعام." },

            // --- HARD --- (Original + New)
            { id: 61, difficulty: 'hard', purpose: 'learn', english: "Can you help me find this address?", iraqi: "تگدر تساعدني ألگى هذا العنوان؟", pronunciation: "تِگْدَر تْساعِدْني ألْگى هَذا العِنْوان؟", example: "بلا زحمة، تگدر تساعدني ألگى هذا العنوان؟", explanation: "طلب المساعدة في العثور على عنوان معين." },
            { id: 62, difficulty: 'hard', purpose: 'learn', english: "I would like to order food.", iraqi: "أريد أطلب أكل.", pronunciation: "أريد أطْلُب أكِل.", example: "لو سمحت، أريد أطلب أكل، شنو عندكم؟", explanation: "طلب الطعام في مطعم أو مقهى." },
            { id: 63, difficulty: 'hard', purpose: 'learn', english: "Where is a good restaurant?", iraqi: "وين أكو مطعم طيب؟", pronunciation: "وَيْن أكو مَطْعَم طَيِّب؟", example: "جوعان، وين أكو مطعم طيب هنا؟", explanation: "سؤال عن موقع مطعم جيد." },
            { id: 64, difficulty: 'hard', purpose: 'learn', english: "How do I get to the hospital?", iraqi: "شلون أوصل للمستشفى؟", pronunciation: "شْلون أوْصَل لِلْمُسْتَشْفى؟", example: "صار حادث، شلون أوصل لأقرب مستشفى؟", explanation: "سؤال عن الاتجاهات إلى المستشفى." },
            { id: 65, difficulty: 'hard', purpose: 'learn', english: "What do you recommend visiting?", iraqi: "شتنصحني أزور؟", pronunciation: "شـتَنْصَحْني أزور؟", example: "أول مرة أجي، شتنصحني أزور أماكن حلوة؟", explanation: "طلب توصيات للأماكن السياحية." },
            { id: 66, difficulty: 'hard', purpose: 'learn', english: "I need to exchange money.", iraqi: "محتاج أصرّف فلوس.", pronunciation: "مِحْتاج أصَرِّف فْلوس.", example: "عندي دولارات، محتاج أصرّف فلوس.", explanation: "التعبير عن الحاجة لصرف العملات." },
            { id: 67, difficulty: 'hard', purpose: 'learn', english: "Could you speak more slowly?", iraqi: "ممكن تحچي على كيفك؟", pronunciation: "مُمْكِن تِحْچي عَلى كَيْفَك؟", example: "ما دألحگ، ممكن تحچي على كيفك؟", explanation: "طلب التحدث ببطء." },
            { id: 68, difficulty: 'hard', purpose: 'learn', english: "I'm looking for a gift.", iraqi: "دأدور على هدية.", pronunciation: "دأدور عَلى هَدِيَّة.", example: "دأدور على هدية لصديقتي، عندك اقتراحات؟", explanation: "التعبير عن البحث عن هدية." },
            { id: 69, difficulty: 'hard', purpose: 'learn', english: "How long does it take?", iraqi: "شگد يرادلها وكت؟", pronunciation: "شْگَد يْرادِلْها وَكِت؟", example: "شگد يرادلها وكت حتى نوصل من هنا للسنتر؟", explanation: "سؤال عن المدة الزمنية." },
            { id: 70, difficulty: 'hard', purpose: 'learn', english: "What is the traditional food?", iraqi: "شنو الأكل التراثي؟", pronunciation: "شنو الأكِل التُراثي؟", example: "شنو الأكل التراثي اللي لازم أجرّبه؟", explanation: "سؤال عن الأكلات التقليدية." },
            { id: 71, difficulty: 'hard', purpose: 'learn', english: "I think I'm lost.", iraqi: "أعتقد ضيّعت.", pronunciation: "أعْتَقِد ضَيَّعْت.", example: "أعتقد ضيّعت، ممكن تدليني على الطريق؟", explanation: "التعبير عن الضياع وطلب المساعدة." },
            { id: 72, difficulty: 'hard', purpose: 'learn', english: "Could you write that down?", iraqi: "ممكن تكتبها؟", pronunciation: "مُمْكِن تِكْتِبْها؟", example: "خاف أنساها، ممكن تكتبها بورقة؟", explanation: "طلب كتابة شيء ما." },
            { id: 73, difficulty: 'hard', purpose: 'learn', english: "What's the bottom line?", iraqi: "شنو الزبدة؟", pronunciation: "شنو الزِبْدَة؟", example: "حچيت هواي، انطيني شنو الزبدة؟", explanation: "تعبير يعني 'ما هو خلاصة الموضوع؟'." },
            { id: 74, difficulty: 'hard', purpose: 'learn', english: "He is a good person.", iraqi: "هو ابن أوادم.", pronunciation: "هو إبِن أوادِم.", example: "لا تخاف منه، هو خوش ولد وابن أوادم.", explanation: "تعبير يعني أنه شخص محترم ومن عائلة طيبة." },
            { id: 75, difficulty: 'hard', purpose: 'learn', english: "What's this nonsense?", iraqi: "شنو هالسخافة؟", pronunciation: "شنو هالـسَخافَة؟", example: "شفت تصرفه؟ شنو هالسخافة؟", explanation: "تعبير للاستنكار من شيء تافه أو غير منطقي." },
            { id: 106, difficulty: 'hard', purpose: 'learn', english: "I'm fed up.", iraqi: "روحي طالعة.", pronunciation: "روحي طالْعَة.", example: "من الصبح بالشغل، روحي طالعة.", explanation: "تعبير يعني الشعور بالضجر الشديد والملل." },
            { id: 107, difficulty: 'hard', purpose: 'learn', english: "It's none of my business.", iraqi: "آني شعليّه؟", pronunciation: "آني شَعْلَيَّه؟", example: "ليش تتدخل؟ آني شعليّه بالموضوع.", explanation: "تعبير يعني 'أنا لست معنياً بالأمر'." },
            { id: 76, difficulty: 'hard', purpose: 'quiz', english: "The situation is complicated.", iraqi: "الوضعية كلش معقدة.", pronunciation: "الوَضْعِيَّة كُلِّش مْعَقَّدَة.", example: "حاولت أحلها بس الوضعية كلش معقدة.", explanation: "وصف موقف صعب." },
            { id: 77, difficulty: 'hard', purpose: 'quiz', english: "I have an important meeting.", iraqi: "عندي اجتماع مهم.", pronunciation: "عِنْدي إجْتِماع مُهِم.", example: "عندي اجتماع مهم باچر الصبح.", explanation: "التحدث عن التزام مهم." },
            { id: 78, difficulty: 'hard', purpose: 'quiz', english: "I've been waiting for an hour.", iraqi: "صارلي ساعة أنتظرك.", pronunciation: "صارْلي ساعَة أنْتَظْرَك.", example: "وين چنت؟ صارلي ساعة أنتظرك!", explanation: "التعبير عن الانتظار الطويل." },
            { id: 79, difficulty: 'hard', purpose: 'quiz', english: "The traffic was terrible.", iraqi: "الازدحام چان فد شي.", pronunciation: "الإزْدِحام چان فَد شي.", example: "الازدحام چان فد شي اليوم، لهذا اتأخرت.", explanation: "وصف الازدحام المروري الشديد." },
            { id: 80, difficulty: 'hard', purpose: 'quiz', english: "I'm looking forward to our trip.", iraqi: "كلش متحمس لسفرتنا.", pronunciation: "كُلِّش مِتْحَمِّس لْسَفْرَتْنا.", example: "كلش متحمس لسفرتنا الأسبوع الجاي.", explanation: "التعبير عن الحماس لرحلة قادمة." },
            { id: 81, difficulty: 'hard', purpose: 'quiz', english: "Recommend a good book.", iraqi: "انصحني بكتاب حلو.", pronunciation: "إنْصَحْني بْكتاب حِلو.", example: "ممكن تنصحني بكتاب حلو أقراه؟", explanation: "طلب توصية لكتاب جيد." },
            { id: 82, difficulty: 'hard', purpose: 'quiz', english: "I need to buy groceries.", iraqi: "محتاج أتسوق مسواگ.", pronunciation: "مِحْتاج أتْسَوَّق مِسْواگ.", example: "محتاج أتسوق مسواگ، أكو سوبرماركت قريّب؟", explanation: "الحاجة لشراء مواد غذائية." },
            { id: 83, difficulty: 'hard', purpose: 'quiz', english: "I'm not feeling well.", iraqi: "مدى أحس نفسي زين.", pronunciation: "مَدى أحِس نَفْسي زَيْن.", example: "مدى أحس نفسي زين، أعتقد لازم أرجع للبيت.", explanation: "التعبير عن الشعور بالمرض." },
            { id: 84, difficulty: 'hard', purpose: 'quiz', english: "What are your plans?", iraqi: "شنو مخططاتك؟", pronunciation: "شنو مْخَطَّطاتَك؟", example: "شنو مخططاتك لنهاية الأسبوع؟", explanation: "السؤال عن الخطط المستقبلية." },
            { id: 85, difficulty: 'hard', purpose: 'quiz', english: "This is the best food ever!", iraqi: "هذا أطيب أكل بحياتي!", pronunciation: "هذا أطْيَب أكِل بْحَياتي!", example: "هذا أطيب أكل عراقي ضگته بحياتي!", explanation: "مدح الطعام بشكل كبير جدًا." },
            { id: 86, difficulty: 'hard', purpose: 'quiz', english: "I need to focus on my studies.", iraqi: "لازم أركز على دراستي.", pronunciation: "لازِم أرَكِّز عَلى دِراسْتي.", example: "لازم أركز على دراستي، عندي امتحان مصيري.", explanation: "التأكيد على أهمية الدراسة." },
            { id: 87, difficulty: 'hard', purpose: 'quiz', english: "It's been a long time.", iraqi: "صار هواية وكت.", pronunciation: "صار هْوايَة وَكِت.", example: "صار هواية وكت من آخر مرة شفنه بعض.", explanation: "التعبير عن مرور فترة زمنية طويلة." },
            { id: 88, difficulty: 'hard', purpose: 'quiz', english: "I'm trying to save money.", iraqi: "دأحاول أجمع فلوس.", pronunciation: "دأحاول أجَمِّع فْلوس.", example: "دأحاول أجمع فلوس حتى أشتري سيارة.", explanation: "التحدث عن هدف مالي." },
            { id: 89, difficulty: 'hard', purpose: 'quiz', english: "Give me some advice.", iraqi: "انطيني نصيحة.", pronunciation: "إنْطيني نَصيحَة.", example: "تگدر تنطيني نصيحة شلون أحسن لهجتي؟", explanation: "طلب النصيحة والمشورة." },
            { id: 90, difficulty: 'hard', purpose: 'quiz', english: "I'm very grateful.", iraqi: "آني كلش ممنون.", pronunciation: "آني كُلِّش مَمْنون.", example: "آني كلش ممنون لكل مساعدتك.", explanation: "التعبير عن امتنان عميق." },
            { id: 108, difficulty: 'hard', purpose: 'quiz', english: "Let's get to the point.", iraqi: "خل ندخل بالموضوع.", pronunciation: "خَل نِدْخُل بالـمَوْضوع.", example: "كافي مقدمات، خل ندخل بالموضوع.", explanation: "طلب بدء الحديث في صلب الموضوع مباشرة." },
            { id: 109, difficulty: 'hard', purpose: 'quiz', english: "Take it easy / Calm down.", iraqi: "على كيفك.", pronunciation: "عَلى كَيْفَك.", example: "ليش معصّب؟ على كيفك.", explanation: "عبارة لتهدئة شخص ما أو الطلب منه أن يتمهل." },
            { id: 110, difficulty: 'hard', purpose: 'quiz', english: "Whatever you want.", iraqi: "اللي تريده.", pronunciation: "اللي تْريدَه.", example: "وين نروح؟ بكيفك، اللي تريده.", explanation: "إعطاء حرية الاختيار للطرف الآخر." }
        ];

        const QUIZ_QUESTIONS_COUNT = 15;

        // --- GAME STATE ---
        let gameState = {
            currentLearnCardIndex: 0,
            totalWordsLearnedGlobally: 0,
            overallMaxStreak: 1,
            quizCurrentQuestionIndex: 0,
            quizScore: 0,
            quizQuestions: [],
            totalCorrectQuizAnswersGlobal: 0,
            totalQuizQuestionsAttemptedGlobal: 0,
            quizzesCompletedGlobal: 0,
            gameStarted: false,
            settings: { difficulty: 'easy', autoFlipCard: false, showExamples: true, enableVibration: true, enableSound: true, colorTheme: 'default', pageBgColor: '#ECEFF1' },
            progressByDifficulty: { easy:{learnedWordIds:new Set(),quizAttempts:[],highestQuizScore:0,highestQuizTotal:0,learnStreak:1,maxLearnStreak:1,learnItemsTotal:0,quizItemsTotal:0},medium:{learnedWordIds:new Set(),quizAttempts:[],highestQuizScore:0,highestQuizTotal:0,learnStreak:1,maxLearnStreak:1,learnItemsTotal:0,quizItemsTotal:0},hard:{learnedWordIds:new Set(),quizAttempts:[],highestQuizScore:0,highestQuizTotal:0,learnStreak:1,maxLearnStreak:1,learnItemsTotal:0,quizItemsTotal:0}},
            achievements: {}
        };
        
        function initializeAchievements() { const t=wordsData.filter(w=>w.purpose==='learn').length;gameState.achievements={beginner:{unlocked:!1,goal:Math.max(1,Math.min(5,t)),current:0,name:"المبتدئ النشيط",description:`تعلم ${Math.max(1,Math.min(5,t))} كلمة/جملة جديدة (إجمالي)`},intermediate:{unlocked:!1,goal:Math.max(1,Math.min(15,t)),current:0,name:"المتعلم الجاد",description:`تعلم ${Math.max(1,Math.min(15,t))} كلمة/جملة جديدة (إجمالي)`},advanced:{unlocked:!1,goal:Math.max(1,t),current:0,name:"خبير اللهجة",description:`إتقان كل محتوى التعلم (${Math.max(1,t)})`},streakStar:{unlocked:!1,goal:5,current:0,name:"نجم التسلسل",description:"حقق سلسلة تعلم من 5 (في أي مستوى)"},quizNovice:{unlocked:!1,goal:10,current:0,name:"هاوي الاختبارات",description:"أجب عن 10 أسئلة صحيحة (إجمالي)"},quizChampion:{unlocked:!1,goal:Math.min(QUIZ_QUESTIONS_COUNT, wordsData.filter(w=>w.purpose ==='quiz' && w.difficulty === gameState.settings.difficulty).length || QUIZ_QUESTIONS_COUNT),current:0,name:"بطل الاختبارات",description:`علامة كاملة في اختبار بالمستوى الحالي`}}}

        // --- DOM ELEMENTS ---
        const learnDifficultySubtitleEl = document.getElementById('learn-difficulty-subtitle');
        const quizDifficultySubtitleEl = document.getElementById('quiz-difficulty-subtitle');
        const difficultyStatsDisplayEl = document.getElementById('difficulty-stats-display');
        const learnCompletionMessageEl = document.getElementById('learn-completion-message');
        const statsTotalLearnedEl = document.getElementById('stats-total-learned');
        const statsMaxStreakEl = document.getElementById('stats-max-streak');
        const statsQuizAccuracyEl = document.getElementById('stats-quiz-accuracy');
        const statsQuizzesCompletedEl = document.getElementById('stats-quizzes-completed');
        const statsOverallProgressBarEl = document.getElementById('stats-overall-progress-bar');
        const enableVibrationCheckbox = document.getElementById('enable-vibration');
        const enableSoundCheckbox = document.getElementById('enable-sound');
        const bgColorSpans = document.querySelectorAll('.bg-color-options span');
        const sections = document.querySelectorAll('.section');
        const navButtons = document.querySelectorAll('nav button');
        const learnStreakEl = document.getElementById('learn-streak');
        const learnProgressEl = document.getElementById('learn-progress');
        const flashcardClickableArea = document.getElementById('flashcard-clickable-area'); 
        const flashcard = document.getElementById('flashcard');
        const flashcardFrontText = document.getElementById('flashcard-front-text');
        const flashcardBackIraqi = document.getElementById('flashcard-back-iraqi');
        const flashcardPronunciation = document.getElementById('flashcard-pronunciation');
        const flashcardExample = document.getElementById('flashcard-example');
        const flashcardExplanation = document.getElementById('flashcard-explanation');
        const hintBtn = document.getElementById('hint-btn');
        const dontKnowBtn = document.getElementById('dont-know-btn');
        const nextCardBtn = document.getElementById('next-card-btn');
        const audioEnLearnBtn = document.getElementById('audio-en-learn');
        const audioIqLearnBtn = document.getElementById('audio-iq-learn');
        const audioSaLearnBtn = document.getElementById('audio-sa-learn');
        const quizProgressEl = document.getElementById('quiz-progress');
        const quizScoreDisplayEl = document.getElementById('quiz-score-display');
        const quizQuestionEl = document.getElementById('quiz-question');
        const quizOptionsEl = document.getElementById('quiz-options');
        const quizFeedbackEl = document.getElementById('quiz-feedback');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const newQuizBtn = document.getElementById('new-quiz-btn');
        const audioEnQuizBtn = document.getElementById('audio-en-quiz');
        const achievementsListEl = document.getElementById('achievements-list');
        const difficultyButtons = document.querySelectorAll('.difficulty-options button');
        const colorThemeSpans = document.querySelectorAll('.color-options span');
        const autoFlipCardCheckbox = document.getElementById('auto-flip-card');
        const showExamplesCheckbox = document.getElementById('show-examples');
        const resetProgressBtn = document.getElementById('reset-progress-btn');
        const closeBtnHeader = document.querySelector('.close-btn-header');
        const startGameContainer = document.getElementById('start-game-container');
        const startGameBtn = document.getElementById('start-game-btn');
        const learnAudioButtons = document.getElementById('learn-audio-buttons');
        const learnMainActions = document.getElementById('learn-main-actions');
        
        let autoFlipTimeout;
        let synth; let voices = []; let synthesisReady = false;
        
        function initializeSpeechSynthesis() { if('speechSynthesis'in window){synth=window.speechSynthesis;console.log("SpeechSynthesis API supported.");const a=()=>{voices=synth.getVoices();if(voices.length>0){synthesisReady=!0;console.log("Voices loaded:",voices.length);[audioEnLearnBtn,audioIqLearnBtn,audioSaLearnBtn,audioEnQuizBtn].forEach(b=>{if(b)b.disabled=!1});}else console.log("getVoices() returned empty list. Will retry if onvoiceschanged is supported or on interaction.");};if(synth.onvoiceschanged!==undefined)synth.onvoiceschanged=()=>{console.log("onvoiceschanged event fired.");a();};a();if(voices.length===0){setTimeout(a,500);const b=new SpeechSynthesisUtterance('');b.volume=0;synth.speak(b);}}else{console.error("SpeechSynthesis API not available. TTS features will be disabled.");synthesisReady=!1;[audioEnLearnBtn,audioIqLearnBtn,audioSaLearnBtn,audioEnQuizBtn].forEach(b=>{if(b){b.disabled=!0;b.title="خاصية الصوت غير مدعومة";}});}}
        initializeSpeechSynthesis();

        const soundEffects = {
            click: new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3'),
            flip: new Audio('https://www.soundjay.com/misc/sounds/page-flip-02.mp3'),
            correct: new Audio('https://www.soundjay.com/buttons/sounds/button-21.mp3'),
            incorrect: new Audio('https://www.soundjay.com/buttons/sounds/button-10.mp3'),
            achievement: new Audio('https://www.soundjay.com/misc/sounds/magic-chime-01.mp3')
        };

        function preloadSounds() { 
            for(const k in soundEffects){
                soundEffects[k].load();
                soundEffects[k].volume=0;
                soundEffects[k].play().then(()=>{
                    soundEffects[k].pause();
                    soundEffects[k].currentTime=0;
                    soundEffects[k].volume=0.6;
                }).catch(e=>{
                    console.warn(`Preload play for ${k} failed (common, safe to ignore):`, e);
                    soundEffects[k].volume=0.6;
                });
            }
        }
        function playSound(soundName) { 
            if(gameState.settings.enableSound && soundEffects[soundName]){
                soundEffects[soundName].currentTime=0;
                soundEffects[soundName].play().catch(e=>console.warn(`Sound ${soundName} play error:`,e));
            }
        }
        function vibrate(duration = 50) { if(gameState.settings.enableVibration && navigator.vibrate) navigator.vibrate(duration); }

        function speakText(text, lang) { if(!synth||!synthesisReady){console.warn("TTS not ready. Cannot speak:",text);return;} if(synth.speaking)synth.cancel();if(text){const u=new SpeechSynthesisUtterance(text);u.onerror=e=>console.error('TTS Error',e);let v=voices.find(vo=>vo.lang.startsWith(lang));if(!v&&(lang==='ar-IQ'||lang.startsWith('ar')))v=voices.find(vo=>vo.lang.startsWith('ar-SA'))||voices.find(vo=>vo.lang.startsWith('ar'));else if(!v&&lang.startsWith('en'))v=voices.find(vo=>vo.lang.startsWith('en-US'))||voices.find(vo=>vo.lang.startsWith('en'));if(v)u.voice=v;else u.lang=lang;u.pitch=1;u.rate=0.9;synth.speak(u);}}

        function getWordsForCurrentSettings(purpose) { const d=gameState.settings.difficulty;return wordsData.filter(w=>w.difficulty===d && w.purpose===purpose); }
        function updateDifficultyItemCounts() { ['easy','medium','hard'].forEach(d=>{const p=gameState.progressByDifficulty[d];p.learnItemsTotal=wordsData.filter(w=>w.difficulty===d&&w.purpose==='learn').length;p.quizItemsTotal=wordsData.filter(w=>w.difficulty===d&&w.purpose==='quiz').length;});}
        function saveGameState() { const s=JSON.parse(JSON.stringify(gameState));for(const d in s.progressByDifficulty)s.progressByDifficulty[d].learnedWordIds=Array.from(s.progressByDifficulty[d].learnedWordIds);localStorage.setItem('iraqiDialectGameState_v3.9.0',JSON.stringify(s)); }
        function loadGameState() { const s=localStorage.getItem('iraqiDialectGameState_v3.9.0');initializeAchievements();if(s){const p=JSON.parse(s);gameState={...gameState,...p,settings:{...gameState.settings,...(p.settings||{})},progressByDifficulty:{easy:{...gameState.progressByDifficulty.easy,...(p.progressByDifficulty?.easy||{}),learnedWordIds:new Set(p.progressByDifficulty?.easy?.learnedWordIds||[])},medium:{...gameState.progressByDifficulty.medium,...(p.progressByDifficulty?.medium||{}),learnedWordIds:new Set(p.progressByDifficulty?.medium?.learnedWordIds||[])},hard:{...gameState.progressByDifficulty.hard,...(p.progressByDifficulty?.hard||{}),learnedWordIds:new Set(p.progressByDifficulty?.hard?.learnedWordIds||[])}},achievements:{...gameState.achievements}};if(p.achievements){for(const k in gameState.achievements)if(p.achievements[k]){gameState.achievements[k].current=p.achievements[k].current;gameState.achievements[k].unlocked=p.achievements[k].unlocked;}}} updateDifficultyItemCounts();recalculateGlobalProgressFromLoadedState();}
        function recalculateGlobalProgressFromLoadedState() { gameState.totalWordsLearnedGlobally=0;let m=1;for(const d in gameState.progressByDifficulty){const p=gameState.progressByDifficulty[d];gameState.totalWordsLearnedGlobally+=p.learnedWordIds.size;if(p.maxLearnStreak>m)m=p.maxLearnStreak;}gameState.overallMaxStreak=m;const ach=gameState.achievements;if(ach.beginner)ach.beginner.current=gameState.totalWordsLearnedGlobally;if(ach.intermediate)ach.intermediate.current=gameState.totalWordsLearnedGlobally;if(ach.advanced)ach.advanced.current=gameState.totalWordsLearnedGlobally;if(ach.streakStar)ach.streakStar.current=gameState.overallMaxStreak;if(ach.quizNovice)ach.quizNovice.current=gameState.totalCorrectQuizAnswersGlobal;}

        function switchSection(targetId) {sections.forEach(s=>s.classList.toggle('active',s.id===targetId));navButtons.forEach(b=>b.classList.toggle('active',b.id===`nav-${targetId.split('-')[0]}`));if(targetId==='quiz-section'&&(gameState.quizQuestions.length===0 || gameState.quizCurrentQuestionIndex >= gameState.quizQuestions.length))startNewQuiz();if(targetId==='learn-section')prepareLearnSection(); if(targetId==='stats-achievements-section')updateStatsAndAchievementsDisplay();window.scrollTo(0,0);}
        navButtons.forEach(b=>b.addEventListener('click',()=>{playSound('click');switchSection(b.id.replace('nav-','') + '-section');}));
        closeBtnHeader.addEventListener('click',()=>{playSound('click');switchSection('learn-section');});

        function prepareLearnSection() {
            const learnPool = getWordsForCurrentSettings('learn');
            const currentDifficultyProgress = gameState.progressByDifficulty[gameState.settings.difficulty];
            
            if (!gameState.gameStarted || (currentDifficultyProgress.learnedWordIds.size === learnPool.length && learnPool.length > 0)) {
                showStartButton();
            } else {
                hideStartButtonAndShowContent();
                loadLearnCard();
            }
            updateLearnUI(); 
        }

        function showStartButton() {
            startGameContainer.classList.remove('hidden');
            flashcardClickableArea.classList.add('hidden-initial');
            flashcardClickableArea.classList.remove('visible-content');
            learnAudioButtons.classList.add('hidden-initial');
            learnAudioButtons.classList.remove('visible-content');
            learnMainActions.classList.add('hidden-initial');
            learnMainActions.classList.remove('visible-content');
            
            const learnPool = getWordsForCurrentSettings('learn');
            const currentDifficultyProgress = gameState.progressByDifficulty[gameState.settings.difficulty];
            if (currentDifficultyProgress.learnedWordIds.size === learnPool.length && learnPool.length > 0){
                startGameBtn.textContent = "🎉 أعد مراجعة المستوى 🎉";
            } else {
                startGameBtn.textContent = "🚀 ابدأ التعلم 🚀";
            }
        }

        function hideStartButtonAndShowContent() {
            startGameContainer.classList.add('hidden');
            flashcardClickableArea.classList.remove('hidden-initial');
            flashcardClickableArea.classList.add('visible-content');
            learnAudioButtons.classList.remove('hidden-initial');
            learnAudioButtons.classList.add('visible-content');
            learnMainActions.classList.remove('hidden-initial');
            learnMainActions.classList.add('visible-content');
        }

        startGameBtn.addEventListener('click', () => {
            playSound('click');
            gameState.gameStarted = true; 
            const learnPool = getWordsForCurrentSettings('learn');
            const currentDifficultyProgress = gameState.progressByDifficulty[gameState.settings.difficulty];
            if (currentDifficultyProgress.learnedWordIds.size === learnPool.length && learnPool.length > 0){
                 gameState.currentLearnCardIndex = 0; 
            }
            hideStartButtonAndShowContent();
            loadLearnCard();
            saveGameState();
        });


        function loadLearnCard() {
            clearTimeout(autoFlipTimeout);flashcard.classList.remove('flipped');learnCompletionMessageEl.classList.add('hidden');
            const cd=gameState.settings.difficulty;const cdp=gameState.progressByDifficulty[cd];const lp=getWordsForCurrentSettings('learn');
            
            if(!gameState.gameStarted && !(cdp.learnedWordIds.size === lp.length && lp.length > 0) ){ 
                showStartButton();
                flashcardFrontText.textContent = ""; 
                flashcardBackIraqi.textContent = "";
                updateLearnUI(); 
                return;
            }

            if(lp.length===0){flashcardFrontText.textContent="لا يوجد محتوى تعلم لهذا المستوى.";flashcardBackIraqi.textContent="-";flashcardPronunciation.textContent="";flashcardExample.textContent="";flashcardExplanation.textContent="";hintBtn.disabled=true;dontKnowBtn.disabled=true;nextCardBtn.disabled=true;updateLearnUI();return;}
            hintBtn.disabled=false;dontKnowBtn.disabled=false;nextCardBtn.disabled=false;

            if(cdp.learnedWordIds.size===lp.length&&lp.length>0){
                 learnCompletionMessageEl.classList.remove('hidden'); 
            }
            if (cdp.learnedWordIds.size === lp.length && gameState.currentLearnCardIndex >= lp.length) {
                showStartButton(); 
                updateLearnUI();
                return;
            }

            gameState.currentLearnCardIndex=gameState.currentLearnCardIndex%lp.length;
            const cwData=lp[gameState.currentLearnCardIndex];
            if(!cwData){console.error("CWData undefined in loadLearnCard for index", gameState.currentLearnCardIndex, "pool length", lp.length); gameState.currentLearnCardIndex=0; if(lp.length > 0) loadLearnCard(); else showStartButton(); return;}
            flashcardFrontText.textContent=cwData.english;flashcardBackIraqi.textContent=cwData.iraqi;flashcardPronunciation.textContent=`نطق: ${cwData.pronunciation}`;flashcardExample.textContent=`مثال: ${cwData.example}`;flashcardExplanation.textContent=`شرح بالفصحى: ${cwData.explanation}`;flashcardExample.classList.toggle('hidden',!gameState.settings.showExamples);
            updateLearnUI();
            if(gameState.settings.autoFlipCard){autoFlipTimeout=setTimeout(()=>{if(!flashcard.classList.contains('flipped')){playSound('flip');flashcard.classList.add('flipped');}},3000);}
            audioEnLearnBtn.onclick=()=>{playSound('click');speakText(cwData.english,'en-US');};
            audioIqLearnBtn.onclick=()=>{playSound('click');speakText(cwData.iraqi,'ar-IQ');};
            audioSaLearnBtn.onclick=()=>{playSound('click');speakText(cwData.explanation,'ar-SA');};
        }

        // MODIFIED: updateLearnUI
        function updateLearnUI() { 
            const c=gameState.settings.difficulty;
            const p=gameState.progressByDifficulty[c];
            const dl={easy:"سهل",medium:"متوسط",hard:"صعب"};
            learnDifficultySubtitleEl.textContent = `المستوى: ${dl[c]}`;
            quizDifficultySubtitleEl.textContent = `المستوى: ${dl[c]}`;
            learnStreakEl.textContent=p.learnStreak;
            learnProgressEl.textContent=`${p.learnedWordIds.size}/${p.learnItemsTotal||0} :التقدم`;
        }

        flashcardClickableArea.addEventListener('click',(e)=>{if(!gameState.gameStarted) return; if(e.target.closest('.audio-btn'))return;playSound('flip');flashcard.classList.toggle('flipped');clearTimeout(autoFlipTimeout);});
        
        hintBtn.addEventListener('click',()=>{
            if(!gameState.gameStarted) return;
            playSound('correct');vibrate();
            if(!flashcard.classList.contains('flipped')){playSound('flip');flashcard.classList.add('flipped');} 
            const cd=gameState.settings.difficulty;const dp=gameState.progressByDifficulty[cd];const lp=getWordsForCurrentSettings('learn');
            if(lp.length===0)return;
            
            let actualCardIndexToProcess=gameState.currentLearnCardIndex%lp.length;
            if(actualCardIndexToProcess<0||actualCardIndexToProcess>=lp.length){actualCardIndexToProcess=0;gameState.currentLearnCardIndex=0;}
            const cw=lp[actualCardIndexToProcess];

            if(cw&&!dp.learnedWordIds.has(cw.id)){dp.learnedWordIds.add(cw.id);gameState.totalWordsLearnedGlobally++;updateAchievementProgress('learner',gameState.totalWordsLearnedGlobally);} 
            dp.learnStreak++;
            if(dp.learnStreak>dp.maxLearnStreak){dp.maxLearnStreak=dp.learnStreak;if(dp.maxLearnStreak>gameState.overallMaxStreak){gameState.overallMaxStreak=dp.maxLearnStreak;updateAchievementProgress('streak',gameState.overallMaxStreak);}} 
            
            let nextCardIndexToShow=(gameState.currentLearnCardIndex+1);
            
            if (dp.learnedWordIds.size === lp.length && nextCardIndexToShow >= lp.length) {
                 setTimeout(() => {
                    showStartButton(); 
                    updateLearnUI();
                    saveGameState();
                }, 300);
            } else {
                setTimeout(()=>{
                    gameState.currentLearnCardIndex=nextCardIndexToShow;
                    loadLearnCard();
                    saveGameState();
                },300);
            }
            updateLearnUI();
        });
        dontKnowBtn.addEventListener('click',()=>{if(!gameState.gameStarted) return; playSound('incorrect');if(!flashcard.classList.contains('flipped')){playSound('flip');flashcard.classList.add('flipped');} gameState.progressByDifficulty[gameState.settings.difficulty].learnStreak=1;updateLearnUI();saveGameState();});
        nextCardBtn.addEventListener('click',()=>{if(!gameState.gameStarted) return; playSound('click');gameState.progressByDifficulty[gameState.settings.difficulty].learnStreak=1;
            let nextCardIndexToShow=(gameState.currentLearnCardIndex+1);
            const lp = getWordsForCurrentSettings('learn');
            const dp = gameState.progressByDifficulty[gameState.settings.difficulty];
            if (dp.learnedWordIds.size === lp.length && nextCardIndexToShow >= lp.length) { 
                showStartButton();
                updateLearnUI();
            } else {
                 gameState.currentLearnCardIndex = nextCardIndexToShow;
                 loadLearnCard();
            }
            saveGameState();
        });

        function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}
        
        function startNewQuiz(){
            playSound('click');
            gameState.quizCurrentQuestionIndex=0;
            gameState.quizScore=0;
            const qp=getWordsForCurrentSettings('quiz');
            
            if(qp.length===0){
                quizQuestionEl.textContent="لا يوجد أسئلة اختبار لهذا المستوى.";
                quizOptionsEl.innerHTML='';
                quizFeedbackEl.textContent='';
                nextQuestionBtn.classList.add('hidden');
                newQuizBtn.classList.remove('hidden');
                updateQuizUI(0);
                return;
            } 
            shuffleArray(qp);
            const aqc=Math.min(QUIZ_QUESTIONS_COUNT,qp.length);
            gameState.quizQuestions=qp.slice(0,aqc);
            quizFeedbackEl.textContent='';
            nextQuestionBtn.classList.add('hidden');
            newQuizBtn.classList.add('hidden');
            quizOptionsEl.innerHTML='';
            loadQuizQuestion();
            updateQuizUI(aqc);
        }
        
        function loadQuizQuestion(){
            if(gameState.quizCurrentQuestionIndex >= gameState.quizQuestions.length){
                endQuiz();return;
            }
            const qd = gameState.quizQuestions[gameState.quizCurrentQuestionIndex];
            
            if (!qd || typeof qd.english !== 'string' || typeof qd.iraqi !== 'string') {
                console.error("Invalid question data:", qd, "at index:", gameState.quizCurrentQuestionIndex);
                quizQuestionEl.textContent = "خطأ في تحميل السؤال.";
                quizOptionsEl.innerHTML = '';
                endQuiz(); 
                return;
            }

            quizQuestionEl.textContent = `ما هي ترجمة كلمة/جملة "${qd.english}" باللهجة العراقية؟`;
            audioEnQuizBtn.onclick = () => {playSound('click'); speakText(qd.english, 'en-US');};

            let opts = [qd.iraqi];
            let awi = wordsData.map(w => w.iraqi).filter(w => typeof w === 'string' && w.trim() !== ''); 
            let dist = [];

            let pds = wordsData
                .filter(w => w.id !== qd.id && 
                             (w.difficulty === gameState.settings.difficulty || w.purpose === 'quiz') && 
                             typeof w.iraqi === 'string' && w.iraqi.trim() !== '')
                .map(w => w.iraqi)
                .filter(p => p !== qd.iraqi); 
            
            shuffleArray(pds);

            for(let p of pds){ 
                if(dist.length < 3 && !opts.includes(p)) dist.push(p);
                if(dist.length >= 3) break;
            }

            if(dist.length < 3){ 
                let fb = awi.filter(w => w !== qd.iraqi && !opts.includes(w) && !dist.includes(w)); 
                shuffleArray(fb);
                for(let f of fb){
                    if(dist.length < 3 && !opts.includes(f)) dist.push(f);
                    if(dist.length >= 3) break;
                }
            }
            opts.push(...dist); 
            opts = [...new Set(opts)].filter(opt => typeof opt === 'string' && opt.trim() !== ''); 
            
            while (opts.length < 2 && awi.length > opts.length) {
                let extra = awi[Math.floor(Math.random() * awi.length)];
                if (!opts.includes(extra)) {
                    opts.push(extra);
                }
            }
            shuffleArray(opts);
            if(opts.length > 4) opts = opts.slice(0,4); 
            quizOptionsEl.innerHTML = ''; 

            if (opts && opts.length > 0) {
                opts.forEach(optionText => {
                    const button = document.createElement('button');
                    button.textContent = optionText;
                    button.onclick = () => { playSound('click'); handleQuizAnswer(optionText, qd.iraqi); };
                    quizOptionsEl.appendChild(button);
                });
            } else { 
                console.error("Quiz: Could not generate options. Fallback. Question:", qd.english);
                const button = document.createElement('button');
                button.textContent = qd.iraqi;
                button.onclick = () => { playSound('click'); handleQuizAnswer(qd.iraqi, qd.iraqi); };
                quizOptionsEl.appendChild(button);
            }

            quizFeedbackEl.textContent = '';
            nextQuestionBtn.classList.add('hidden');
            updateQuizUI(gameState.quizQuestions.length);
        }
        
        // MODIFIED: handleQuizAnswer
        function handleQuizAnswer(sa,ca){
            quizOptionsEl.querySelectorAll('button').forEach(b=>{
                b.disabled=true;
                if(b.textContent===ca)b.classList.add('correct');
                else if(b.textContent===sa)b.classList.add('incorrect');
            });
            gameState.totalQuizQuestionsAttemptedGlobal++;
            if(sa===ca){
                playSound('correct');vibrate(100);
                gameState.quizScore++;
                gameState.totalCorrectQuizAnswersGlobal++;
                quizFeedbackEl.textContent='👍 إجابة صحيحة!';
                quizFeedbackEl.style.color='var(--correct-color)';
            }else{
                playSound('incorrect');vibrate([50,50,50]);
                quizFeedbackEl.textContent='👎 إجابة خاطئة!'; // Removed the correct answer explanation
                quizFeedbackEl.style.color='var(--incorrect-color)';
            } 
            nextQuestionBtn.classList.remove('hidden');
            updateQuizUI(gameState.quizQuestions.length);
            updateAchievementProgress('quiz',{score:gameState.quizScore,totalQuestions:gameState.quizQuestions.length,totalCorrectGlobal:gameState.totalCorrectQuizAnswersGlobal});
            saveGameState();
        }

        function endQuiz(){
            quizQuestionEl.textContent="انتهى الاختبار!";quizOptionsEl.innerHTML='';
            const totalQsInThisQuiz = gameState.quizQuestions.length > 0 ? gameState.quizQuestions.length : 1;
            quizFeedbackEl.textContent=`نتيجتك النهائية: ${gameState.quizScore} من ${totalQsInThisQuiz}`;
            newQuizBtn.classList.remove('hidden');
            const c=gameState.settings.difficulty;const p=gameState.progressByDifficulty[c];
            p.quizAttempts.push({score:gameState.quizScore,total:totalQsInThisQuiz,date:new Date().toISOString()});
            if(gameState.quizScore>p.highestQuizScore||(gameState.quizScore===p.highestQuizScore&&totalQsInThisQuiz>p.highestQuizTotal)){
                p.highestQuizScore=gameState.quizScore;
                p.highestQuizTotal=totalQsInThisQuiz;
            }
            gameState.quizzesCompletedGlobal++;
            updateAchievementProgress('quiz',{score:gameState.quizScore,totalQuestions:totalQsInThisQuiz,totalCorrectGlobal:gameState.totalCorrectQuizAnswersGlobal});
            updateStatsAndAchievementsDisplay();
            saveGameState();
        }
        function updateQuizUI(tq){quizProgressEl.textContent=`السؤال: ${Math.min(gameState.quizCurrentQuestionIndex+1,tq)}/${tq}`;quizScoreDisplayEl.textContent=`النتيجة: ${gameState.quizScore}`; }
        nextQuestionBtn.addEventListener('click',()=>{playSound('click');gameState.quizCurrentQuestionIndex++;loadQuizQuestion();});
        newQuizBtn.addEventListener('click',startNewQuiz);

        function updateStatsAndAchievementsDisplay(){
            statsTotalLearnedEl.textContent=gameState.totalWordsLearnedGlobally;statsMaxStreakEl.textContent=`${gameState.overallMaxStreak} 🔥`;const a=gameState.totalQuizQuestionsAttemptedGlobal>0?Math.round((gameState.totalCorrectQuizAnswersGlobal/gameState.totalQuizQuestionsAttemptedGlobal)*100):0;statsQuizAccuracyEl.textContent=`${a}%`;statsQuizzesCompletedEl.textContent=gameState.quizzesCompletedGlobal;const t=wordsData.filter(w=>w.purpose==='learn').length;const o=t>0?Math.round((gameState.totalWordsLearnedGlobally/t)*100):0;statsOverallProgressBarEl.style.width=`${o}%`;statsOverallProgressBarEl.textContent=`${o}%`;
            difficultyStatsDisplayEl.innerHTML='';const ord=['easy','medium','hard'];const lbl={easy:"سهل",medium:"متوسط",hard:"صعب"};ord.forEach(k=>{const p=gameState.progressByDifficulty[k];const g=document.createElement('div');g.className='difficulty-stats-group';const title=document.createElement('h4');title.textContent=`مستوى: ${lbl[k]}`;g.appendChild(title);const s1=document.createElement('div');s1.className='stat-line';s1.innerHTML=`<span class="label">الكلمات/الجمل المتعلمة:</span> <span class="value">${p.learnedWordIds.size} / ${p.learnItemsTotal||0}</span>`;g.appendChild(s1);const s2=document.createElement('div');s2.className='stat-line';s2.innerHTML=`<span class="label">أعلى نتيجة اختبار:</span> <span class="value">${p.highestQuizScore} / ${p.highestQuizTotal||(p.quizItemsTotal>0?Math.min(QUIZ_QUESTIONS_COUNT,p.quizItemsTotal):0)}</span>`;g.appendChild(s2);const s3=document.createElement('div');s3.className='stat-line';s3.innerHTML=`<span class="label">أطول سلسلة تعلم:</span> <span class="value">${p.maxLearnStreak} 🔥</span>`;g.appendChild(s3);difficultyStatsDisplayEl.appendChild(g);});achievementsListEl.innerHTML='';Object.values(gameState.achievements).forEach(ach=>{if(!ach)return;const i=document.createElement('div');i.classList.add('achievement-item',ach.unlocked?'unlocked':'');i.innerHTML=`<h3>${ach.unlocked?'<span class="trophy-icon">🏆</span>':'<span class="trophy-icon">🔒</span>'} ${ach.name}</h3><p>${ach.description}</p>${ach.goal>0?`<div class="progress-bar-container"><div class="progress-bar-fill" style="width: ${Math.min(100,(ach.current/ach.goal)*100)}%;"></div></div>`:''}`;achievementsListEl.appendChild(i);});
        }
        function updateAchievementProgress(type,value){
            let nu=false;
            if(type==='learner'){['beginner','intermediate','advanced'].forEach(k=>{const a=gameState.achievements[k];if(a&&!a.unlocked){a.current=value;if(a.current>=a.goal){a.unlocked=true;a.current=a.goal;nu=true;}}});}
            else if(type==='streak'){const a=gameState.achievements.streakStar;if(a&&!a.unlocked){a.current=value;if(a.current>=a.goal){a.unlocked=true;a.current=a.goal;nu=true;}}}
            else if(type==='quiz'){
                const n=gameState.achievements.quizNovice;
                if(n&&!n.unlocked){n.current=value.totalCorrectGlobal;if(n.current>=n.goal){n.unlocked=true;n.current=n.goal;nu=true;}}
                else if(n){n.current=Math.min(Math.max(n.current,value.totalCorrectGlobal),n.goal);}
                
                const c=gameState.achievements.quizChampion;
                const currentDifficultyQuizItems = wordsData.filter(w=>w.purpose ==='quiz' && w.difficulty === gameState.settings.difficulty).length;
                c.goal = Math.min(QUIZ_QUESTIONS_COUNT, currentDifficultyQuizItems || QUIZ_QUESTIONS_COUNT);
                c.description = `علامة كاملة في اختبار (${c.goal} أسئلة)`;

                if(c&&!c.unlocked&&value.score===value.totalQuestions&&value.totalQuestions>=c.goal && value.totalQuestions > 0){
                    c.unlocked=true;
                    c.current=c.goal;
                    nu=true;
                }
            } 
            if(nu)playSound('achievement');
            updateStatsAndAchievementsDisplay();
        }
        
        function applySettings(){updateThemeVariables(gameState.settings.colorTheme);document.body.style.backgroundColor=gameState.settings.pageBgColor;difficultyButtons.forEach(b=>b.classList.toggle('active',b.dataset.difficulty===gameState.settings.difficulty));colorThemeSpans.forEach(s=>s.classList.toggle('active',s.dataset.colorTheme===gameState.settings.colorTheme));bgColorSpans.forEach(s=>s.classList.toggle('active',s.dataset.bgColor===gameState.settings.pageBgColor));autoFlipCardCheckbox.checked=gameState.settings.autoFlipCard;showExamplesCheckbox.checked=gameState.settings.showExamples;enableVibrationCheckbox.checked=gameState.settings.enableVibration;enableSoundCheckbox.checked=gameState.settings.enableSound; const rootStyle = document.documentElement.style; const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim(); const rgb = accent.startsWith('#') ? hexToRgb(accent) : parseRgb(accent); if(rgb) rootStyle.setProperty('--accent-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);}
        function hexToRgb(hex) { const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16); return r&&g&&b ? {r,g,b} : null; }
        function parseRgb(rgbString) { const match = rgbString.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/); return match ? {r:parseInt(match[1]), g:parseInt(match[2]), b:parseInt(match[3])} : null; }
        function updateThemeVariables(tn){let p,s,a,as,ae;switch(tn){case'green':p='#66BB6A';s='#43A047';a='#FFEE58';as='#C8E6C9';ae='#A5D6A7';break;case'blue':p='#42A5F5';s='#1E88E5';a='#FFD54F';as='#BBDEFB';ae='#90CAF9';break;case'orange':p='#FFA726';s='#FB8C00';a='#81D4FA';as='#FFE0B2';ae='#FFCC80';break;default:p='#7E57C2';s='#5E35B1';a='#66BB6A';as='#E1BEE7';ae='#CE93D8';}document.documentElement.style.setProperty('--primary-color',p);document.documentElement.style.setProperty('--secondary-color',s);document.documentElement.style.setProperty('--accent-color',a);document.documentElement.style.setProperty('--app-bg-color-start',as);document.documentElement.style.setProperty('--app-bg-color-end',ae); const rootStyle = document.documentElement.style; const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim(); const rgb = accent.startsWith('#') ? hexToRgb(accent) : parseRgb(accent); if(rgb) rootStyle.setProperty('--accent-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`);}
        difficultyButtons.forEach(b=>b.addEventListener('click',()=>{playSound('click');gameState.settings.difficulty=b.dataset.difficulty;
            initializeAchievements(); 
            applySettings();saveGameState();gameState.gameStarted=false; gameState.currentLearnCardIndex=0; 
            if(document.getElementById('learn-section').classList.contains('active')){prepareLearnSection();} 
            if(document.getElementById('quiz-section').classList.contains('active')){startNewQuiz();}
            updateStatsAndAchievementsDisplay();
        }));
        colorThemeSpans.forEach(s=>s.addEventListener('click',()=>{playSound('click');gameState.settings.colorTheme=s.dataset.colorTheme;applySettings();saveGameState();}));
        bgColorSpans.forEach(s=>s.addEventListener('click',()=>{playSound('click');gameState.settings.pageBgColor=s.dataset.bgColor;applySettings();saveGameState();}));
        autoFlipCardCheckbox.addEventListener('change',e=>{gameState.settings.autoFlipCard=e.target.checked;if(gameState.settings.autoFlipCard&&document.getElementById('learn-section').classList.contains('active')&&!flashcard.classList.contains('flipped')&&gameState.gameStarted){clearTimeout(autoFlipTimeout);autoFlipTimeout=setTimeout(()=>{if(!flashcard.classList.contains('flipped')){playSound('flip');flashcard.classList.add('flipped');}},3000);}else{clearTimeout(autoFlipTimeout);}saveGameState();});
        showExamplesCheckbox.addEventListener('change',e=>{gameState.settings.showExamples=e.target.checked;if(document.getElementById('learn-section').classList.contains('active') && gameState.gameStarted)loadLearnCard();saveGameState();});
        enableVibrationCheckbox.addEventListener('change',e=>{gameState.settings.enableVibration=e.target.checked;saveGameState();});
        enableSoundCheckbox.addEventListener('change',e=>{gameState.settings.enableSound=e.target.checked;saveGameState();});
        resetProgressBtn.addEventListener('click',()=>{playSound('click');if(confirm("هل أنت متأكد أنك تريد إعادة ضبط كل التقدم والإعدادات؟ لا يمكن التراجع عن هذا الإجراء.")){playSound('incorrect');localStorage.removeItem('iraqiDialectGameState_v3.9.0');gameState={currentLearnCardIndex:0,totalWordsLearnedGlobally:0,overallMaxStreak:1,quizCurrentQuestionIndex:0,quizScore:0,quizQuestions:[],totalCorrectQuizAnswersGlobal:0,totalQuizQuestionsAttemptedGlobal:0,quizzesCompletedGlobal:0,gameStarted:false,settings:{difficulty:'easy',autoFlipCard:!1,showExamples:!0,enableVibration:!0,enableSound:!0,colorTheme:'default',pageBgColor:'#ECEFF1'},progressByDifficulty:{easy:{learnedWordIds:new Set(),quizAttempts:[],highestQuizScore:0,highestQuizTotal:0,learnStreak:1,maxLearnStreak:1,learnItemsTotal:0,quizItemsTotal:0},medium:{learnedWordIds:new Set(),quizAttempts:[],highestQuizScore:0,highestQuizTotal:0,learnStreak:1,maxLearnStreak:1,learnItemsTotal:0,quizItemsTotal:0},hard:{learnedWordIds:new Set(),quizAttempts:[],highestQuizScore:0,highestQuizTotal:0,learnStreak:1,maxLearnStreak:1,learnItemsTotal:0,quizItemsTotal:0}},achievements:{}};initializeAchievements();updateDifficultyItemCounts();applySettings();updateLearnUI();updateStatsAndAchievementsDisplay();if(document.getElementById('learn-section').classList.contains('active'))prepareLearnSection();if(document.getElementById('quiz-section').classList.contains('active'))startNewQuiz();alert("تمت إعادة ضبط كل شيء.");}});

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            preloadSounds(); 
            loadGameState(); 
            applySettings(); 
            updateLearnUI(); 
            updateStatsAndAchievementsDisplay(); 
            switchSection('learn-section'); 
            updateThemeVariables(gameState.settings.colorTheme);
            document.body.style.backgroundColor = gameState.settings.pageBgColor;
            if(synth&&!synthesisReady&&voices.length===0){setTimeout(()=>{console.log("DOMContentLoaded: Late attempt to populate voices.");if(synth){const cv=synth.getVoices();if(cv.length>0){voices=cv;synthesisReady=!0;console.log("Voices loaded on late attempt:",voices.length);[audioEnLearnBtn,audioIqLearnBtn,audioSaLearnBtn,audioEnQuizBtn].forEach(b=>{if(b)b.disabled=!1});}else console.log("Still no voices on late attempt.");}},1000);}else if(synthesisReady){console.log("Voices were already ready on DOMContentLoaded.");[audioEnLearnBtn,audioIqLearnBtn,audioSaLearnBtn,audioEnQuizBtn].forEach(b=>{if(b)b.disabled=!1});}
        });
    </script>
</body>
</html>