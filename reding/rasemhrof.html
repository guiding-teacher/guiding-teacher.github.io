<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>رسم الحروف العربية - تعلم مع سامي</title>
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --background: #F7FFF7;
            --paper-color: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: var(--background);
            height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: none;
            overflow: hidden;
        }

        .app-title {
            background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .app-title .mascot {
            position: absolute;
            left: 15px;
            font-size: 2rem;
            animation: bounce 2s infinite;
        }

        .title-actions {
            position: absolute;
            left: 60px;
            display: flex;
            gap: 5px;
        }

        .title-btn {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .title-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .target-container {
            background: white;
            padding: 15px;
            text-align: center;
            font-size: 1rem;
            color: var(--primary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
              border: 2px solid #ddd;
             border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .target-letter {
            font-size: 1.0rem;
            font-weight: bold;
            color: #2c3e50;
            background: #f8f9fa;
            padding: 10px 10px;
            border-radius: 10px;
            border: 2px dashed var(--secondary);
        }

        .canvas-wrapper {
            flex: 1;
            position: relative;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f0f0f0;
            padding: 20px;
        }

        .canvas-container {
            position: relative;
            margin: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #ddd;
            background-color: var(--paper-color);
        }

        .lined-paper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            background-image: 
                linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            display: none;
            z-index: 1;
        }

        #drawingCanvas {
            position: relative;
            z-index: 2;
            background: transparent;
            touch-action: none;
            display: block;
        }

        .toolbar {
            display: flex;
            background: white;
            padding: 10px;
            gap: 10px;
            overflow-x: auto;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            -webkit-overflow-scrolling: touch;
        }

        .tool-btn {
            min-width: 50px;
            height: 50px;
            border: none;
            border-radius: 15px;
            background: #f1f2f6;
            color: #2f3542;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
            padding: 0 5px;
            flex-shrink: 0;
        }

        .tool-btn.active {
            background: var(--primary);
            color: white;
            transform: scale(0.95);
        }

        .tool-btn .icon {
            font-size: 1.5rem;
        }

        .tool-btn .label {
            font-size: 0.7rem;
            margin-top: 2px;
        }

        .tool-panel {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 100;
            max-width: 90vw;
            max-height: 60vh;
            overflow: auto;
            animation: fadeIn 0.3s;
            -webkit-overflow-scrolling: touch;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #eee;
            transition: transform 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .size-options {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .size-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #2f3542;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            transition: transform 0.2s;
        }

        .size-option:hover {
            transform: scale(1.1);
        }

        .pen-type-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .pen-type-option {
            padding: 8px;
            border-radius: 10px;
            background: #f1f2f6;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .pen-type-option:hover {
            transform: scale(0.95);
        }

        .pen-type-option.active {
            background: var(--primary);
            color: white;
        }

        .brush-type-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .brush-type-option {
            padding: 8px;
            border-radius: 10px;
            background: #f1f2f6;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .brush-type-option:hover {
            transform: scale(0.95);
        }

        .brush-type-option.active {
            background: var(--primary);
            color: white;
        }

        .sticker-palette {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .sticker-option {
            font-size: 1.5rem;
            cursor: pointer;
            text-align: center;
            padding: 5px;
            border-radius: 10px;
            background: #f1f2f6;
            transition: all 0.2s;
        }

        .sticker-option:hover {
            transform: scale(1.1);
            background: var(--secondary);
        }

        .shape-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
        }

        .shape-option {
            font-size: 1.5rem;
            cursor: pointer;
            text-align: center;
            padding: 5px;
            border-radius: 10px;
            background: #f1f2f6;
            transition: all 0.2s;
        }

        .shape-option:hover {
            transform: scale(1.1);
            background: var(--secondary);
        }

        .paper-size-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .paper-size-option {
            padding: 10px;
            border-radius: 10px;
            background: #f1f2f6;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .paper-size-option:hover {
            transform: scale(0.95);
        }

        .paper-size-option.active {
            background: var(--primary);
            color: white;
        }

        .bg-color-palette {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .bg-color-option {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #eee;
            transition: transform 0.2s;
        }

        .bg-color-option:hover {
            transform: scale(1.1);
        }

        .draggable {
            position: absolute;
            z-index: 10;
            user-select: none;
            touch-action: none;
            transition: transform 0.1s;
            cursor: move;
        }

        .draggable.selected {
            outline: 2px dashed var(--primary);
        }

            .draggable-controls {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 5px;
            background: white;
            padding: 5px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 20;
        }

        .draggable.selected .draggable-controls {
            display: flex;
        }

        .control-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: #f1f2f6;
            color: #2f3542;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            pointer-events: auto; /* إضافة هذه الخاصية */
        }

        .control-btn.delete {
            background: #ff6b6b;
            color: white;
        }

        

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--primary);
            opacity: 0;
            z-index: 9999;
            animation: confetti-fall 3s ease-in-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.5s;
        }

        .celebration h2 {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .celebration .emoji {
            font-size: 5rem;
            animation: bounce 1s infinite alternate;
        }

        .celebration button {
            margin-top: 20px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .empty-canvas-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
            text-align: center;
            display: none;
        }

        .save-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1002;
            text-align: center;
            display: none;
        }

        .save-panel button {
            margin: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 1rem;
            cursor: pointer;
        }

        .save-panel .save-btn {
            background: var(--primary);
            color: white;
        }

        .save-panel .cancel-btn {
            background: #f1f2f6;
            color: #2f3542;
        }

        @media (max-width: 768px) {
            .color-palette, .bg-color-palette, .sticker-palette {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .shape-palette {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .title-actions {
                left: 50px;
            }
            
            .title-btn {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }
            
            .tool-btn {
                min-width: 45px;
                height: 45px;
                font-size: 1rem;
            }
            
            .tool-btn .label {
                font-size: 0.6rem;
            }
        }

        @media (max-width: 480px) {
            .color-palette, .bg-color-palette {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .sticker-palette, .shape-palette {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .pen-type-options, .brush-type-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .target-letter {
                font-size: 2rem;
                padding: 5px 10px;
            }
            
            .target-container {
                font-size: 1.5rem;
            }
            
            .title-actions {
                left: 40px;
                gap: 3px;
            }
            
            .title-btn {
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
            }
            
            .tool-panel {
                max-width: 95vw;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app-title">
        <span class="mascot">👦</span>
        تعلم رسم الحروف العربية
    </div>
    
    <div class="target-container">
        <span>ارسم هذا الحرف:</span>
        <span class="target-letter" id="targetLetter">ب</span>
        <button class="tool-btn" onclick="setRandomLetter()" style="margin-right: auto;">
            <span class="icon">🔄</span>
            <span class="label">تغيير</span>
        </button>

        <div class="title-actions">
            <button class="title-btn" onclick="showToolPanel('paperSizePanel')">📄</button>
            <button class="title-btn" onclick="showToolPanel('bgColorPanel')">🎨</button>
            <button class="title-btn" onclick="toggleLinedPaper()">📝</button>
        </div>
    </div>
    
    <div class="canvas-wrapper">
        <div class="canvas-container" id="canvasContainer">
            <div class="lined-paper" id="linedPaper"></div>
            <canvas id="drawingCanvas"></canvas>
        </div>
    </div>
    
    <div class="toolbar">
        <button class="tool-btn" onclick="showToolPanel('colorPanel')">
            <span class="icon">🎨</span>
            <span class="label">لون</span>
        </button>
        <button class="tool-btn" onclick="showToolPanel('sizePanel')">
            <span class="icon">🖌️</span>
            <span class="label">حجم</span>
        </button>
        <button class="tool-btn" onclick="showToolPanel('penTypePanel')">
            <span class="icon">✒️</span>
            <span class="label">نوع القلم</span>
        </button>
        <button class="tool-btn" onclick="showToolPanel('brushTypePanel')">
            <span class="icon">🖍️</span>
            <span class="label">نوع الفرشاة</span>
        </button>
        <button class="tool-btn" onclick="showToolPanel('geometricShapesPanel')">
            <span class="icon">🔷</span>
            <span class="label">هندسية</span>
        </button>
        <button class="tool-btn" onclick="showToolPanel('shapePanel')">
            <span class="icon">⭐</span>
            <span class="label">أشكال</span>
        </button>
        <button class="tool-btn" onclick="showToolPanel('stickerPanel')">
            <span class="icon">😊</span>
            <span class="label">وجوه</span>
        </button>
        <button class="tool-btn" id="eraserBtn" onclick="toggleEraserMode()">
            <span class="icon">🧽</span>
            <span class="label">مسح</span>
        </button>
        <button class="tool-btn" onclick="clearCanvas()">
            <span class="icon">🗑️</span>
            <span class="label">مسح الكل</span>
        </button>
        <button class="tool-btn" onclick="undoAction()">
            <span class="icon">↩️</span>
            <span class="label">تراجع</span>
        </button>
        <button class="tool-btn" onclick="showSavePanel()">
            <span class="icon">💾</span>
            <span class="label">حفظ</span>
        </button>
    </div>
    
    <!-- لوحة الألوان -->
    <div class="tool-panel" id="colorPanel">
        <div class="color-palette">
            <div class="color-option" style="background: #e74c3c;" onclick="setColor('#e74c3c')"></div>
            <div class="color-option" style="background: #c0392b;" onclick="setColor('#c0392b')"></div>
            <div class="color-option" style="background: #d35400;" onclick="setColor('#d35400')"></div>
            <div class="color-option" style="background: #e67e22;" onclick="setColor('#e67e22')"></div>
            <div class="color-option" style="background: #f39c12;" onclick="setColor('#f39c12')"></div>
            <div class="color-option" style="background: #f1c40f;" onclick="setColor('#f1c40f')"></div>
            <div class="color-option" style="background: #2ecc71;" onclick="setColor('#2ecc71')"></div>
            <div class="color-option" style="background: #27ae60;" onclick="setColor('#27ae60')"></div>
            <div class="color-option" style="background: #1abc9c;" onclick="setColor('#1abc9c')"></div>
            <div class="color-option" style="background: #16a085;" onclick="setColor('#16a085')"></div>
            <div class="color-option" style="background: #3498db;" onclick="setColor('#3498db')"></div>
            <div class="color-option" style="background: #2980b9;" onclick="setColor('#2980b9')"></div>
            <div class="color-option" style="background: #9b59b6;" onclick="setColor('#9b59b6')"></div>
            <div class="color-option" style="background: #8e44ad;" onclick="setColor('#8e44ad')"></div>
            <div class="color-option" style="background: #34495e;" onclick="setColor('#34495e')"></div>
            <div class="color-option" style="background: #2c3e50;" onclick="setColor('#2c3e50')"></div>
            <div class="color-option" style="background: #e84393;" onclick="setColor('#e84393')"></div>
            <div class="color-option" style="background: #fd79a8;" onclick="setColor('#fd79a8')"></div>
            <div class="color-option" style="background: #6c5ce7;" onclick="setColor('#6c5ce7')"></div>
            <div class="color-option" style="background: #a29bfe;" onclick="setColor('#a29bfe')"></div>
            <div class="color-option" style="background: #00b894;" onclick="setColor('#00b894')"></div>
            <div class="color-option" style="background: #55efc4;" onclick="setColor('#55efc4')"></div>
            <div class="color-option" style="background: #ffeaa7;" onclick="setColor('#ffeaa7')"></div>
            <div class="color-option" style="background: #fdcb6e;" onclick="setColor('#fdcb6e')"></div>
            <div class="color-option" style="background: #e17055;" onclick="setColor('#e17055')"></div>
            <div class="color-option" style="background: #ff7675;" onclick="setColor('#ff7675')"></div>
            <div class="color-option" style="background: #0984e3;" onclick="setColor('#0984e3')"></div>
            <div class="color-option" style="background: #74b9ff;" onclick="setColor('#74b9ff')"></div>
            <div class="color-option" style="background: #00cec9;" onclick="setColor('#00cec9')"></div>
            <div class="color-option" style="background: #81ecec;" onclick="setColor('#81ecec')"></div>
            <div class="color-option" style="background: #dfe6e9;" onclick="setColor('#dfe6e9')"></div>
            <div class="color-option" style="background: #b2bec3;" onclick="setColor('#b2bec3')"></div>
            <div class="color-option" style="background: #636e72;" onclick="setColor('#636e72')"></div>
            <div class="color-option" style="background: #000000;" onclick="setColor('#000000')"></div>
        </div>
    </div>
    
    <!-- لوحة أحجام الخط -->
    <div class="tool-panel" id="sizePanel">
        <div class="size-options">
            <div class="size-option" onclick="setSize(1)">1</div>
            <div class="size-option" onclick="setSize(2)">2</div>
            <div class="size-option" onclick="setSize(3)">3</div>
            <div class="size-option" onclick="setSize(5)">5</div>
            <div class="size-option" onclick="setSize(8)">8</div>
            <div class="size-option" onclick="setSize(10)">10</div>
            <div class="size-option" onclick="setSize(12)">12</div>
            <div class="size-option" onclick="setSize(15)">15</div>
            <div class="size-option" onclick="setSize(18)">18</div>
            <div class="size-option" onclick="setSize(20)">20</div>
            <div class="size-option" onclick="setSize(25)">25</div>
            <div class="size-option" onclick="setSize(30)">30</div>
            <div class="size-option" onclick="setSize(40)">40</div>
            <div class="size-option" onclick="setSize(50)">50</div>
            <div class="size-option" onclick="setSize(60)">60</div>
            <div class="size-option" onclick="setSize(80)">80</div>
        </div>
    </div>
    
    <!-- لوحة أنواع الأقلام -->
    <div class="tool-panel" id="penTypePanel">
        <div class="pen-type-options">
            <div class="pen-type-option active" onclick="setPenType('solid')">مستمر</div>
            <div class="pen-type-option" onclick="setPenType('dashed')">منقط</div>
            <div class="pen-type-option" onclick="setPenType('dotted')">نقاط</div>
            <div class="pen-type-option" onclick="setPenType('double')">مزدوج</div>
            <div class="pen-type-option" onclick="setPenType('wave')">متموج</div>
            <div class="pen-type-option" onclick="setPenType('zigzag')">متعرج</div>
        </div>
    </div>

    <!-- لوحة الأشكال الهندسية -->
    <div class="tool-panel" id="geometricShapesPanel">
        <div class="shape-palette">
            <div class="shape-option" onclick="addGeometricShape('rectangle')">▭</div>
            <div class="shape-option" onclick="addGeometricShape('circle')">⬤</div>
            <div class="shape-option" onclick="addGeometricShape('triangle')">▲</div>
            <div class="shape-option" onclick="addGeometricShape('line')">─</div>
            <div class="shape-option" onclick="addGeometricShape('diamond')">◆</div>
            <div class="shape-option" onclick="addGeometricShape('pentagon')">⬟</div>
            <div class="shape-option" onclick="addGeometricShape('hexagon')">⬢</div>
            <div class="shape-option" onclick="addGeometricShape('star')">★</div>
            <div class="shape-option" onclick="addGeometricShape('heart')">♥</div>
            <div class="shape-option" onclick="addGeometricShape('oval')">⬭</div>
            <div class="shape-option" onclick="addGeometricShape('arrow')">➔</div>
            <div class="shape-option" onclick="addGeometricShape('cross')">✚</div>
        </div>
    </div>
    
    <!-- لوحة أنواع الفرش -->
    <div class="tool-panel" id="brushTypePanel">
        <div class="brush-type-options">
            <div class="brush-type-option active" onclick="setBrushType('round')">دائري</div>
            <div class="brush-type-option" onclick="setBrushType('square')">مربع</div>
            <div class="brush-type-option" onclick="setBrushType('flat')">مسطح</div>
            <div class="brush-type-option" onclick="setBrushType('marker')">ماركر</div>
            <div class="brush-type-option" onclick="setBrushType('chalk')">طباشير</div>
            <div class="brush-type-option" onclick="setBrushType('pencil')">قلم رصاص</div>
        </div>
    </div>
    
    <!-- لوحة الأشكال -->
    <div class="tool-panel" id="shapePanel">
        <div class="shape-palette">
            <div class="shape-option" onclick="addShape('star')">⭐</div>
            <div class="shape-option" onclick="addShape('heart')">❤️</div>
            <div class="shape-option" onclick="addShape('circle')">🔴</div>
            <div class="shape-option" onclick="addShape('square')">🟥</div>
            <div class="shape-option" onclick="addShape('triangle')">🔺</div>
            <div class="shape-option" onclick="addShape('cloud')">☁️</div>
            <div class="shape-option" onclick="addShape('sun')">☀️</div>
            <div class="shape-option" onclick="addShape('moon')">🌙</div>
            <div class="shape-option" onclick="addShape('flower')">🌼</div>
            <div class="shape-option" onclick="addShape('tree')">🌳</div>
            <div class="shape-option" onclick="addShape('car')">🚗</div>
            <div class="shape-option" onclick="addShape('house')">🏠</div>
            <div class="shape-option" onclick="addShape('ball')">⚽</div>
            <div class="shape-option" onclick="addShape('book')">📚</div>
            <div class="shape-option" onclick="addShape('cat')">🐱</div>
            <div class="shape-option" onclick="addShape('dog')">🐶</div>
            <div class="shape-option" onclick="addShape('fish')">🐠</div>
            <div class="shape-option" onclick="addShape('bird')">🐦</div>
            <div class="shape-option" onclick="addShape('apple')">🍎</div>
            <div class="shape-option" onclick="addShape('banana')">🍌</div>
            <div class="shape-option" onclick="addShape('gift')">🎁</div>
            <div class="shape-option" onclick="addShape('balloon')">🎈</div>
            <div class="shape-option" onclick="addShape('rocket')">🚀</div>
            <div class="shape-option" onclick="addShape('train')">🚂</div>
            <div class="shape-option" onclick="addShape('boat')">⛵</div>
            <div class="shape-option" onclick="addShape('plane')">✈️</div>
            <div class="shape-option" onclick="addShape('umbrella')">☂️</div>
            <div class="shape-option" onclick="addShape('clock')">⏰</div>
            <div class="shape-option" onclick="addShape('light')">💡</div>
            <div class="shape-option" onclick="addShape('key')">🔑</div>
            <div class="shape-option" onclick="addShape('lock')">🔒</div>
            <div class="shape-option" onclick="addShape('scissor')">✂️</div>
            <div class="shape-option" onclick="addShape('phone')">📱</div>
            <div class="shape-option" onclick="addShape('tv')">📺</div>
            <div class="shape-option" onclick="addShape('camera')">📷</div>
            <div class="shape-option" onclick="addShape('game')">🎮</div>
            <div class="shape-option" onclick="addShape('music')">🎵</div>
            <div class="shape-option" onclick="addShape('microphone')">🎤</div>
            <div class="shape-option" onclick="addShape('flag')">🚩</div>
            <div class="shape-option" onclick="addShape('medal')">🏅</div>
            <div class="shape-option" onclick="addShape('crown')">👑</div>
            <div class="shape-option" onclick="addShape('robot')">🤖</div>
            <div class="shape-option" onclick="addShape('alien')">👽</div>
            <div class="shape-option" onclick="addShape('ghost')">👻</div>
            <div class="shape-option" onclick="addShape('dinosaur')">🦖</div>
            <div class="shape-option" onclick="addShape('unicorn')">🦄</div>
            <div class="shape-option" onclick="addShape('dragon')">🐉</div>
            <div class="shape-option" onclick="addShape('castle')">🏰</div>
        </div>
    </div>
    
    <!-- لوحة الملصقات -->
    <div class="tool-panel" id="stickerPanel">
        <div class="sticker-palette">
            <div class="sticker-option" onclick="addSticker('😀')">😀</div>
            <div class="sticker-option" onclick="addSticker('😃')">😃</div>
            <div class="sticker-option" onclick="addSticker('😄')">😄</div>
            <div class="sticker-option" onclick="addSticker('😁')">😁</div>
            <div class="sticker-option" onclick="addSticker('😆')">😆</div>
            <div class="sticker-option" onclick="addSticker('😅')">😅</div>
            <div class="sticker-option" onclick="addSticker('😂')">😂</div>
            <div class="sticker-option" onclick="addSticker('🤣')">🤣</div>
            <div class="sticker-option" onclick="addSticker('😊')">😊</div>
            <div class="sticker-option" onclick="addSticker('😇')">😇</div>
            <div class="sticker-option" onclick="addSticker('🙂')">🙂</div>
            <div class="sticker-option" onclick="addSticker('🙃')">🙃</div>
            <div class="sticker-option" onclick="addSticker('😉')">😉</div>
            <div class="sticker-option" onclick="addSticker('😌')">😌</div>
            <div class="sticker-option" onclick="addSticker('😍')">😍</div>
            <div class="sticker-option" onclick="addSticker('🥰')">🥰</div>
            <div class="sticker-option" onclick="addSticker('😘')">😘</div>
            <div class="sticker-option" onclick="addSticker('😗')">😗</div>
            <div class="sticker-option" onclick="addSticker('😙')">😙</div>
            <div class="sticker-option" onclick="addSticker('😚')">😚</div>
            <div class="sticker-option" onclick="addSticker('😋')">😋</div>
            <div class="sticker-option" onclick="addSticker('😛')">😛</div>
            <div class="sticker-option" onclick="addSticker('😝')">😝</div>
            <div class="sticker-option" onclick="addSticker('😜')">😜</div>
            <div class="sticker-option" onclick="addSticker('🤪')">🤪</div>
            <div class="sticker-option" onclick="addSticker('🤨')">🤨</div>
            <div class="sticker-option" onclick="addSticker('🧐')">🧐</div>
            <div class="sticker-option" onclick="addSticker('🤓')">🤓</div>
            <div class="sticker-option" onclick="addSticker('😎')">😎</div>
            <div class="sticker-option" onclick="addSticker('🤩')">🤩</div>
            <div class="sticker-option" onclick="addSticker('🥳')">🥳</div>
            <div class="sticker-option" onclick="addSticker('😏')">😏</div>
            <div class="sticker-option" onclick="addSticker('😒')">😒</div>
            <div class="sticker-option" onclick="addSticker('😞')">😞</div>
            <div class="sticker-option" onclick="addSticker('😔')">😔</div>
            <div class="sticker-option" onclick="addSticker('😟')">😟</div>
            <div class="sticker-option" onclick="addSticker('😕')">😕</div>
            <div class="sticker-option" onclick="addSticker('🙁')">🙁</div>
            <div class="sticker-option" onclick="addSticker('☹️')">☹️</div>
            <div class="sticker-option" onclick="addSticker('😣')">😣</div>
            <div class="sticker-option" onclick="addSticker('😖')">😖</div>
            <div class="sticker-option" onclick="addSticker('😫')">😫</div>
            <div class="sticker-option" onclick="addSticker('😩')">😩</div>
            <div class="sticker-option" onclick="addSticker('🥺')">🥺</div>
            <div class="sticker-option" onclick="addSticker('😢')">😢</div>
            <div class="sticker-option" onclick="addSticker('😭')">😭</div>
            <div class="sticker-option" onclick="addSticker('😤')">😤</div>
            <div class="sticker-option" onclick="addSticker('😠')">😠</div>
            <div class="sticker-option" onclick="addSticker('😡')">😡</div>
            <div class="sticker-option" onclick="addSticker('🤬')">🤬</div>
            <div class="sticker-option" onclick="addSticker('🤯')">🤯</div>
            <div class="sticker-option" onclick="addSticker('😳')">😳</div>
            <div class="sticker-option" onclick="addSticker('🥵')">🥵</div>
            <div class="sticker-option" onclick="addSticker('🥶')">🥶</div>
            <div class="sticker-option" onclick="addSticker('😱')">😱</div>
            <div class="sticker-option" onclick="addSticker('😨')">😨</div>
            <div class="sticker-option" onclick="addSticker('😰')">😰</div>
            <div class="sticker-option" onclick="addSticker('😥')">😥</div>
            <div class="sticker-option" onclick="addSticker('😓')">😓</div>
            <div class="sticker-option" onclick="addSticker('🤗')">🤗</div>
            <div class="sticker-option" onclick="addSticker('🤔')">🤔</div>
            <div class="sticker-option" onclick="addSticker('🤭')">🤭</div>
            <div class="sticker-option" onclick="addSticker('🤫')">🤫</div>
            <div class="sticker-option" onclick="addSticker('🤥')">🤥</div>
            <div class="sticker-option" onclick="addSticker('😶')">😶</div>
            <div class="sticker-option" onclick="addSticker('😐')">😐</div>
            <div class="sticker-option" onclick="addSticker('😑')">😑</div>
            <div class="sticker-option" onclick="addSticker('😬')">😬</div>
            <div class="sticker-option" onclick="addSticker('🙄')">🙄</div>
            <div class="sticker-option" onclick="addSticker('😯')">😯</div>
            <div class="sticker-option" onclick="addSticker('😦')">😦</div>
            <div class="sticker-option" onclick="addSticker('😧')">😧</div>
            <div class="sticker-option" onclick="addSticker('😮')">😮</div>
            <div class="sticker-option" onclick="addSticker('😲')">😲</div>
            <div class="sticker-option" onclick="addSticker('🥱')">🥱</div>
            <div class="sticker-option" onclick="addSticker('😴')">😴</div>
            <div class="sticker-option" onclick="addSticker('🤤')">🤤</div>
            <div class="sticker-option" onclick="addSticker('😪')">😪</div>
            <div class="sticker-option" onclick="addSticker('😵')">😵</div>
            <div class="sticker-option" onclick="addSticker('🤐')">🤐</div>
            <div class="sticker-option" onclick="addSticker('🥴')">🥴</div>
            <div class="sticker-option" onclick="addSticker('🤢')">🤢</div>
            <div class="sticker-option" onclick="addSticker('🤮')">🤮</div>
            <div class="sticker-option" onclick="addSticker('🤧')">🤧</div>
            <div class="sticker-option" onclick="addSticker('😷')">😷</div>
            <div class="sticker-option" onclick="addSticker('🤒')">🤒</div>
            <div class="sticker-option" onclick="addSticker('🤕')">🤕</div>
            <div class="sticker-option" onclick="addSticker('🤑')">🤑</div>
            <div class="sticker-option" onclick="addSticker('🤠')">🤠</div>
            <div class="sticker-option" onclick="addSticker('😈')">😈</div>
            <div class="sticker-option" onclick="addSticker('👿')">👿</div>
            <div class="sticker-option" onclick="addSticker('👹')">👹</div>
            <div class="sticker-option" onclick="addSticker('👺')">👺</div>
            <div class="sticker-option" onclick="addSticker('🤡')">🤡</div>
            <div class="sticker-option" onclick="addSticker('👻')">👻</div>
            <div class="sticker-option" onclick="addSticker('👽')">👽</div>
            <div class="sticker-option" onclick="addSticker('👾')">👾</div>
            <div class="sticker-option" onclick="addSticker('🤖')">🤖</div>
            <div class="sticker-option" onclick="addSticker('🎃')">🎃</div>
            <div class="sticker-option" onclick="addSticker('😺')">😺</div>
            <div class="sticker-option" onclick="addSticker('😸')">😸</div>
            <div class="sticker-option" onclick="addSticker('😹')">😹</div>
            <div class="sticker-option" onclick="addSticker('😻')">😻</div>
            <div class="sticker-option" onclick="addSticker('😼')">😼</div>
            <div class="sticker-option" onclick="addSticker('😽')">😽</div>
            <div class="sticker-option" onclick="addSticker('🙀')">🙀</div>
            <div class="sticker-option" onclick="addSticker('😿')">😿</div>
            <div class="sticker-option" onclick="addSticker('😾')">😾</div>
        </div>
    </div>
    
    <!-- لوحة حجم الورقة -->
    <div class="tool-panel" id="paperSizePanel">
        <div class="paper-size-options">
            <div class="paper-size-option" onclick="setPaperSize('mobile')">جوال (360×640)</div>
            <div class="paper-size-option" onclick="setPaperSize('tablet')">تابلت (768×1024)</div>
            <div class="paper-size-option" onclick="setPaperSize('laptop')">لابتوب (1366×768)</div>
            <div class="paper-size-option" onclick="setPaperSize('desktop')">كمبيوتر (1920×1080)</div>
            <div class="paper-size-option" onclick="setPaperSize('tv')">شاشة تلفاز (3840×2160)</div>
            <div class="paper-size-option" onclick="setPaperSize('youtube')">يوتيوب (1280×720)</div>
            <div class="paper-size-option" onclick="setPaperSize('instagram')">انستغرام (1080×1080)</div>
            <div class="paper-size-option" onclick="setPaperSize('a5')">A4 (210×297مم)</div>
            <div class="paper-size-option" onclick="setPaperSize('square2000')">مربع (2000×2000)</div>
            <div class="paper-size-option" onclick="setPaperSize('rect2000x1000')">مستطيل (2000×1000)</div>
            <div class="paper-size-option" onclick="setPaperSize('rect2000x2500')">مستطيل (2000×2500)</div>
            <div class="paper-size-option" onclick="setPaperSize('ratio16x9')">نسبة 16:9</div>
            <div class="paper-size-option" onclick="setPaperSize('size3000x2000')">مقاس (3000×2000)</div>
            <div class="paper-size-option" onclick="setPaperSize('full')">ملء الشاشة</div>
        </div>
    </div>
    
    <!-- لوحة ألوان الخلفية -->
    <div class="tool-panel" id="bgColorPanel">
        <div class="bg-color-palette">
            <div class="bg-color-option" style="background: #ffffff;" onclick="setBackgroundColor('#ffffff')"></div>
            <div class="bg-color-option" style="background: #f8f9fa;" onclick="setBackgroundColor('#f8f9fa')"></div>
            <div class="bg-color-option" style="background: #e9ecef;" onclick="setBackgroundColor('#e9ecef')"></div>
            <div class="bg-color-option" style="background: #dee2e6;" onclick="setBackgroundColor('#dee2e6')"></div>
            <div class="bg-color-option" style="background: #ced4da;" onclick="setBackgroundColor('#ced4da')"></div>
            <div class="bg-color-option" style="background: #adb5bd;" onclick="setBackgroundColor('#adb5bd')"></div>
            <div class="bg-color-option" style="background: #6c757d;" onclick="setBackgroundColor('#6c757d')"></div>
            <div class="bg-color-option" style="background: #495057;" onclick="setBackgroundColor('#495057')"></div>
            <div class="bg-color-option" style="background: #343a40;" onclick="setBackgroundColor('#343a40')"></div>
            <div class="bg-color-option" style="background: #212529;" onclick="setBackgroundColor('#212529')"></div>
            <div class="bg-color-option" style="background: #fff5f5;" onclick="setBackgroundColor('#fff5f5')"></div>
            <div class="bg-color-option" style="background: #fff0f6;" onclick="setBackgroundColor('#fff0f6')"></div>
            <div class="bg-color-option" style="background: #f8f0fc;" onclick="setBackgroundColor('#f8f0fc')"></div>
            <div class="bg-color-option" style="background: #f3f0ff;" onclick="setBackgroundColor('#f3f0ff')"></div>
            <div class="bg-color-option" style="background: #edf2ff;" onclick="setBackgroundColor('#edf2ff')"></div>
            <div class="bg-color-option" style="background: #e6fcf5;" onclick="setBackgroundColor('#e6fcf5')"></div>
            <div class="bg-color-option" style="background: #e6fcf5;" onclick="setBackgroundColor('#e6fcf5')"></div>
            <div class="bg-color-option" style="background: #fff9db;" onclick="setBackgroundColor('#fff9db')"></div>
            <div class="bg-color-option" style="background: #fff4e6;" onclick="setBackgroundColor('#fff4e6')"></div>
            <div class="bg-color-option" style="background: #f8f9fa;" onclick="setBackgroundColor('#f8f9fa')"></div>
            <div class="bg-color-option" style="background: #e9f5ff;" onclick="setBackgroundColor('#e9f5ff')"></div>
            <div class="bg-color-option" style="background: #f0f9ff;" onclick="setBackgroundColor('#f0f9ff')"></div>
            <div class="bg-color-option" style="background: #f0fdf4;" onclick="setBackgroundColor('#f0fdf4')"></div>
            <div class="bg-color-option" style="background: #f7fee7;" onclick="setBackgroundColor('#f7fee7')"></div>
            <div class="bg-color-option" style="background: #fff7ed;" onclick="setBackgroundColor('#fff7ed')"></div>
            <div class="bg-color-option" style="background: #fef2f2;" onclick="setBackgroundColor('#fef2f2')"></div>
            <div class="bg-color-option" style="background: #fdf4ff;" onclick="setBackgroundColor('#fdf4ff')"></div>
            <div class="bg-color-option" style="background: #f0fdfa;" onclick="setBackgroundColor('#f0fdfa')"></div>
            <div class="bg-color-option" style="background: #ecfdf5;" onclick="setBackgroundColor('#ecfdf5')"></div>
            <div class="bg-color-option" style="background: #f5f3ff;" onclick="setBackgroundColor('#f5f3ff')"></div>
            <div class="bg-color-option" style="background: #fefce8;" onclick="setBackgroundColor('#fefce8')"></div>
            <div class="bg-color-option" style="background: #fffbeb;" onclick="setBackgroundColor('#fffbeb')"></div>
        </div>
    </div>
    
    <!-- لوحة المسح -->
    <div class="tool-panel" id="eraserPanel">
        <div class="size-options">
            <div class="size-option" onclick="setEraserSize(5)">5</div>
            <div class="size-option" onclick="setEraserSize(10)">10</div>
            <div class="size-option" onclick="setEraserSize(15)">15</div>
            <div class="size-option" onclick="setEraserSize(20)">20</div>
            <div class="size-option" onclick="setEraserSize(25)">25</div>
            <div class="size-option" onclick="setEraserSize(30)">30</div>
            <div class="size-option" onclick="setEraserSize(40)">40</div>
            <div class="size-option" onclick="setEraserSize(50)">50</div>
        </div>
    </div>

    <!-- تحذير لوحة فارغة -->
    <div class="empty-canvas-warning" id="emptyCanvasWarning">
        <h3>اللوحة فارغة!</h3>
        <p>يجب أن ترسم شيئاً قبل الحفظ.</p>
        <button onclick="document.getElementById('emptyCanvasWarning').style.display = 'none'">حسناً</button>
    </div>

    <!-- لوحة الحفظ -->
    <div class="save-panel" id="savePanel">
        <h3>حفظ الرسمة</h3>
        <p>هل تريد حفظ الرسمة الحالية؟</p>
        <div>
            <button class="save-btn" onclick="saveDrawing()">حفظ</button>
            <button class="cancel-btn" onclick="document.getElementById('savePanel').style.display = 'none'">إلغاء</button>
        </div>
    </div>

    <script>
        // العناصر الأساسية
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const linedPaper = document.getElementById('linedPaper');
        const canvasContainer = document.getElementById('canvasContainer');
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = '#000000';
        let currentSize = 5;
        let currentPenType = 'solid';
        let currentBrushType = 'round';
        let undoStack = [];
        let arabicLetters = ['ا', 'ب', 'ت', 'ث', 'ج', 'ح', 'خ', 'د', 'ذ', 'ر', 'ز', 'س', 'ش', 'ص', 'ض', 'ط', 'ظ', 'ع', 'غ', 'ف', 'ق', 'ك', 'ل', 'م', 'ن', 'ه', 'و', 'ي'];
        let activePanel = null;
        let draggedElement = null;
        let startX, startY;
        let paperSize = 'full';
        let isLinedPaper = false;
        let selectedElement = null;
        let controlsVisible = false;
        let userSettings = {
            color: '#000000',
            size: 5,
            penType: 'solid',
            brushType: 'round',
            bgColor: '#ffffff',
            paperSize: 'full',
            isLinedPaper: false
        };

        // تهيئة التطبيق
        function initApp() {
            // تحميل الإعدادات المحفوظة
            loadSettings();
            
            resizeCanvas();
            setRandomLetter();
            setupEventListeners();
            
            // تخزين الحالة الأولية للتراجع
            saveState();
            
            // تحسين الأداء
            optimizePerformance();
        }

        // تحسين أداء التطبيق
        function optimizePerformance() {
            // تفعيل تسريع الأجهزة للكانفاس
            canvas.style.willChange = 'contents';
            
            // تقليل عدد حالات التراجع المحفوظة
            undoStack = undoStack.slice(-15);
            
            // إلغاء تحميل الصور غير المستخدمة
            setTimeout(() => {
                const images = document.querySelectorAll('img[data-lazy]');
                images.forEach(img => {
                    img.src = img.getAttribute('data-lazy');
                });
            }, 1000);
        }

        // تحميل الإعدادات المحفوظة
        function loadSettings() {
            const savedSettings = localStorage.getItem('drawingAppSettings');
            if (savedSettings) {
                userSettings = JSON.parse(savedSettings);
                currentColor = userSettings.color;
                currentSize = userSettings.size;
                currentPenType = userSettings.penType;
                currentBrushType = userSettings.brushType;
                paperSize = userSettings.paperSize;
                isLinedPaper = userSettings.isLinedPaper || false;
                
                // تطبيق الإعدادات
                setColor(currentColor);
                setSize(currentSize);
                setPenType(currentPenType);
                setBrushType(currentBrushType);
                setPaperSize(paperSize);
                setBackgroundColor(userSettings.bgColor);
                
                if (isLinedPaper) {
                    linedPaper.style.display = 'block';
                }
            }
        }

        // حفظ الإعدادات الحالية
        function saveSettings() {
            userSettings = {
                color: currentColor,
                size: currentSize,
                penType: currentPenType,
                brushType: currentBrushType,
                bgColor: getComputedStyle(document.documentElement).getPropertyValue('--paper-color').trim(),
                paperSize: paperSize,
                isLinedPaper: isLinedPaper
            };
            
            localStorage.setItem('drawingAppSettings', JSON.stringify(userSettings));
        }

        // ضبط حجم لوحة الرسم
        function resizeCanvas() {
            const container = document.querySelector('.canvas-wrapper');
            let width, height;
            
            switch(paperSize) {
                case 'mobile':
                    width = 360;
                    height = 640;
                    break;
                case 'tablet':
                    width = 768;
                    height = 1024;
                    break;
                case 'laptop':
                    width = 1366;
                    height = 768;
                    break;
                case 'desktop':
                    width = 1920;
                    height = 1080;
                    break;
                case 'tv':
                    width = 3840;
                    height = 2160;
                    break;
                case 'youtube':
                    width = 1280;
                    height = 720;
                    break;
                case 'instagram':
                    width = 1080;
                    height = 1080;
                    break;
                case 'a5':
                    // تحويل المقاسات من مم إلى بكسل (1مم = 3.78 بكسل)
                    width = 210 * 3.78;
                    height = 297 * 3.78;
                    break;
                case 'square2000':
                    width = 2000;
                    height = 2000;
                    break;
                case 'rect2000x1000':
                    width = 2000;
                    height = 1000;
                    break;
                case 'rect2000x2500':
                    width = 2000;
                    height = 2500;
                    break;
                case 'ratio16x9':
                    width = 1600;
                    height = 900;
                    break;
                case 'size3000x2000':
                    width = 3000;
                    height = 2000;
                    break;
                case 'full':
                default:
                    width = container.offsetWidth - 40;
                    height = container.offsetHeight - 40;
                    break;
            }
            
            // ضبط حجم العناصر
            canvas.width = width;
            canvas.height = height;
            linedPaper.style.width = width + 'px';
            linedPaper.style.height = height + 'px';
            canvasContainer.style.width = width + 'px';
            canvasContainer.style.height = height + 'px';
            
            // تطبيق لون الخلفية
            canvasContainer.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--paper-color').trim();
            
            // إعادة تعبئة الخلفية
            ctx.fillStyle = 'rgba(255,255,255,0)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            saveSettings();
        }

        // تبديل الورقة المخططة
        function toggleLinedPaper() {
            isLinedPaper = !isLinedPaper;
            linedPaper.style.display = isLinedPaper ? 'block' : 'none';
            
            // عند تفعيل الورقة المخططة، نضبط حجم A5
            if (isLinedPaper) {
                setPaperSize('a5');
            }
            
            saveSettings();
        }

        // تعيين حجم الورقة
        function setPaperSize(size) {
            paperSize = size;
            resizeCanvas();
            closeActivePanel();
            saveSettings();
        }

        // تعيين لون الخلفية
        function setBackgroundColor(color) {
            document.documentElement.style.setProperty('--paper-color', color);
            canvasContainer.style.backgroundColor = color;
            closeActivePanel();
            saveSettings();
        }

        // تعيين حرف عشوائي
        function setRandomLetter() {
            const randomIndex = Math.floor(Math.random() * arabicLetters.length);
            document.getElementById('targetLetter').textContent = arabicLetters[randomIndex];
            createConfetti();
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // أحداث لوحة الرسم
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // أحداث اللمس
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            
            // أحداث النوافذ
            window.addEventListener('resize', debounce(resizeCanvas, 200));
            
            // إغلاق اللوحات عند النقر خارجها
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.tool-panel') && !e.target.closest('.tool-btn') && !e.target.closest('.title-btn')) {
                    closeActivePanel();
                }
                
                // إخفاء عناصر التحكم عند النقر خارج العنصر المحدد
                if (!e.target.closest('.draggable') && !e.target.closest('.draggable-controls')) {
                    hideElementControls();
                }
            });
            
            // إخفاء عناصر التحكم عند الضغط على Esc
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideElementControls();
                }
            });
        }

        // دالة لتأخير تنفيذ الأحداث
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }

        // عرض لوحة الأدوات
        function showToolPanel(panelId) {
            // إخفاء اللوحة النشطة إذا كانت هي نفسها
            if (activePanel === panelId) {
                closeActivePanel();
                return;
            }
            
            // إغلاق أي لوحة نشطة حالية
            closeActivePanel();
            
            // عرض اللوحة المطلوبة
            const panel = document.getElementById(panelId);
            panel.style.display = 'block';
            activePanel = panelId;
            
            // وضع اللوحة في مكان مناسب
            const toolbarHeight = document.querySelector('.toolbar').offsetHeight;
            panel.style.bottom = `${toolbarHeight + 10}px`;
        }

        // إغلاق اللوحة النشطة
        function closeActivePanel() {
            if (activePanel) {
                document.getElementById(activePanel).style.display = 'none';
                activePanel = null;
            }
        }

        // تعيين لون الرسم
        function setColor(color) {
            currentColor = color;
            ctx.strokeStyle = color;
            ctx.fillStyle = color;
            closeActivePanel();
            createConfetti();
            saveSettings();
        }

        // تعيين حجم القلم
        function setSize(size) {
            currentSize = size;
            ctx.lineWidth = size;
            closeActivePanel();
            saveSettings();
        }

        // تعيين حجم الممحاة
        function setEraserSize(size) {
            currentSize = size;
            ctx.lineWidth = size;
            closeActivePanel();
            saveSettings();
        }

        // تعيين نوع القلم
        function setPenType(type) {
            currentPenType = type;
            
            // تحديث الواجهة
            document.querySelectorAll('.pen-type-option').forEach(option => {
                option.classList.remove('active');
                if (option.textContent.includes(type)) {
                    option.classList.add('active');
                }
            });
            
            closeActivePanel();
            saveSettings();
        }

        // تعيين نوع الفرشاة
        function setBrushType(type) {
            currentBrushType = type;
            
            // تحديث الواجهة
            document.querySelectorAll('.brush-type-option').forEach(option => {
                option.classList.remove('active');
                if (option.textContent.includes(type)) {
                    option.classList.add('active');
                }
            });
            
            closeActivePanel();
            saveSettings();
        }

        // تفعيل/تعطيل وضع المسح
        function toggleEraserMode() {
            const eraserBtn = document.getElementById('eraserBtn');
            if (currentTool === 'eraser') {
                currentTool = 'pen';
                ctx.globalCompositeOperation = 'source-over';
                eraserBtn.classList.remove('active');
                setSize(currentSize);
            } else {
                currentTool = 'eraser';
                ctx.globalCompositeOperation = 'destination-out';
                eraserBtn.classList.add('active');
                showToolPanel('eraserPanel');
            }
        }

        // مسح اللوحة بالكامل
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(255,255,255,0)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // إزالة جميع العناصر القابلة للسحب
            document.querySelectorAll('.draggable').forEach(el => el.remove());
            
            // حفظ حالة جديدة للتراجع
            undoStack = [];
            saveState();
        }

        // التراجع عن الإجراء الأخير
        function undoAction() {
            if (undoStack.length > 0) {
                const lastState = undoStack.pop();
                ctx.putImageData(lastState.imageData, 0, 0);
                
                // إعادة تحميل العناصر القابلة للسحب
                document.querySelectorAll('.draggable').forEach(el => el.remove());
                
                if (lastState.elements) {
                    lastState.elements.forEach(el => {
                        const element = document.createElement('div');
                        element.className = 'draggable';
                        element.style.fontSize = el.fontSize;
                        element.style.color = el.color;
                        element.style.left = el.left;
                        element.style.top = el.top;
                        element.textContent = el.text;
                        element.dataset.type = el.type;
                        
                        if (el.type === 'shape') {
                            element.dataset.shape = el.shape;
                        } else if (el.type === 'sticker') {
                            element.dataset.sticker = el.sticker;
                        } else if (el.type === 'geometric') {
                            element.dataset.shape = el.shape;
                        }
                        
                        canvasContainer.appendChild(element);
                        makeDraggable(element);
                    });
                }
            }
        }

        // حفظ حالة اللوحة للتراجع
        function saveState() {
            if (undoStack.length > 20) { // تحديد عدد حالات التراجع المسموح بها
                undoStack.shift();
            }
            
            // حفظ حالة الكانفاس
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // حفظ حالة العناصر القابلة للسحب
            const elements = [];
            document.querySelectorAll('.draggable').forEach(el => {
                elements.push({
                    type: el.dataset.type,
                    shape: el.dataset.shape || '',
                    sticker: el.dataset.sticker || '',
                    fontSize: el.style.fontSize,
                    color: el.style.color,
                    left: el.style.left,
                    top: el.style.top,
                    text: el.textContent
                });
            });
            
            undoStack.push({
                imageData: imageData,
                elements: elements
            });
        }

        // بدء الرسم
        function startDrawing(e) {
            if (e.target !== canvas) return;
            
            // إخفاء عناصر التحكم عند البدء بالرسم
            hideElementControls();
            
            isDrawing = true;
            draw(e);
            saveState();
        }

        // عملية الرسم
        function draw(e) {
            if (!isDrawing) return;
            
            // الحصول على إحداثيات المؤشر
            let clientX, clientY;
            
            if (e.type.includes('touch')) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const rect = canvas.getBoundingClientRect();
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            // تطبيق نمط القلم المحدد
            if (currentPenType === 'dashed') {
                ctx.setLineDash([currentSize * 2, currentSize]);
            } else if (currentPenType === 'dotted') {
                ctx.setLineDash([2, currentSize]);
            } else if (currentPenType === 'double') {
                ctx.setLineDash([]);
                // رسم خط مزدوج
                ctx.lineWidth = currentSize / 3;
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x + currentSize/2, y + currentSize/2);
                ctx.lineTo(x + currentSize/2, y + currentSize/2);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
                return;
            } else if (currentPenType === 'wave') {
                ctx.setLineDash([]);
                // رسم خط متموج
                for (let i = 0; i < 5; i++) {
                    ctx.lineTo(x + Math.sin(y/10 + i) * 5, y + i);
                }
            } else if (currentPenType === 'zigzag') {
                ctx.setLineDash([]);
                // رسم خط متعرج
                for (let i = 0; i < 5; i++) {
                    ctx.lineTo(x + (i % 2 === 0 ? 5 : -5), y + i);
                }
            } else {
                ctx.setLineDash([]);
            }
            
            // تطبيق نوع الفرشاة
            if (currentBrushType === 'round') {
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            } else if (currentBrushType === 'square') {
                ctx.lineCap = 'square';
                ctx.lineJoin = 'miter';
            } else if (currentBrushType === 'flat') {
                ctx.lineCap = 'butt';
                ctx.lineJoin = 'bevel';
            } else if (currentBrushType === 'marker') {
                ctx.globalAlpha = 0.5;
                ctx.lineCap = 'square';
                ctx.lineJoin = 'miter';
            } else if (currentBrushType === 'chalk') {
                ctx.globalAlpha = 0.8;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.shadowBlur = 2;
                ctx.shadowColor = ctx.strokeStyle;
            } else if (currentBrushType === 'pencil') {
                ctx.globalAlpha = 0.9;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.shadowBlur = 0;
            }
            
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
            
            // إعادة ضبط الإعدادات
            ctx.globalAlpha = 1.0;
            ctx.shadowBlur = 0;
        }

        // إيقاف الرسم
        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        // معالجة اللمس
        function handleTouchStart(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }

        // إضافة شكل
        function addShape(shape) {
            saveState();
            
            const shapeElement = document.createElement('div');
            shapeElement.className = 'draggable';
            shapeElement.style.fontSize = `${currentSize * 5}px`;
            shapeElement.style.color = currentColor;
            shapeElement.dataset.type = 'shape';
            shapeElement.dataset.shape = shape;
            
            // تعيين المحتوى بناء على الشكل المطلوب
            shapeElement.textContent = getShapeContent(shape);
            
            canvasContainer.appendChild(shapeElement);
            
            // وضع الشكل في مكان مناسب
            const x = canvas.width / 2 - 25;
            const y = canvas.height / 2 - 25;
            
            shapeElement.style.left = `${x}px`;
            shapeElement.style.top = `${y}px`;
            
            // جعل العنصر قابل للسحب والتحكم
            makeDraggable(shapeElement);
            
            closeActivePanel();
            createConfetti();
        }

        // الحصول على محتوى الشكل
        function getShapeContent(shape) {
            const shapes = {
                'star': '⭐', 'heart': '❤️', 'circle': '🔴', 'square': '🟥', 'triangle': '🔺',
                'cloud': '☁️', 'sun': '☀️', 'moon': '🌙', 'flower': '🌼', 'tree': '🌳',
                'car': '🚗', 'house': '🏠', 'ball': '⚽', 'book': '📚', 'cat': '🐱',
                'dog': '🐶', 'fish': '🐠', 'bird': '🐦', 'apple': '🍎', 'banana': '🍌',
                'gift': '🎁', 'balloon': '🎈', 'rocket': '🚀', 'train': '🚂', 'boat': '⛵',
                'plane': '✈️', 'umbrella': '☂️', 'clock': '⏰', 'light': '💡', 'key': '🔑',
                'lock': '🔒', 'scissor': '✂️', 'phone': '📱', 'tv': '📺', 'camera': '📷',
                'game': '🎮', 'music': '🎵', 'microphone': '🎤', 'flag': '🚩', 'medal': '🏅',
                'crown': '👑', 'robot': '🤖', 'alien': '👽', 'ghost': '👻', 'dinosaur': '🦖',
                'unicorn': '🦄', 'dragon': '🐉', 'castle': '🏰'
            };
            
            return shapes[shape] || '⭐';
        }

        // إضافة ملصق
        function addSticker(sticker) {
            saveState();
            
            const stickerElement = document.createElement('div');
            stickerElement.className = 'draggable';
            stickerElement.textContent = sticker;
            stickerElement.style.fontSize = '40px';
            stickerElement.dataset.type = 'sticker';
            stickerElement.dataset.sticker = sticker;
            
            canvasContainer.appendChild(stickerElement);
            
            // وضع الملصق في وسط اللوحة
            const x = canvas.width / 2 - 20;
            const y = canvas.height / 2 - 20;
            
            stickerElement.style.left = `${x}px`;
            stickerElement.style.top = `${y}px`;
            
            // جعل الملصق قابل للسحب والتحكم
            makeDraggable(stickerElement);
            
            closeActivePanel();
            createConfetti();
        }

        // إضافة شكل هندسي
        function addGeometricShape(shape) {
            saveState();
            
            const shapeElement = document.createElement('div');
            shapeElement.className = 'draggable';
            shapeElement.style.fontSize = `${currentSize * 5}px`;
            shapeElement.style.color = currentColor;
            shapeElement.dataset.type = 'geometric';
            shapeElement.dataset.shape = shape;
            
            // تعيين المحتوى بناء على الشكل المطلوب
            shapeElement.textContent = getGeometricShapeContent(shape);
            
            canvasContainer.appendChild(shapeElement);
            
            // وضع الشكل في وسط اللوحة
            const x = canvas.width / 2 - 25;
            const y = canvas.height / 2 - 25;
            
            shapeElement.style.left = `${x}px`;
            shapeElement.style.top = `${y}px`;
            
            // جعل العنصر قابل للسحب والتحكم
            makeDraggable(shapeElement);
            
            closeActivePanel();
            createConfetti();
        }

        // الحصول على محتوى الشكل الهندسي
        function getGeometricShapeContent(shape) {
            const shapes = {
                'rectangle': '▭',
                'circle': '⬤',
                'triangle': '▲',
                'line': '─',
                'diamond': '◆',
                'pentagon': '⬟',
                'hexagon': '⬢',
                'star': '★',
                'heart': '♥',
                'oval': '⬭',
                'arrow': '➔',
                'cross': '✚'
            };
            
            return shapes[shape] || '▭';
        }

        // جعل العنصر قابل للسحب والتحكم
        
            
            
    
function makeDraggable(element) {
    // إنشاء عناصر التحكم
    const controls = document.createElement('div');
    controls.className = 'draggable-controls';
    controls.innerHTML = `
        <button class="control-btn" data-action="decrease">➖</button>
        <button class="control-btn" data-action="increase">➕</button>
        <button class="control-btn delete" data-action="delete">🗑️</button>
    `;
    
    element.appendChild(controls);
    
    // جعل العنصر نفسه يستجيب لأحداث المؤشر عند السحب
    element.style.pointerEvents = 'auto';
    
    // أحداث السحب
    element.addEventListener('mousedown', function(e) {
        if (e.target === element) {
            startDrag(e);
        }
    });
    
    element.addEventListener('touchstart', function(e) {
        if (e.target === element) {
            startDrag(e);
        }
    }, { passive: false });
    
    // أحداث التحكم
    controls.addEventListener('mousedown', function(e) {
        e.stopPropagation();
    });
    
    controls.addEventListener('click', function(e) {
        e.stopPropagation();
        const btn = e.target.closest('.control-btn');
        if (!btn) return;
        
        const action = btn.getAttribute('data-action');
        switch(action) {
            case 'increase':
                scaleElement(element, 1.1);
                break;
            case 'decrease':
                scaleElement(element, 0.9);
                break;
            case 'delete':
                deleteElement(element);
                break;
        }
    });
    
    // عند النقر على العنصر الرئيسي
    element.addEventListener('click', function(e) {
        if (e.target === element) {
            showElementControls(element);
        }
    });
    
    // ... (بقية دوال السحب كما هي)





            
            function startDrag(e) {
                // منع ظهور عناصر التحكم عند السحب
                hideElementControls();
                
                // تحديد العنصر الحالي
                selectedElement = element;
                draggedElement = element;
                
                if (e.type === 'mousedown') {
                    startX = e.clientX - element.getBoundingClientRect().left;
                    startY = e.clientY - element.getBoundingClientRect().top;
                    document.addEventListener('mousemove', dragElement);
                    document.addEventListener('mouseup', stopDrag);
                } else {
                    startX = e.touches[0].clientX - element.getBoundingClientRect().left;
                    startY = e.touches[0].clientY - element.getBoundingClientRect().top;
                    document.addEventListener('touchmove', dragElement, { passive: false });
                    document.addEventListener('touchend', stopDrag);
                }
            }
            
            function dragElement(e) {
                if (!draggedElement) return;
                
                let clientX, clientY;
                
                if (e.type === 'mousemove') {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }
                
                const container = canvasContainer.getBoundingClientRect();
                let newLeft = clientX - container.left - startX;
                let newTop = clientY - container.top - startY;
                
                newLeft = Math.max(0, Math.min(newLeft, container.width - draggedElement.offsetWidth));
                newTop = Math.max(0, Math.min(newTop, container.height - draggedElement.offsetHeight));
                
                draggedElement.style.left = `${newLeft}px`;
                draggedElement.style.top = `${newTop}px`;
            }
            
            function stopDrag() {
                draggedElement = null;
                document.removeEventListener('mousemove', dragElement);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchmove', dragElement);
                document.removeEventListener('touchend', stopDrag);
                saveState();
            }
        }

        // عرض عناصر التحكم للعنصر
        function showElementControls(element) {
            // إخفاء جميع عناصر التحكم أولاً
            hideElementControls();
            
            // تحديد العنصر الحالي
            selectedElement = element;
            element.classList.add('selected');
        }

        // إخفاء عناصر التحكم للعناصر
        function hideElementControls() {
            document.querySelectorAll('.draggable').forEach(el => {
                el.classList.remove('selected');
            });
            
            selectedElement = null;
        }

        // تحجيم العنصر
        function scaleElement(element, factor) {
            const currentSize = parseInt(element.style.fontSize) || 40;
            const newSize = Math.max(20, Math.min(200, currentSize * factor));
            
            element.style.fontSize = `${newSize}px`;
            saveState();
        }

        // حذف العنصر
        function deleteElement(element) {
            element.remove();
            saveState();
        }                         
               
                           



        // عرض لوحة الحفظ
        function showSavePanel() {
            // التحقق مما إذا كانت اللوحة فارغة
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let isEmpty = true;
            
            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] !== 0) { // إذا كانت هناك أي بكسل غير شفاف
                    isEmpty = false;
                    break;
                }
            }
            
            // التحقق من وجود ملصقات أو أشكال
            const hasElements = document.querySelectorAll('.draggable').length > 0;
            
            if (isEmpty && !hasElements) {
                document.getElementById('emptyCanvasWarning').style.display = 'block';
                return;
            }
            
            document.getElementById('savePanel').style.display = 'block';
        }

        // حفظ الرسم كصورة
        function saveDrawing() {
            // إنشاء عنصر مؤقت لرسم كل شيء عليه
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // ضبط حجمه بنفس حجم اللوحة الأصلية
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            // رسم خلفية بيضاء
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // رسم محتوى لوحة الرسم
            tempCtx.drawImage(canvas, 0, 0);
            
            // رسم جميع الملصقات والأشكال
            const draggables = document.querySelectorAll('.draggable');
            draggables.forEach(el => {
                const rect = el.getBoundingClientRect();
                const canvasRect = canvasContainer.getBoundingClientRect();
                
                const x = rect.left - canvasRect.left;
                const y = rect.top - canvasRect.top;
                const fontSize = parseInt(el.style.fontSize) || 40;
                
                // حفظ حالة السياق
                tempCtx.save();
                
                // رسم النص (الإيموجي)
                tempCtx.font = `${fontSize}px Arial`;
                tempCtx.fillStyle = el.style.color || 'black';
                tempCtx.fillText(el.textContent, x, y + fontSize);
                
                // استعادة حالة السياق
                tempCtx.restore();
            });
            
            // تحويل إلى صورة وحفظها
            const dataURL = tempCanvas.toDataURL('image/png');
            
            // إنشاء رابط تحميل
            const link = document.createElement('a');
            link.download = 'رسمة-سامي-' + new Date().toLocaleDateString() + '.png';
            link.href = dataURL;
            
            // إضافة الرابط إلى DOM ونشطه
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // إغلاق لوحة الحفظ
            document.getElementById('savePanel').style.display = 'none';
            
            // عرض رسالة نجاح
            showCelebration('تم حفظ الرسمة بنجاح!', '🎉');
        }

        // عرض رسالة نجاح
        function showCelebration(message, emoji) {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.innerHTML = `
                <h2>${message}</h2>
                <div class="emoji">${emoji}</div>
                <button onclick="this.parentElement.remove()">حسناً</button>
            `;
            document.body.appendChild(celebration);
            
            // إضافة تأثيرات الكونفيتي
            for (let i = 0; i < 50; i++) {
                createConfetti();
            }
        }

        // إنشاء تأثيرات الكونفيتي
        function createConfetti() {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * window.innerWidth + 'px';
            confetti.style.backgroundColor = getRandomColor();
            document.body.appendChild(confetti);
            
            // إزالة العنصر بعد انتهاء الرسوم المتحركة
            setTimeout(() => {
                confetti.remove();
            }, 3000);
        }

        // الحصول على لون عشوائي
        function getRandomColor() {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFBE0B', '#FB5607', '#8338EC', '#3A86FF', '#FF006E'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // بدء التطبيق
        window.onload = initApp;
    </script>
</body>
</html>