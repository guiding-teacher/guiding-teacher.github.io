<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">

  <!-- START: SEO Meta Tags -->
  <title>Kodedeck | محرر أكواد اون لاين متكامل لـ HTML, CSS, و JavaScript</title>
  <meta name="description" content="Kodedeck هو محرر أكواد عربي متقدم ومجاني يعمل مباشرة في متصفحك. اكتب وجرب أكواد HTML, CSS, و JavaScript مع معاينة مباشرة، حفظ المشاريع، بحث متقدم، ومشاركة إبداعاتك بسهولة.">
  <meta name="keywords" content="محرر اكواد, محرر html, محرر css, محرر javascript, اون لاين, محرر ويب, كتابة كود, تجربة اكواد, منصة اكواد عربية, kodedeck, برمجة, تطوير الويب, معاينة مباشرة, مشاركة الكود">
  <link rel="icon" href="/images/Kodedeck1.png">
  
  <!-- Open Graph / Facebook / WhatsApp -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://guiding-teacher.github.io/program/index.html/Kodedeck.html"> <!-- ✨ استبدل هذا برابط موقعك الفعلي -->
  <meta property="og:title" content="Kodedeck | محرر أكواد اون لاين متكامل">
  <meta property="og:description" content="محرر أكواد عربي متقدم ومجاني يعمل مباشرة في متصفحك. مثالي لـ HTML, CSS, و JavaScript.">
  <meta property="og:image" content="/images/Kodedeck2.png"> <!-- ✨ استبدل هذا برابط صورتك (يفضل مقاس 1200x630) -->
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://guiding-teacher.github.io/program/index.html/Kodedeck.html"> <!-- ✨ استبدل هذا برابط موقعك الفعلي -->
  <meta property="twitter:title" content="Kodedeck | محرر أكواد اون لاين متكامل">
  <meta property="twitter:description" content="محرر أكواد عربي متقدم ومجاني يعمل مباشرة في متصفحك. مثالي لـ HTML, CSS, و JavaScript.">
  <meta property="twitter:image" content=" /images/Kodedeck2.png"> <!-- ✨ استبدل هذا برابط صورتك -->
  <!-- END: SEO Meta Tags -->

  <!-- ✨ MODIFIED: The viewport tag is essential for the new desktop view feature -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  
  <!-- CodeMirror Core & Addons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.css">

  <!-- CodeMirror Themes (Dracula is default) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/dracula.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/eclipse.min.css">

  <!-- Linters for JS, CSS, HTML -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.6/jshint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/csslint/1.0.5/csslint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/htmlhint/1.1.4/htmlhint.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchtags.js"></script>
  
  <!-- Linting Addons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/javascript-lint.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/css-lint.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/html-lint.js"></script>

  <!-- Code Folding Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldcode.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/brace-fold.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/xml-fold.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/comment-fold.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/selection/active-line.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/display/placeholder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/search.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/searchcursor.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/split.js/1.6.0/split.min.js"></script>
  <style>
    :root {
      --dark-bg: #1a1a1d;
      --header-bg: #282a36;
      --gutter-bg: #44475a;
      --text-color: #f0f0f0;
      --green-accent: #50fa7b;
      --red-accent: #ff5555;
      --blue-accent: #8be9fd;
      --purple-accent: #bd93f9;
      --yellow-accent: #f1fa8c;
    }
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: var(--dark-bg);
      color: var(--text-color);
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .header {
      background-color: var(--header-bg);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid var(--gutter-bg);
      flex-shrink: 0;
    }
    .header-center {
        flex-grow: 1;
        text-align: center;
        color: var(--text-color);
        font-size: 1rem;
        font-weight: 500;
        opacity: 0.8;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding: 0 15px;
    }
    .header h3 {
      color: var(--green-accent);
      margin-bottom: 0;
    }
    .content-wrapper {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 5px 0 80px 0;
      box-sizing: border-box;
    }
    .split-container {
      display: flex;
      width: 100%;
      height: 100%;
    }
    .split-container.vertical {
      flex-direction: column;
    }
    .gutter {
      background-color: var(--gutter-bg);
    }
    .gutter.gutter-horizontal {
      cursor: col-resize;
    }
    .gutter.gutter-vertical {
      cursor: row-resize;
    }
    .pane {
      overflow: hidden;
    }
    .CodeMirror {
      height: 100% !important;
      font-size: 16px;
    }
    /* Style for matching tags */
    .CodeMirror-matchingtag {
        background-color: rgba(189, 147, 249, 0.25);
    }
    .CodeMirror-foldgutter-open,
    .CodeMirror-foldgutter-folded {
      cursor: pointer;
      color: var(--purple-accent);
      padding-top: 3px;
    }
    .CodeMirror-foldgutter-open:after { content: "▾"; }
    .CodeMirror-foldgutter-folded:after { content: "▸"; }
    
    #preview-frame {
      width: 100%;
      height: 100%;
      border: none;
      background-color: white;
    }

    #file-uploader { display: none; }
    .toolbar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: var(--header-bg);
      display: flex;
      border-top: 1px solid var(--gutter-bg);
      z-index: 20;
    }
    #status-bar {
      padding: 5px 15px;
      justify-content: flex-start;
      gap: 20px;
      font-size: 14px;
      color: var(--purple-accent);
      bottom: 45px; /* Position above bottom-toolbar */
    }
    #status-bar span { cursor: default; }
    #status-bar #error-status:hover { cursor: pointer; color: var(--red-accent); }
    .cm-error-highlight { background-color: rgba(255, 85, 85, 0.3); }
    .editor-line-highlight { background-color: rgba(189, 147, 249, 0.25); }
    #bottom-toolbar {
      padding: 5px;
      justify-content: center;
      gap: 15px;
      height: 45px;
    }
    .toolbar button { background: none; border: none; color: var(--text-color); font-size: 20px; cursor: pointer; transition: color 0.2s; }
    .toolbar button:hover { color: var(--green-accent); }
    #selection-toolbar { position: absolute; background-color: var(--header-bg); border-radius: 8px; padding: 6px 10px; display: none; /* Managed by JS */ z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.4); gap: 12px; border: 1px solid var(--gutter-bg); }
    #selection-toolbar button { font-size: 20px; padding: 2px; line-height: 1; color: #ccc; background: none; border: none; cursor: pointer; }
    #selection-toolbar button:hover { color: var(--blue-accent); }
    #search-bar { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background-color: var(--header-bg); padding: 10px 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: none; z-index: 1001; gap: 10px; align-items: center; }
    #search-input { display: block; background-color: var(--dark-bg); border: 1px solid var(--gutter-bg); color: var(--text-color); padding: 5px 10px; border-radius: 4px; width: 250px; }
    #search-input:focus { outline: none; border-color: var(--blue-accent); }
    #search-close { background: none; border: none; color: var(--text-color); cursor: pointer; font-size: 18px; }
    #search-close:hover { color: var(--red-accent); }
    .header-buttons { display: flex; gap: 10px; }
    .header-buttons .btn { display: flex; align-items: center; gap: 5px; }
    #advanced-search-panel { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); background-color: var(--header-bg); padding: 8px 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: none; /* مخفي بشكل افتراضي */ z-index: 1002; width: auto; border: 1px solid var(--purple-accent); align-items: center; gap: 8px; max-width: 90%; }
    #advanced-search-panel h6 { display: none; /* إخفاء العنوان */ }
    #advanced-search-input { background-color: var(--dark-bg); border: 1px solid var(--gutter-bg); color: var(--text-color); padding: 6px 10px; border-radius: 4px; width: 200px; margin-bottom: 0; font-size: 14px; transition: border-color 0.3s; }
    #advanced-search-input:focus { outline: none; border-color: var(--blue-accent); }
    #advanced-search-panel .btn-group { display: flex; gap: 5px; margin-bottom: 0; }
    #advanced-search-panel button { background-color: var(--purple-accent); color: var(--dark-bg); border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; transition: background-color 0.3s; font-size: 14px; width: auto; display: flex; align-items: center; justify-content: center; }
    #advanced-search-panel button:hover { background-color: var(--blue-accent); }
    #advanced-search-panel .btn-primary { background-color: var(--blue-accent); }
    #advanced-search-panel .btn-info { background-color: var(--green-accent); }
    #advanced-search-panel .btn-warning { background-color: var(--yellow-accent); color: var(--dark-bg); }
    #advanced-search-panel .btn-danger { background-color: var(--red-accent); }
    #advanced-search-panel .btn-secondary { background-color: var(--gutter-bg); }
    .search-result { background-color: rgba(139, 233, 253, 0.2); border: 1px solid var(--blue-accent); }
    #search-results-counter { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background-color: var(--header-bg); padding: 5px 10px; border-radius: 4px; font-size: 14px; display: none; z-index: 1003; }
    @media (max-width: 768px) { #bottom-toolbar { gap: 10px; padding: 5px 2px; overflow-x: auto; justify-content: flex-start; } #bottom-toolbar button { font-size: 18px; flex-shrink: 0; } .header-buttons { gap: 5px; } .header-buttons .btn { padding: 4px 8px; } .header h3 { font-size: 1.1rem; } .header-center { display: none; /* Hide filename on smaller screens to save space */ } #advanced-search-panel { bottom: 45px; padding: 6px 10px; gap: 6px; max-width: 95%; } #advanced-search-input { width: 150px; padding: 5px 8px; font-size: 13px; } #advanced-search-panel button { padding: 5px 6px; font-size: 13px; } #advanced-search-panel .btn-group { gap: 4px; } }
    @media (max-width: 480px) { #advanced-search-panel { flex-wrap: wrap; justify-content: center; bottom: 50px; } #advanced-search-input { width: 100%; margin-bottom: 5px; } }
    .notification { position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px; padding: 12px 16px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); animation: slideIn 0.3s ease-out; }
    .notification-success { background-color: var(--green-accent); color: var(--dark-bg); }
    .notification-warning { background-color: var(--yellow-accent); color: var(--dark-bg); }
    .notification-error { background-color: var(--red-accent); color: white; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>
<body>
  <div class="header">
    <h3><i class="bi bi-code-slash"></i> Kodedeck</h3>
    <div class="header-center" title="اسم الملف الحالي">
      <span id="current-filename">Untitled.html</span>
    </div>
    <div class="header-buttons">
      <button id="new-file-btn" class="btn btn-success btn-sm" title="ملف جديد"><i class="bi bi-plus-lg"></i></button>
      <button id="clear-editor-btn" class="btn btn-warning btn-sm" title="مسح المحرر"><i class="bi bi-eraser"></i></button>
      <button id="toggle-layout-btn" class="btn btn-info btn-sm" title="تبديل التخطيط"><i class="bi bi-distribute-vertical"></i></button>
      <!-- ✨ MODIFIED: Button function changed to control the entire page view -->
      <button id="desktop-view-btn" class="btn btn-secondary btn-sm" title="تبديل عرض سطح المكتب"><i class="bi bi-pc-display"></i></button>
      <label for="file-uploader" class="btn btn-primary btn-sm" title="رفع ملف"><i class="bi bi-upload"></i></label>
      <input type="file" id="file-uploader" accept=".html,.css,.js">
    </div>
  </div>

  <div class="content-wrapper">
    <div id="main-container" class="split-container">
      <div id="editor-pane" class="pane"><textarea id="main-editor"></textarea></div>
      <div id="preview-pane" class="pane">
          <iframe id="preview-frame" title="معاينة الكود"></iframe>
      </div>
    </div>
  </div>

  <div id="status-bar" class="toolbar">
    <span id="line-count-status" title="عدد الأسطر">Lines: 1</span>
    <span id="word-count-status" title="عدد الكلمات">Words: 0</span>
    <span id="error-status" title="اضغط للانتقال إلى أول خطأ">Errors: 0</span>
  </div>

  <div id="bottom-toolbar" class="toolbar">
    <button id="undo-btn" title="تراجع"><i class="bi bi-arrow-counterclockwise"></i></button>
    <button id="redo-btn" title="إعادة"><i class="bi bi-arrow-clockwise"></i></button>
    <button id="cut-btn" title="قص"><i class="bi bi-scissors"></i></button>
    <button id="copy-btn" title="نسخ"><i class="bi bi-clipboard"></i></button>
    <button id="paste-btn" title="لصق"><i class="bi bi-clipboard-plus"></i></button>
    <button id="select-all-btn" title="تحديد الكل"><i class="bi bi-textarea-t"></i></button>
    <div style="border-left: 2px solid var(--gutter-bg); margin: 0 10px;"></div>
    <button id="save-btn" title="حفظ الكود" data-bs-toggle="modal" data-bs-target="#saveModal"><i class="bi bi-save"></i></button>
    <button id="download-btn" title="تنزيل الكود"><i class="bi bi-download"></i></button>
    <button id="share-btn" title="مشاركة" data-bs-toggle="modal" data-bs-target="#shareModal"><i class="bi bi-share-fill"></i></button>
    <button id="load-btn" title="فتح الأكواد المحفوظة" data-bs-toggle="modal" data-bs-target="#loadModal"><i class="bi bi-archive"></i></button>
    <button id="theme-btn" title="تغيير الثيم" data-bs-toggle="modal" data-bs-target="#themeModal"><i class="bi bi-palette"></i></button>
    <button id="search-btn" title="بحث متقدم"><i class="bi bi-search-heart"></i></button>
  </div>

  <div id="selection-toolbar">
    <button id="popup-cut-btn" title="قص"><i class="bi bi-scissors"></i></button>
    <button id="popup-copy-btn" title="نسخ"><i class="bi bi-clipboard"></i></button>
    <button id="popup-paste-btn" title="لصق"><i class="bi bi-clipboard-plus"></i></button>
    <button id="popup-select-all-btn" title="تحديد الكل"><i class="bi bi-textarea-t"></i></button>
    <button id="popup-search-btn" title="البحث في الويب"><i class="bi bi-globe"></i></button>
  </div>

  <div id="search-bar">
    <input type="text" id="search-input" placeholder="ابحث في الكود...">
    <button id="search-close"><i class="bi bi-x-lg"></i></button>
  </div>

  <div id="search-results-counter"></div>

  <div id="advanced-search-panel">
    <input type="text" id="advanced-search-input" placeholder="ابحث...">
    <div class="btn-group">
      <button id="find-prev-btn" class="btn btn-sm btn-primary" title="السابق"><i class="bi bi-arrow-up"></i></button>
      <button id="find-next-btn" class="btn btn-sm btn-primary" title="التالي"><i class="bi bi-arrow-down"></i></button>
    </div>
    <button id="find-all-btn" class="btn btn-sm btn-info" title="إظهار الكل"><i class="bi bi-list-check"></i></button>
    <div class="btn-group">
      <button id="replace-btn" class="btn btn-sm btn-warning" title="استبدال"><i class="bi bi-arrow-left-right"></i></button>
      <button id="replace-all-btn" class="btn btn-sm btn-danger" title="استبدال الكل"><i class="bi bi-arrow-repeat"></i></button>
    </div>
    <button id="advanced-search-close" class="btn btn-sm btn-secondary" title="إغلاق"><i class="bi bi-x-lg"></i></button>
  </div>
  <!-- Modals -->
  <div class="modal fade" id="saveModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content bg-dark text-light"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-save"></i> حفظ الكود</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>أدخل اسمًا لهذا الكود:</p><input type="text" id="snippet-name-input" class="form-control bg-secondary text-light" placeholder="مثال: صفحتي الرئيسية"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" id="confirm-save-btn" class="btn btn-primary">حفظ</button></div></div></div></div>
  <div class="modal fade" id="loadModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content bg-dark text-light"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-archive"></i> الأكواد المحفوظة</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="snippets-list-container"><p class="text-center">لا توجد أكواد محفوظة بعد.</p></div></div></div></div>
  <div class="modal fade" id="themeModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content bg-dark text-light"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-palette"></i> اختر ثيم المحرر</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body d-grid gap-2"><button class="btn btn-outline-info theme-select-btn" data-theme="dracula">Dracula (Default)</button><button class="btn btn-outline-light theme-select-btn" data-theme="material">Material</button><button class="btn btn-outline-success theme-select-btn" data-theme="monokai">Monokai</button><button class="btn btn-outline-warning theme-select-btn" data-theme="eclipse">Eclipse (Light)</button></div></div></div></div>
  <div class="modal fade" id="shareModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content bg-dark text-light"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-share-fill"></i> مشاركة</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p>شارك رابط الأداة أو الكود مباشرة:</p><div class="d-flex justify-content-center gap-3 fs-1"><a href="#" id="share-facebook" class="text-light" title="مشاركة على فيسبوك"><i class="bi bi-facebook"></i></a><a href="#" id="share-whatsapp" class="text-light" title="مشاركة على واتساب"><i class="bi bi-whatsapp"></i></a><a href="#" id="share-telegram" class="text-light" title="مشاركة على تلغرام"><i class="bi bi-telegram"></i></a></div><hr><button id="native-share-btn" class="btn btn-primary w-100"><i class="bi bi-phone"></i> استخدام قائمة المشاركة في الجهاز</button></div></div></div></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let splitInstance;
      let isVerticalLayout = false;
      let lintAnnotations = [];
      let currentErrorMarker = null;
      let highlightedLineMarker = null;
      let autoSaveTimeout;
      let searchCursor = null;
      let searchMarkers = [];
      let isAdvancedSearchOpen = false;
      let searchResultsCount = 0;
      let currentSearchResultIndex = 0;
      
      // ✨ START: NEW - State for Full Page Desktop View
      let isFullDesktopView = false;
      const viewportMeta = document.querySelector('meta[name="viewport"]');
      const originalViewportContent = viewportMeta.getAttribute('content');
      // ✨ END: NEW - State for Full Page Desktop View

      const mainContainer = document.getElementById('main-container');
      const selectionToolbar = document.getElementById('selection-toolbar');
      const searchBar = document.getElementById('search-bar');
      const searchInput = document.getElementById('search-input');
      const searchClose = document.getElementById('search-close');
      const searchResultsCounter = document.getElementById('search-results-counter');
      const advancedSearchPanel = document.getElementById('advanced-search-panel');
      const advancedSearchInput = document.getElementById('advanced-search-input');
      const saveModal = new bootstrap.Modal(document.getElementById('saveModal'));
      const loadModal = new bootstrap.Modal(document.getElementById('loadModal'));
      const themeModal = new bootstrap.Modal(document.getElementById('themeModal'));
      const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));

      // ## 1. تهيئة المحرر (CodeMirror)
      const editor = CodeMirror.fromTextArea(document.getElementById('main-editor'), {
        lineNumbers: true,
        mode: 'htmlmixed',
        autoCloseTags: true,
        autoCloseBrackets: true,
        styleActiveLine: true,
        matchTags: {bothTags: true},
        gutters: ["CodeMirror-lint-markers", "CodeMirror-foldgutter"],
        lint: true,
        foldGutter: true, 
        lineWrapping: true,
          extraKeys: {
          "Ctrl-F": function(cm) { toggleAdvancedSearch(); },
          "F3": function(cm) { findNext(); },
          "Shift-F3": function(cm) { findPrev(); }
        }
      });
      
      const fileNameElement = document.getElementById('current-filename');
      function updateFileName(newName) {
          fileNameElement.textContent = newName;
          fileNameElement.title = newName;
      }
      
      // ## 2. وظائف الواجهة والتخطيط
      function setupSplitLayout() {
        if (splitInstance) splitInstance.destroy();
        const direction = isVerticalLayout ? 'vertical' : 'horizontal';
        mainContainer.className = `split-container ${isVerticalLayout ? 'vertical' : ''}`;
        splitInstance = Split(['#editor-pane', '#preview-pane'], {
          sizes: [50, 50],
          minSize: 100,
          gutterSize: 8,
          direction: direction
        });
      }

      document.getElementById('toggle-layout-btn').addEventListener('click', () => {
        isVerticalLayout = !isVerticalLayout;
        setupSplitLayout();
        const icon = document.getElementById('toggle-layout-btn').querySelector('i');
        icon.className = isVerticalLayout ? 'bi bi-distribute-horizontal' : 'bi bi-distribute-vertical';
      });

      // ✨ START: NEW - Full Page Desktop View Toggle Logic
      const desktopViewBtn = document.getElementById('desktop-view-btn');
      
      function toggleFullDesktopView() {
        isFullDesktopView = !isFullDesktopView;
        const icon = desktopViewBtn.querySelector('i');

        if (isFullDesktopView) {
            // Set to desktop mode: fixed wide viewport. The browser will scale it down.
            viewportMeta.setAttribute('content', 'width=1280');
            icon.className = 'bi bi-phone';
            desktopViewBtn.title = 'تبديل عرض الهاتف';
        } else {
            // Set back to mobile/responsive mode using the original value
            viewportMeta.setAttribute('content', originalViewportContent);
            icon.className = 'bi bi-pc-display';
            desktopViewBtn.title = 'تبديل عرض سطح المكتب';
        }
      }

      desktopViewBtn.addEventListener('click', toggleFullDesktopView);
      // ✨ END: NEW - Full Page Desktop View Toggle Logic

      // ## 3. وظائف شريط الحالة (Status Bar)
      editor.on("lintDone", function(annotations) {
          lintAnnotations = annotations;
          const errorCount = lintAnnotations.length;
          document.getElementById('error-status').textContent = `Errors: ${errorCount}`;
      });

      function updateStatusBar() {
          const lineCount = editor.lineCount();
          const wordCount = editor.getValue().split(/\s+/).filter(Boolean).length;
          document.getElementById('line-count-status').textContent = `Lines: ${lineCount}`;
          document.getElementById('word-count-status').textContent = `Words: ${wordCount}`;
          if (currentErrorMarker) {
              currentErrorMarker.clear();
              currentErrorMarker = null;
          }
      }

      document.getElementById('error-status').addEventListener('click', () => {
        if (lintAnnotations.length > 0) {
          const error = lintAnnotations[0];
          const from = { line: error.from.line, ch: error.from.ch };
          const to = { line: error.to.line, ch: error.to.ch };
          editor.setCursor(from);
          editor.focus();
          if (currentErrorMarker) currentErrorMarker.clear();
          currentErrorMarker = editor.markText(from, to, { className: 'cm-error-highlight' });
        }
      });

      // ## 4. وظائف الحفظ والاسترجاع (LocalStorage)
      function autoSave() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
          localStorage.setItem('kodedeck_autosave', editor.getValue());
        }, 500);
      }

      function loadAutoSavedCode() {
        const savedCode = localStorage.getItem('kodedeck_autosave');
        if (savedCode) {
          editor.setValue(savedCode);
        } else {
          editor.setValue(`<!DOCTYPE html> 
<html> 
<head> 
  <title>Kodedeck</title> 
  <style> 
    body { font-family: Arial, sans-serif; margin: 40px; background-color: #f5f5f5; color: #333; } 
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); } 
    h1 { color: #2c3e50; } 
    p { line-height: 1.6; color: #34495e; } 
  </style> 
</head> 
<body> 
  <div class="container" ondblclick="alert('Hello from the preview!')"> 
    <h1>مرحباً بك في Kodedeck!</h1> 
    <p>انقر نقراً مزدوجاً هنا أو على العنوان لترى السطر المقابل في المحرر يتوهج!</p> 
  </div> 
  <script> 
    // This script block is ready for your code.
    console.log("Welcome to Kodedeck!"); 
  <\/script> 
</body> 
</html>`);
        }
        updateFileName('Untitled.html');
      }

      function getFileExtension(mode) {
        switch(mode) {
          case 'htmlmixed': return '.html'; case 'xml': return '.xml'; case 'css': return '.css'; case 'javascript': return '.js';
          default: return '.txt';
        }
      }
      
      function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => { notification.remove(); }, 3000);
      }

      document.getElementById('confirm-save-btn').addEventListener('click', () => {
        const name = document.getElementById('snippet-name-input').value.trim();
        if (!name) { showNotification('الرجاء إدخال اسم للكود.', 'warning'); return; }
        const code = editor.getValue();
        const mode = editor.getMode().name;
        const timestamp = new Date().toISOString();
        const extension = getFileExtension(mode);
        let snippets = JSON.parse(localStorage.getItem('kodedeck_snippets') || '{}');
        snippets[name] = { code: code, language: mode, timestamp: timestamp, extension: extension };
        localStorage.setItem('kodedeck_snippets', JSON.stringify(snippets));
        saveModal.hide();
        document.getElementById('snippet-name-input').value = '';
        updateFileName(name + extension);
        showNotification('تم حفظ الكود بنجاح!');
      });

      function populateSnippetsModal() {
        const snippets = JSON.parse(localStorage.getItem('kodedeck_snippets') || '{}');
        const container = document.getElementById('snippets-list-container');
        const snippetNames = Object.keys(snippets);
        if (snippetNames.length === 0) {
          container.innerHTML = '<p class="text-center">لا توجد أكواد محفوظة بعد.</p>'; return;
        }
        container.innerHTML = `<ul class="list-group list-group-flush">${snippetNames.map(name => {
            const snippet = snippets[name];
            const isObject = typeof snippet === 'object';
            const language = isObject ? snippet.language : 'غير معروف';
            const timestamp = isObject ? new Date(snippet.timestamp).toLocaleString('ar-EG') : 'غير معروف';
            return `<li class="list-group-item bg-dark text-light">
                <div class="d-flex justify-content-between align-items-center mb-2"><strong>${name}</strong><small class="text-muted">${language} - ${timestamp}</small></div>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-success" onclick="loadSnippet('${name}')">تحميل</button>
                  <button class="btn btn-sm btn-info" onclick="downloadSnippet('${name}')">تنزيل</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteSnippet('${name}')"><i class="bi bi-trash"></i></button>
                </div></li>`;
          }).join('')}</ul>`;
      }

      window.loadSnippet = function(name) {
        const snippets = JSON.parse(localStorage.getItem('kodedeck_snippets'));
        if (snippets && snippets[name]) {
          const snippet = snippets[name];
          const code = typeof snippet === 'object' ? snippet.code : snippet;
          editor.setValue(code);
          updateFileName(name + snippet.extension);
          loadModal.hide();
          showNotification(`تم تحميل ${name} بنجاح!`);
        }
      }

      window.deleteSnippet = function(name) {
        if (confirm(`هل أنت متأكد من حذف "${name}"؟`)) {
          let snippets = JSON.parse(localStorage.getItem('kodedeck_snippets'));
          delete snippets[name];
          localStorage.setItem('kodedeck_snippets', JSON.stringify(snippets));
          populateSnippetsModal();
          showNotification(`تم حذف ${name} بنجاح!`, 'warning');
        }
      }

      window.downloadSnippet = function(name) {
        const snippets = JSON.parse(localStorage.getItem('kodedeck_snippets') || '{}');
        const snippet = snippets[name];
        if (!snippet) return;
        const code = typeof snippet === 'object' ? snippet.code : snippet;
        const extension = typeof snippet === 'object' ? snippet.extension : '.html';
        const blob = new Blob([code], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = name + extension;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        showNotification(`تم تنزيل ${name} بنجاح!`);
      }

      function downloadCode() {
        const currentName = fileNameElement.textContent || 'kodedeck_code.html';
        const baseName = currentName.substring(0, currentName.lastIndexOf('.')) || currentName;
        const newName = prompt("أدخل اسم الملف للتنزيل:", baseName);
        if (newName === null || newName.trim() === '') {
          showNotification('تم إلغاء التنزيل.', 'warning'); return;
        }
        const code = editor.getValue();
        const mode = editor.getMode().name;
        const extension = getFileExtension(mode);
        const finalName = newName.endsWith(extension) ? newName : newName + extension;
        const blob = new Blob([code], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = finalName;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        showNotification(`تم تنزيل الكود بنجاح!`);
      }

      function applyTheme(themeName) {
        editor.setOption('theme', themeName);
        localStorage.setItem('kodedeck_theme', themeName);
      }

      function loadSavedTheme() {
        const savedTheme = localStorage.getItem('kodedeck_theme') || 'dracula';
        applyTheme(savedTheme);
      }

      document.querySelectorAll('.theme-select-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const themeName = this.dataset.theme;
          applyTheme(themeName);
          themeModal.hide();
        });
      });

      async function handleClipboard(action) {
        try {
          if (action === 'cut' || action === 'copy') {
            const selectedText = editor.getSelection();
            if(selectedText) {
              await navigator.clipboard.writeText(selectedText);
              if (action === 'cut') editor.replaceSelection('');
            }
          } else if (action === 'paste') {
            const text = await navigator.clipboard.readText();
            editor.replaceSelection(text);
          }
        } catch (err) {
          console.error('فشل الوصول للحافظة: ', err);
          showNotification('فشل الوصول إلى الحافظة.', 'error');
        }
        editor.focus();
      }

      function highlightLineInEditor(line) {
          if (highlightedLineMarker) { highlightedLineMarker.clear(); }
          const lineHandle = editor.getLineHandle(line); if (!lineHandle) return;
          highlightedLineMarker = editor.markText(
              { line: line, ch: 0 }, { line: line, ch: editor.getLine(line).length }, { className: 'editor-line-highlight' }
          );
          editor.scrollIntoView({ line: line, ch: 0 }, 100);
          setTimeout(() => { if (highlightedLineMarker) { highlightedLineMarker.clear(); highlightedLineMarker = null; } }, 2500);
      }

      function updatePreview() {
        const previewFrame = document.getElementById('preview-frame');
        const preview = previewFrame.contentWindow.document;
        preview.open();
        let code = editor.getValue();
        const antiScrollStyles = `<style>html, body { overflow-x: hidden !important; box-sizing: border-box !important; } img { max-width: 100%; height: auto; }</style>`;
        code = code.includes('</head>') ? code.replace('</head>', antiScrollStyles + '</head>') : antiScrollStyles + code;
        const safeCode = code.replace(/<script\b[^>]*>([\s\S]*?)<\/script>/gi, (match, scriptContent) => {
          return `<script>(function(){try{${scriptContent}}catch(e){console.error(e)}})();<\/script>`;
        });
        preview.write(safeCode);
        preview.close();
        preview.body.addEventListener('dblclick', (event) => {
            const target = event.target; if (!target || !target.outerHTML) return;
            const cursor = editor.getSearchCursor(target.outerHTML, {line: 0, ch: 0}, false);
            if (cursor.findNext()) { highlightLineInEditor(cursor.from().line); }
        });
      }

      editor.on('change', () => { updatePreview(); updateStatusBar(); autoSave(); });

      document.getElementById('undo-btn').addEventListener('click', () => editor.undo());
      document.getElementById('redo-btn').addEventListener('click', () => editor.redo());
      document.getElementById('cut-btn').addEventListener('click', () => handleClipboard('cut'));
      document.getElementById('copy-btn').addEventListener('click', () => handleClipboard('copy'));
      document.getElementById('paste-btn').addEventListener('click', () => handleClipboard('paste'));
      document.getElementById('select-all-btn').addEventListener('click', () => editor.execCommand('selectAll'));
      document.getElementById('download-btn').addEventListener('click', downloadCode);

      const shareUrl = window.location.href;
      const shareTitle = document.title;
      document.getElementById('share-facebook').addEventListener('click', (e) => { e.preventDefault(); window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`, '_blank'); });
      document.getElementById('share-whatsapp').addEventListener('click', (e) => { e.preventDefault(); window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(shareTitle + ':\n' + shareUrl)}`, '_blank'); });
      document.getElementById('share-telegram').addEventListener('click', (e) => { e.preventDefault(); window.open(`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(shareTitle)}`, '_blank'); });
      
      document.getElementById('native-share-btn').addEventListener('click', async () => {
        if (navigator.share && navigator.canShare) {
            const code = editor.getValue();
            if (!code.trim()) {
                await navigator.share({ title: shareTitle, text: 'تحقق من محرر الأكواد الرائع هذا!', url: shareUrl }); return;
            }
            const currentName = fileNameElement.textContent || 'shared_code.html';
            const baseName = currentName.substring(0, currentName.lastIndexOf('.')) || currentName;
            const newName = prompt("أدخل اسم الملف للمشاركة:", baseName);
            if (newName === null || newName.trim() === '') {
                showNotification('تم إلغاء المشاركة.', 'warning'); return;
            }
            const extension = getFileExtension(editor.getMode().name);
            const finalName = newName.endsWith(extension) ? newName : newName + extension;
            const fileToShare = new File([code], finalName, { type: 'text/plain' });
            if (navigator.canShare({ files: [fileToShare] })) {
                try {
                    await navigator.share({ files: [fileToShare], title: `مشاركة ملف: ${finalName}`, text: `ملف كود من Kodedeck.` });
                } catch (err) { if (err.name !== 'AbortError') console.error('خطأ في مشاركة الملف:', err); }
            } else { await navigator.share({ title: `كود من Kodedeck: ${finalName}`, text: code, url: shareUrl }); }
        } else {
            showNotification('ميزة المشاركة الأصلية غير مدعومة في هذا المتصفح.', 'warning');
        }
      });
      
      document.getElementById('new-file-btn').addEventListener('click', () => {
        if (editor.getValue() && !confirm('هل تريد فتح ملف جديد؟ سيتم فقدان التغييرات غير المحفوظة.')) return;
        editor.setValue(`<!DOCTYPE html>...`);
        updateFileName('Untitled.html');
      });

      document.getElementById('clear-editor-btn').addEventListener('click', () => {
        if (confirm('هل تريد مسح كل النص في المحرر؟')) editor.setValue('');
      });

      document.getElementById('popup-cut-btn').addEventListener('click', () => { handleClipboard('cut'); selectionToolbar.style.display = 'none'; });
      document.getElementById('popup-copy-btn').addEventListener('click', () => { handleClipboard('copy'); selectionToolbar.style.display = 'none'; });
      document.getElementById('popup-paste-btn').addEventListener('click', () => { handleClipboard('paste'); selectionToolbar.style.display = 'none'; });
      document.getElementById('popup-select-all-btn').addEventListener('click', () => { editor.execCommand('selectAll'); selectionToolbar.style.display = 'none'; });
      document.getElementById('popup-search-btn').addEventListener('click', () => {
        const selectedText = editor.getSelection();
        if (selectedText) window.open('https://www.google.com/search?q=' + encodeURIComponent(selectedText), '_blank');
        selectionToolbar.style.display = 'none';
      });

      editor.on('cursorActivity', function() {
        if (editor.somethingSelected()) {
          const coords = editor.cursorCoords(editor.getCursor(true), 'page');
          selectionToolbar.style.left = `${coords.left}px`;
          selectionToolbar.style.top = `${coords.top - 50}px`;
          selectionToolbar.style.display = 'flex';
        } else {
          selectionToolbar.style.display = 'none';
        }
      });
      
      document.getElementById('search-btn').onclick = toggleAdvancedSearch;
      function toggleAdvancedSearch() {
        if (advancedSearchPanel.style.display === 'flex') {
          advancedSearchPanel.style.display = 'none'; isAdvancedSearchOpen = false; clearSearchMarkers();
        } else {
          advancedSearchPanel.style.display = 'flex'; isAdvancedSearchOpen = true; advancedSearchInput.focus();
        }
      }

      document.getElementById('advanced-search-close').onclick = () => {
        advancedSearchPanel.style.display = 'none'; isAdvancedSearchOpen = false; clearSearchMarkers(); editor.focus();
      };
      
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && isAdvancedSearchOpen) toggleAdvancedSearch(); });
      
      document.getElementById('find-next-btn').onclick = findNext; document.getElementById('find-prev-btn').onclick = findPrev; document.getElementById('find-all-btn').onclick = findAll; document.getElementById('replace-btn').onclick = replace; document.getElementById('replace-all-btn').onclick = replaceAll;
      
      function findNext() {} function findPrev() {} function findAll() {} function replace() {} function replaceAll() {}
      function clearSearchMarkers() { searchMarkers.forEach(marker => marker.clear()); searchMarkers = []; }

      const fileUploader = document.getElementById('file-uploader');
      fileUploader.addEventListener('change', (event) => {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => { 
          editor.setValue(e.target.result); 
          updateFileName(file.name);
          showNotification(`تم تحميل الملف ${file.name} بنجاح`, 'success'); 
        };
        reader.readAsText(file); event.target.value = '';
      });

      setupSplitLayout(); loadSavedTheme(); loadAutoSavedCode(); updatePreview(); updateStatusBar();
      document.getElementById('loadModal').addEventListener('shown.bs.modal', populateSnippetsModal);
    });
  </script>
</body>
</html>