<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ¹Ù„Ù… Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¹ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù„Ù„Ø£Ø·ÙØ§Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <meta name="theme-color" content="#4CAF50">
    <style>
        :root {
            --primary-color: #4CAF50;
            --success-color: #8BC34A;
            --warning-color: #FFC107;
            --error-color: #F44336;
            --light-color: #E8F5E9;
            --dark-color: #2E7D32;
            --accent-color: #FF5722;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Tajawal', sans-serif; background-color: #F1F8E9; color: var(--dark-color); line-height: 1.6; touch-action: manipulation; }
        .container { max-width: 100%; padding: 15px; margin: 0 auto; }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white; padding: 20px 0; text-align: center; border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 25px; position: relative; overflow: hidden;
        }
        .home-btn {
            position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.2);
            color: white; border: 2px solid white; border-radius: 50px; padding: 8px 15px;
            text-decoration: none; font-weight: bold; display: flex; align-items: center; gap: 8px; cursor: pointer; z-index: 10;
        }
        header::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="white" opacity="0.1"><text x="50%" y="50%" font-size="30" text-anchor="middle" dominant-baseline="middle">Ø£ Ø¨ Øª</text></svg>');
            pointer-events: none;
        }
        h1 { font-size: 2rem; margin: 0; position: relative; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .subtitle { font-size: 1.1rem; opacity: 0.9; margin-top: 5px; }
        
        .letters-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .letter-card {
            background-color: white; border-radius: 15px; padding: 20px 10px; text-align: center; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(0,0,0,0.1); position: relative; overflow: hidden;
            border: 3px solid var(--primary-color); aspect-ratio: 1/1; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .letter-card:hover, .letter-card:active { transform: translateY(-5px) scale(1.05); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        .letter-card::after { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 5px; background: linear-gradient(90deg, var(--accent-color), var(--warning-color)); }
        .letter-card.completed::before {
            content: "âœ“"; position: absolute; top: 5px; left: 5px; width: 25px; height: 25px;
            background-color: var(--success-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1rem; font-weight: bold;
        }
        .letter { font-size: 3rem; font-weight: bold; margin-bottom: 10px; color: var(--dark-color); text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .letter-name { font-size: 1rem; color: var(--dark-color); background-color: rgba(76, 175, 80, 0.1); padding: 5px 10px; border-radius: 10px; display: inline-block; }
        
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: white; border-radius: 25px; width: 95%; max-width: 500px; padding: 25px;
            text-align: center; position: relative; animation: modalFadeIn 0.4s; border: 5px solid var(--accent-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;
        }
        @keyframes modalFadeIn { from { opacity: 0; transform: translateY(-30px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .close-modal {
            position: absolute; top: 15px; left: 15px; font-size: 1.8rem; cursor: pointer; color: var(--dark-color);
            background-color: var(--light-color); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: all 0.3s ease; z-index: 1;
        }
        .close-modal:hover, .close-modal:active { transform: rotate(90deg) scale(1.1); background-color: var(--accent-color); color: white; }
        .modal-letter { font-size: 5rem; margin: 20px 0; line-height: 1; color: var(--dark-color); text-shadow: 3px 3px 6px rgba(0,0,0,0.1); position: relative; display: inline-block; }
        .modal-letter::after { content: ""; position: absolute; bottom: -10px; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); border-radius: 2px; }
        .letter-name-modal { font-size: 1.3rem; margin-bottom: 20px; color: var(--dark-color); background-color: rgba(139, 195, 74, 0.2); padding: 10px 15px; border-radius: 15px; display: inline-block; }
        
        .harakat-container { display: flex; justify-content: center; gap: 15px; margin: 25px 0; flex-wrap: wrap; }
        .haraka-btn {
            background-color: var(--light-color); border: 3px solid var(--primary-color); border-radius: 50%;
            width: 70px; height: 70px; font-size: 2.2rem; cursor: pointer; transition: all 0.3s ease; display: flex;
            justify-content: center; align-items: center; position: relative; color: var(--dark-color);
        }
        .haraka-btn:hover, .haraka-btn:active { background-color: var(--primary-color); color: white; transform: scale(1.1); }
        .haraka-btn.active { background-color: var(--primary-color); color: white; transform: scale(1.1); box-shadow: 0 0 15px rgba(76, 175, 80, 0.5); }
        .haraka-btn.completed { background-color: var(--success-color); color: white; border-color: var(--success-color); }
        .haraka-name { position: absolute; bottom: -25px; font-size: 0.9rem; color: var(--dark-color); white-space: nowrap; }
        
        .voice-section { margin-top: 25px; padding: 20px; background-color: var(--light-color); border-radius: 20px; border: 2px dashed var(--primary-color); }
        .record-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color)); color: white; border: none;
            border-radius: 50px; padding: 15px 25px; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center;
            gap: 10px; margin: 0 auto; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 100%; max-width: 250px; justify-content: center;
        }
        .record-btn:hover, .record-btn:active { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .record-btn.recording { background: linear-gradient(135deg, var(--error-color), #D32F2F); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(244, 67, 54, 0); } 100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); } }
        
        .status-message { margin-top: 15px; padding: 12px; border-radius: 15px; display: none; font-size: 1.1rem; border-left: 5px solid transparent; }
        .status-message.success { background-color: rgba(139, 195, 74, 0.3); color: #2E7D32; display: block; border-left-color: var(--success-color); }
        .status-message.error { background-color: rgba(244, 67, 54, 0.2); color: #C62828; display: block; border-left-color: var(--error-color); }
        .status-message.info { background-color: rgba(33, 150, 243, 0.2); color: #0D47A1; display: block; border-left-color: var(--primary-color); }
        
        .next-btn {
            background: linear-gradient(135deg, var(--success-color), #689F38); color: white; border: none; border-radius: 50px;
            padding: 12px 25px; font-size: 1.1rem; cursor: pointer; margin-top: 15px; display: none; transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 100%; max-width: 250px;
        }
        .try-again-btn {
            background: linear-gradient(135deg, var(--warning-color), #FF8F00); color: white; border: none; border-radius: 50px;
            padding: 12px 25px; font-size: 1.1rem; cursor: pointer; margin-top: 15px; display: none; transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 100%; max-width: 250px;
        }
        .audio-wave { display: flex; justify-content: center; align-items: center; height: 50px; gap: 5px; margin: 15px 0; }
        .audio-wave span {
            display: inline-block; width: 5px; height: 15px; background: linear-gradient(to top, var(--primary-color), var(--accent-color));
            border-radius: 3px; animation: audioWave 1.5s infinite ease-in-out;
        }
        .audio-wave span:nth-child(1) { animation-delay: 0.1s; } .audio-wave span:nth-child(2) { animation-delay: 0.2s; }
        .audio-wave span:nth-child(3) { animation-delay: 0.3s; } .audio-wave span:nth-child(4) { animation-delay: 0.4s; } .audio-wave span:nth-child(5) { animation-delay: 0.5s; }
        @keyframes audioWave { 0%, 100% { height: 15px; } 50% { height: 35px; } }
        
        .confetti { position: fixed; width: 10px; height: 10px; background-color: var(--accent-color); opacity: 0; z-index: 9999; animation: confetti 3s ease-in-out; pointer-events: none; }
        @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        
        .offline-message { position: fixed; bottom: 20px; left: 20px; right: 20px; background-color: var(--warning-color); color: white; padding: 10px; border-radius: 10px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1001; display: none; }
        
        @media (max-width: 480px) {
            .letters-grid { grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 12px; }
            .letter { font-size: 2.5rem; } .letter-name { font-size: 0.9rem; }
            .modal-letter { font-size: 4rem; } .haraka-btn { width: 60px; height: 60px; font-size: 2rem; }
            .haraka-name { font-size: 0.8rem; bottom: -20px; } h1 { font-size: 1.7rem; } .subtitle { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <header>
        <a href="drsne.html" class="home-btn">
            <i class="fas fa-arrow-right"></i> Ø®Ø±ÙˆØ¬
        </a>
        <h1>ØªØ¹Ù„Ù… Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</h1>
        <div class="subtitle">Ø§Ø³ØªÙ…Ø¹ ÙˆØ±Ø¯Ø¯ ÙˆØªØ¹Ù„Ù… Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>
    </header>
    
    <div class="container">
        <div class="letters-grid" id="lettersGrid"></div>
    </div>
    
    <div class="modal" id="letterModal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">Ã—</span>
            <div class="modal-letter" id="modalLetter"></div>
            <div class="letter-name-modal" id="letterNameModal"></div>
            <div class="harakat-container" id="harakatContainer"></div>
            
            <div class="voice-section" id="voiceSection">
                <div id="instruction">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø£Ø¹Ù„Ø§Ù‡ Ø«Ù… Ø³Ø¬Ù„ ØµÙˆØªÙƒ</div>
                
                <button class="record-btn" id="recordBtn">
                    <span id="recordIcon">ğŸ¤</span>
                    <span id="recordText">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª</span>
                </button>
                
                <div class="audio-wave" id="audioWave">
                    <span></span><span></span><span></span><span></span><span></span>
                </div>
                
                <div class="status-message" id="statusMessage"></div>
                <button class="next-btn" id="nextBtn">Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„ØªØ§Ù„ÙŠØ©</button>
                <button class="try-again-btn" id="tryAgainBtn">Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
            </div>
        </div>
    </div>
    
    <div class="offline-message" id="offlineMessage">
        Ø£Ù†Øª Ø§Ù„Ø¢Ù† ØªØ³ØªØ®Ø¯Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„. Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„.
    </div>
    
  <script>
        function appSpeak(text) {
            return new Promise((resolve) => {
                if (!text) { resolve(); return; }
                let rate = 1; let pitch = 1;
                if (window.speechSynthesis) window.speechSynthesis.cancel();
                
                if (typeof Android !== 'undefined') {
                    Android.speakArabic(text, rate.toString(), pitch.toString());
                    let charDelay = 120 / rate; 
                    let estimatedTime = Math.max(1000, text.length * charDelay);
                    setTimeout(resolve, estimatedTime);
                    return;
                }
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'ar-SA';
                    utterance.rate = rate;
                    utterance.onend = resolve;
                    utterance.onerror = resolve;
                    window.speechSynthesis.speak(utterance);
                } else {
                    resolve();
                }
            });
        }

        const arabicLetters = [
            { letter: 'Ø§', name: 'Ø£Ù„Ù', pronunciations: { 'Ù': 'Ø£Ù', 'Ù': 'Ø£Ù', 'Ù': 'Ø¥Ù' } },
            { letter: 'Ø¨', name: 'Ø¨Ø§Ø¡', pronunciations: { 'Ù': 'Ø¨Ù', 'Ù': 'Ø¨Ù', 'Ù': 'Ø¨Ù' } },
            { letter: 'Øª', name: 'ØªØ§Ø¡', pronunciations: { 'Ù': 'ØªÙ', 'Ù': 'ØªÙ', 'Ù': 'ØªÙ' } },
            { letter: 'Ø«', name: 'Ø«Ø§Ø¡', pronunciations: { 'Ù': 'Ø«Ù', 'Ù': 'Ø«Ù', 'Ù': 'Ø«Ù' } },
            { letter: 'Ø¬', name: 'Ø¬ÙŠÙ…', pronunciations: { 'Ù': 'Ø¬Ù', 'Ù': 'Ø¬Ù', 'Ù': 'Ø¬Ù' } },
            { letter: 'Ø­', name: 'Ø­Ø§Ø¡', pronunciations: { 'Ù': 'Ø­Ù', 'Ù': 'Ø­Ù', 'Ù': 'Ø­Ù' } },
            { letter: 'Ø®', name: 'Ø®Ø§Ø¡', pronunciations: { 'Ù': 'Ø®Ù', 'Ù': 'Ø®Ù', 'Ù': 'Ø®Ù' } },
            { letter: 'Ø¯', name: 'Ø¯Ø§Ù„', pronunciations: { 'Ù': 'Ø¯Ù', 'Ù': 'Ø¯Ù', 'Ù': 'Ø¯Ù' } },
            { letter: 'Ø°', name: 'Ø°Ø§Ù„', pronunciations: { 'Ù': 'Ø°Ù', 'Ù': 'Ø°Ù', 'Ù': 'Ø°Ù' } },
            { letter: 'Ø±', name: 'Ø±Ø§Ø¡', pronunciations: { 'Ù': 'Ø±Ù', 'Ù': 'Ø±Ù', 'Ù': 'Ø±Ù' } },
            { letter: 'Ø²', name: 'Ø²Ø§ÙŠ', pronunciations: { 'Ù': 'Ø²Ù', 'Ù': 'Ø²Ù', 'Ù': 'Ø²Ù' } },
            { letter: 'Ø³', name: 'Ø³ÙŠÙ†', pronunciations: { 'Ù': 'Ø³Ù', 'Ù': 'Ø³Ù', 'Ù': 'Ø³Ù' } },
            { letter: 'Ø´', name: 'Ø´ÙŠÙ†', pronunciations: { 'Ù': 'Ø´Ù', 'Ù': 'Ø´Ù', 'Ù': 'Ø´Ù' } },
            { letter: 'Øµ', name: 'ØµØ§Ø¯', pronunciations: { 'Ù': 'ØµÙ', 'Ù': 'ØµÙ', 'Ù': 'ØµÙ' } },
            { letter: 'Ø¶', name: 'Ø¶Ø§Ø¯', pronunciations: { 'Ù': 'Ø¶Ù', 'Ù': 'Ø¶Ù', 'Ù': 'Ø¶Ù' } },
            { letter: 'Ø·', name: 'Ø·Ø§Ø¡', pronunciations: { 'Ù': 'Ø·Ù', 'Ù': 'Ø·Ù', 'Ù': 'Ø·Ù' } },
            { letter: 'Ø¸', name: 'Ø¸Ø§Ø¡', pronunciations: { 'Ù': 'Ø¸Ù', 'Ù': 'Ø¸Ù', 'Ù': 'Ø¸Ù' } },
            { letter: 'Ø¹', name: 'Ø¹ÙŠÙ†', pronunciations: { 'Ù': 'Ø¹Ù', 'Ù': 'Ø¹Ù', 'Ù': 'Ø¹Ù' } },
            { letter: 'Øº', name: 'ØºÙŠÙ†', pronunciations: { 'Ù': 'ØºÙ', 'Ù': 'ØºÙ', 'Ù': 'ØºÙ' } },
            { letter: 'Ù', name: 'ÙØ§Ø¡', pronunciations: { 'Ù': 'ÙÙ', 'Ù': 'ÙÙ', 'Ù': 'ÙÙ' } },
            { letter: 'Ù‚', name: 'Ù‚Ø§Ù', pronunciations: { 'Ù': 'Ù‚Ù', 'Ù': 'Ù‚Ù', 'Ù': 'Ù‚Ù' } },
            { letter: 'Ùƒ', name: 'ÙƒØ§Ù', pronunciations: { 'Ù': 'ÙƒÙ', 'Ù': 'ÙƒÙ', 'Ù': 'ÙƒÙ' } },
            { letter: 'Ù„', name: 'Ù„Ø§Ù…', pronunciations: { 'Ù': 'Ù„Ù', 'Ù': 'Ù„Ù', 'Ù': 'Ù„Ù' } },
            { letter: 'Ù…', name: 'Ù…ÙŠÙ…', pronunciations: { 'Ù': 'Ù…Ù', 'Ù': 'Ù…Ù', 'Ù': 'Ù…Ù' } },
            { letter: 'Ù†', name: 'Ù†ÙˆÙ†', pronunciations: { 'Ù': 'Ù†Ù', 'Ù': 'Ù†Ù', 'Ù': 'Ù†Ù' } },
            { letter: 'Ù‡', name: 'Ù‡Ø§Ø¡', pronunciations: { 'Ù': 'Ù‡Ù', 'Ù': 'Ù‡Ù', 'Ù': 'Ù‡Ù' } },
            { letter: 'Ùˆ', name: 'ÙˆØ§Ùˆ', pronunciations: { 'Ù': 'ÙˆÙ', 'Ù': 'ÙˆÙ', 'Ù': 'ÙˆÙ' } },
            { letter: 'ÙŠ', name: 'ÙŠØ§Ø¡', pronunciations: { 'Ù': 'ÙŠÙ', 'Ù': 'ÙŠÙ', 'Ù': 'ÙŠÙ' } }
        ];

        const harakat = [
            { symbol: 'Ù', name: 'ÙØªØ­Ø©' },
            { symbol: 'Ù', name: 'Ø¶Ù…Ø©' },
            { symbol: 'Ù', name: 'ÙƒØ³Ø±Ø©' }
        ];
        
        const lettersGrid = document.getElementById('lettersGrid');
        const letterModal = document.getElementById('letterModal');
        const closeModal = document.getElementById('closeModal');
        const modalLetter = document.getElementById('modalLetter');
        const letterNameModal = document.getElementById('letterNameModal');
        const harakatContainer = document.getElementById('harakatContainer');
        const voiceSection = document.getElementById('voiceSection');
        const recordBtn = document.getElementById('recordBtn');
        const recordIcon = document.getElementById('recordIcon');
        const recordText = document.getElementById('recordText');
        const statusMessage = document.getElementById('statusMessage');
        const nextBtn = document.getElementById('nextBtn');
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        const instruction = document.getElementById('instruction');
        const audioWave = document.getElementById('audioWave');
        const offlineMessage = document.getElementById('offlineMessage');
        
        let currentLetter = null;
        let currentHaraka = null;
        let isRecording = false;
        let storedPronunciations = {};
        let completedHarakat = {};
        let isOnline = navigator.onLine;
        let speechRecognition = null;
        
        // Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ© ÙÙ‚Ø·
        let audioContext = null;
        let analyser = null;
        let microphone = null;

        function initApp() {
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            loadStoredData();
            initLettersGrid();
            initHarakatButtons();
            audioWave.style.display = 'none';
            initSpeechRecognition();
        }
        
        function initSpeechRecognition() {
            // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                speechRecognition = new SpeechRecognition();
                speechRecognition.continuous = false;
                speechRecognition.interimResults = false;
                speechRecognition.lang = 'ar-SA';
                speechRecognition.maxAlternatives = 3; // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨Ø¯Ø§Ø¦Ù„ Ù…ØªØ¹Ø¯Ø¯Ø©
                
                speechRecognition.onstart = () => {
                    console.log("Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª Ø¨Ø¯Ø£");
                };
                
                speechRecognition.onresult = (event) => {
                    let bestMatch = null;
                    let bestConfidence = 0;
                    
                    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø¯Ø§Ø¦Ù„
                    for (let i = 0; i < event.results.length; i++) {
                        for (let j = 0; j < event.results[i].length; j++) {
                            const transcript = event.results[i][j].transcript.trim();
                            const confidence = event.results[i][j].confidence;
                            console.log(`Ø§Ù„Ø¨Ø¯ÙŠÙ„ ${j}: "${transcript}" (Ø«Ù‚Ø©: ${confidence})`);
                            
                            if (confidence > bestConfidence) {
                                bestMatch = transcript;
                                bestConfidence = confidence;
                            }
                        }
                    }
                    
                    console.log("Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©:", bestMatch);
                    
                    if (bestMatch) {
                        const expected = currentLetter.pronunciations[currentHaraka];
                        const isCorrect = checkPronunciationMatch(bestMatch, expected);
                        
                        stopVisuals();
                        if (isCorrect) handleCorrectPronunciation(bestMatch);
                        else handleIncorrectPronunciation();
                    } else {
                        showError("Ù„Ù… Ø£Ø³Ù…Ø¹Ùƒ Ø¬ÙŠØ¯Ø§Ù‹ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
                    }
                };
                
                speechRecognition.onerror = (event) => {
                    stopVisuals();
                    console.error('Speech recognition error', event.error);
                    if (event.error === 'no-speech') {
                        showError("Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù ØµÙˆØª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†");
                    } else if (event.error === 'audio-capture') {
                        showError("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…ØªØ§Ø­. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†");
                    } else if (event.error === 'not-allowed') {
                        showError("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø°Ù†");
                    } else {
                        showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
                    }
                };
                
                speechRecognition.onend = () => {
                    isRecording = false;
                    updateUIForRecording(false);
                    stopVisuals();
                };
            } else {
                console.warn('Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­');
                recordBtn.style.display = 'none';
                instruction.innerHTML = "Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù…ØªØµÙØ­Ùƒ. Ø¬Ø±Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome Ø£Ùˆ Edge.";
            }
        }
        
        // ========================================================
        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        // ========================================================
        function normalizeArabic(text) {
            if (!text || typeof text !== 'string') return "";
            
            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù†Øµ Ø¹Ø±Ø¨ÙŠ
            let normalized = text;
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„ÙÙˆØ§ØµÙ„ Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©
            normalized = normalized.replace(/\s+/g, '');
            
            // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ´ÙƒÙŠÙ„ ÙˆØ§Ù„ØªÙ†ÙˆÙŠÙ†
            normalized = normalized.replace(/[\u064B-\u065F]/g, '');
            
            // ØªÙˆØ­ÙŠØ¯ Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø£Ù„Ù
            normalized = normalized.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§');
            
            // ØªÙˆØ­ÙŠØ¯ Ø£Ø´ÙƒØ§Ù„ Ø§Ù„ÙŠØ§Ø¡
            normalized = normalized.replace(/[Ù‰Ù°]/g, 'ÙŠ');
            
            // ØªÙˆØ­ÙŠØ¯ Ø£Ø´ÙƒØ§Ù„ Ø§Ù„ØªØ§Ø¡ Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©
            normalized = normalized.replace(/Ø©/g, 'Ù‡');
            
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø£Ø­Ø±Ù ØºÙŠØ± Ø¹Ø±Ø¨ÙŠØ©
            normalized = normalized.replace(/[^\u0600-\u06FF]/g, '');
            
            return normalized.trim();
        }

        // ========================================================
        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø±Ù†Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        // ========================================================
        function checkPronunciationMatch(spoken, expected) {
            if (!spoken || !expected) return false;
            
            let cleanSpoken = normalizeArabic(spoken);
            let baseLetter = normalizeArabic(currentLetter.letter);
            let haraka = currentHaraka;
            
            console.log(`Ø§Ù„ØªØ­Ù‚Ù‚: "${cleanSpoken}" Ù…Ù‚Ø§Ø¨Ù„ "${baseLetter}" Ù…Ø¹ Ø§Ù„Ø­Ø±ÙƒØ© "${haraka}"`);
            console.log(`Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø§Ù„Ø£ØµÙ„ÙŠ: "${expected}"`);
            
            // Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ù†Ø·Ù‚Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©
            let validPronunciations = [];
            
            // 1. Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„Ø£ØµÙ„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ (Ø¨ÙØŒ Ø¨ÙØŒ Ø¨Ù)
            validPronunciations.push(normalizeArabic(expected));
            
            // 2. Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø³Ø§ÙƒÙ† ÙÙ‚Ø· (Ø¨)
            validPronunciations.push(baseLetter);
            
            // 3. Ù†Ø·Ù‚ Ø§Ù„Ø­Ø±ÙƒØ© ÙƒØ­Ø±Ù Ù…Ø¯
            if (haraka === 'Ù') { // ÙØªØ­Ø©
                // Ø§Ù„ÙØªØ­Ø© ÙŠÙ…ÙƒÙ† Ù†Ø·Ù‚Ù‡Ø§ ÙƒØ£Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø±Ù
                validPronunciations.push(baseLetter + 'Ø§'); // Ø¨Ø§
                validPronunciations.push('Ø§' + baseLetter); // Ø§Ø¨ (ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù„Ù‡Ø¬Ø§Øª)
                validPronunciations.push(baseLetter + 'Ù‰'); // Ø¨Ù‰
                // Ù„Ù„Ø£Ù„Ù ÙÙ‚Ø·
                if (baseLetter === 'Ø§') {
                    validPronunciations.push('Ø£');
                    validPronunciations.push('Ø¥');
                    validPronunciations.push('Ø¢');
                }
            } 
            else if (haraka === 'Ù') { // Ø¶Ù…Ø©
                // Ø§Ù„Ø¶Ù…Ø© ÙŠÙ…ÙƒÙ† Ù†Ø·Ù‚Ù‡Ø§ ÙƒÙˆØ§Ùˆ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø±Ù
                validPronunciations.push(baseLetter + 'Ùˆ'); // Ø¨Ùˆ
                validPronunciations.push('Ùˆ' + baseLetter); // ÙˆØ¨ (ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù„Ù‡Ø¬Ø§Øª)
            } 
            else if (haraka === 'Ù') { // ÙƒØ³Ø±Ø©
                // Ø§Ù„ÙƒØ³Ø±Ø© ÙŠÙ…ÙƒÙ† Ù†Ø·Ù‚Ù‡Ø§ ÙƒÙŠØ§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø±Ù
                validPronunciations.push(baseLetter + 'ÙŠ'); // Ø¨ÙŠ
                validPronunciations.push('ÙŠ' + baseLetter); // ÙŠØ¨ (ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù„Ù‡Ø¬Ø§Øª)
                validPronunciations.push(baseLetter + 'Ù‰'); // Ø¨Ù‰
            }
            
            console.log("Ø§Ù„Ù†Ø·Ù‚Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©:", validPronunciations);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
            for (let pronunciation of validPronunciations) {
                if (cleanSpoken === pronunciation) {
                    console.log(`ØªØ·Ø§Ø¨Ù‚ Ù…Ø¨Ø§Ø´Ø±: "${cleanSpoken}" Ù…Ø¹ "${pronunciation}"`);
                    return true;
                }
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¬Ø²Ø¦ÙŠ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø·Ù‚ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„)
            for (let pronunciation of validPronunciations) {
                if (cleanSpoken.includes(pronunciation) && pronunciation.length > 0) {
                    console.log(`ØªØ·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ: "${cleanSpoken}" ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ "${pronunciation}"`);
                    return true;
                }
            }
            
            // ØªØ­Ù‚Ù‚ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ´Ø§Ø¨Ù‡ Ø§Ù„ØµÙˆØªÙŠ
            if (isPhoneticallySimilar(cleanSpoken, baseLetter, haraka)) {
                console.log(`ØªØ´Ø§Ø¨Ù‡ ØµÙˆØªÙŠ: "${cleanSpoken}"`);
                return true;
            }
            
            console.log("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ·Ø§Ø¨Ù‚");
            return false;
        }
        
        // ========================================================
        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø§Ù„ØµÙˆØªÙŠ
        // ========================================================
        function isPhoneticallySimilar(spoken, baseLetter, haraka) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø·Ù‚ ÙØ§Ø±ØºØ§Ù‹
            if (!spoken || spoken.length === 0) return false;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø·Ù‚ Ù‡Ùˆ Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙÙ‚Ø·
            if (spoken === baseLetter) return true;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©
            if (haraka === 'Ù') { // ÙØªØ­Ø©
                // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±Ù ÙˆØ§Ù„Ø£Ù„Ù Ù…Ø¹Ø§Ù‹
                if (spoken.includes(baseLetter) && 
                    (spoken.includes('Ø§') || spoken.includes('Ø£') || spoken.includes('Ø¥') || spoken.includes('Ø¢') || spoken.includes('Ù‰'))) {
                    return true;
                }
            } 
            else if (haraka === 'Ù') { // Ø¶Ù…Ø©
                // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±Ù ÙˆØ§Ù„ÙˆØ§Ùˆ Ù…Ø¹Ø§Ù‹
                if (spoken.includes(baseLetter) && 
                    (spoken.includes('Ùˆ') || spoken.includes('Ø¤'))) {
                    return true;
                }
            } 
            else if (haraka === 'Ù') { // ÙƒØ³Ø±Ø©
                // ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø±Ù ÙˆØ§Ù„ÙŠØ§Ø¡ Ù…Ø¹Ø§Ù‹
                if (spoken.includes(baseLetter) && 
                    (spoken.includes('ÙŠ') || spoken.includes('Ù‰') || spoken.includes('Ø¦'))) {
                    return true;
                }
            }
            
            return false;
        }
        
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            if (!isOnline) {
                offlineMessage.style.display = 'block';
                setTimeout(() => { offlineMessage.style.display = 'none'; }, 5000);
            }
        }
        
        function loadStoredData() {
            const storedData = localStorage.getItem('arabicLettersAppData');
            if (storedData) {
                storedPronunciations = JSON.parse(storedData);
                updateLetterCardsCompletion();
            } else { storedPronunciations = {}; }
        }
        
        function updateLetterCardsCompletion() {
            const letterCards = document.querySelectorAll('.letter-card');
            letterCards.forEach(card => {
                const letter = card.querySelector('.letter').textContent;
                if (storedPronunciations[letter] && 
                    Object.keys(storedPronunciations[letter]).length === harakat.length) {
                    card.classList.add('completed');
                } else { card.classList.remove('completed'); }
            });
        }
        
        function saveData() {
            localStorage.setItem('arabicLettersAppData', JSON.stringify(storedPronunciations));
            updateLetterCardsCompletion();
        }
        
        function initLettersGrid() {
            lettersGrid.innerHTML = '';
            arabicLetters.forEach(letterData => {
                const letterCard = document.createElement('div');
                letterCard.className = 'letter-card';
                const isCompleted = storedPronunciations[letterData.letter] && 
                                   Object.keys(storedPronunciations[letterData.letter]).length === harakat.length;
                if (isCompleted) letterCard.classList.add('completed');
                letterCard.innerHTML = `<div class="letter">${letterData.letter}</div><div class="letter-name">${letterData.name}</div>`;
                letterCard.addEventListener('click', () => {
                    currentLetter = letterData;
                    completedHarakat = storedPronunciations[letterData.letter] || {};
                    openModal();
                });
                lettersGrid.appendChild(letterCard);
            });
        }
        
        function initHarakatButtons() {
            harakatContainer.innerHTML = '';
            harakat.forEach(haraka => {
                const harakaBtn = document.createElement('button');
                harakaBtn.className = 'haraka-btn';
                if (completedHarakat[haraka.symbol]) harakaBtn.classList.add('completed');
                harakaBtn.dataset.haraka = haraka.symbol;
                harakaBtn.innerHTML = `${haraka.symbol}<div class="haraka-name">${haraka.name}</div>`;
                harakaBtn.addEventListener('click', (e) => { handleHarakaClick(e, haraka); });
                harakatContainer.appendChild(harakaBtn);
            });
        }
        
        function openModal() {
            modalLetter.textContent = currentLetter.letter;
            letterNameModal.textContent = currentLetter.name;
            initHarakatButtons();
            resetVoiceSection();
            letterModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            if (isOnline) playSound('pop');
            appSpeak(currentLetter.name);
        }
        
        function closeModalHandler() {
            letterModal.style.display = 'none';
            document.body.style.overflow = '';
            currentHaraka = null;
            if (isRecording) stopRecording();
            stopVisuals();
            if (isOnline) playSound('pop');
        }
        
        function resetVoiceSection() {
            statusMessage.style.display = 'none';
            nextBtn.style.display = 'none';
            tryAgainBtn.style.display = 'none';
            recordBtn.style.display = 'none';
            recordIcon.textContent = 'ğŸ¤';
            recordText.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª';
            recordBtn.className = 'record-btn';
            instruction.textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø£Ø¹Ù„Ø§Ù‡ Ø«Ù… Ø³Ø¬Ù„ ØµÙˆØªÙƒ';
            audioWave.style.display = 'none';
            isRecording = false;
        }
        
        function handleHarakaClick(e, haraka) {
            const harakaBtns = document.querySelectorAll('.haraka-btn');
            harakaBtns.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            currentHaraka = haraka.symbol;
            
            const expected = currentLetter.pronunciations[currentHaraka];
            
            // ØªØ­Ø¯ÙŠØ¯ Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©
            let examples = [];
            if (haraka.symbol === 'Ù') {
                examples = [`"${expected}" (Ù…Ø«Ù„ Ø¨Ù)`, `"${currentLetter.letter}Ø§" (Ù…Ø«Ù„ Ø¨Ø§)`];
            } else if (haraka.symbol === 'Ù') {
                examples = [`"${expected}" (Ù…Ø«Ù„ Ø¨Ù)`, `"${currentLetter.letter}Ùˆ" (Ù…Ø«Ù„ Ø¨Ùˆ)`];
            } else if (haraka.symbol === 'Ù') {
                examples = [`"${expected}" (Ù…Ø«Ù„ Ø¨Ù)`, `"${currentLetter.letter}ÙŠ" (Ù…Ø«Ù„ Ø¨ÙŠ)`];
            }
            
            instruction.innerHTML = `Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Ù„:<br><strong>${examples.join(' Ø£Ùˆ ')}</strong>`;
            resetVoiceSection();
            recordBtn.style.display = 'flex';
            
            // Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ
            appSpeak(`Ø­Ø§ÙˆÙ„ Ù†Ø·Ù‚ ${currentLetter.name} Ù…Ø¹ ${haraka.name}`);
            setTimeout(() => {
                appSpeak(`ÙŠÙ…ÙƒÙ†Ùƒ Ù‚ÙˆÙ„ ${examples.join(' Ø£Ùˆ ')}`);
            }, 1500);
        }
        
        function playSound(type) {
            const sounds = {
                'correct': 'https://www.soundjay.com/buttons/sounds/button-09.mp3',
                'wrong': 'https://www.soundjay.com/buttons/sounds/button-10.mp3',
                'pop': 'https://www.soundjay.com/buttons/sounds/button-21.mp3'
            };
            try { new Audio(sounds[type]).play().catch(e => console.log(e)); } catch (e) { console.error(e); }
        }
        
        function speakInstruction(text) { appSpeak(text); }
        
        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = getRandomColor();
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(confetti);
                setTimeout(() => { confetti.remove(); }, 3000);
            }
        }
        
        function getRandomColor() {
            const colors = ['#4CAF50', '#8BC34A', '#FFC107', '#FF5722', '#2196F3', '#9C27B0'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // ========================================================
        // Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„
        // ========================================================
        
        function startRecording() {
            if (!currentHaraka) { 
                showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹');
                appSpeak('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹');
                return; 
            }
            
            if (isRecording) { 
                stopRecording(); 
                return; 
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª
            if (!speechRecognition) {
                showError("Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù…ØªØµÙØ­Ùƒ");
                return;
            }

            // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(() => {
                        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØª
                        try {
                            speechRecognition.start();
                            isRecording = true;
                            updateUIForRecording(true);
                            startVisuals();
                            showInfo("Ø£Ù†Ø§ Ø£Ø³ØªÙ…Ø¹ Ø¥Ù„ÙŠÙƒ Ø§Ù„Ø¢Ù†... ØªØ­Ø¯Ø« Ø¨ÙˆØ¶ÙˆØ­");
                        } catch (e) {
                            console.error(e);
                            showError("ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
                        }
                    })
                    .catch(err => {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø°Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†:', err);
                        showError("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†");
                        appSpeak("ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­");
                    });
            } else {
                // Ø¨Ø¯Ø¡ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† getUserMedia ØºÙŠØ± Ù…ØªÙˆÙØ±
                try {
                    speechRecognition.start();
                    isRecording = true;
                    updateUIForRecording(true);
                    startVisuals();
                } catch (e) {
                    console.error(e);
                    showError("ØªØ¹Ø°Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
                }
            }
        }
        
        function stopRecording() {
            if (speechRecognition && isRecording) {
                speechRecognition.stop();
            }
            isRecording = false;
            updateUIForRecording(false);
            stopVisuals();
        }

        function updateUIForRecording(recording) {
            if (recording) {
                recordIcon.textContent = 'ğŸ”´';
                recordText.textContent = 'Ø£ØªØ­Ø¯Ø« Ø§Ù„Ø¢Ù†...';
                recordBtn.className = 'record-btn recording';
                audioWave.style.display = 'flex';
                statusMessage.style.display = 'none';
            } else {
                recordIcon.textContent = 'ğŸ¤';
                recordText.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª';
                recordBtn.className = 'record-btn';
                audioWave.style.display = 'none';
            }
        }
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„Ø¨ØµØ±ÙŠØ©
        async function startVisuals() {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                microphone.connect(analyser);
                
                // Ù…Ø¤Ø«Ø±Ø§Øª Ø¨ØµØ±ÙŠØ© ÙÙ‚Ø·
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                function updateWave() {
                    if (!isRecording) return;
                    
                    analyser.getByteFrequencyData(dataArray);
                    
                    const waveSpans = document.querySelectorAll('.audio-wave span');
                    for (let i = 0; i < waveSpans.length; i++) {
                        const value = dataArray[i] || 0;
                        const height = 15 + (value / 255) * 30;
                        waveSpans[i].style.height = `${height}px`;
                    }
                    
                    requestAnimationFrame(updateWave);
                }
                
                updateWave();
            } catch (e) {
                console.warn("Visuals disabled:", e);
            }
        }

        function stopVisuals() {
            if (microphone && microphone.mediaStream) {
                microphone.mediaStream.getTracks().forEach(track => track.stop());
            }
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¬Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            const waveSpans = document.querySelectorAll('.audio-wave span');
            waveSpans.forEach(span => span.style.height = '15px');
        }
        
        function showError(message) {
            statusMessage.className = 'status-message error';
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            tryAgainBtn.style.display = 'inline-block';
            nextBtn.style.display = 'none';
            if (isOnline) playSound('wrong');
            appSpeak(message);
        }
        
        function showInfo(message) {
            statusMessage.className = 'status-message info';
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            tryAgainBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        }
        
        function handleCorrectPronunciation(spokenText) {
            // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
            completedHarakat[currentHaraka] = true;
            if (!storedPronunciations[currentLetter.letter]) {
                storedPronunciations[currentLetter.letter] = {};
            }
            storedPronunciations[currentLetter.letter][currentHaraka] = true;
            saveData();
            
            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„Ø°ÙŠ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            let feedback = "Ø£Ø­Ø³Ù†Øª! Ø§Ù„Ù†Ø·Ù‚ ØµØ­ÙŠØ­.";
            const cleanSpoken = normalizeArabic(spokenText);
            const baseLetter = normalizeArabic(currentLetter.letter);
            
            if (cleanSpoken.includes(baseLetter + 'Ø§') || cleanSpoken.includes('Ø§' + baseLetter)) {
                feedback = "Ù…Ù…ØªØ§Ø²! Ù†Ø·Ù‚ØªÙ‡Ø§ 'Ø¨Ø§' Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.";
            } else if (cleanSpoken.includes(baseLetter + 'Ùˆ') || cleanSpoken.includes('Ùˆ' + baseLetter)) {
                feedback = "Ù…Ù…ØªØ§Ø²! Ù†Ø·Ù‚ØªÙ‡Ø§ 'Ø¨Ùˆ' Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.";
            } else if (cleanSpoken.includes(baseLetter + 'ÙŠ') || cleanSpoken.includes('ÙŠ' + baseLetter)) {
                feedback = "Ù…Ù…ØªØ§Ø²! Ù†Ø·Ù‚ØªÙ‡Ø§ 'Ø¨ÙŠ' Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.";
            } else if (cleanSpoken === baseLetter) {
                feedback = "Ø¬ÙŠØ¯! Ù†Ø·Ù‚Øª Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø³Ø§ÙƒÙ† Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.";
            } else {
                feedback = "Ø£Ø­Ø³Ù†Øª! Ù†Ø·Ù‚Øª Ø§Ù„Ø­Ø±Ù Ù…Ø¹ Ø§Ù„Ø­Ø±ÙƒØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.";
            }
            
            statusMessage.className = 'status-message success';
            statusMessage.textContent = feedback;
            nextBtn.style.display = 'inline-block';
            tryAgainBtn.style.display = 'none';
            
            createConfetti();
            if (isOnline) playSound('correct');
            appSpeak("Ø£Ø­Ø³Ù†Øª! Ø§Ù„Ù†Ø·Ù‚ ØµØ­ÙŠØ­");
            
            initHarakatButtons();
            checkAllHarakatCompleted();
        }
        
        function handleIncorrectPronunciation() {
            statusMessage.className = 'status-message error';
            statusMessage.textContent = 'Ø§Ù„Ù†Ø·Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
            tryAgainBtn.style.display = 'inline-block';
            nextBtn.style.display = 'none';
            if (isOnline) playSound('wrong');
            appSpeak('Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
        }
        
        function checkAllHarakatCompleted() {
            if (Object.keys(completedHarakat).length === harakat.length) {
                statusMessage.textContent = 'Ù…Ù…ØªØ§Ø²! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø±Ù.';
                appSpeak('Ù…Ù…ØªØ§Ø² Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø±Ù');
            }
        }
        
        function nextHaraka() {
            const harakaBtns = document.querySelectorAll('.haraka-btn');
            const currentIndex = Array.from(harakaBtns).findIndex(btn => btn.dataset.haraka === currentHaraka);
            if (currentIndex < harakaBtns.length - 1) {
                // Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„ØªØ§Ù„ÙŠ
                harakaBtns[currentIndex + 1].click();
            } else {
                statusMessage.className = 'status-message success';
                statusMessage.textContent = 'ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø±Ù.';
                appSpeak('ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø­Ø±Ù');
                nextBtn.style.display = 'none';
            }
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', initApp);
        closeModal.addEventListener('click', closeModalHandler);
        letterModal.addEventListener('click', (e) => { if (e.target === letterModal) closeModalHandler(); });
        recordBtn.addEventListener('click', () => { if (isRecording) stopRecording(); else startRecording(); });
        nextBtn.addEventListener('click', nextHaraka);
        tryAgainBtn.addEventListener('click', () => {
            resetVoiceSection();
            const expected = currentLetter.pronunciations[currentHaraka];
            
            let examples = [];
            if (currentHaraka === 'Ù') {
                examples = [`"${expected}" (Ù…Ø«Ù„ Ø¨Ù)`, `"${currentLetter.letter}Ø§" (Ù…Ø«Ù„ Ø¨Ø§)`];
            } else if (currentHaraka === 'Ù') {
                examples = [`"${expected}" (Ù…Ø«Ù„ Ø¨Ù)`, `"${currentLetter.letter}Ùˆ" (Ù…Ø«Ù„ Ø¨Ùˆ)`];
            } else if (currentHaraka === 'Ù') {
                examples = [`"${expected}" (Ù…Ø«Ù„ Ø¨Ù)`, `"${currentLetter.letter}ÙŠ" (Ù…Ø«Ù„ Ø¨ÙŠ)`];
            }
            
            instruction.innerHTML = `Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙˆÙ‚Ù„:<br><strong>${examples.join(' Ø£Ùˆ ')}</strong>`;
            recordBtn.style.display = 'flex';
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ
            appSpeak(`Ø­Ø§ÙˆÙ„ Ù†Ø·Ù‚ ${examples.join(' Ø£Ùˆ ')}`);
        });
    </script>
</body>
</html>