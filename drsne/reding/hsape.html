
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø¹Ø¯ Ø§Ù„Ø§Ø¨ØªØ³Ø§Ù…Ø§Øª - Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ø¹Ø¯ Ù„Ù„Ø£Ø·ÙØ§Ù„</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§®</text></svg>">
    
    <style>
        :root {
            --primary: #6C63FF;
            --primary-dark: #564FC1;
            --secondary: #FFD166;
            --success: #06D6A0;
            --danger: #EF476F;
            --light: #F8F9FA;
            --dark: #212529;
            --background: #F0F4F8;
            --card-bg: #FFFFFF;
            --text: #2B2D42;
            --text-light: #8D99AE;
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            direction: rtl;
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex-grow: 1; /* Allow container to grow and push nav to bottom */
            display: flex; /* Make container a flex container too */
            flex-direction: column; /* Content inside container stacks vertically */
        }

        /* Screen transitions */
        .screen {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            flex-grow: 1; /* Allow screens to fill available space */
        }

        .screen.active {
            display: flex; /* Or block, depending on content */
            opacity: 1;
            transform: translateY(0);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 1.5rem;
            margin-top: 20px;
            text-align: center;
        }

        /* Start Screen */
        .start-screen {
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            text-align: center;
            padding-bottom: 80px; /* Space for nav bar */
        }

        .game-logo {
            font-size: 5rem;
            margin-bottom: 20px;
            color: var(--primary);
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .game-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--primary-dark);
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .game-subtitle {
            font-size: 1.2rem;
            color: var(--text-light);
            margin-bottom: 30px;
            max-width: 600px;
        }

        .start-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* Buttons */
        .btn {
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(108, 99, 255, 0.3);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background-color: #FFC233;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(255, 209, 102, 0.3);
        }

        .btn-lg {
            padding: 15px 40px;
            font-size: 1.3rem;
        }

        /* Level Select Screen */
        .level-select-screen {
            padding-bottom: 80px; /* Space for nav bar */
        }

        .section-title {
            font-size: 2rem;
            font-weight: 900;
            color: var(--primary-dark);
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            padding-bottom: 10px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 50%;
            transform: translateX(50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 2px;
        }

        .level-categories {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
        }

        .category-btn {
            padding: 10px 20px;
            border-radius: 50px;
            background-color: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-btn.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(108, 99, 255, 0.2);
        }

        .levels-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .level-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .level-card.locked {
            opacity: 0.7;
            filter: grayscale(0.5);
            cursor: not-allowed;
        }

        .level-card.locked::after {
            content: '\f023'; /* Font Awesome lock icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem; /* Larger lock icon */
            color: var(--text-light);
            background-color: rgba(255, 255, 255, 0.7); /* Slightly translucent background for visibility */
            border-radius: 50%;
            padding: 15px;
            z-index: 1;
        }

        .level-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-name {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--text);
            margin-bottom: 15px;
        }

        .level-difficulty {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .difficulty-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--text-light);
        }

        .difficulty-dot.active {
            background-color: var(--secondary);
        }

        .level-description {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .level-rewards {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .reward {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .reward i {
            color: var(--secondary);
        }

        .stars-earned {
            display: flex;
            gap: 5px;
            margin-top: 15px;
        }

        .star {
            color: var(--text-light);
        }

        .star.earned {
            color: var(--secondary);
        }

        /* Game Screen */
        .game-screen {
            padding-bottom: 80px; /* Space for nav bar */
            flex-direction: column;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 15px; /* Gap between elements on wrap */
        }
        .game-header .btn {
            flex-shrink: 0; /* Prevent back button from shrinking too much */
        }
        .game-info {
            display: flex;
            gap: 10px; /* Reduced gap */
            flex-wrap: wrap; /* Allow wrapping info boxes */
            justify-content: flex-end; /* Align to end if wrapped */
            flex-grow: 1; /* Allow info boxes to take available space */
        }
        .info-box {
            background-color: white;
            border-radius: 10px;
            padding: 8px 12px; /* Smaller padding */
            display: flex;
            align-items: center;
            gap: 6px; /* Smaller gap */
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            font-weight: 700;
            color: var(--text);
            font-size: 0.9rem; /* Smaller font size */
        }

        .game-info .info-box i {
            font-size: 1rem; /* Smaller icon size */
        }

        @media (max-width: 480px) {
            .game-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .game-info {
                justify-content: flex-start;
                width: 100%;
            }
            .info-box {
                flex-grow: 1; /* Allow info boxes to grow to fill space */
                justify-content: center;
            }
        }


        .game-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
            flex-grow: 1; /* Pushes nav bar down */
        }

        .question-text {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 30px;
            text-align: center;
        }

        .items-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            max-width: 600px;
            min-height: 200px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .items-container.addition-layout,
        .items-container.subtraction-layout,
        .items-container.comparison-layout,
        .items-container.odd-even-layout { /* Added odd-even layout */
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .items-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            min-width: 120px; /* Ensure groups have some width */
            padding: 10px;
            border: 2px dashed var(--primary);
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            min-height: 100px;
            flex-grow: 1; /* Allow groups to grow */
        }

        .math-operator {
            font-size: 4rem;
            font-weight: 900;
            color: var(--primary);
            margin: 0 10px;
        }
        
        .emoji-item {
            font-size: 3.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }

        .emoji-item.removed {
            opacity: 0.3;
            text-decoration: line-through;
            transform: scale(0.8);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .emoji-item:hover {
            transform: scale(1.1) rotate(10deg);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            max-width: 500px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .options-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .option-btn {
            aspect-ratio: 1/1;
            border-radius: 15px;
            background-color: white;
            border: 3px solid var(--primary);
            color: var(--primary);
            font-size: 2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .option-btn:hover:not(.disabled) {
            background-color: var(--primary);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(108, 99, 255, 0.3);
        }

        .option-btn.correct {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
            transform: scale(1.05);
        }

        .option-btn.wrong {
            background-color: var(--danger);
            border-color: var(--danger);
            color: white;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }

        .feedback-container {
            min-height: 60px;
            margin-bottom: 20px;
            text-align: center;
        }

        .feedback-message {
            font-size: 1.3rem;
            font-weight: 700;
            padding: 10px 20px;
            border-radius: 50px;
            display: inline-block;
        }

        .feedback-message.correct {
            background-color: rgba(6, 214, 160, 0.1);
            color: var(--success);
        }

        .feedback-message.wrong {
            background-color: rgba(239, 71, 111, 0.1);
            color: var(--danger);
        }

        .next-btn {
            margin-top: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .next-btn.show {
            opacity: 1;
            transform: translateY(0);
        }

        .progress-container {
            width: 100%;
            max-width: 500px;
            background-color: #e0e0e0;
            border-radius: 10px;
            height: 10px;
            margin-top: 30px;
            margin-bottom: 20px; /* Added margin */
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Next Stage Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .next-stage-modal {
            background: linear-gradient(135deg, var(--card-bg), #f9f9f9);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            transform: scale(0.8);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.show .next-stage-modal {
            transform: scale(1);
            opacity: 1;
        }

        .modal-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .modal-title {
            font-size: 2rem;
            font-weight: 900;
            color: var(--primary-dark);
            margin-bottom: 15px;
        }

        .modal-subtitle {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 25px;
        }

        .modal-progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e0e0e0;
            border-radius: 6px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .modal-progress-fill {
            height: 100%;
            background: linear-gradient(to right, var(--success), var(--secondary));
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .modal-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .modal-stat-item {
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-stat-item i {
            color: var(--secondary);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .modal-buttons .btn {
            flex-grow: 1;
            min-width: 150px;
        }


        /* Level Complete Screen */
        .level-complete-screen {
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            text-align: center;
            padding-bottom: 80px; /* Space for nav bar */
        }

        .celebration-emoji {
            font-size: 5rem;
            margin-bottom: 20px;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-20px); }
        }

        .complete-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--success);
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .complete-subtitle {
            font-size: 1.2rem;
            color: var(--text-light);
            margin-bottom: 30px;
            max-width: 600px;
        }

        .stars-earned-large {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .star-large {
            font-size: 2.5rem;
            color: #e0e0e0;
        }

        .star-large.earned {
            color: var(--secondary);
            animation: starPop 0.5s ease-out;
        }

        @keyframes starPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .reward-container {
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
        }

        .reward-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .reward-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .reward-item:last-child {
            border-bottom: none;
        }

        .reward-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .reward-value {
            font-weight: 700;
            color: var(--success);
        }

        /* Shop Screen */
        .shop-screen {
            padding-bottom: 80px; /* Space for nav bar */
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .shop-item {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            text-align: center;
            border: 2px solid transparent;
        }

        .shop-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .shop-item-image {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .shop-item-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text);
        }

        .shop-item-price {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 1.1rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }

        .shop-item-description {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .shop-item-btn {
            width: 100%;
            padding: 10px;
            border-radius: 50px;
            background-color: var(--primary);
            color: white;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shop-item-btn:hover {
            background-color: var(--primary-dark);
        }

        .shop-item-btn.owned {
            background-color: var(--success);
        }

        .shop-item-btn.not-enough {
            background-color: var(--danger);
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .shop-item-btn.applied {
            background-color: var(--primary-dark);
            cursor: default;
            pointer-events: none;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Daily Challenge Screen */
        .daily-challenge-screen {
            padding-bottom: 80px; /* Space for nav bar */
        }

        .challenge-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
            text-align: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .challenge-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .challenge-description {
            color: var(--text-light);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .challenge-progress {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .challenge-progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .challenge-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            color: var(--text-light);
        }

        .challenge-reward {
            background-color: rgba(255, 209, 102, 0.1);
            border: 2px dashed var(--secondary);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .challenge-reward-title {
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 10px;
        }

        /* Settings Screen */
        .settings-screen {
            padding-bottom: 80px; /* Space for nav bar */
        }

        .settings-card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 30px;
        }

        .settings-group {
            margin-bottom: 30px;
        }

        .settings-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 700;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Profile Screen */
        .profile-screen {
            padding-bottom: 80px; /* Space for nav bar */
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            border: 3px solid var(--secondary);
            flex-shrink: 0; /* Prevent shrinking */
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--text);
            margin-bottom: 5px;
        }

        .profile-level {
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .profile-progress {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .profile-progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Nav Bar */
        .nav-bar {
            position: sticky; /* Changed to sticky for better layout control */
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
            margin-top: auto; /* Push to bottom */
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-light);
            font-size: 0.8rem;
            transition: all 0.3s ease;
            flex: 1; /* Distribute space evenly */
        }

        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .nav-item.active {
            color: var(--primary);
            transform: translateY(-5px);
        }

        /* Special Effects */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: var(--primary);
            opacity: 0;
            z-index: 999;
            animation: confetti-fall 3s ease-in-out forwards;
            border-radius: 50%; /* Make confetti round */
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .game-subtitle {
                font-size: 1rem;
            }
            
            .question-text {
                font-size: 1.5rem;
            }
            
            .emoji-item {
                font-size: 2.5rem;
            }
            
            .option-btn {
                font-size: 1.5rem;
            }
            
            .complete-title {
                font-size: 2rem;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar {
                margin-bottom: 15px;
            }
        }

        @media (max-width: 480px) {
            .options-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px; /* Smaller gap for mobile options */
            }
            
            .btn-lg {
                padding: 12px 25px;
                font-size: 1.1rem;
            }
            
            .level-name {
                font-size: 1.2rem;
            }
            
            .complete-title {
                font-size: 1.8rem;
            }

            .nav-item {
                font-size: 0.7rem;
            }
            .nav-item i {
                font-size: 1.2rem;
            }

            .modal-title {
                font-size: 1.5rem;
            }
            .modal-subtitle {
                font-size: 0.9rem;
            }
            .modal-icon {
                font-size: 3rem;
            }
            /* Specific mobile size adjustment for option buttons */
            .option-btn {
                font-size: 1.1rem; /* Reduced from 1.2rem */
                padding: 6px; /* Further adjusted padding */
                border-radius: 10px; /* Slightly smaller border radius */
            }
            .emoji-item {
                font-size: 1.8rem; /* Reduced from 2.2rem */
            }
            .items-container {
                min-height: unset; /* Allow it to be more flexible */
                gap: 10px; /* Slightly smaller gap */
            }
            .items-group {
                min-height: unset; /* Allow it to be more flexible */
                gap: 8px; /* Slightly smaller gap */
            }
            .math-operator {
                font-size: 3rem; /* Smaller operator */
            }
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div class="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©...</div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <div class="start-screen container screen">
        <div class="game-logo">ğŸ§®</div>
        <h1 class="game-title">Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ø¹Ø¯ Ø§Ù„Ù…Ù…ØªØ¹Ø©</h1>
        <p class="game-subtitle">ØªØ¹Ù„Ù… Ø§Ù„Ø¹Ø¯ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù…ØªØ¹Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª! Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ Ù„Ù„Ù…ØºØ§Ù…Ø±Ø©ØŸ</p>
        
        <div class="start-buttons">
            <button id="start-game-btn" class="btn btn-primary btn-lg">
                <i class="fas fa-play"></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨
            </button>
            <button id="daily-challenge-btn" class="btn btn-secondary btn-lg">
                <i class="fas fa-calendar-star"></i> Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ
            </button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ -->
    <div class="level-select-screen container screen">
        <h2 class="section-title">Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰</h2>
        
        <div class="level-categories">
            <button class="category-btn active" data-category="all">Ø§Ù„ÙƒÙ„</button>
            <button class="category-btn" data-category="count">Ø¹Ø¯</button>
            <button class="category-btn" data-category="addition">Ø¬Ù…Ø¹</button>
            <button class="category-btn" data-category="subtraction">Ø·Ø±Ø­</button>
            <button class="category-btn" data-category="comparison">Ù…Ù‚Ø§Ø±Ù†Ø©</button>
            <button class="category-btn" data-category="odd_even">ÙØ±Ø¯ÙŠ/Ø²ÙˆØ¬ÙŠ</button>
        </div>
        
        <div class="levels-container">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨ -->
    <div class="game-screen container screen">
        <div class="game-header">
            <button id="back-to-levels-btn" class="btn btn-secondary">
                <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
            </button>
            
            <div class="game-info">
                <div class="info-box">
                    <i class="fas fa-star"></i>
                    <span id="current-score">0</span>
                </div>
                <div class="info-box">
                    <i class="fas fa-trophy"></i>
                    <span id="current-level-name">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</span>
                    <span id="current-stage-display"> (Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1/10)</span>
                </div>
                <div class="info-box">
                    <i class="fas fa-gem"></i>
                    <span id="current-gems">0</span>
                </div>
            </div>
        </div>
        
        <div class="game-content">
            <div class="progress-container">
                <div class="progress-bar" id="level-progress"></div>
            </div>
            
            <h3 class="question-text" id="question-text"></h3>
            
            <div class="items-container" id="items-container">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
            </div>
            
            <div class="options-grid" id="options-grid">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
            </div>
            
            <div class="feedback-container">
                <div class="feedback-message" id="feedback-message"></div>
            </div>
            
            <button id="next-btn" class="btn btn-primary next-btn">
                <i class="fas fa-arrow-left"></i> Ø§Ù„ØªØ§Ù„ÙŠ
            </button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© (Modal) -->
    <div class="modal-overlay" id="next-stage-modal-overlay">
        <div class="next-stage-modal">
            <div class="modal-icon" id="modal-icon">âœ¨</div>
            <h3 class="modal-title" id="modal-title">Ø£Ø­Ø³Ù†Øª!</h3>
            <p class="modal-subtitle" id="modal-subtitle">Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ!</p>
            
            <div class="modal-progress-bar">
                <div class="modal-progress-fill" id="modal-progress-fill"></div>
            </div>
            
            <div class="modal-stats">
                <div class="modal-stat-item">
                    <i class="fas fa-check-circle"></i>
                    <span id="modal-correct-answers">0/0</span>
                </div>
                <div class="modal-stat-item">
                    <i class="fas fa-trophy"></i>
                    <span id="modal-current-stage">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1/10</span>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button id="modal-continue-btn" class="btn btn-primary btn-lg">
                    <i class="fas fa-arrow-left"></i> Ø£ÙƒÙ…Ù„ Ø§Ù„Ù„Ø¹Ø¨
                </button>
                <button id="modal-back-to-levels-btn" class="btn btn-secondary">
                    <i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
                </button>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ -->
    <div class="level-complete-screen container screen">
        <div class="celebration-emoji">ğŸ‰</div>
        <h2 class="complete-title">Ø£Ø­Ø³Ù†Øª! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰!</h2>
        <p class="complete-subtitle">Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ <span id="earned-points">0</span> Ù†Ù‚Ø·Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</p>
        
        <div class="stars-earned-large">
            <div class="star-large" id="star-1"><i class="fas fa-star"></i></div>
            <div class="star-large" id="star-2"><i class="fas fa-star"></i></div>
            <div class="star-large" id="star-3"><i class="fas fa-star"></i></div>
        </div>
        
        <div class="reward-container">
            <h3 class="reward-title">Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</h3>
            <div class="reward-item">
                <div class="reward-name">
                    <i class="fas fa-star"></i>
                    <span>Ø§Ù„Ù†Ù‚Ø§Ø·</span>
                </div>
                <div class="reward-value" id="complete-screen-points">+50</div>
            </div>
            <div class="reward-item">
                <div class="reward-name">
                    <i class="fas fa-gem"></i>
                    <span>Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±</span>
                </div>
                <div class="reward-value" id="complete-screen-gems">+5</div>
            </div>
            <div class="reward-item" id="next-level-reward-item">
                <div class="reward-name">
                    <i class="fas fa-trophy"></i>
                    <span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</span>
                </div>
                <div class="reward-value">Ù…ÙØªÙˆØ­!</div>
            </div>
        </div>
        
        <div class="start-buttons">
            <button id="next-level-complete-btn" class="btn btn-primary btn-lg">
                <i class="fas fa-arrow-circle-right"></i> Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ
            </button>
            <button id="back-to-levels-complete-btn" class="btn btn-secondary btn-lg">
                <i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
            </button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØªØ¬Ø± -->
    <div class="shop-screen container screen">
        <h2 class="section-title">Ù…ØªØ¬Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
        <p class="game-subtitle">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬ÙˆØ§Ù‡Ø± Ø§Ù„ØªÙŠ Ø¬Ù…Ø¹ØªÙ‡Ø§ Ù„Ø´Ø±Ø§Ø¡ Ø´Ø®ØµÙŠØ§Øª ÙˆÙ…ÙˆØ§Ø¶ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©</p>
        <div class="info-box" style="justify-content: center; margin-bottom: 20px;">
            <i class="fas fa-gem"></i>
            <span id="shop-current-gems" style="font-size: 1.2rem; font-weight: bold;">0</span>
        </div>
        
        <div class="shop-items">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
    <div class="daily-challenge-screen container screen">
        <h2 class="section-title">Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2>
        
        <div class="challenge-card">
            <h3 class="challenge-title" id="daily-challenge-title">ØªØ­Ø¯ÙŠ Ø§Ù„Ø¹Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹</h3>
            <p class="challenge-description" id="daily-challenge-desc">
                Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ 10 Ø£Ø³Ø¦Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø®Ù„Ø§Ù„ 3 Ø¯Ù‚Ø§Ø¦Ù‚ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ£Ø© Ø®Ø§ØµØ©!
            </p>
            
            <div class="challenge-progress">
                <div class="challenge-progress-bar" id="challenge-progress"></div>
            </div>
            
            <div class="challenge-stats">
                <span id="challenge-completed">0/10 Ù…ÙƒØªÙ…Ù„</span>
                <span id="challenge-time">03:00 Ù…ØªØ¨Ù‚ÙŠ</span>
            </div>
            
            <div class="challenge-reward">
                <div class="challenge-reward-title">Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</div>
                <div class="reward-item">
                    <div class="reward-name">
                        <i class="fas fa-gem"></i>
                        <span>10 Ø¬ÙˆØ§Ù‡Ø±</span>
                    </div>
                </div>
            </div>
            
            <button id="start-challenge-btn" class="btn btn-primary btn-lg">
                <i class="fas fa-play"></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ
            </button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div class="settings-screen container screen">
        <h2 class="section-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
        
        <div class="settings-card">
            <div class="settings-group">
                <h3 class="settings-title"><i class="fas fa-volume-up"></i> Ø§Ù„ØµÙˆØª</h3>
                <div class="settings-option">
                    <span class="settings-label">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©</span>
                    <label class="switch">
                        <input type="checkbox" id="sound-effects-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-option">
                    <span class="settings-label">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰</span>
                    <label class="switch">
                        <input type="checkbox" id="background-music-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-group">
                <h3 class="settings-title"><i class="fas fa-gamepad"></i> Ø§Ù„Ù„Ø¹Ø¨Ø©</h3>
                <div class="settings-option">
                    <span class="settings-label">ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠ</span>
                    <label class="switch">
                        <input type="checkbox" id="challenge-mode-toggle" disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-option">
                    <span class="settings-label">Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²</span>
                    <label class="switch">
                        <input type="checkbox" id="vibration-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="settings-group">
                <h3 class="settings-title"><i class="fas fa-user"></i> Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
                <div class="settings-option">
                    <span class="settings-label">Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                    <button id="reset-data-btn" class="btn btn-danger">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                </div>
                <div class="settings-option">
                    <span class="settings-label">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                    <button id="logout-btn" class="btn btn-secondary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ -->
    <div class="profile-screen container screen">
        <h2 class="section-title">Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</h2>
        
        <div class="profile-header">
            <div class="profile-avatar" id="profile-avatar">A</div>
            <div class="profile-info">
                <h3 class="profile-name" id="profile-name">Ø£Ø­Ù…Ø¯</h3>
                <p class="profile-level">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ <span id="profile-level">5</span></p>
                <div class="profile-progress">
                    <div class="profile-progress-bar" id="profile-progress-bar" style="width: 60%"></div>
                </div>
                <p><span id="profile-current-xp">600</span>/<span id="profile-next-xp">1000</span> Ù†Ù‚Ø·Ø© Ø®Ø¨Ø±Ø©</p>
            </div>
        </div>
        
        <div class="profile-stats">
            <div class="stat-card">
                <div class="stat-value" id="total-points">1,250</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-levels">12</div>
                <div class="stat-label">Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-stars">28</div>
                <div class="stat-label">Ø§Ù„Ù†Ø¬ÙˆÙ…</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-gems">45</div>
                <div class="stat-label">Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±</div>
            </div>
        </div>
        
        <button id="edit-profile-btn" class="btn btn-primary btn-lg">
            <i class="fas fa-user-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
        </button>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… -->
    <div class="nav-bar">
        <a href="#" class="nav-item active" id="nav-home">
            <i class="fas fa-home"></i>
            <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </a>
        <a href="#" class="nav-item" id="nav-levels">
            <i class="fas fa-gamepad"></i>
            <span>Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</span>
        </a>
        <a href="#" class="nav-item" id="nav-shop">
            <i class="fas fa-shopping-bag"></i>
            <span>Ø§Ù„Ù…ØªØ¬Ø±</span>
        </a>
        <a href="#" class="nav-item" id="nav-profile">
            <i class="fas fa-user"></i>
            <span>Ù…Ù„ÙÙŠ</span>
        </a>
        <a href="#" class="nav-item" id="nav-settings">
            <i class="fas fa-cog"></i>
            <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
        </a>
    </div>

    <!-- Ù…ÙƒØªØ¨Ø§Øª JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <!-- Moment.js is included but not actively used for new features -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ar.min.js"></script>

    <script>
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        document.addEventListener('DOMContentLoaded', () => {
            // Ø¹Ù†Ø§ØµØ± DOM
            const loadingScreen = document.querySelector('.loading-screen');
            const startScreen = document.querySelector('.start-screen');
            const levelSelectScreen = document.querySelector('.level-select-screen');
            const gameScreen = document.querySelector('.game-screen');
            const nextStageModalOverlay = document.getElementById('next-stage-modal-overlay');
            const nextStageModal = nextStageModalOverlay.querySelector('.next-stage-modal');
            const levelCompleteScreen = document.querySelector('.level-complete-screen');
            const shopScreen = document.querySelector('.shop-screen');
            const dailyChallengeScreen = document.querySelector('.daily-challenge-screen');
            const settingsScreen = document.querySelector('.settings-screen');
            const profileScreen = document.querySelector('.profile-screen');
            
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
            const navHome = document.getElementById('nav-home');
            const navLevels = document.getElementById('nav-levels');
            const navShop = document.getElementById('nav-shop');
            const navProfile = document.getElementById('nav-profile');
            const navSettings = document.getElementById('nav-settings'); // New
            
            // Ø£Ø²Ø±Ø§Ø±/Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰
            const startGameBtn = document.getElementById('start-game-btn');
            const dailyChallengeBtn = document.getElementById('daily-challenge-btn');
            const backToLevelsBtn = document.getElementById('back-to-levels-btn');
            const nextBtn = document.getElementById('next-btn');
            const modalContinueBtn = document.getElementById('modal-continue-btn'); // New
            const modalBackToLevelsBtn = document.getElementById('modal-back-to-levels-btn'); // New
            const nextLevelCompleteBtn = document.getElementById('next-level-complete-btn');
            const backToLevelsCompleteBtn = document.getElementById('back-to-levels-complete-btn');
            const startChallengeBtn = document.getElementById('start-challenge-btn');
            const resetDataBtn = document.getElementById('reset-data-btn'); // New
            const logoutBtn = document.getElementById('logout-btn'); // Existing, but add functionality
            const editProfileBtn = document.getElementById('edit-profile-btn'); // New
            
            // Ù…ÙØ§ØªÙŠØ­ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØª
            const soundEffectsToggle = document.getElementById('sound-effects-toggle');
            const backgroundMusicToggle = document.getElementById('background-music-toggle');
            const vibrationToggle = document.getElementById('vibration-toggle');
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
            const gameData = {
                player: {
                    name: "Ø£Ø­Ù…Ø¯",
                    avatar: "A",
                    level: 1, // Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø§Ø¹Ø¨
                    xp: 0,
                    nextLevelXp: 1000,
                    points: 0, // Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
                    gems: 10, // Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ù…ÙŠØ²Ø©
                    unlockedLevels: [1], // Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
                    stars: {}, // { levelId: starsCount }
                    inventory: [], // Ù…Ø¹Ø±ÙØ§Øª Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„ØªÙŠ ØªÙ… Ø´Ø±Ø§Ø¤Ù‡Ø§
                    activeAvatar: null, // Ù…Ø¹Ø±Ù Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø²ÙŠØ© Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§
                    activeBackground: null, // Ù…Ø¹Ø±Ù Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§
                    settings: {
                        soundEffects: true,
                        backgroundMusic: true,
                        vibration: true
                    }
                },
                levels: [
                    // Count Levels
                    {
                        id: 1, name: "Ø§Ù„Ø¹Ø¯ Ø§Ù„Ø¨Ø³ÙŠØ·", category: "easy", type: "count", description: "Ø¹Ø¯ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙ‚Ø· (Ù…Ø¹ Ø£Ø´ÙƒØ§Ù„ Ø£Ø®Ø±Ù‰).",
                        emojis: ['ğŸ', 'â­', 'ğŸˆ'], allEmojis: ['ğŸ', 'â­', 'ğŸˆ', 'ğŸ’™', 'ğŸŸ¢', 'ğŸŸ¥', 'ğŸŸ¡', 'ğŸ”¶'], minCount: 2, maxCount: 5, numDistractors: 2, questions: 10, rewardPoints: 50, rewardGems: 1, unlocked: true
                    },
                    {
                        id: 2, name: "Ø¹Ø¯ Ø§Ù„ÙÙˆØ§ÙƒÙ‡", category: "easy", type: "count", description: "Ø¹Ø¯ Ø§Ù„ÙÙˆØ§ÙƒÙ‡ ÙˆØ§Ù„Ø®Ø¶Ø±ÙˆØ§Øª Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø© (Ù…Ø¹ Ù…Ø´ØªØªØ§Øª).",
                        emojis: ['ğŸ‡', 'ğŸ‹', 'ğŸ¥•', 'ğŸ“'], allEmojis: ['ğŸ‡', 'ğŸ‹', 'ğŸ¥•', 'ğŸ“', 'ğŸ¥‘', 'ğŸ¥¦', 'ğŸŒ', 'ğŸ¥', 'ğŸ’'], minCount: 3, maxCount: 6, numDistractors: 3, questions: 10, rewardPoints: 60, rewardGems: 1, unlocked: false
                    },
                    // Addition Levels
                    {
                        id: 3, name: "Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ø´ÙƒØ§Ù„", category: "medium", type: "addition", description: "Ø§Ø¬Ù…Ø¹ Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ù„ØªØ¬Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹.",
                        emojis: ['ğŸ¶', 'ğŸ±', 'ğŸ°'], minCount: 4, maxCount: 8, questions: 10, rewardPoints: 70, rewardGems: 2, unlocked: false // min/max refer to total sum
                    },
                    {
                        id: 4, name: "Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø·Ø¹Ù…Ø©", category: "medium", type: "addition", description: "Ø§Ø¬Ù…Ø¹ Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„Ù„Ø°ÙŠØ°Ø©.",
                        emojis: ['ğŸ•', 'ğŸ”', 'ğŸ©'], minCount: 5, maxCount: 10, questions: 10, rewardPoints: 80, rewardGems: 2, unlocked: false // min/max refer to total sum
                    },
                    // Subtraction Levels
                    {
                        id: 5, name: "Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø´ÙƒØ§Ù„", category: "medium", type: "subtraction", description: "Ø£Ø²Ù„ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ ÙˆØ¹Ø¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ.",
                        emojis: ['âš½', 'ğŸ€', 'ğŸˆ'], minCount: 5, maxCount: 8, questions: 10, rewardPoints: 90, rewardGems: 3, unlocked: false
                    },
                    {
                        id: 6, name: "Ø·Ø±Ø­ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª", category: "medium", type: "subtraction", description: "Ø§ÙƒØªØ´Ù Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©.",
                        emojis: ['ğŸš—', 'ğŸš•', 'ğŸšŒ'], minCount: 6, maxCount: 9, questions: 10, rewardPoints: 100, rewardGems: 3, unlocked: false
                    },
                    // Comparison Levels
                    {
                        id: 7, name: "Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø´ÙƒØ§Ù„", category: "hard", type: "comparison", description: "Ù‚Ø§Ø±Ù† Ø¨ÙŠÙ† Ù…Ø¬Ù…ÙˆØ¹ØªÙŠÙ† Ù…Ù† Ø§Ù„Ø£Ø´ÙƒØ§Ù„ (Ø£ÙƒØ«Ø±ØŒ Ø£Ù‚Ù„ØŒ ÙŠØ³Ø§ÙˆÙŠ).",
                        emojis: ['ğŸŒ³', 'ğŸŒº', 'â˜€ï¸'], minCount: 4, maxCount: 8, questions: 10, rewardPoints: 110, rewardGems: 4, unlocked: false
                    },
                    {
                        id: 8, name: "Ø§Ù„ÙØ¶Ø§Ø¡ ÙˆØ§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©", category: "hard", type: "comparison", description: "Ù‚Ø§Ø±Ù† Ø¨ÙŠÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ ÙÙŠ Ø§Ù„ÙØ¶Ø§Ø¡.",
                        emojis: ['ğŸš€', 'ğŸŒŒ', 'ğŸŒ '], minCount: 5, maxCount: 9, questions: 10, rewardPoints: 120, rewardGems: 4, unlocked: false
                    },
                    // Odd/Even Levels
                    {
                        id: 9, name: "ÙØ±Ø¯ÙŠ Ø£Ù… Ø²ÙˆØ¬ÙŠØŸ", category: "hard", type: "odd_even", description: "Ø­Ø¯Ø¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ ÙØ±Ø¯ÙŠØ§Ù‹ Ø£Ù… Ø²ÙˆØ¬ÙŠØ§Ù‹.",
                        emojis: ['ğŸŒŸ', 'ğŸŒˆ', 'ğŸ’¡'], minCount: 3, maxCount: 10, questions: 10, rewardPoints: 130, rewardGems: 5, unlocked: false
                    },
                    // Mixed Challenge Levels
                    {
                        id: 10, name: "ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…", category: "hard", type: "mixed", description: "Ù…Ø²ÙŠØ¬ Ù…Ù† ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø¹Ø¯ØŒ Ø§Ù„Ø¬Ù…Ø¹ØŒ ÙˆØ§Ù„Ø·Ø±Ø­.",
                        emojis: ['ğŸ”¢', 'ğŸ§®', 'ğŸ“ˆ', 'ğŸ“‰'], minCount: 7, maxCount: 12, questions: 10, rewardPoints: 140, rewardGems: 5, unlocked: false
                    },
                    {
                        id: 11, name: "Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ", category: "hard", type: "mixed", description: "Ø§Ø®ØªØ¨Ø± ÙƒÙ„ Ù…Ù‡Ø§Ø±Ø§ØªÙƒ ÙÙŠ ØªØ­Ø¯ÙŠ Ø´Ø§Ù…Ù„ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹).",
                        emojis: ['ğŸ†', 'ğŸ…', 'ğŸ¥‡', 'ğŸ‘‘', 'ğŸ’', 'âœ¨', 'ğŸ‰'], minCount: 8, maxCount: 15, questions: 10, rewardPoints: 150, rewardGems: 5, unlocked: false
                    }
                ],
                shopItems: [
                    { id: 1, name: "Ø´Ø®ØµÙŠØ© Ø±Ø§Ø¦Ø¯ ÙØ¶Ø§Ø¡", description: "Ø´Ø®ØµÙŠØ© Ø±Ø§Ø¦Ø¯ ÙØ¶Ø§Ø¡ Ù…Ù…ÙŠØ²Ø©", price: 20, type: "avatar", emoji: "ğŸ‘¨â€ğŸš€", applied: false },
                    { id: 2, name: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ¨", description: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ø­ØªØ±Ù", price: 25, type: "avatar", emoji: "ğŸ‘¨â€âš•ï¸", applied: false },
                    { id: 3, name: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø´Ø±Ø·ÙŠ", description: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø´Ø±Ø·ÙŠ Ø§Ù„Ø´Ø¬Ø§Ø¹", price: 25, type: "avatar", emoji: "ğŸ‘®", applied: false },
                    { id: 4, name: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø³Ø§Ø­Ø±", description: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø³Ø§Ø­Ø± Ø§Ù„ØºØ§Ù…Ø¶", price: 30, type: "avatar", emoji: "ğŸ§™", applied: false },
                    { id: 5, name: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ±Ø©", description: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø£Ù…ÙŠØ±Ø© Ø§Ù„Ø¬Ù…ÙŠÙ„Ø©", price: 30, type: "avatar", emoji: "ğŸ‘¸", applied: false },
                    { id: 6, name: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ù…Ù‚Ø§ØªÙ„", description: "Ø´Ø®ØµÙŠØ© Ù…Ù‚Ø§ØªÙ„ Ù‚ÙˆÙŠ", price: 35, type: "avatar", emoji: "ğŸ¥·", applied: false },
                    { id: 7, name: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…", description: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ", price: 35, type: "avatar", emoji: "ğŸ§‘â€ğŸ”¬", applied: false },
                    { id: 8, name: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø·Ø¨Ø§Ø®", description: "Ø´Ø®ØµÙŠØ© Ø·Ø¨Ø§Ø® Ù…Ø§Ù‡Ø±", price: 32, type: "avatar", emoji: "ğŸ‘¨â€ğŸ³", applied: false },
                    { id: 9, name: "Ø´Ø®ØµÙŠØ© Ø§Ù„Ø±ÙˆØ¨ÙˆØª", description: "Ø´Ø®ØµÙŠØ© Ø±ÙˆØ¨ÙˆØª Ø°ÙƒÙŠØ©", price: 40, type: "avatar", emoji: "ğŸ¤–", applied: false },
                    { id: 10, name: "Ø´Ø®ØµÙŠØ© Ø§Ù„ÙÙ†Ø§Ù†", description: "Ø´Ø®ØµÙŠØ© ÙÙ†Ø§Ù† Ù…Ø¨Ø¯Ø¹", price: 40, type: "avatar", emoji: "ğŸ§‘â€ğŸ¨", applied: false },

                    { id: 11, name: "Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ§Ø¨Ø©", description: "Ø®Ù„ÙÙŠØ© ØºØ§Ø¨Ø© Ø¬Ù…ÙŠÙ„Ø© Ù„Ù„Ø¹Ø¨Ø©", price: 30, type: "background", emoji: "ğŸŒ²", applied: false },
                    { id: 12, name: "Ø®Ù„ÙÙŠØ© Ø§Ù„ÙØ¶Ø§Ø¡", description: "Ø®Ù„ÙÙŠØ© ÙØ¶Ø§Ø¦ÙŠØ© Ø±Ø§Ø¦Ø¹Ø©", price: 35, type: "background", emoji: "ğŸš€", applied: false },
                    { id: 13, name: "Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø­Ø±", description: "Ø®Ù„ÙÙŠØ© ØªØ­Øª Ø§Ù„Ù…Ø§Ø¡ Ù…Ø¹ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ", price: 35, type: "background", emoji: "ğŸŒŠ", applied: false },
                    { id: 14, name: "Ø®Ù„ÙÙŠØ© Ø§Ù„ØµØ­Ø±Ø§Ø¡", description: "Ø®Ù„ÙÙŠØ© ØµØ­Ø±Ø§ÙˆÙŠØ© Ù‡Ø§Ø¯Ø¦Ø©", price: 40, type: "background", emoji: "ğŸœï¸", applied: false },
                    { id: 15, name: "Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©", description: "Ø®Ù„ÙÙŠØ© Ù…Ø¯ÙŠÙ†Ø© ØµØ§Ø®Ø¨Ø©", price: 40, type: "background", emoji: "ğŸ™ï¸", applied: false },
                    { id: 16, name: "Ø®Ù„ÙÙŠØ© Ø§Ù„Ø±Ø¨ÙŠØ¹", description: "Ø®Ù„ÙÙŠØ© Ø²Ù‡ÙˆØ± ÙˆØ£Ù„ÙˆØ§Ù† Ø§Ù„Ø±Ø¨ÙŠØ¹", price: 30, type: "background", emoji: "ğŸŒ¸", applied: false },
                    { id: 17, name: "Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´ØªØ§Ø¡", description: "Ø®Ù„ÙÙŠØ© Ø«Ù„ÙˆØ¬ ÙˆØ£Ø¬ÙˆØ§Ø¡ Ø§Ù„Ø´ØªØ§Ø¡", price: 30, type: "background", emoji: "â„ï¸", applied: false },
                    { id: 18, name: "Ø®Ù„ÙÙŠØ© Ù‚ÙˆØ³ Ù‚Ø²Ø­", description: "Ø®Ù„ÙÙŠØ© Ù…Ù„ÙˆÙ†Ø© Ø¨Ø£Ù„ÙˆØ§Ù† Ù‚ÙˆØ³ Ù‚Ø²Ø­", price: 25, type: "background", emoji: "ğŸŒˆ", applied: false },
                    { id: 19, name: "Ø®Ù„ÙÙŠØ© Ø§Ù„ØºØ±ÙˆØ¨", description: "Ø®Ù„ÙÙŠØ© ØºØ±ÙˆØ¨ Ø§Ù„Ø´Ù…Ø³ Ø§Ù„Ø®Ù„Ø§Ø¨", price: 38, type: "background", emoji: "ğŸŒ‡", applied: false },
                    { id: 20, name: "Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´Ø§Ø·Ø¦", description: "Ø®Ù„ÙÙŠØ© Ø´Ø§Ø·Ø¦ Ø§Ø³ØªÙˆØ§Ø¦ÙŠ", price: 33, type: "background", emoji: "ğŸ–ï¸", applied: false },

                    { id: 21, name: "Ø­Ø²Ù…Ø© Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª", description: "Ø£Ø´ÙƒØ§Ù„ Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ø¯", price: 40, type: "emoji_pack", emoji: "ğŸ¾", content: ['ğŸ¦', 'ğŸ¦Š', 'ğŸ¦‰', 'ğŸ¢', 'ğŸ¦€'] },
                    { id: 22, name: "Ø­Ø²Ù…Ø© Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø·Ø¹Ø§Ù…", description: "Ø£Ø´ÙƒØ§Ù„ Ø·Ø¹Ø§Ù… Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ø¯", price: 45, type: "emoji_pack", emoji: "ğŸ”", content: ['ğŸŒ®', 'ğŸ•', 'ğŸœ', 'ğŸ©', 'ğŸª'] },
                    { id: 23, name: "Ø­Ø²Ù…Ø© Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª", description: "Ø£Ø´ÙƒØ§Ù„ Ø£Ø¯ÙˆØ§Øª Ù…ØªÙ†ÙˆØ¹Ø© Ù„Ù„Ø¹Ø¯", price: 50, type: "emoji_pack", emoji: "ğŸ› ï¸", content: ['ğŸ”§', 'ğŸ”¨', 'ğŸ”©', 'âš™ï¸', 'ğŸ”—'] },
                    { id: 24, name: "Ø­Ø²Ù…Ø© Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø£ÙŠØ¯ÙŠ", description: "Ø£Ø´ÙƒØ§Ù„ Ø£ÙŠØ¯ÙŠ Ù…ØªÙ†ÙˆØ¹Ø© Ù„Ù„Ø¹Ø¯", price: 55, type: "emoji_pack", emoji: "âœ‹", content: ['ğŸ–ï¸', 'ğŸ¤', 'ğŸ¤™', 'âœŠ', 'ğŸ‘'] },
                    { id: 25, name: "Ø­Ø²Ù…Ø© Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø£Ø¹Ù„Ø§Ù…", description: "Ø£Ø¹Ù„Ø§Ù… Ø¯ÙˆÙ„ Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ø¹Ø¯", price: 60, type: "emoji_pack", emoji: "ğŸŒ", content: ['ğŸ‡ªğŸ‡¬', 'ğŸ‡¸ğŸ‡¦', 'ğŸ‡¦ğŸ‡ª', 'ğŸ‡¶ğŸ‡¦', 'ğŸ‡°ğŸ‡¼'] },
                    { id: 26, name: "Ø­Ø²Ù…Ø© Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©", description: "Ø£Ø´ÙƒØ§Ù„ Ù…Ù† Ø§Ù„Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø®Ù„Ø§Ø¨Ø©", price: 45, type: "emoji_pack", emoji: "ğŸŒ¿", content: ['ğŸŒ²', 'ğŸŒ³', 'ğŸ‚', 'ğŸ', 'ğŸ„'] },
                    { id: 27, name: "Ø­Ø²Ù…Ø© Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ©", description: "Ø£Ø´ÙƒØ§Ù„ Ù‡Ù†Ø¯Ø³ÙŠØ© Ù„Ù„Ø¹Ø¯", price: 35, type: "emoji_pack", emoji: "ğŸ“", content: ['ğŸ”º', 'â¬›', 'âšª', 'â­', 'â¤ï¸'] },
                    { id: 28, name: "Ø­Ø²Ù…Ø© Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰", description: "Ø£Ø´ÙƒØ§Ù„ Ø£Ø¯ÙˆØ§Øª Ù…ÙˆØ³ÙŠÙ‚ÙŠØ©", price: 40, type: "emoji_pack", emoji: "ğŸ¶", content: ['ğŸµ', 'ğŸ¼', 'ğŸ¹', 'ğŸ¥', 'ğŸº'] },
                    { id: 29, name: "Ø­Ø²Ù…Ø© Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù…Ø´Ø§Ø¹Ø±", description: "Ø£Ø´ÙƒØ§Ù„ ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ù„Ù„Ø¹Ø¯", price: 50, type: "emoji_pack", emoji: "ğŸ˜€", content: ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜'] },
                    { id: 30, name: "Ø­Ø²Ù…Ø© Ø£Ø´ÙƒØ§Ù„ Ø§Ù„ÙØµÙˆÙ„", description: "Ø£Ø´ÙƒØ§Ù„ Ù„ÙƒÙ„ ÙØµÙˆÙ„ Ø§Ù„Ø³Ù†Ø©", price: 55, type: "emoji_pack", emoji: "ğŸŒ»", content: ['â˜€ï¸', 'ğŸ‚', 'â„ï¸', 'ğŸŒ¸', 'â˜”'] },

                    { id: 31, name: "ØªÙ„Ù…ÙŠØ­Ø§Øª (x5)", description: "5 ØªÙ„Ù…ÙŠØ­Ø§Øª Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØµØ¹Ø¨Ø©", price: 15, type: "power_up", emoji: "ğŸ’¡", quantity: 5 },
                    { id: 32, name: "ØªØ®Ø·ÙŠ Ø³Ø¤Ø§Ù„ (x3)", description: "3 ÙØ±Øµ Ù„ØªØ®Ø·ÙŠ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ØµØ¹Ø¨", price: 20, type: "power_up", emoji: "â­ï¸", quantity: 3 },
                ],
                dailyChallenge: {
                    title: "ØªØ­Ø¯ÙŠ Ø§Ù„Ø¹Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹",
                    description: "Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ 10 Ø£Ø³Ø¦Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ Ø®Ù„Ø§Ù„ 3 Ø¯Ù‚Ø§Ø¦Ù‚ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ£Ø© Ø®Ø§ØµØ©!",
                    goal: 10,
                    timeLimit: 180, // 3 Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
                    rewardGems: 10,
                    rewardXp: 200 // Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø®Ø¨Ø±Ø© Ù„Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ
                }
            };
            
            // Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            let currentState = {
                currentScreen: null, // ØªØªØ¨Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ø£Ø¬Ù„ Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª GSAP
                currentLevel: null,
                currentStage: 0, // Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (ÙŠØ¨Ø¯Ø£ Ù…Ù† 1)
                correctAnswersInLevel: 0,
                selectedAnswer: null,
                isAnswered: false,
                isCorrectLastQuestion: false, // NEW: Flag to store correctness of last question
                timer: null,
                timeLeft: 0,
                isDailyChallengeActive: false, // Ø¹Ù„Ø§Ù…Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ
                dailyChallenge: {
                    completedQuestions: 0,
                    correctQuestions: 0,
                    timeLimit: 0,
                    timerInterval: null
                },
                currentCorrectAnswer: null
            };
            
            // Ø§Ù„Ø£ØµÙˆØ§Øª
            const sounds = {
                background: new Howl({
                    src: ['https://assets.codepen.io/21542/howler-demo-bg.mp3'],
                    loop: true,
                    volume: 0.2 // Ø­Ø¬Ù… ØµÙˆØª Ø£Ù‚Ù„ Ù„Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©
                }),
                correct: new Howl({
                    src: ['https://assets.codepen.io/21542/howler-demo-sound1.mp3'],
                    volume: 0.5
                }),
                wrong: new Howl({
                    src: ['https://assets.codepen.io/21542/howler-demo-sound2.mp3'],
                    volume: 0.5
                }),
                levelComplete: new Howl({
                    src: ['https://assets.codepen.io/21542/howler-demo-sound3.mp3'],
                    volume: 0.6
                }),
                buttonClick: new Howl({
                    src: ['https://assets.codepen.io/21542/howler-demo-sound4.mp3'], // Placeholder
                    volume: 0.3
                })
            };
            
            // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
            function initGame() {
                loadGameData();
                applyPlayerSettings(); // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                playBackgroundMusic();
                updateProfileUI(); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                renderLevels();
                renderShopItems();
                updateDailyChallengeUI();
                
                // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ 1.5 Ø«Ø§Ù†ÙŠØ©
                gsap.to(loadingScreen, { opacity: 0, duration: 0.5, delay: 1.5, onComplete: () => {
                    loadingScreen.style.display = 'none';
                    showScreen(startScreen);
                }});
            }
            
            function loadGameData() {
                const savedData = localStorage.getItem('countingGameData');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    Object.assign(gameData.player, parsedData);
                    
                    if (!gameData.player.unlockedLevels || gameData.player.unlockedLevels.length === 0) {
                        gameData.player.unlockedLevels = [1];
                    }
                    gameData.levels.forEach(level => {
                        level.unlocked = gameData.player.unlockedLevels.includes(level.id);
                    });

                    if (!gameData.player.settings) {
                        gameData.player.settings = { soundEffects: true, backgroundMusic: true, vibration: true };
                    }
                    // ØªÙ‡ÙŠØ¦Ø© Ø­Ø§Ù„Ø© "Ù…Ø·Ø¨Ù‚" Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ØªØ¬Ø±
                    gameData.shopItems.forEach(item => {
                        item.applied = false; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹
                        if (item.type === 'avatar' && item.id === gameData.player.activeAvatar) {
                            item.applied = true;
                        } else if (item.type === 'background' && item.id === gameData.player.activeBackground) {
                            item.applied = true;
                        }
                    });

                } else {
                    gameData.levels[0].unlocked = true;
                }
            }
            
            function saveGameData() {
                localStorage.setItem('countingGameData', JSON.stringify(gameData.player));
            }

            function resetGameData() {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
                    localStorage.removeItem('countingGameData');
                    alert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©. Ø³ØªØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©.');
                    location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
                }
            }
            
            // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª ---
            function showScreen(screenElement) {
                // Hide all screens initially without transition
                document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');

                if (currentState.currentScreen) {
                    gsap.to(currentState.currentScreen, { opacity: 0, y: 20, duration: 0.3, onComplete: () => {
                        currentState.currentScreen.style.display = 'none'; // Ensure display is none after animation
                        screenElement.style.display = 'flex'; // Use flex for all main screens
                        gsap.fromTo(screenElement, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.3 });
                        currentState.currentScreen = screenElement;
                        updateNavButtons(screenElement);
                    }});
                } else {
                    screenElement.style.display = 'flex';
                    gsap.fromTo(screenElement, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.3 });
                    currentState.currentScreen = screenElement;
                    updateNavButtons(screenElement);
                }
            }
            
            function updateNavButtons(screen) {
                const navItems = [navHome, navLevels, navShop, navProfile, navSettings];
                navItems.forEach(item => item.classList.remove('active'));
                
                if (screen === startScreen) {
                    navHome.classList.add('active');
                } else if (screen === levelSelectScreen || screen === gameScreen || screen === levelCompleteScreen) {
                    navLevels.classList.add('active');
                } else if (screen === shopScreen) {
                    navShop.classList.add('active');
                } else if (screen === profileScreen) {
                    navProfile.classList.add('active');
                } else if (screen === settingsScreen) {
                    navSettings.classList.add('active');
                }
            }

            function playSound(sound) {
                if (gameData.player.settings.soundEffects) {
                    sound.play();
                }
            }

            function playBackgroundMusic() {
                if (gameData.player.settings.backgroundMusic) {
                    sounds.background.play();
                } else {
                    sounds.background.stop();
                }
            }

            function applyPlayerSettings() {
                soundEffectsToggle.checked = gameData.player.settings.soundEffects;
                backgroundMusicToggle.checked = gameData.player.settings.backgroundMusic;
                vibrationToggle.checked = gameData.player.settings.vibration;

                if (gameData.player.activeAvatar) {
                    const avatarItem = gameData.shopItems.find(item => item.id === gameData.player.activeAvatar && item.type === 'avatar');
                    if (avatarItem) {
                        document.getElementById('profile-avatar').textContent = avatarItem.emoji;
                    }
                } else {
                    document.getElementById('profile-avatar').textContent = gameData.player.avatar;
                }

                if (gameData.player.activeBackground) {
                    const backgroundItem = gameData.shopItems.find(item => item.id === gameData.player.activeBackground && item.type === 'background');
                    if (backgroundItem) {
                        // For demonstration, changing background color or simple gradients.
                        // For actual images, you'd need image assets and adjust CSS for `body.background-id-X`.
                        document.body.style.backgroundImage = 'none'; // Reset any previous gradient/image
                        document.body.style.backgroundColor = 'var(--background)'; // Reset default
                        if (backgroundItem.id === 11) document.body.style.backgroundImage = 'linear-gradient(to top, #A8E6CF, #DCEC6B)'; // Forest feel
                        else if (backgroundItem.id === 12) document.body.style.backgroundImage = 'linear-gradient(to bottom, #1A2980, #26D0CE)'; // Space feel
                        else if (backgroundItem.id === 13) document.body.style.backgroundImage = 'linear-gradient(to top, #36D1DC, #5B86E5)'; // Sea feel
                        else if (backgroundItem.id === 14) document.body.style.backgroundImage = 'linear-gradient(to right, #F9D423, #FF4E50)'; // Desert feel
                        else if (backgroundItem.id === 15) document.body.style.backgroundImage = 'linear-gradient(to bottom, #2C3E50, #BDC3C7)'; // City feel
                        else if (backgroundItem.id === 16) document.body.style.backgroundImage = 'linear-gradient(to top right, #FFB6C1, #FFFACD)'; // Spring feel
                        else if (backgroundItem.id === 17) document.body.style.backgroundImage = 'linear-gradient(to top, #B2D4F3, #E8F5FF)'; // Winter feel
                        else if (backgroundItem.id === 18) document.body.style.backgroundImage = 'linear-gradient(to right, #FFD166, #EF476F, #06D6A0, #118AB2)'; // Rainbow feel
                        else if (backgroundItem.id === 19) document.body.style.backgroundImage = 'linear-gradient(to top, #FF8008, #FFC837)'; // Sunset feel
                        else if (backgroundItem.id === 20) document.body.style.backgroundImage = 'linear-gradient(to bottom, #7DDFFF, #F7FCF0)'; // Beach feel
                    }
                } else {
                    document.body.style.backgroundImage = 'none';
                    document.body.style.backgroundColor = 'var(--background)';
                }
            }
            
            // --- Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª ---
            function renderLevels(category = 'all') {
                const levelsContainer = document.querySelector('.levels-container');
                levelsContainer.innerHTML = '';
                
                gameData.levels.forEach(level => {
                    // Filter by category or type
                    if (category !== 'all' && level.category !== category && level.type !== category) return;
                    
                    const starsEarned = gameData.player.stars[level.id] || 0;
                    const isUnlocked = gameData.player.unlockedLevels.includes(level.id);

                    let iconClass;
                    switch(level.type) {
                        case 'count': iconClass = 'calculator'; break;
                        case 'addition': iconClass = 'plus'; break;
                        case 'subtraction': iconClass = 'minus'; break;
                        case 'comparison': iconClass = 'balance-scale'; break;
                        case 'odd_even': iconClass = 'dice-five'; break; // Representing numbers visually
                        default: iconClass = 'brain';
                    }
                    
                    const levelCard = document.createElement('div');
                    levelCard.className = `level-card ${isUnlocked ? '' : 'locked'}`;
                    levelCard.innerHTML = `
                        <div class="level-number">
                            <i class="fas fa-${iconClass}"></i>
                            Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${level.id}
                        </div>
                        <h3 class="level-name">${level.name}</h3>
                        <div class="level-difficulty">
                            <div class="difficulty-dot ${level.category === 'easy' ? 'active' : ''}"></div>
                            <div class="difficulty-dot ${level.category === 'medium' ? 'active' : ''}"></div>
                            <div class="difficulty-dot ${level.category === 'hard' ? 'active' : ''}"></div>
                        </div>
                        <p class="level-description">${level.description}</p>
                        <div class="level-rewards">
                            <div class="reward">
                                <i class="fas fa-coins"></i>
                                <span>${level.rewardPoints} Ù†Ù‚Ø·Ø©</span>
                            </div>
                            <div class="reward">
                                <i class="fas fa-gem"></i>
                                <span>${level.rewardGems} Ø¬ÙˆÙ‡Ø±Ø©</span>
                            </div>
                        </div>
                        ${starsEarned > 0 ? `
                        <div class="stars-earned">
                            <div class="star ${starsEarned >= 1 ? 'earned' : ''}"><i class="fas fa-star"></i></div>
                            <div class="star ${starsEarned >= 2 ? 'earned' : ''}"><i class="fas fa-star"></i></div>
                            <div class="star ${starsEarned >= 3 ? 'earned' : ''}"><i class="fas fa-star"></i></div>
                        </div>
                        ` : ''}
                    `;
                    
                    if (isUnlocked) {
                        levelCard.addEventListener('click', () => startLevel(level));
                    }
                    
                    levelsContainer.appendChild(levelCard);
                });
            }
            
            // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨ (Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©) ---
            function startLevel(level) {
                currentState.currentLevel = level;
                currentState.currentStage = 0; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                currentState.correctAnswersInLevel = 0;
                currentState.isDailyChallengeActive = false; // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠ
                
                document.getElementById('current-level-name').textContent = level.name;
                document.getElementById('current-score').textContent = gameData.player.points;
                document.getElementById('current-gems').textContent = gameData.player.gems;
                
                showScreen(gameScreen);
                loadQuestion();
            }
            
            function loadQuestion() {
                currentState.currentStage++; // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
                currentState.isAnswered = false;
                currentState.selectedAnswer = null;
                currentState.isCorrectLastQuestion = false; // Reset correctness flag for new question
                
                document.getElementById('current-stage-display').textContent = ` (Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${currentState.currentStage}/${currentState.currentLevel.questions})`;
                
                const progress = (currentState.currentStage - 1) / currentState.currentLevel.questions * 100;
                document.getElementById('level-progress').style.width = `${progress}%`;
                
                nextBtn.classList.remove('show');
                const feedbackMessage = document.getElementById('feedback-message');
                feedbackMessage.textContent = '';
                feedbackMessage.className = 'feedback-message';
                
                // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„
                let questionType = currentState.currentLevel.type;
                if (questionType === 'mixed') { // For mixed levels, randomize question types
                    const availableTypes = ['count', 'addition', 'subtraction', 'comparison', 'odd_even'];
                    questionType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
                }

                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container'; // Reset container layout initially

                switch (questionType) {
                    case 'count':
                        _loadCountingQuestion();
                        break;
                    case 'addition':
                        _loadAdditionQuestion();
                        break;
                    case 'subtraction':
                        _loadSubtractionQuestion();
                        break;
                    case 'comparison':
                        _loadComparisonQuestion();
                        break;
                    case 'odd_even':
                        _loadOddEvenQuestion();
                        break;
                    default:
                        _loadCountingQuestion(); // Fallback
                }
            }

            // Helper to get available emojis (including unlocked packs)
            function _getAvailableEmojis(levelEmojis) {
                let availableEmojis = [...levelEmojis];
                gameData.player.inventory.forEach(itemId => {
                    const item = gameData.shopItems.find(si => si.id === itemId && si.type === 'emoji_pack');
                    if (item && item.content) {
                        availableEmojis = availableEmojis.concat(item.content);
                    }
                });
                return availableEmojis;
            }

            // Shuffle array helper
            function _shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // --- Question Type Specific Loaders ---

            function _loadCountingQuestion() {
                const level = currentState.currentLevel;
                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container'; // Ensure default layout

                const targetEmojisPool = level.emojis; // Emojis specific to be counted for this level
                const allEmojisPool = level.allEmojis || _getAvailableEmojis(level.emojis); // All possible emojis including distractors
                
                const targetEmoji = targetEmojisPool[Math.floor(Math.random() * targetEmojisPool.length)];
                
                const count = Math.floor(Math.random() * (level.maxCount - level.minCount + 1)) + level.minCount;
                const numDistractors = level.numDistractors || Math.floor(Math.random() * (level.maxCount / 2)) + 1; // Random distractors up to half of max count

                let allEmojis = Array(count).fill(targetEmoji);
                let currentDistractors = 0;
                while (currentDistractors < numDistractors) {
                    const randomEmoji = allEmojisPool[Math.floor(Math.random() * allEmojisPool.length)];
                    if (randomEmoji !== targetEmoji) {
                        allEmojis.push(randomEmoji);
                        currentDistractors++;
                    }
                }
                allEmojis = _shuffleArray(allEmojis);

                itemsContainer.innerHTML = '';
                allEmojis.forEach(emoji => {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji;
                    itemsContainer.appendChild(item);
                });

                document.getElementById('question-text').innerHTML = `ÙƒÙ… ÙŠÙˆØ¬Ø¯ Ù…Ù† <span id="current-emoji">${targetEmoji}</span> ÙÙ‚Ø·ØŸ`;
                currentState.currentCorrectAnswer = count;
                _renderOptions(count, 'number');
            }

            function _loadAdditionQuestion() {
                const level = currentState.currentLevel;
                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container addition-layout'; // Set layout class

                const emoji = _getAvailableEmojis(level.emojis)[Math.floor(Math.random() * level.emojis.length)];
                
                // Ensure totalSum is between level.minCount and level.maxCount
                const totalSum = Math.floor(Math.random() * (level.maxCount - level.minCount + 1)) + level.minCount;
                
                // Ensure count1 is at least 1, and count2 (totalSum - count1) is at least 1
                // And ensure count1 is not too large compared to totalSum
                const maxCount1 = Math.min(totalSum - 1, Math.floor(level.maxCount / 2)); // Limit each part to half of maxLevelCount
                const minCount1 = Math.max(1, totalSum - Math.floor(level.maxCount / 2));
                const count1 = Math.floor(Math.random() * (maxCount1 - minCount1 + 1)) + minCount1;
                const count2 = totalSum - count1;

                itemsContainer.innerHTML = `
                    <div class="items-group group1"></div>
                    <div class="math-operator">+</div>
                    <div class="items-group group2"></div>
                `;
                const group1 = itemsContainer.querySelector('.group1');
                const group2 = itemsContainer.querySelector('.group2');

                for (let i = 0; i < count1; i++) {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji;
                    group1.appendChild(item);
                }
                for (let i = 0; i < count2; i++) {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji;
                    group2.appendChild(item);
                }

                document.getElementById('question-text').innerHTML = `ÙƒÙ… Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ØŸ`;
                currentState.currentCorrectAnswer = totalSum; // The correct answer is the total sum
                _renderOptions(totalSum, 'number');
            }

            function _loadSubtractionQuestion() {
                const level = currentState.currentLevel;
                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container subtraction-layout'; // Set layout class

                const emoji = _getAvailableEmojis(level.emojis)[Math.floor(Math.random() * level.emojis.length)];
                
                const totalCount = Math.floor(Math.random() * (level.maxCount - level.minCount + 1)) + level.minCount;
                const removeCount = Math.floor(Math.random() * (totalCount - 1)) + 1; // Must remove at least 1, max total-1

                itemsContainer.innerHTML = `<div class="items-group group1"></div>`;
                const group1 = itemsContainer.querySelector('.group1');

                const emojisToDisplay = [];
                for (let i = 0; i < totalCount; i++) {
                    emojisToDisplay.push({ emoji: emoji, removed: i < removeCount });
                }
                _shuffleArray(emojisToDisplay); // Shuffle so removed items aren't always first

                emojisToDisplay.forEach(itemData => {
                    const item = document.createElement('div');
                    item.className = `emoji-item ${itemData.removed ? 'removed' : ''}`;
                    item.textContent = itemData.emoji;
                    group1.appendChild(item);
                });

                document.getElementById('question-text').innerHTML = `Ø¥Ø°Ø§ Ø£Ø²Ù„Øª Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù…Ø®Ø·Ø·Ø©ØŒ ÙÙƒÙ… ÙŠØªØ¨Ù‚Ù‰ØŸ`;
                currentState.currentCorrectAnswer = totalCount - removeCount;
                _renderOptions(totalCount - removeCount, 'number');
            }

            function _loadComparisonQuestion() {
                const level = currentState.currentLevel;
                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container comparison-layout'; // Set layout class

                const availableEmojis = _getAvailableEmojis(level.emojis);
                const emoji1 = availableEmojis[0];
                const emoji2 = availableEmojis.length > 1 ? availableEmojis[1] : availableEmojis[0]; // Ensure a different emoji if possible
                
                let count1, count2;
                const comparisonType = Math.floor(Math.random() * 3); // 0: equal, 1: more, 2: less

                const minVal = level.minCount;
                const maxVal = level.maxCount;

                if (comparisonType === 0) { // Equal
                    count1 = Math.floor(Math.random() * (maxVal - minVal + 1)) + minVal;
                    count2 = count1;
                } else if (comparisonType === 1) { // More (count1 > count2)
                    count1 = Math.floor(Math.random() * (maxVal - minVal - 1)) + minVal + 1; // count1 is at least minVal+1
                    count2 = Math.floor(Math.random() * (count1 - minVal)) + minVal; // count2 is less than count1
                } else { // Less (count1 < count2)
                    count2 = Math.floor(Math.random() * (maxVal - minVal - 1)) + minVal + 1;
                    count1 = Math.floor(Math.random() * (count2 - minVal)) + minVal;
                }
                count1 = Math.max(minVal, Math.min(count1, maxVal));
                count2 = Math.max(minVal, Math.min(count2, maxVal));


                itemsContainer.innerHTML = `
                    <div class="items-group group1"></div>
                    <span class="math-operator"> vs </span>
                    <div class="items-group group2"></div>
                `;
                const group1 = itemsContainer.querySelector('.group1');
                const group2 = itemsContainer.querySelector('.group2');

                for (let i = 0; i < count1; i++) {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji1;
                    group1.appendChild(item);
                }
                for (let i = 0; i < count2; i++) {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = emoji2;
                    group2.appendChild(item);
                }
                
                document.getElementById('question-text').innerHTML = `Ù‡Ù„ Ø¹Ø¯Ø¯ ${emoji1} "Ø£ÙƒØ«Ø± Ù…Ù†" Ø£Ù… "Ø£Ù‚Ù„ Ù…Ù†" Ø£Ù… "ÙŠØ³Ø§ÙˆÙŠ" Ø¹Ø¯Ø¯ ${emoji2}ØŸ`;
                
                let correctAnswerText;
                if (count1 > count2) correctAnswerText = 'Ø£ÙƒØ«Ø± Ù…Ù†';
                else if (count1 < count2) correctAnswerText = 'Ø£Ù‚Ù„ Ù…Ù†';
                else correctAnswerText = 'ÙŠØ³Ø§ÙˆÙŠ';

                currentState.currentCorrectAnswer = correctAnswerText;
                _renderOptions(correctAnswerText, 'comparison_text');
            }

            function _loadOddEvenQuestion() {
                const level = currentState.currentLevel;
                const itemsContainer = document.getElementById('items-container');
                itemsContainer.className = 'items-container odd-even-layout'; // Set layout class for odd/even

                const availableEmojis = _getAvailableEmojis(level.emojis);
                const targetEmoji = availableEmojis[Math.floor(Math.random() * availableEmojis.length)];
                
                const count = Math.floor(Math.random() * (level.maxCount - level.minCount + 1)) + level.minCount;
                
                itemsContainer.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const item = document.createElement('div');
                    item.className = 'emoji-item';
                    item.textContent = targetEmoji;
                    itemsContainer.appendChild(item);
                }

                document.getElementById('question-text').innerHTML = `Ù‡Ù„ Ø¹Ø¯Ø¯ ${targetEmoji} ÙØ±Ø¯ÙŠ Ø£Ù… Ø²ÙˆØ¬ÙŠØŸ`;
                
                currentState.currentCorrectAnswer = (count % 2 === 0) ? 'Ø²ÙˆØ¬ÙŠ' : 'ÙØ±Ø¯ÙŠ';
                _renderOptions(currentState.currentCorrectAnswer, 'odd_even_text');
            }


            // Helper to render options based on type
            function _renderOptions(correctAnswer, type) {
                const optionsGrid = document.getElementById('options-grid');
                optionsGrid.innerHTML = '';
                
                let optionsArray = [];
                if (type === 'number') {
                    optionsArray = _generateNumericOptions(correctAnswer, currentState.currentLevel.maxCount);
                } else if (type === 'comparison_text') {
                    optionsArray = _generateComparisonTextOptions(correctAnswer);
                } else if (type === 'odd_even_text') {
                    optionsArray = _generateOddEvenTextOptions(correctAnswer);
                }

                optionsArray.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'option-btn';
                    button.textContent = option;
                    button.dataset.value = option;
                    button.addEventListener('click', () => selectAnswer(option, button));
                    optionsGrid.appendChild(button);
                });

                gsap.fromTo(optionsGrid.children, {
                    opacity: 0,
                    y: 50
                }, {
                    opacity: 1,
                    y: 0,
                    duration: 0.4,
                    delay: (i) => 0.2 + i * 0.08,
                    ease: 'power3.out'
                });
            }
            
            function _generateNumericOptions(correctAnswer, maxPossible) {
                let options = new Set();
                options.add(correctAnswer);
                
                while (options.size < 4) {
                    let randomOption;
                    const offset = Math.floor(Math.random() * 5) - 2; // -2, -1, 0, 1, 2
                    randomOption = correctAnswer + offset;
                    randomOption = Math.max(1, Math.min(randomOption, maxPossible + 5));
                    if (randomOption !== correctAnswer) {
                        options.add(randomOption);
                    }
                }
                return Array.from(options).sort(() => Math.random() - 0.5);
            }

            function _generateComparisonTextOptions(correctAnswer) {
                const allOptions = ['Ø£ÙƒØ«Ø± Ù…Ù†', 'Ø£Ù‚Ù„ Ù…Ù†', 'ÙŠØ³Ø§ÙˆÙŠ'];
                let options = new Set();
                options.add(correctAnswer);
                
                while (options.size < 3) { // Comparison has 3 options
                    const randomOption = allOptions[Math.floor(Math.random() * allOptions.length)];
                    options.add(randomOption);
                }
                return Array.from(options).sort(() => Math.random() - 0.5);
            }

            function _generateOddEvenTextOptions(correctAnswer) {
                const allOptions = ['ÙØ±Ø¯ÙŠ', 'Ø²ÙˆØ¬ÙŠ'];
                let options = new Set();
                options.add(correctAnswer);
                while (options.size < 2) { // Only two options
                    const randomOption = allOptions[Math.floor(Math.random() * allOptions.length)];
                    options.add(randomOption);
                }
                return Array.from(options).sort(() => Math.random() - 0.5);
            }
            
            function selectAnswer(selectedAnswer, button) {
                if (currentState.isAnswered) return;
                
                currentState.isAnswered = true;
                currentState.selectedAnswer = selectedAnswer;
                
                // Compare based on type (numbers or strings)
                const isCorrect = (selectedAnswer == currentState.currentCorrectAnswer);
                
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.classList.add('disabled');
                    btn.disabled = true;
                });
                
                if (isCorrect) {
                    button.classList.add('correct');
                    currentState.correctAnswersInLevel++;
                    gameData.player.points += 10;
                    currentState.isCorrectLastQuestion = true; // Set flag
                    
                    document.getElementById('current-score').textContent = gameData.player.points;
                    
                    const feedbackMessage = document.getElementById('feedback-message');
                    feedbackMessage.textContent = 'Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ø£Ø­Ø³Ù†Øª! ğŸ‰';
                    feedbackMessage.classList.add('correct');
                    playSound(sounds.correct);
                    
                    if (gameData.player.settings.vibration && 'vibrate' in navigator) {
                        navigator.vibrate(100);
                    }
                } else {
                    button.classList.add('wrong');
                    currentState.isCorrectLastQuestion = false; // Set flag
                    
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.dataset.value == currentState.currentCorrectAnswer) {
                            btn.classList.add('correct');
                        }
                    });
                    
                    const feedbackMessage = document.getElementById('feedback-message');
                    feedbackMessage.textContent = `Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ ${currentState.currentCorrectAnswer}.`;
                    feedbackMessage.classList.add('wrong');
                    playSound(sounds.wrong);
                    
                    if (gameData.player.settings.vibration && 'vibrate' in navigator) {
                        navigator.vibrate([100, 50, 100]);
                    }
                }
                
                gsap.to(nextBtn, { opacity: 1, y: 0, duration: 0.3, delay: 1, onComplete: () => nextBtn.classList.add('show') });
            }
            
            // New helper function to proceed
            function _proceedToNextQuestionOrComplete() {
                if (currentState.currentStage < currentState.currentLevel.questions) {
                    loadQuestion();
                } else {
                    completeLevel();
                }
            }

            // --- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© (Modal) ---
            function showNextStageModal() {
                const isPreviousCorrect = currentState.isCorrectLastQuestion; // Use the stored flag
                document.getElementById('modal-icon').textContent = isPreviousCorrect ? 'âœ…' : 'âŒ';
                document.getElementById('modal-title').textContent = isPreviousCorrect ? 'Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!' : 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!'; // Show this even for wrong if desired
                document.getElementById('modal-subtitle').textContent = `Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${currentState.currentStage} Ù…Ù† Ø£ØµÙ„ ${currentState.currentLevel.questions}.`;
                
                const progressPercentage = (currentState.currentStage / currentState.currentLevel.questions) * 100;
                document.getElementById('modal-progress-fill').style.width = `${progressPercentage}%`;
                
                document.getElementById('modal-correct-answers').textContent = `${currentState.correctAnswersInLevel}/${currentState.currentStage}`;
                document.getElementById('modal-current-stage').textContent = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${currentState.currentStage}/${currentState.currentLevel.questions}`;
                
                nextStageModalOverlay.classList.add('show');
                playSound(sounds.buttonClick);
            }

            function hideNextStageModal() {
                nextStageModalOverlay.classList.remove('show');
                _proceedToNextQuestionOrComplete(); // Proceed after modal is hidden
            }
            
            // --- Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ---
            function completeLevel() {
                const level = currentState.currentLevel;
                
                const starsEarned = Math.min(3, Math.floor(currentState.correctAnswersInLevel / level.questions * 3));
                
                if (!gameData.player.stars[level.id] || starsEarned > gameData.player.stars[level.id]) {
                    gameData.player.stars[level.id] = starsEarned;
                }
                
                const pointsAwarded = level.rewardPoints + (starsEarned * 10);
                const gemsAwarded = level.rewardGems + (starsEarned >= 3 ? 2 : starsEarned >= 2 ? 1 : 0);
                
                gameData.player.points += pointsAwarded;
                gameData.player.gems += gemsAwarded;
                
                const nextLevelId = level.id + 1;
                const nextLevelExists = gameData.levels.find(l => l.id === nextLevelId);
                if (nextLevelExists && !gameData.player.unlockedLevels.includes(nextLevelId)) {
                    gameData.player.unlockedLevels.push(nextLevelId);
                    nextLevelExists.unlocked = true;
                    document.getElementById('next-level-reward-item').style.display = 'flex';
                } else {
                    document.getElementById('next-level-reward-item').style.display = 'none';
                }
                
                gameData.player.xp += pointsAwarded;
                if (gameData.player.xp >= gameData.player.nextLevelXp) {
                    gameData.player.level++;
                    gameData.player.xp -= gameData.player.nextLevelXp;
                    gameData.player.nextLevelXp = Math.floor(gameData.player.nextLevelXp * 1.5);
                    alert(`ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${gameData.player.level}!`);
                }
                
                saveGameData();
                
                document.getElementById('earned-points').textContent = pointsAwarded;
                document.getElementById('complete-screen-points').textContent = `+${pointsAwarded}`;
                document.getElementById('complete-screen-gems').textContent = `+${gemsAwarded}`;
                
                const stars = [
                    document.getElementById('star-1'),
                    document.getElementById('star-2'),
                    document.getElementById('star-3')
                ];
                
                stars.forEach((star, index) => {
                    star.classList.remove('earned');
                    if (index < starsEarned) {
                        setTimeout(() => {
                            star.classList.add('earned');
                        }, index * 200);
                    }
                });
                
                playSound(sounds.levelComplete);
                createConfetti();
                
                showScreen(levelCompleteScreen);
            }
            
            function createConfetti() {
                const colors = ['#6C63FF', '#FFD166', '#06D6A0', '#EF476F', '#118AB2', '#FF9F1C', '#CBF3F0'];
                
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = `${Math.random() * 100}vw`;
                    confetti.style.top = `${Math.random() * -20}vh`;
                    confetti.style.width = `${Math.random() * 10 + 5}px`;
                    confetti.style.height = `${Math.random() * 10 + 5}px`;
                    confetti.style.animationDuration = `${Math.random() * 2 + 3}s`;
                    confetti.style.animationDelay = `${Math.random() * 1.5}s`;
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    
                    document.body.appendChild(confetti);
                    
                    gsap.to(confetti, {
                        y: window.innerHeight * 1.2,
                        x: (Math.random() - 0.5) * window.innerWidth * 0.5,
                        rotation: '+=720',
                        opacity: 0,
                        duration: 3 + Math.random() * 2,
                        ease: 'power1.in',
                        delay: Math.random() * 0.5,
                        onComplete: () => confetti.remove()
                    });
                }
            }
            
            // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ¬Ø± ---
            function renderShopItems() {
                const shopItemsContainer = document.querySelector('.shop-items');
                shopItemsContainer.innerHTML = '';

                document.getElementById('shop-current-gems').textContent = gameData.player.gems;
                
                gameData.shopItems.forEach(item => {
                    const isOwned = gameData.player.inventory.includes(item.id);
                    const canAfford = gameData.player.gems >= item.price;
                    const isApplied = (item.type === 'avatar' && gameData.player.activeAvatar === item.id) ||
                                      (item.type === 'background' && gameData.player.activeBackground === item.id);
                    
                    const shopItem = document.createElement('div');
                    shopItem.className = 'shop-item';
                    shopItem.innerHTML = `
                        <div class="shop-item-image">${item.emoji}</div>
                        <h3 class="shop-item-name">${item.name}</h3>
                        <div class="shop-item-price">
                            <i class="fas fa-gem"></i>
                            <span>${item.price}</span>
                        </div>
                        <p class="shop-item-description">${item.description}</p>
                        <button class="shop-item-btn" 
                                data-id="${item.id}"
                                data-type="${item.type}"
                                ${isOwned ? '' : (canAfford ? '' : 'disabled')}>
                            ${isOwned ? (isApplied ? 'Ù…ÙØ·Ø¨Ù‚' : 'ØªØ·Ø¨ÙŠÙ‚') : (canAfford ? 'Ø´Ø±Ø§Ø¡' : 'Ø¬ÙˆØ§Ù‡Ø± ØºÙŠØ± ÙƒØ§ÙÙŠØ©')}
                        </button>
                    `;
                    
                    const btn = shopItem.querySelector('.shop-item-btn');
                    if (isOwned) {
                        btn.classList.add('owned');
                        if (isApplied) btn.classList.add('applied');
                        btn.textContent = isApplied ? 'Ù…ÙØ·Ø¨Ù‚' : 'ØªØ·Ø¨ÙŠÙ‚';
                        btn.disabled = false;
                    } else if (!canAfford) {
                        btn.classList.add('not-enough');
                        btn.disabled = true;
                    }

                    btn.addEventListener('click', () => {
                        if (isOwned) {
                            applyItem(item);
                        } else {
                            purchaseItem(item);
                        }
                    });
                    
                    shopItemsContainer.appendChild(shopItem);
                });
            }
            
            function purchaseItem(item) {
                playSound(sounds.buttonClick);
                if (gameData.player.gems >= item.price) {
                    gameData.player.gems -= item.price;
                    gameData.player.inventory.push(item.id);
                    
                    if (item.type === 'power_up') {
                        alert(`ØªÙ… Ø´Ø±Ø§Ø¡ ${item.name} Ø¨Ù†Ø¬Ø§Ø­! Ù„Ø¯ÙŠÙƒ Ø§Ù„Ø¢Ù† ${item.quantity} Ù…Ù† ${item.name}.`);
                    } else {
                        alert(`ØªÙ… Ø´Ø±Ø§Ø¡ ${item.name} Ø¨Ù†Ø¬Ø§Ø­!`);
                    }
                    
                    saveGameData();
                    updateProfileUI();
                    renderShopItems();
                } else {
                    alert('Ù„Ø§ ØªÙ…Ù„Ùƒ Ø¬ÙˆØ§Ù‡Ø± ÙƒØ§ÙÙŠØ© Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±!');
                }
            }

            function applyItem(item) {
                playSound(sounds.buttonClick);
                if (item.type === 'avatar') {
                    if (gameData.player.activeAvatar !== item.id) {
                        gameData.player.activeAvatar = item.id;
                        document.getElementById('profile-avatar').textContent = item.emoji;
                        alert(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø´Ø®ØµÙŠØ© ${item.name}!`);
                    } else {
                        gameData.player.activeAvatar = null;
                        document.getElementById('profile-avatar').textContent = gameData.player.avatar;
                        alert(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Ø´Ø®ØµÙŠØ© ${item.name}!`);
                    }
                } else if (item.type === 'background') {
                    if (gameData.player.activeBackground !== item.id) {
                        gameData.player.activeBackground = item.id;
                        applyPlayerSettings(); // Reapply settings to update background
                        alert(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø®Ù„ÙÙŠØ© ${item.name}!`);
                    } else {
                        gameData.player.activeBackground = null;
                        applyPlayerSettings(); // Reapply settings to remove background
                        alert(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Ø®Ù„ÙÙŠØ© ${item.name}!`);
                    }
                } else if (item.type === 'emoji_pack') {
                    alert(`Ø­Ø²Ù…Ø© ${item.name} Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù† Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©!`);
                }
                saveGameData();
                renderShopItems();
            }
            
            // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ ---
            function updateDailyChallengeUI() {
                const challenge = gameData.dailyChallenge;
                document.getElementById('daily-challenge-title').textContent = challenge.title;
                document.getElementById('daily-challenge-desc').textContent = challenge.description;
                
                const progressPercentage = (currentState.dailyChallenge.correctQuestions / challenge.goal) * 100;
                document.getElementById('challenge-progress').style.width = `${progressPercentage}%`;
                
                document.getElementById('challenge-completed').textContent = 
                    `${currentState.dailyChallenge.correctQuestions}/${challenge.goal} Ù…ÙƒØªÙ…Ù„`;
                
                const minutes = Math.floor(currentState.dailyChallenge.timeLimit / 60);
                const seconds = currentState.dailyChallenge.timeLimit % 60;
                document.getElementById('challenge-time').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} Ù…ØªØ¨Ù‚ÙŠ`;
            }

            // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ---
            function updateProfileUI() {
                document.getElementById('profile-name').textContent = gameData.player.name;
                document.getElementById('profile-level').textContent = gameData.player.level;
                
                const progressPercentage = (gameData.player.xp / gameData.player.nextLevelXp) * 100;
                document.getElementById('profile-progress-bar').style.width = `${progressPercentage}%`;
                document.getElementById('profile-current-xp').textContent = gameData.player.xp;
                document.getElementById('profile-next-xp').textContent = gameData.player.nextLevelXp;
                
                document.getElementById('total-points').textContent = gameData.player.points.toLocaleString();
                document.getElementById('total-levels').textContent = gameData.player.unlockedLevels.length;
                document.getElementById('total-stars').textContent = Object.values(gameData.player.stars).reduce((a, b) => a + b, 0);
                document.getElementById('total-gems').textContent = gameData.player.gems;

                if (document.getElementById('current-gems')) {
                    document.getElementById('current-gems').textContent = gameData.player.gems;
                }
            }

            function editProfile() {
                playSound(sounds.buttonClick);
                const newName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯:', gameData.player.name);
                if (newName && newName.trim() !== '') {
                    gameData.player.name = newName.trim();
                }
                
                if (!gameData.player.activeAvatar) {
                    const newAvatarChar = prompt('Ø£Ø¯Ø®Ù„ Ø­Ø±ÙÙ‹Ø§ Ø£Ùˆ Ø±Ù…Ø²Ù‹Ø§ Ø¬Ø¯ÙŠØ¯Ù‹Ø§ Ù„Ø±Ù…Ø²Ùƒ (Ù…Ø«Ø§Ù„: Ø£, ğŸ˜„):', gameData.player.avatar);
                    if (newAvatarChar && newAvatarChar.trim() !== '') {
                        gameData.player.avatar = newAvatarChar.trim().substring(0, 1);
                    }
                }
                saveGameData();
                updateProfileUI();
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ!');
            }
            
            // --- Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ---
            startGameBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                showScreen(levelSelectScreen);
            });
            
            dailyChallengeBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                showScreen(dailyChallengeScreen);
                currentState.isDailyChallengeActive = true;
                currentState.dailyChallenge.correctQuestions = 0;
                currentState.dailyChallenge.timeLimit = gameData.dailyChallenge.timeLimit;
                updateDailyChallengeUI();
                clearInterval(currentState.dailyChallenge.timerInterval);
                currentState.dailyChallenge.timerInterval = setInterval(() => {
                    currentState.dailyChallenge.timeLimit--;
                    if (currentState.dailyChallenge.timeLimit <= 0) {
                        clearInterval(currentState.dailyChallenge.timerInterval);
                        alert('Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ!');
                        currentState.isDailyChallengeActive = false;
                    } else if (currentState.dailyChallenge.correctQuestions < gameData.dailyChallenge.goal) {
                        // Simulate answering questions
                        currentState.dailyChallenge.correctQuestions++;
                    } else {
                         clearInterval(currentState.dailyChallenge.timerInterval);
                         alert('ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ Ø¬ÙˆØ§Ø¦Ø²!');
                         gameData.player.gems += gameData.dailyChallenge.rewardGems;
                         gameData.player.xp += gameData.dailyChallenge.rewardXp;
                         saveGameData();
                         updateProfileUI();
                         currentState.isDailyChallengeActive = false;
                    }
                    updateDailyChallengeUI();
                }, 1000);
            });
            
            backToLevelsBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                showScreen(levelSelectScreen);
            });
            
            nextBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                // NEW: Logic for next button press
                if (currentState.currentLevel && currentState.currentStage < currentState.currentLevel.questions && currentState.isCorrectLastQuestion) {
                    showNextStageModal(); // Show modal only if correct and not last stage
                } else {
                    _proceedToNextQuestionOrComplete(); // Proceed directly if wrong or last stage
                }
            });

            modalContinueBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                hideNextStageModal(); // This will call _proceedToNextQuestionOrComplete()
            });

            modalBackToLevelsBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                nextStageModalOverlay.classList.remove('show'); // Hide modal
                showScreen(levelSelectScreen);
            });
            
            nextLevelCompleteBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                const nextLevelId = currentState.currentLevel.id + 1;
                const nextLevel = gameData.levels.find(level => level.id === nextLevelId);
                
                if (nextLevel && gameData.player.unlockedLevels.includes(nextLevel.id)) {
                    startLevel(nextLevel);
                } else {
                    showScreen(levelSelectScreen);
                }
            });
            
            backToLevelsCompleteBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                showScreen(levelSelectScreen);
            });
            
            startChallengeBtn.addEventListener('click', () => {
                playSound(sounds.buttonClick);
                alert('Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±! ğŸš§');
                currentState.isDailyChallengeActive = true;
                currentState.dailyChallenge.correctQuestions = 0;
                currentState.dailyChallenge.timeLimit = gameData.dailyChallenge.timeLimit;
                updateDailyChallengeUI();
                clearInterval(currentState.dailyChallenge.timerInterval);
                currentState.dailyChallenge.timerInterval = setInterval(() => {
                    currentState.dailyChallenge.timeLimit--;
                    if (currentState.dailyChallenge.timeLimit <= 0) {
                        clearInterval(currentState.dailyChallenge.timerInterval);
                        alert('Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ!');
                        currentState.isDailyChallengeActive = false;
                    } else if (currentState.dailyChallenge.correctQuestions < gameData.dailyChallenge.goal) {
                        currentState.dailyChallenge.correctQuestions++;
                    } else {
                         clearInterval(currentState.dailyChallenge.timerInterval);
                         alert('ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ Ø¬ÙˆØ§Ø¦Ø²!');
                         gameData.player.gems += gameData.dailyChallenge.rewardGems;
                         gameData.player.xp += gameData.dailyChallenge.rewardXp;
                         saveGameData();
                         updateProfileUI();
                         currentState.isDailyChallengeActive = false;
                    }
                    updateDailyChallengeUI();
                }, 1000);
            });
            
            // Ø§Ù„ØªÙ†Ù‚Ù„
            navHome.addEventListener('click', (e) => { e.preventDefault(); playSound(sounds.buttonClick); showScreen(startScreen); });
            navLevels.addEventListener('click', (e) => { e.preventDefault(); playSound(sounds.buttonClick); renderLevels(); showScreen(levelSelectScreen); });
            navShop.addEventListener('click', (e) => { e.preventDefault(); playSound(sounds.buttonClick); renderShopItems(); showScreen(shopScreen); });
            navProfile.addEventListener('click', (e) => { e.preventDefault(); playSound(sounds.buttonClick); updateProfileUI(); showScreen(profileScreen); });
            navSettings.addEventListener('click', (e) => { e.preventDefault(); playSound(sounds.buttonClick); applyPlayerSettings(); showScreen(settingsScreen); });
            
            // ØªØµÙÙŠØ© Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
            document.querySelectorAll('.category-btn').forEach(button => {
                button.addEventListener('click', () => {
                    playSound(sounds.buttonClick);
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderLevels(button.dataset.category);
                });
            });

            // Ù…ÙØ§ØªÙŠØ­ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            soundEffectsToggle.addEventListener('change', (e) => {
                gameData.player.settings.soundEffects = e.target.checked;
                saveGameData();
            });
            backgroundMusicToggle.addEventListener('change', (e) => {
                gameData.player.settings.backgroundMusic = e.target.checked;
                playBackgroundMusic();
                saveGameData();
            });
            vibrationToggle.addEventListener('change', (e) => {
                gameData.player.settings.vibration = e.target.checked;
                saveGameData();
            });

            // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            resetDataBtn.addEventListener('click', resetGameData);
            logoutBtn.addEventListener('click', () => { alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬. (Ù‡Ø°Ù‡ Ù…ÙŠØ²Ø© ÙˆÙ‡Ù…ÙŠØ©)'); });

            // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
            editProfileBtn.addEventListener('click', editProfile);

            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
            initGame();
        });
    </script>
</body>
</html>
