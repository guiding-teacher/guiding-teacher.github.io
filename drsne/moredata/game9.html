<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <title>لعبة توصيل المتشابهات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        
        :root {
            --primary-color: #8e44ad;
            --secondary-color: #9b59b6;
            --correct-color: #2ecc71;
            --background-color: #ecf0f1;
            --board-color: #ffffff;
            --font-family: 'Cairo', sans-serif;
            --line-color: #f1c40f;
            --hotspot-color: #8e44ad;
            --hotspot-glow: rgba(142, 68, 173, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-family); background-color: var(--background-color);
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; padding: 10px; overflow: hidden;
        }

        .game-container {
            width: 100%; max-width: 800px; background-color: var(--board-color);
            border-radius: 25px; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            padding: 10px; text-align: center;
            display: flex; flex-direction: column; height: 95vh;
        }

        .game-header { margin-bottom: 5px; flex-shrink: 0; }
        .prompt-bar {
            font-size: 1.2rem; font-weight: 700; color: #fff;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 10px; border-radius: 12px;
        }
        
        .progress-bar { width: 100%; height: 6px; background-color: #e0e0e0; border-radius: 3px; overflow: hidden; margin: 8px 0; }
        .progress-fill { width: 0%; height: 100%; background: var(--correct-color); border-radius: 3px; transition: width 0.5s ease; }
        
        .matching-area {
            position: relative; width: 100%; flex-grow: 1;
            border-radius: 12px; overflow: hidden;
            background-size: contain; background-position: center;
            background-repeat: no-repeat;
            touch-action: none; /* مهم جداً للهواتف */
        }
        
        .matching-area canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #background-canvas { z-index: 1; pointer-events: none; }
        #drawing-canvas { z-index: 2; }

        .game-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 100; opacity: 0; visibility: hidden; transition: all 0.3s ease; backdrop-filter: blur(5px); }
        .game-overlay.visible { opacity: 1; visibility: visible; }
        
        .popup { background: white; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); transform: scale(0.9); transition: transform 0.3s ease; width: 90%; max-width: 350px; }
        .game-overlay.visible .popup { transform: scale(1); }
        .popup-title { font-size: 1.5rem; margin-bottom: 15px; color: #333; }
        .popup-button { font-family: var(--font-family); padding: 12px 30px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: white; border: none; border-radius: 50px; font-size: 1.2rem; cursor: pointer; width: 100%; }
        
        .popup-image { max-width: 120px; max-height: 120px; border-radius: 10px; margin-bottom: 10px; }
        #info-popup .popup-content { display: flex; flex-direction: column; align-items: center; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake 0.4s ease-in-out; }
    </style>
</head>
<body>

<div class="game-container" id="game-container">
    <div class="game-header">
        <div class="prompt-bar" id="prompt-bar">صل بين الأشياء المتشابهة</div>
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
    </div>
    <div class="matching-area" id="matching-area">
        <canvas id="background-canvas"></canvas>
        <canvas id="drawing-canvas"></canvas>
    </div>
</div>

<div class="game-overlay visible" id="start-overlay"><div class="popup"><i class="fas fa-link" style="font-size: 3rem; color:var(--primary-color); margin-bottom:10px;"></i><h2 class="popup-title">هل أنت مستعد للتوصيل؟</h2><button id="start-button" class="popup-button">ابدأ اللعب</button></div></div>
<div class="game-overlay" id="final-win-overlay"><div class="popup"><i class="fas fa-trophy" style="font-size: 3rem; color: #ffc107; margin-bottom:10px;"></i><h2 class="popup-title">عمل رائع! لقد وصلت كل الأشكال!</h2><button id="restart-button" class="popup-button">العب مرة أخرى</button></div></div>

<div class="game-overlay" id="info-popup">
    <div class="popup">
        <div class="popup-content">
            <img id="info-image" class="popup-image" src="" alt="وصف الصورة">
            <h2 id="info-title" class="popup-title"></h2>
            <button id="info-close-button" class="popup-button" style="background: var(--correct-color);">متابعة</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // العناصر
    const gameContainer = document.getElementById('game-container');
    const matchingArea = document.getElementById('matching-area');
    const progressFill = document.getElementById('progress-fill');
    const canvases = { bg: document.getElementById('background-canvas'), draw: document.getElementById('drawing-canvas') };
    const ctx = { bg: canvases.bg.getContext('2d'), draw: canvases.draw.getContext('2d') };
    const overlays = { start: document.getElementById('start-overlay'), win: document.getElementById('final-win-overlay'), info: document.getElementById('info-popup') };
    const buttons = { start: document.getElementById('start-button'), restart: document.getElementById('restart-button'), infoClose: document.getElementById('info-close-button') };
    const infoElems = { img: document.getElementById('info-image'), title: document.getElementById('info-title') };

    // الثوابت
    const HOTSPOT_RADIUS = 40; // زيادة المنطقة القابلة للمس قليلاً للهواتف

    // البيانات
    const gamePairs=[
        {id:'flower',itemA_pos:{x:25.5,y:12},itemB_pos:{x:26.5,y:30},imageSrc:'https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExcm82YzZrcWZjMm5pNjZ0eDRjd2lsY2pvM3h2NjM3ZjlyOTlscjR6ayZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/yDpFRI246xNLzNoaCm/giphy.gif',description:'زهرة التوليب',isMatched:false},
        {id:'teacup',itemA_pos:{x:57,y:14.5},itemB_pos:{x:66.5,y:30},imageSrc:'https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExZGp2eWNhajh3enlsbjR2YzYzNm4zbGZhNTFqanlsZGk5ZnJ5eHF4aiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/SteB4dSAcvz4Q/giphy.gif',description:'فنجان شاي',isMatched:false},
        {id:'table',itemA_pos:{x:30,y:38},itemB_pos:{x:30,y:55},imageSrc:'https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExcjljMnltOGt5ajVzbmo5ZWo2ajNrZnM5YTBqdnB0aWg5dm9tcjExaCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/xT9IgjnrmEsKNUmEKc/giphy.gif',description:'طاولة',isMatched:false},
        {id:'vase',itemA_pos:{x:85,y:35},itemB_pos:{x:70,y:55},imageSrc:'https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExdWl0MHV0OXlzM3ZtNXl2N3VlNzVvdHl3emZ1NHZyMWQ2dTI3aWQ1MiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/le5OhP9YOxnBZt5vgz/giphy.gif',description:'مزهرية',isMatched:false},
        {id:'flag',itemA_pos:{x:18,y:65},itemB_pos:{x:30,y:80},imageSrc:'https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExMDQ3ejdobjQ0Nndoemw4M2EwZDB5Zjk5cjl2Mjd2MmQ0MXB0cG45cyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/5qGClwRT54rcvzrs7x/giphy.gif',description:'علم العراق',isMatched:false},
        {id:'apple',itemA_pos:{x:55,y:65},itemB_pos:{x:70,y:80},imageSrc:'https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExZXp5enIzMHNyZ2tnYmV1bXp6d2c0b2tjMjIwMDRsemh0MzVhNDFtdyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Jr1LxCGe5emwDXwHki/giphy.gif',description:'تفاحة حمراء',isMatched:false}
    ];

    // حالة اللعبة
    let isGameActive = false;
    let isDrawing = false;
    let selectedItem = null;
    let matchedCount = 0;
    let scale = 1;
    let imageRenderInfo = { x: 0, y: 0, width: 0, height: 0 };
    
    // الصورة الخلفية
    const backgroundImage = new Image();
    const imagePath = '../images/ga9.jpg';

    // التحميل المسبق
    function preloadGameImages() {
        gamePairs.forEach(pair => { new Image().src = pair.imageSrc; });
    }

    // النطق
    function speak(text) {
        if (typeof Android !== 'undefined' && Android.speakArabic) {
            Android.speakArabic(text);
        } else if (window.speechSynthesis) {
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ar-SA';
            speechSynthesis.speak(u);
        }
    }

    // التهيئة
    function init() {
        preloadGameImages();
        backgroundImage.onload = () => {
            matchingArea.style.backgroundImage = `url('${imagePath}')`;
            setupEventListeners();
            window.addEventListener('resize', resizeAndDrawAll);
            resizeAndDrawAll();
        };
        backgroundImage.src = imagePath;
    }

    // بدء اللعبة
    function startGame() {
        overlays.start.classList.remove('visible');
        isGameActive = true;
        gamePairs.forEach(p => p.isMatched = false);
        matchedCount = 0;
        updateProgressBar();
        resizeAndDrawAll();
    }

    // الحسابات والرسم
    function calculateImageRenderSize() {
        const cw = canvases.bg.width;
        const ch = canvases.bg.height;
        const imgRatio = backgroundImage.naturalWidth / backgroundImage.naturalHeight;
        const canvasRatio = cw / ch;
        
        let rw, rh, x, y;
        if (canvasRatio > imgRatio) {
            rh = ch; rw = ch * imgRatio;
            x = (cw - rw) / 2; y = 0;
        } else {
            rw = cw; rh = cw / imgRatio;
            x = 0; y = (ch - rh) / 2;
        }
        imageRenderInfo = { x, y, width: rw, height: rh };
        scale = rw / 800; // مقياس تقريبي
    }

    function resizeAndDrawAll() {
        const rect = matchingArea.getBoundingClientRect();
        Object.values(canvases).forEach(c => { c.width = rect.width; c.height = rect.height; });
        calculateImageRenderSize();
        drawScene();
    }

    function percentToPixel(p) {
        return {
            x: imageRenderInfo.x + (p.x / 100) * imageRenderInfo.width,
            y: imageRenderInfo.y + (p.y / 100) * imageRenderInfo.height
        };
    }

    // الحصول على الإحداثيات (مصحح للموبايل)
    function getCanvasCoords(e) {
        const rect = canvases.draw.getBoundingClientRect();
        let clientX, clientY;
        
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else if (e.changedTouches && e.changedTouches.length > 0) {
            clientX = e.changedTouches[0].clientX;
            clientY = e.changedTouches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        
        return { x: clientX - rect.left, y: clientY - rect.top };
    }

    // الرسم
    function drawScene() {
        ctx.bg.clearRect(0, 0, canvases.bg.width, canvases.bg.height);
        gamePairs.forEach(pair => {
            if (pair.isMatched) {
                drawPermanentLine(pair.itemA_pos, pair.itemB_pos);
            } else {
                drawHotspot(pair.itemA_pos);
                drawHotspot(pair.itemB_pos);
            }
        });
    }

    function drawPermanentLine(pos1, pos2) {
        const p1 = percentToPixel(pos1);
        const p2 = percentToPixel(pos2);
        ctx.bg.beginPath(); ctx.bg.moveTo(p1.x, p1.y); ctx.bg.lineTo(p2.x, p2.y);
        ctx.bg.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--correct-color');
        ctx.bg.lineWidth = 6 * scale; ctx.bg.lineCap = 'round';
        ctx.bg.stroke();
    }

    function drawHotspot(pos) {
        const p = percentToPixel(pos);
        const radius = 12 * scale;
        // هالة
        ctx.bg.beginPath(); ctx.bg.arc(p.x, p.y, radius + 5, 0, Math.PI * 2);
        ctx.bg.fillStyle = 'rgba(142, 68, 173, 0.4)'; ctx.bg.fill();
        // نقطة
        ctx.bg.beginPath(); ctx.bg.arc(p.x, p.y, radius, 0, Math.PI * 2);
        ctx.bg.fillStyle = '#8e44ad'; ctx.bg.fill();
    }

    function drawTemporaryLine(endPos) {
        ctx.draw.clearRect(0, 0, canvases.draw.width, canvases.draw.height);
        const startPos = selectedItem.pos;
        ctx.draw.beginPath(); ctx.draw.moveTo(startPos.x, startPos.y); ctx.draw.lineTo(endPos.x, endPos.y);
        ctx.draw.strokeStyle = '#f1c40f'; ctx.draw.lineWidth = 6 * scale; ctx.draw.lineCap = 'round';
        ctx.draw.setLineDash([10, 10]); ctx.draw.stroke(); ctx.draw.setLineDash([]);
    }

    // منطق اللعبة
    function findClickedItem(pos) {
        for (const pair of gamePairs) {
            const p1 = percentToPixel(pair.itemA_pos);
            if (distance(pos, p1) < HOTSPOT_RADIUS * scale) return { pair, itemKey: 'itemA', pos: p1 };
            
            const p2 = percentToPixel(pair.itemB_pos);
            if (distance(pos, p2) < HOTSPOT_RADIUS * scale) return { pair, itemKey: 'itemB', pos: p2 };
        }
        return null;
    }

    function distance(p1, p2) { return Math.hypot(p1.x - p2.x, p1.y - p2.y); }

    // معالجات الأحداث
    function handleStart(e) {
        if (!isGameActive) return;
        e.preventDefault(); // منع التمرير
        const pos = getCanvasCoords(e);
        const item = findClickedItem(pos);
        
        if (item && !item.pair.isMatched) {
            isDrawing = true;
            selectedItem = item;
        }
    }

    function handleMove(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const pos = getCanvasCoords(e);
        drawTemporaryLine(pos);
    }

    function handleEnd(e) {
        if (!isDrawing) return;
        isDrawing = false;
        ctx.draw.clearRect(0, 0, canvases.draw.width, canvases.draw.height);
        
        const pos = getCanvasCoords(e);
        const targetItem = findClickedItem(pos);
        
        if (selectedItem && targetItem && 
            selectedItem.pair.id === targetItem.pair.id && 
            selectedItem.itemKey !== targetItem.itemKey) {
            
            handleCorrectMatch(selectedItem.pair);
        } else {
            handleIncorrectMatch();
        }
        selectedItem = null;
    }

    function handleCorrectMatch(pair) {
        pair.isMatched = true;
        matchedCount++;
        updateProgressBar();
        resizeAndDrawAll();
        showInfoPopup(pair);
        
        if (matchedCount === gamePairs.length) {
            isGameActive = false;
            setTimeout(() => overlays.win.classList.add('visible'), 1500);
        }
    }

    function handleIncorrectMatch() {
        gameContainer.classList.add('shake');
        setTimeout(() => gameContainer.classList.remove('shake'), 400);
    }

    // النوافذ المنبثقة
    function showInfoPopup(pair) {
        isGameActive = false;
        infoElems.img.src = pair.imageSrc;
        infoElems.title.textContent = pair.description;
        overlays.info.classList.add('visible');
        speak(pair.description);
    }

    function hideInfoPopup() {
        isGameActive = true;
        overlays.info.classList.remove('visible');
    }

    function updateProgressBar() {
        progressFill.style.width = `${(matchedCount / gamePairs.length) * 100}%`;
    }

    // الاستماع للأحداث
    function setupEventListeners() {
        const c = canvases.draw;
        
        // الماوس
        c.addEventListener('mousedown', handleStart);
        c.addEventListener('mousemove', handleMove);
        document.addEventListener('mouseup', handleEnd);
        
        // اللمس
        c.addEventListener('touchstart', handleStart, { passive: false });
        c.addEventListener('touchmove', handleMove, { passive: false });
        c.addEventListener('touchend', handleEnd);
        
        // الأزرار
        buttons.start.onclick = startGame;
        buttons.restart.onclick = () => { overlays.win.classList.remove('visible'); startGame(); };
        buttons.infoClose.onclick = hideInfoPopup;
    }
    
    // حلقة الحركة (للتأكد من الرسم المستمر)
    function animate() {
        if (isGameActive && !isDrawing) {
            // تأثير نبض خفيف للنقاط غير المتصلة يمكن إضافته هنا
            drawScene();
        }
        requestAnimationFrame(animate);
    }

    init();
    animate();
});
</script>
</body>
</html>