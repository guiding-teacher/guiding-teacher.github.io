<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>محرر الصور والنصوص التفاعلي</title>

    <!-- تضمين مكتبة jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- تضمين خطوط Google Fonts العربية -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&family=Amiri:ital,wght@0,400;0,700;1,400;1,700&family=Aref+Ruqaa+Ink:wght@400;700&family=Aref+Ruqaa:wght@400;700&family=Cairo:wght@200..1000&family=Changa:wght@200..800&family=El+Messiri:wght@400..700&family=Harmattan:wght@400;700&family=IBM+Plex+Sans+Arabic:wght@100..700&family=Jomhuria&family=Katibeh&family=Lalezar&family=Lateef:wght@200..800&family=Lemonada:wght@300..700&family=Mada:wght@200..900&family=Markazi+Text:wght@400..700&family=Mirza:wght@400..700&family=Noto+Kufi+Arabic:wght@100..900&family=Noto+Naskh+Arabic:wght@400..700&family=Noto+Sans+Arabic:wght@100..900&family=Readex+Pro:wght@160..700&family=Reem+Kufi+Fun:wght@400..700&family=Reem+Kufi+Ink:wght@400&family=Reem+Kufi:wght@400..700&family=Ruwudu:wght@400..700&family=Scheherazade+New:wght@400;700&family=Tajawal:wght@200..900&family=Vibes&family=Gulzar&family=Alkalami&family=Noto+Nastaliq+Urdu&family=Alkalami&family=Mirza&display=swap" rel="stylesheet">

    <!-- تضمين Font Awesome للأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --primary-color: #4a6fa5; --secondary-color: #6c757d; --light-color: #f8f9fa;
            --dark-color: #343a40; --background-color: #f5f7fa; --danger-color: #e74c3c;
            --success-color: #2ecc71; --info-color: #3498db; --shadow-color: rgba(0, 0, 0, 0.1);
            --a4-width-px: 794px; --a4-height-px: 1123px; --toolbar-bg: #2c3e50;
            --toolbar-text: #ecf0f1; --toolbar-hover: #34495e; --toolbar-active: #1abc9c;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body {
            font-family: 'Cairo', sans-serif; background-color: var(--background-color); color: var(--dark-color);
            direction: rtl; text-align: right; min-height: 100vh; display: flex; flex-direction: column;
            align-items: center; padding: 1rem; line-height: 1.6; user-select: none; -webkit-user-select: none;
            -moz-user-select: none; -ms-user-select: none; overflow-x: hidden;
        }
        h1 {
            color: var(--primary-color); margin-bottom: 1rem; text-align: center; font-family: 'Changa', sans-serif;
            font-weight: 700; font-size: 2.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #image-selection-area {
            background-color: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 6px 18px var(--shadow-color);
            margin-bottom: 1.5rem; width: 100%; max-width: 900px; display: flex; flex-direction: column; transition: all 0.3s ease;
        }
        #image-selection-area h2 {
            text-align: center; margin-bottom: 1.5rem; color: var(--primary-color); font-size: 1.4rem;
            font-family: 'Tajawal', sans-serif; font-weight: 600;
        }
        #image-gallery {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1.2rem; max-height: 350px;
            overflow-y: auto; padding: 0.8rem; border: 1px solid #eee; margin-bottom: 1.2rem; background-color: #fdfdfd; border-radius: 8px;
        }
        .gallery-item {
            display: flex; flex-direction: column; align-items: center; gap: 0.8rem; border: 1px solid #e0e0e0; padding: 0.8rem;
            border-radius: 8px; background-color: white; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.05); cursor: pointer;
        }
        .gallery-item:hover { transform: translateY(-5px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); border-color: var(--primary-color); }
        .gallery-item img { max-width: 100%; height: 100px; object-fit: cover; border-radius: 6px; }
        .gallery-item button {
            font-size: 0.9rem; padding: 0.5rem 0.8rem; cursor: pointer; background-color: var(--primary-color); color: white;
            border: none; border-radius: 6px; transition: all 0.3s ease; width: 100%; font-family: 'Tajawal', sans-serif;
        }
        #upload-section { margin-top: 1.2rem; border-top: 1px dashed #ddd; padding-top: 1.2rem; text-align: center; }
        #large-upload-button {
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.8rem;
            background-color: var(--primary-color); color: white; border-radius: 12px; cursor: pointer; transition: all 0.3s ease;
            width: 100%; min-height: 120px; font-size: 1.3rem; border: 2px dashed rgba(255,255,255,0.3); font-family: 'Tajawal', sans-serif;
        }
        #imageLoader { display: none; }
        #editor-screen { display: none; flex-direction: column; align-items: center; width: 100%; }
        #editor-main-area {
            display: flex; flex-direction: row-reverse; gap: 1.5rem; width: 100%; max-width: 1400px; align-items: flex-start;
        }
        #canvas-container {
            flex: 1; min-width: 0; /* Changed for flexbox wrapping */
            border: 1px solid #d1d8e0; box-shadow: 0 8px 24px var(--shadow-color);
            background-color: white; position: relative; overflow: hidden; aspect-ratio: var(--a4-width-px) / var(--a4-height-px);
            height: auto; touch-action: none; border-radius: 8px;
        }
        #imageCanvas { display: block; width: 100%; height: 100%; cursor: crosshair; background-color: #f1f5f9; }
        #imageCanvas.grabbing { cursor: grabbing; }

        /* --- In-place text editor styles --- */
        #inline-text-editor {
            position: absolute; display: none; z-index: 100;
            background: transparent; border: 1px dashed var(--info-color);
            padding: 0; margin: 0; resize: none; overflow: hidden;
            text-align: right; white-space: pre-wrap;
            transform-origin: top right;
        }

        /* --- Contextual menu for images --- */
        #image-context-menu {
            position: absolute; display: none; z-index: 101;
            background: rgba(44, 62, 80, 0.9); padding: 6px;
            border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            display: flex; gap: 6px; transform: translate(50%, -110%);
        }
        .context-menu-button {
            background: var(--toolbar-hover); color: white; border: none;
            width: 32px; height: 32px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1rem;
        }
        .context-menu-button.delete { background-color: var(--danger-color); }
        .context-menu-button:hover { filter: brightness(1.2); }
        
        #loading-indicator {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.85);
            color: white; padding: 20px 30px; border-radius: 12px; font-size: 1.2rem; display: none; z-index: 200;
        }
        #toolbar {
            flex-basis: 340px; min-width: 254px; background-color: var(--toolbar-bg); padding: 1rem; border-radius: 12px;
            box-shadow: 0 6px 18px var(--shadow-color); display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;
            color: var(--toolbar-text); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto;
        }
         
        .tool-group { display: flex; flex-direction: column; gap: 0.4rem; position: relative; }
        .tool-group.full-width { grid-column: 1 / -1; }
        .tool-group label { font-size: 0.85rem; color: var(--toolbar-text); margin-bottom: -0.3rem; white-space: nowrap; font-family: 'Tajawal', sans-serif; }
        .input-spinner { display: flex; align-items: center; width: 100%; border: 2px solid #3d5166; border-radius: 10px; overflow: hidden; }
        .input-spinner input[type="number"] {
            flex-grow: 1; padding: 0.2rem; border: none; font-size: 1rem; text-align: center;
            background-color: #2c3e50; color: var(--toolbar-text); -moz-appearance: textfield; appearance: textfield;
        }
        .input-spinner input::-webkit-outer-spin-button, .input-spinner input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-spinner button {
            background-color: #3d5166; border: none; color: var(--toolbar-text); padding: 0 0.4rem; cursor: pointer; font-size: 1.6rem; align-self: stretch;
        }
        .input-spinner button:hover:not(:disabled) { background-color: var(--toolbar-hover); }
        .input-spinner button:disabled { opacity: 0.5; cursor: not-allowed; }
        #toolbar select, #toolbar input[type="color"], #toolbar input[type="range"] {
            width: 100%; padding: 0.2rem; border: 1px solid #3d5166; border-radius: 8px; font-size: 0.95rem;
            background-color: #2c3e50; color: var(--toolbar-text);
        }
        #toolbar input[type="color"] { padding: 0.2rem; height: 30px; cursor: pointer; }
        .style-buttons, #global-controls { display: flex; gap: 0.6rem; grid-column: 1 / -1; flex-wrap: wrap; justify-content: flex-start; }
        .style-button, .global-control-button {
            padding: 0.6rem 0.8rem; border: 1px solid #3d5166; background-color: #34495e; border-radius: 8px; cursor: pointer;
            font-size: 0.95rem; font-weight: bold; min-width: 40px; color: var(--toolbar-text); display: flex; align-items: center; justify-content: center; gap: 0.4rem;
        }
        .style-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .style-button:hover:not(:disabled) { background-color: var(--toolbar-hover); }
        .style-button.active { background-color: var(--toolbar-active); color: white; }
        #deleteTextBtn { background-color: var(--danger-color); color: white; border: none; margin-right: auto; }
        #zoom-controls { position: fixed; bottom: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .zoom-button {
            width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color); color: white;
            display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #action-buttons { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 1400px; margin: 1.5rem auto 0 auto; }
        .action-button {
            padding: 0.8rem 1.5rem; border: none; border-radius: 8px; background-color: var(--primary-color); color: white;
            font-size: 1rem; font-weight: 600; cursor: pointer; flex-grow: 1; min-width: 150px;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .action-button:disabled { opacity: 0.6; cursor: not-allowed; background-color: var(--secondary-color); }
        .toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 9999; }
        .toast {
            background: white; border-left: 5px solid; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px 20px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;
            opacity: 0; transform: translateX(-100%); transition: all 0.4s ease-in-out;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        
        #addImageBtn { font-size: 1rem; }
        
        /* --- RESPONSIVE STYLES --- */
        @media (max-width: 1024px) {
            body { padding: 0.5rem; }
            h1 { font-size: 1.8rem; margin-bottom: 0.8rem; }
            #editor-main-area { flex-direction: column; gap: 1rem; }
            #toolbar { 
                width: 100%; max-width: none; position: static; 
                order: 2; /* Toolbar appears after canvas */
                max-height: 45vh; /* Limit height to 45% of the viewport height */
                overflow-y: auto; /* Add a scrollbar if content overflows */
            }
            
            #canvas-container { 
                width: 100%; max-width: var(--a4-width-px); margin: 0 auto;
                order: 1; /* Canvas appears first */
            }
            
            #action-buttons { margin-top: 1rem; }
        }
    </style>
</head>
<body>
    <button onclick="window.location.href='index.html'" style="all: unset; position: fixed; top: 10px; left: 20px; font-size: 30px; color: #b7b63c; text-shadow: 1px 1px 1px #52484a; cursor: pointer; z-index: 9999;">
        <i class="fas fa-home"></i> 
    </button>
   
    <div id="image-selection-area">
         <h1>محرر الصور والنصوص التفاعلي</h1>
        <h2>اختر صورة للبدء</h2>
        <div id="image-gallery">
            <div class="gallery-item"><img src="images/bbr123.png" data-src="images/bbr123.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbraa.png" data-src="images/bbraa.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrdd.png" data-src="images/bbrdd.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrff.png" data-src="images/bbrff.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrgg.png" data-src="images/bbrgg.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrhh.png" data-src="images/bbrhh.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrjj.png" data-src="images/bbrjj.png"><button>استخدام</button></div>
            <div class="gallery-item"><img src="images/bbrss.png" data-src="images/bbrss.png"><button>استخدام</button></div>
        </div>
        <div id="upload-section">
            <input type="file" id="imageLoader" accept="image/*"/>
            <label for="imageLoader" id="large-upload-button">
                <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg" style="width: 48px; height: 48px; margin-bottom: 0.8rem;"><path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/></svg>
                <span>اختر صورة من جهازك</span>
            </label>
        </div>
    </div>

    <div id="editor-screen">
        <div id="editor-main-area">
            <div id="canvas-container">
                <canvas id="imageCanvas"></canvas>
                <textarea id="inline-text-editor"></textarea>
                <div id="image-context-menu">
                    <button class="context-menu-button" id="ctxScaleUpBtn" title="تكبير"><i class="fas fa-search-plus"></i></button>
                    <button class="context-menu-button" id="ctxScaleDownBtn" title="تصغير"><i class="fas fa-search-minus"></i></button>
                    <!-- **** NEW: زر إعادة تعيين الصورة **** -->
                    <button class="context-menu-button" id="ctxResetImageBtn" title="إعادة تعيين"><i class="fas fa-sync-alt"></i></button>
                    <button class="context-menu-button delete" id="ctxDeleteImageBtn" title="حذف"><i class="fas fa-trash"></i></button>
                </div>
                <div id="loading-indicator"></div>
            </div>
            <div id="toolbar">
                <div class="tool-group"><label for="fontSize">الحجم:</label><div class="input-spinner"><button class="spinner-btn decrease" data-target="fontSize">-</button><input type="number" id="fontSize" value="48" min="8" max="500"><button class="spinner-btn increase" data-target="fontSize">+</button></div></div>
                <!-- **** MODIFIED: تم تغيير id من fontColor إلى color لإصلاح المشكلة **** -->
                <div class="tool-group"><label for="color">لون الخط:</label><input type="color" id="color" value="#000000"></div>
                <div class="tool-group"><label for="strokeColor">لون الحد:</label><input type="color" id="strokeColor" value="#ffffff"></div>
                <div class="tool-group"><label for="strokeWidth">عرض الحد:</label><div class="input-spinner"><button class="spinner-btn decrease" data-target="strokeWidth">-</button><input type="number" id="strokeWidth" value="0" min="0" max="50"><button class="spinner-btn increase" data-target="strokeWidth">+</button></div></div>
                <div class="tool-group"><label for="bgColor">لون الخلفية:</label><input type="color" id="bgColor" value="#ffffff"></div>
                <div class="tool-group"><label for="bgOpacity">شفافية الخلفية:</label><input type="range" id="bgOpacity" min="0" max="1" step="0.1" value="0"></div>
                <div class="tool-group full-width"><label for="fontFamily">نوع الخط:</label><select id="fontFamily"><option value="'Cairo', sans-serif">Cairo</option><option value="'Noto Kufi Arabic', sans-serif">Noto Kufi Arabic</option><option value="'Reem Kufi', sans-serif">Reem Kufi</option><option value="'Aref Ruqaa', serif">Aref Ruqaa</option><option value="'Amiri', serif">Amiri</option><option value="'Tajawal', sans-serif">Tajawal</option><option value="'Changa', sans-serif">Changa</option></select></div>
                <div class="tool-group"><label for="opacity">شفافية النص:</label><input type="range" id="opacity" min="0" max="1" step="0.05" value="1"></div>
                <div class="tool-group"><label for="letterSpacing">تباعد الأحرف:</label><div class="input-spinner"><button class="spinner-btn decrease" data-target="letterSpacing">-</button><input type="number" id="letterSpacing" value="0" min="-10" max="50" step="1"><button class="spinner-btn increase" data-target="letterSpacing">+</button></div></div>
                <div class="tool-group"><label for="rotation">الدوران:</label><div class="input-spinner"><button class="spinner-btn decrease" data-target="rotation">-</button><input type="number" id="rotation" value="0" min="-180" max="180" step="5"><button class="spinner-btn increase" data-target="rotation">+</button></div></div>
                <div class="tool-group"><label for="lineHeight">تباعد الأسطر:</label><div class="input-spinner"><button class="spinner-btn decrease" data-target="lineHeight">-</button><input type="number" id="lineHeight" value="1.2" min="0.8" max="3" step="0.1"><button class="spinner-btn increase" data-target="lineHeight">+</button></div></div>
               
                <div class="tool-group full-width" style="margin-top: 1rem;">
                    <button class="global-control-button" id="addImageBtn"><i class="fas fa-plus"></i> إضافة صورة</button>
                
                <div id="image-tools-container" class="full-width" style="display: none; flex-direction: column; gap: -3rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #4a637d;">
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 1.2rem;">
                        <div class="tool-group">
                            <label for="imageRotation">الدوران:</label>
                            <div class="input-spinner"><button class="spinner-btn decrease" data-target="imageRotation">-</button><input type="number" id="imageRotation" value="0" min="-184" max="180" step="5"><button class="spinner-btn increase" data-target="imageRotation">+</button></div>
                        </div>
                        <div class="tool-group">
                            <label for="imageWidth">العرض (px):</label>
                            <div class="input-spinner"><button class="spinner-btn decrease" data-target="imageWidth">-</button><input type="number" id="imageWidth" value="100" min="-184" max="180" step="5"><button class="spinner-btn increase" data-target="imageWidth">+</button></div>
                        </div>
                        <div class="tool-group">
                            <label for="imageHeight">الارتفاع (px):</label>
                            <div class="input-spinner"><button class="spinner-btn decrease" data-target="imageHeight">-</button><input type="number" id="imageHeight" value="100" min="-184" max="180" step="5"><button class="spinner-btn increase" data-target="imageHeight">+</button></div>
                        </div>
                    </div>
                </div>
                </div>
                
                <div class="style-buttons"><button class="style-button" id="boldBtn"><b>B</b></button><button class="style-button" id="italicBtn"><i>I</i></button><button class="style-button" id="underlineBtn"><u>U</u></button><button class="style-button" id="shadowBtn">ظل</button><button class="style-button" id="copyTextBtn">نسخ</button><button class="style-button" id="pasteTextBtn">لصق</button><button class="style-button" id="deleteTextBtn"><i class="fas fa-trash"></i></button></div>
            </div>
        </div>
        <div id="action-buttons">
            <button id="saveBtn" class="action-button"><i class="fas fa-save"></i> حفظ (PNG)</button>
            <button id="pdfBtn" class="action-button"><i class="fas fa-file-pdf"></i> تصدير PDF</button>
            <button id="printBtn" class="action-button"><i class="fas fa-print"></i> طباعة</button>
            <button id="resetBtn" class="action-button"><i class="fas fa-sync-alt"></i> اختيار صورة أخرى</button>
        </div>
    </div>
    <div id="zoom-controls">
        <div class="zoom-button" id="zoomInBtn"><i class="fas fa-plus"></i></div>
        <div class="zoom-button" id="zoomOutBtn"><i class="fas fa-minus"></i></div>
        <div class="zoom-button" id="resetZoomBtn"><i class="fas fa-sync-alt"></i></div>
    </div>
    <div class="toast-container"></div>

    <script>
    (function() {
        'use strict';
        const imageSelectionArea = document.getElementById('image-selection-area');
        const editorScreen = document.getElementById('editor-screen');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const toolbar = document.getElementById('toolbar');
        const inlineTextEditor = document.getElementById('inline-text-editor');
        const imageContextMenu = document.getElementById('image-context-menu');
        const imageToolsContainer = document.getElementById('image-tools-container');

        let currentImage = null, originalImageWidth = 0, originalImageHeight = 0;
        let textObjects = [], overlayImages = [];
        let selectedTextIndex = -1, selectedImageIndex = -1;
        let isDragging = false, dragStartX = 0, dragStartY = 0, didMove = false;
        let copiedTextObject = null;
        let canvasScale = 1, canvasOffsetX = 0, canvasOffsetY = 0;
        let lastTapTime = 0;

        function setupEventListeners() {
            document.getElementById('image-gallery').addEventListener('click', (e) => {
                const item = e.target.closest('.gallery-item');
                if (item) loadImage(item.querySelector('img').dataset.src);
            });
            document.getElementById('imageLoader').addEventListener('change', handleImageUpload);
            setupCanvasListeners();
            toolbar.addEventListener('input', handleToolbarInteraction);
            toolbar.addEventListener('click', (e) => {
                if (e.target.closest('.style-button, .spinner-btn, .global-control-button')) {
                    handleToolbarInteraction(e);
                }
            });
            
            inlineTextEditor.addEventListener('input', autoResizeTextarea);
            inlineTextEditor.addEventListener('blur', confirmInlineTextEdit);

            document.getElementById('ctxScaleUpBtn').addEventListener('click', () => handleImageAction('scaleUp'));
            document.getElementById('ctxScaleDownBtn').addEventListener('click', () => handleImageAction('scaleDown'));
            // **** NEW: Listener for the reset button ****
            document.getElementById('ctxResetImageBtn').addEventListener('click', () => handleImageAction('reset'));
            document.getElementById('ctxDeleteImageBtn').addEventListener('click', () => handleImageAction('delete'));

            document.getElementById('saveBtn').addEventListener('click', () => withLoading(document.getElementById('saveBtn'), saveImage));
            document.getElementById('pdfBtn').addEventListener('click', () => withLoading(document.getElementById('pdfBtn'), exportToPDF));
            document.getElementById('printBtn').addEventListener('click', () => withLoading(document.getElementById('printBtn'), printCanvas));
            document.getElementById('resetBtn').addEventListener('click', resetEditor);
            document.getElementById('zoomInBtn').addEventListener('click', () => adjustCanvasZoom(0.1));
            document.getElementById('zoomOutBtn').addEventListener('click', () => adjustCanvasZoom(-0.1));
            document.getElementById('resetZoomBtn').addEventListener('click', resetCanvasZoom);
        }

        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => loadImage(event.target.result);
                reader.readAsDataURL(file);
                showLoading(true, "جارٍ تحميل الملف...");
            }
            e.target.value = null;
        }

        function setupCanvasListeners() {
            const getEventCoords = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                return { x: (clientX - rect.left) / (rect.width / canvas.width), y: (clientY - rect.top) / (rect.height / canvas.height) };
            };

            const handleStart = (e) => {
                if (!currentImage || inlineTextEditor.style.display === 'block') return;
                e.preventDefault();
                const coords = getEventCoords(e);
                dragStartX = coords.x; dragStartY = coords.y;
                didMove = false;
                
                const textIndex = findTextIndexAt(coords.x, coords.y);
                if (textIndex !== -1) {
                    selectText(textIndex);
                    isDragging = true;
                } else {
                    const imageIndex = findImageIndexAt(coords.x, coords.y);
                    if (imageIndex !== -1) {
                        selectImage(imageIndex);
                        isDragging = true;
                    } else {
                        deselectAll();
                    }
                }
                drawCanvas();
            };

            const handleMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                didMove = true;
                const coords = getEventCoords(e);
                const dx = coords.x - dragStartX; const dy = coords.y - dragStartY;
                if (selectedTextIndex !== -1) {
                    const obj = textObjects[selectedTextIndex];
                    obj.x += dx; obj.y += dy;
                } else if (selectedImageIndex !== -1) {
                    const img = overlayImages[selectedImageIndex];
                    img.x += dx; img.y += dy;
                    updateImageContextMenuPosition();
                }
                dragStartX = coords.x; dragStartY = coords.y;
                requestAnimationFrame(drawCanvas);
            };

            const handleEnd = (e) => {
                if (e.changedTouches) {
                    const currentTime = new Date().getTime();
                    const tapLength = currentTime - lastTapTime;
                    if (tapLength < 300 && tapLength > 0) {
                        e.preventDefault();
                        handleDoubleClick(e);
                    }
                    lastTapTime = currentTime;
                }
                isDragging = false; 
            };

            const handleDoubleClick = (e) => {
                if(didMove) return;
                const coords = getEventCoords(e);
                const textIndex = findTextIndexAt(coords.x, coords.y);
                if (textIndex !== -1) {
                    selectText(textIndex);
                    editSelectedText();
                } else if (findImageIndexAt(coords.x, coords.y) === -1) {
                    addNewText(coords.x, coords.y);
                }
            };

            canvas.addEventListener('mousedown', handleStart);
            canvas.addEventListener('mousemove', handleMove);
            canvas.addEventListener('mouseup', handleEnd);
            canvas.addEventListener('mouseleave', handleEnd);
            canvas.addEventListener('dblclick', handleDoubleClick);
            canvas.addEventListener('touchstart', handleStart, { passive: false });
            canvas.addEventListener('touchmove', handleMove, { passive: false });
            canvas.addEventListener('touchend', handleEnd);
        }
        
        function loadImage(src) {
            showLoading(true, "جارٍ تحميل الصورة...");
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => {
                currentImage = img;
                originalImageWidth = img.width; originalImageHeight = img.height;
                canvas.width = originalImageWidth; canvas.height = originalImageHeight;
                resetEditorState();
                drawCanvas();
                imageSelectionArea.style.display = 'none';
                editorScreen.style.display = 'flex';
                showLoading(false);
                enableActionButtons();
            };
            img.onerror = () => { showLoading(false); showToast("خطأ في تحميل الصورة.", 'error'); };
            img.src = src;
        }

        function drawCanvas() {
            if (!ctx) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvasOffsetX, canvasOffsetY);
            ctx.scale(canvasScale, canvasScale);
            if (currentImage) ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            overlayImages.forEach((imgObj, index) => drawSingleImage(imgObj, index === selectedImageIndex));
            textObjects.forEach((textObj, index) => drawSingleText(textObj, index === selectedTextIndex));
            ctx.restore();
        }

        function drawSingleText(textObj, isSelected) {
            if (textObj.isEditing) return;

            ctx.save();
            ctx.globalAlpha = textObj.opacity;
            const font = `${textObj.italic ? 'italic' : 'normal'} ${textObj.bold ? 'bold' : 'normal'} ${textObj.fontSize}px ${textObj.fontFamily}`;
            ctx.font = font;
            ctx.textAlign = 'right'; ctx.textBaseline = 'top';
            if ('letterSpacing' in ctx) ctx.letterSpacing = `${textObj.letterSpacing || 0}px`;

            const lines = textObj.text.split('\n');
            const lineHeight = textObj.fontSize * (textObj.lineHeight || 1.2);
            let maxWidth = 0;
            lines.forEach(line => {
                const metrics = ctx.measureText(line);
                if (metrics.width > maxWidth) maxWidth = metrics.width;
            });
            const totalHeight = (lines.length * lineHeight) - (lineHeight - textObj.fontSize) * (lines.length > 0 ? 1 : 0);
            
            textObj.bounds = { x1: textObj.x - maxWidth, y1: textObj.y, width: maxWidth, height: totalHeight };

            if (textObj.rotation) {
                const centerX = textObj.x - maxWidth / 2; const centerY = textObj.y + totalHeight / 2;
                ctx.translate(centerX, centerY);
                ctx.rotate(textObj.rotation * Math.PI / 180);
                ctx.translate(-centerX, -centerY);
            }
            if (textObj.bgOpacity > 0) {
                ctx.fillStyle = textObj.bgColor;
                ctx.globalAlpha = textObj.bgOpacity * textObj.opacity;
                ctx.fillRect(textObj.bounds.x1, textObj.bounds.y1, textObj.bounds.width, textObj.bounds.height);
                ctx.globalAlpha = textObj.opacity;
            }
            if (textObj.shadow) { ctx.shadowColor = 'rgba(0,0,0,0.6)'; ctx.shadowBlur = 7; ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3; }
            
            lines.forEach((line, i) => {
                const yPos = textObj.y + (i * lineHeight);
                if (textObj.strokeWidth > 0) {
                    ctx.strokeStyle = textObj.strokeColor;
                    ctx.lineWidth = textObj.strokeWidth;
                    ctx.strokeText(line, textObj.x, yPos);
                }
                ctx.fillStyle = textObj.color;
                ctx.fillText(line, textObj.x, yPos);
            });
            
            if (isSelected) {
                ctx.strokeStyle = 'rgba(0, 123, 255, 0.9)'; ctx.lineWidth = 2; ctx.setLineDash([6, 4]);
                ctx.strokeRect(textObj.bounds.x1 - 5, textObj.bounds.y1 - 5, textObj.bounds.width + 10, textObj.bounds.height + 10);
                ctx.setLineDash([]);
            }
            ctx.restore();
        }
        
        function drawSingleImage(imgObj, isSelected) {
            ctx.save();
            ctx.translate(imgObj.x, imgObj.y);
            ctx.rotate((imgObj.rotation || 0) * Math.PI / 180);
            
            const halfW = imgObj.width / 2;
            const halfH = imgObj.height / 2;
            
            ctx.drawImage(imgObj.image, -halfW, -halfH, imgObj.width, imgObj.height);
            
            if (isSelected) {
                ctx.strokeStyle = 'rgba(0, 123, 255, 0.9)';
                ctx.lineWidth = 2;
                ctx.strokeRect(-halfW, -halfH, imgObj.width, imgObj.height);
            }
            ctx.restore();
        }

        function findTextIndexAt(x, y) {
            for (let i = textObjects.length - 1; i >= 0; i--) {
                const b = textObjects[i].bounds;
                if (b && x >= b.x1 && x <= b.x1 + b.width && y >= b.y1 && y <= b.y1 + b.height) return i;
            }
            return -1;
        }
        
        function findImageIndexAt(x, y) {
            for (let i = overlayImages.length - 1; i >= 0; i--) {
                const imgObj = overlayImages[i];
                const angle = (imgObj.rotation || 0) * Math.PI / 180;
                const cos = Math.cos(angle);
                const sin = Math.sin(angle);
                const dx = x - imgObj.x;
                const dy = y - imgObj.y;
                const rotatedX = dx * cos + dy * sin;
                const rotatedY = -dx * sin + dy * cos;
                if (Math.abs(rotatedX) <= imgObj.width / 2 && Math.abs(rotatedY) <= imgObj.height / 2) {
                    return i;
                }
            }
            return -1;
        }

        function addNewText(x, y) {
            const newTextObj = {
                text: "نص جديد", x, y, fontSize: 48, fontFamily: "'Cairo', sans-serif", color: "#000000",
                bold: false, italic: false, underline: false, shadow: false, strokeWidth: 0, bgOpacity: 0, opacity: 1,
                letterSpacing: 0, rotation: 0, lineHeight: 1.2, strokeColor: '#ffffff', bgColor: '#ffffff'
            };
            textObjects.push(newTextObj);
            selectText(textObjects.length - 1);
            drawCanvas();
            editSelectedText();
        }
        
        function editSelectedText() {
            if (selectedTextIndex === -1) return;
            const textObj = textObjects[selectedTextIndex];
            textObj.isEditing = true;
            drawCanvas();
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = rect.width / canvas.width;
            const scaleY = rect.height / canvas.height;

            inlineTextEditor.value = textObj.text;
            inlineTextEditor.style.display = 'block';
            inlineTextEditor.style.top = `${textObj.y * scaleY}px`;
            inlineTextEditor.style.right = `${(canvas.width - textObj.x) * scaleX}px`;
            inlineTextEditor.style.fontSize = `${textObj.fontSize * scaleY}px`;
            inlineTextEditor.style.fontFamily = textObj.fontFamily;
            inlineTextEditor.style.color = textObj.color;
            inlineTextEditor.style.fontWeight = textObj.bold ? 'bold' : 'normal';
            inlineTextEditor.style.fontStyle = textObj.italic ? 'italic' : 'normal';
            inlineTextEditor.style.textDecoration = textObj.underline ? 'underline' : 'none';
            inlineTextEditor.style.lineHeight = textObj.lineHeight;
            inlineTextEditor.style.letterSpacing = `${textObj.letterSpacing}px`;
            inlineTextEditor.style.transform = `rotate(${textObj.rotation}deg)`;
            
            autoResizeTextarea();
            inlineTextEditor.focus();
            inlineTextEditor.select();
        }

        function autoResizeTextarea() {
            inlineTextEditor.style.height = 'auto';
            inlineTextEditor.style.width = 'auto';
            inlineTextEditor.style.height = `${inlineTextEditor.scrollHeight}px`;
            inlineTextEditor.style.width = `${inlineTextEditor.scrollWidth}px`;
        }

        function confirmInlineTextEdit() {
            if (selectedTextIndex === -1) return;

            const textObj = textObjects[selectedTextIndex];
            delete textObj.isEditing;
            const newText = inlineTextEditor.value;
            
            inlineTextEditor.style.display = 'none';

            if (newText.trim() === "") {
                textObjects.splice(selectedTextIndex, 1);
                deselectAll();
            } else {
                textObj.text = newText;
            }
            drawCanvas();
        }

        function handleToolbarInteraction(e) {
            const target = e.target.closest('input, select, button');
            if (!target) return;
            const id = target.id;
            
            if (target.closest('.spinner-btn')) {
                const input = document.getElementById(target.dataset.target);
                const step = parseFloat(input.step) || 1;
                const currentValue = parseFloat(input.value) || 0;
                input.value = (currentValue + (target.classList.contains('increase') ? step : -step)).toFixed(step.toString().includes('.') ? 1 : 0);
                input.dispatchEvent(new Event('input', { bubbles: true })); return;
            }
            
            if (id === 'addImageBtn') {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = 'image/*';
                input.onchange = e => {
                    const reader = new FileReader();
                    reader.onload = event => {
                        const img = new Image();
                        img.onload = () => { 
                            // **** NEW: Store initial dimensions for reset ****
                            const initialWidth = img.width * 0.3;
                            const initialHeight = img.height * 0.3;
                            overlayImages.push({ 
                                image: img, x: canvas.width / 2, y: canvas.height / 2, 
                                width: initialWidth, height: initialHeight, rotation: 0,
                                initialWidth: initialWidth, initialHeight: initialHeight
                            }); 
                            selectImage(overlayImages.length - 1); 
                            drawCanvas(); 
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                };
                input.click();
            }

            if (selectedTextIndex !== -1) {
                const obj = textObjects[selectedTextIndex];
                if (id === 'deleteTextBtn') { textObjects.splice(selectedTextIndex, 1); deselectAll(); }
                else if (id === 'copyTextBtn') { copiedTextObject = JSON.parse(JSON.stringify(obj)); document.getElementById('pasteTextBtn').disabled = false; showToast("تم نسخ النص!", 'info'); }
                else if (id === 'pasteTextBtn' && copiedTextObject) { const newObj = { ...copiedTextObject, x: copiedTextObject.x + 20, y: copiedTextObject.y + 20 }; textObjects.push(newObj); selectText(textObjects.length - 1); }
                else if (target.classList.contains('style-button')) { target.classList.toggle('active'); obj[id.replace('Btn', '')] = target.classList.contains('active'); }
                else { const prop = target.id; obj[prop] = (target.type.match(/number|range/)) ? parseFloat(target.value) : target.value; }
            } else if (selectedImageIndex !== -1) {
                const imgObj = overlayImages[selectedImageIndex];
                if (id === 'imageRotation') imgObj.rotation = parseFloat(target.value);
                if (id === 'imageWidth') imgObj.width = parseFloat(target.value);
                if (id === 'imageHeight') imgObj.height = parseFloat(target.value);
            }
            drawCanvas();
        }
        
        function handleImageAction(action) {
            if (selectedImageIndex === -1) return;
            const img = overlayImages[selectedImageIndex];
            if (action === 'scaleUp') { img.width *= 1.1; img.height *= 1.1; }
            else if (action === 'scaleDown') { img.width *= 0.9; img.height *= 0.9; }
            // **** NEW: Handle the reset action ****
            else if (action === 'reset') {
                img.width = img.initialWidth;
                img.height = img.initialHeight;
                img.rotation = 0;
            }
            else if (action === 'delete') { overlayImages.splice(selectedImageIndex, 1); deselectAll(); }
            updateToolbarState();
            updateImageContextMenuPosition();
            drawCanvas();
        }

        async function withLoading(button, asyncFunc) {
            const originalContent = button.innerHTML;
            button.disabled = true; button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> جارٍ العمل...`;
            try { await asyncFunc(); }
            catch (error) { console.error(error); showToast(`حدث خطأ: ${error.message}`, 'error'); }
            finally { button.disabled = false; button.innerHTML = originalContent; }
        }

        async function saveImage() {
            const dataURL = prepareOutputCanvas().toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'edited-image.png'; link.href = dataURL; link.click();
            showToast('تم بدء تحميل الصورة!', 'success');
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: 'a4' });
            const imgData = prepareOutputCanvas().toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
            pdf.save('edited-image.pdf');
            showToast('تم تصدير PDF بنجاح!', 'success');
        }

        async function printCanvas() {
            const dataURL = prepareOutputCanvas().toDataURL('image/png');
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<html><head><title>طباعة</title><style>@page{size:A4 portrait;margin:0}body{margin:0}img{width:100%;height:100%}</style></head><body><img src="${dataURL}" onload="window.print();setTimeout(window.close, 100);"></body></html>`);
            printWindow.document.close();
        }

        function prepareOutputCanvas() {
            deselectAll(); drawCanvas();
            const outputCanvas = document.createElement('canvas');
            outputCanvas.width = originalImageWidth; outputCanvas.height = originalImageHeight;
            const outCtx = outputCanvas.getContext('2d');
            const scale = outputCanvas.width / canvas.width;
            outCtx.drawImage(currentImage, 0, 0, outputCanvas.width, outputCanvas.height);
            overlayImages.forEach(imgObj => {
                outCtx.save();
                outCtx.translate(imgObj.x * scale, imgObj.y * scale);
                outCtx.rotate((imgObj.rotation || 0) * Math.PI / 180);
                outCtx.drawImage(imgObj.image, (-imgObj.width / 2) * scale, (-imgObj.height / 2) * scale, imgObj.width * scale, imgObj.height * scale);
                outCtx.restore();
            });
            textObjects.forEach(obj => {
                const scaledObj = JSON.parse(JSON.stringify(obj));
                scaledObj.x *= scale; scaledObj.y *= scale;
                scaledObj.fontSize *= scale; scaledObj.strokeWidth *= scale;
                drawSingleTextOnContext(outCtx, scaledObj);
            });
            return outputCanvas;
        }

        function drawSingleTextOnContext(targetContext, obj) {
            targetContext.save();
            targetContext.globalAlpha = obj.opacity;
            const font = `${obj.italic ? 'italic' : 'normal'} ${obj.bold ? 'bold' : 'normal'} ${obj.fontSize}px ${obj.fontFamily}`;
            targetContext.font = font;
            targetContext.textAlign = 'right'; targetContext.textBaseline = 'top';
            if ('letterSpacing' in targetContext) targetContext.letterSpacing = `${obj.letterSpacing || 0}px`;
            const lines = obj.text.split('\n');
            const lineHeight = obj.fontSize * (obj.lineHeight || 1.2);
            let maxWidth = 0;
            lines.forEach(line => {
                const metrics = targetContext.measureText(line);
                if (metrics.width > maxWidth) maxWidth = metrics.width;
            });
            const totalHeight = (lines.length * lineHeight) - (lineHeight - obj.fontSize) * (lines.length > 0 ? 1 : 0);
            if (obj.rotation) {
                const centerX = obj.x - maxWidth / 2; const centerY = obj.y + totalHeight / 2;
                targetContext.translate(centerX, centerY);
                targetContext.rotate(obj.rotation * Math.PI / 180);
                targetContext.translate(-centerX, -centerY);
            }
            if (obj.bgOpacity > 0) {
                targetContext.fillStyle = obj.bgColor;
                targetContext.globalAlpha = obj.bgOpacity * obj.opacity;
                targetContext.fillRect(obj.x - maxWidth, obj.y, maxWidth, totalHeight);
                targetContext.globalAlpha = obj.opacity;
            }
            if (obj.shadow) { targetContext.shadowColor = 'rgba(0,0,0,0.6)'; targetContext.shadowBlur = 7; targetContext.shadowOffsetX = 3; targetContext.shadowOffsetY = 3; }
            lines.forEach((line, i) => {
                const yPos = obj.y + (i * lineHeight);
                if (obj.strokeWidth > 0) {
                    targetContext.strokeStyle = obj.strokeColor;
                    targetContext.lineWidth = obj.strokeWidth;
                    targetContext.strokeText(line, obj.x, yPos);
                }
                targetContext.fillStyle = obj.color;
                targetContext.fillText(line, obj.x, yPos);
            });
            targetContext.restore();
        }

        function selectText(index) { selectedTextIndex = index; selectedImageIndex = -1; updateToolbarState(); hideImageContextMenu(); }
        function selectImage(index) { selectedImageIndex = index; selectedTextIndex = -1; updateToolbarState(); updateImageContextMenuPosition(); }
        function deselectAll() { selectedTextIndex = -1; selectedImageIndex = -1; updateToolbarState(); hideImageContextMenu(); }
        
        function updateToolbarState() {
            const allTextInputs = toolbar.querySelectorAll('.tool-group:not(#image-tools-container .tool-group) input, .tool-group:not(#image-tools-container .tool-group) select, .style-buttons button');
            if (selectedTextIndex !== -1) {
                allTextInputs.forEach(el => el.disabled = false);
                imageToolsContainer.style.display = 'none';

                const obj = textObjects[selectedTextIndex];
                for (const key in obj) {
                    const el = document.getElementById(key) || document.getElementById(key + 'Btn');
                    if (el) {
                        if (el.classList.contains('style-button')) el.classList.toggle('active', !!obj[key]); else el.value = obj[key];
                    }
                }
            } else if (selectedImageIndex !== -1) {
                allTextInputs.forEach(el => { el.disabled = true; if(el.classList.contains('active')) el.classList.remove('active'); });
                imageToolsContainer.style.display = 'flex';

                const imgObj = overlayImages[selectedImageIndex];
                document.getElementById('imageRotation').value = imgObj.rotation || 0;
                document.getElementById('imageWidth').value = Math.round(imgObj.width);
                document.getElementById('imageHeight').value = Math.round(imgObj.height);
            } else {
                allTextInputs.forEach(el => { el.disabled = true; if(el.classList.contains('active')) el.classList.remove('active'); });
                imageToolsContainer.style.display = 'none';
            }
        }

        function resetEditorState() { textObjects = []; overlayImages = []; deselectAll(); resetCanvasZoom(); }
        function resetEditor() { currentImage = null; resetEditorState(); drawCanvas(); imageSelectionArea.style.display = 'flex'; editorScreen.style.display = 'none'; disableActionButtons(); }
        
        function updateImageContextMenuPosition() {
            if (selectedImageIndex === -1) { hideImageContextMenu(); return; }
            const imgObj = overlayImages[selectedImageIndex];
            const rect = canvas.getBoundingClientRect();
            const scaleX = rect.width / canvas.width;
            const scaleY = rect.height / canvas.height;
            const x = (imgObj.x) * scaleX;
            const y = (imgObj.y - imgObj.height / 2) * scaleY;
            imageContextMenu.style.left = `${x}px`;
            imageContextMenu.style.top = `${y}px`;
            imageContextMenu.style.display = 'flex';
        }
        function hideImageContextMenu() { imageContextMenu.style.display = 'none'; }
        function disableActionButtons() { ['saveBtn', 'pdfBtn', 'printBtn'].forEach(id => document.getElementById(id).disabled = true); }
        function enableActionButtons() { ['saveBtn', 'pdfBtn', 'printBtn'].forEach(id => document.getElementById(id).disabled = false); }
        function showLoading(show, msg = "...") { const el = document.getElementById('loading-indicator'); el.textContent = msg; el.style.display = show ? 'block' : 'none'; }
        function adjustCanvasZoom(delta) { canvasScale = Math.max(0.1, Math.min(5, canvasScale + delta)); drawCanvas(); }
        function resetCanvasZoom() { canvasScale = 1; canvasOffsetX = 0; canvasOffsetY = 0; drawCanvas(); }
        function showToast(message, type = 'info') {
            const container = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast`;
            toast.style.borderLeftColor = `var(--${type}-color)`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 4000);
        }

        // Initialize
        setupEventListeners();
        disableActionButtons();
        updateToolbarState();
        hideImageContextMenu();
    })();
    </script>
</body>
</html>